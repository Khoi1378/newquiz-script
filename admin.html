<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Admin Panel</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#ffecd2; --bg2:#fcb69f;
      --card:#fff; --text:#1f2937; --muted:#6b7280;
      --primary:#7c3aed; --bad:#dc2626; --ok:#16a34a;
      --border:#e5e7eb; --soft:#f8fafc;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --radius:18px; --admin:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
        linear-gradient(120deg,var(--bg1) 0%, var(--bg2) 100%);
      overflow:hidden;
    }
    #shell{height:100vh; overflow:auto; -webkit-overflow-scrolling:touch; padding:12px 0 110px}
    .wrap{max-width:1180px; margin:0 auto; padding:0 14px}

    .topbar{
      margin-top:10px;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(229,231,235,.9);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .titlebox{display:flex; gap:10px; align-items:center; flex:1 1 420px; min-width:240px}
    .logo{
      width:42px; height:42px; border-radius:16px;
      background:linear-gradient(135deg,#a78bfa,#fb7185);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:900;
      box-shadow:0 10px 22px rgba(124,58,237,.18);
      user-select:none;
    }
    .titles h1{font-size:1.02rem; margin:0; font-weight:800}
    .titles .tiny{margin-top:3px; font-size:.86rem; color:var(--muted); font-weight:650}
    a{color:#4c1d95; text-decoration:none; font-weight:950}
    a:hover{text-decoration:underline}

    .pill{
      background:#f3f4f6; border:1px solid #e5e7eb;
      border-radius:999px; padding:8px 12px;
      font-weight:900; font-size:.9rem; color:#374151; white-space:nowrap;
      display:flex; gap:8px; align-items:center;
    }
    .badge-admin{
      padding:4px 8px; border-radius:999px; font-weight:950; font-size:.78rem;
      background:rgba(37,99,235,.12);
      border:1px solid rgba(37,99,235,.35);
      color:var(--admin); white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin:12px 0;
    }
    .row1{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .vi{margin:0; font-weight:900; font-size:1.04rem; line-height:1.25}
    .muted{color:var(--muted); font-weight:650}
    .idx{
      font-size:.78rem; font-weight:900;
      padding:6px 10px; border-radius:999px;
      background:#eff6ff; color:#1d4ed8; border:1px solid #dbeafe;
      white-space:nowrap;
    }
    .idx.ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .idx.warn{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .idx.bad{background:#fee2e2;color:#991b1b;border-color:#fecaca}

    .btn{
      border:0; cursor:pointer;
      border-radius:999px; padding:10px 14px;
      font-weight:900; font-size:.9rem;
      transition:transform .16s ease, filter .16s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none; white-space:nowrap;
      box-shadow:0 12px 24px rgba(0,0,0,.12);
      background:#fff; color:#111827; border:1px solid #e5e7eb;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(.98)}
    .btn:active{transform:translateY(0)}
    .btn[disabled]{opacity:.6; cursor:not-allowed; transform:none !important; filter:none !important}
    .btn-primary{
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      color:#fff; border:0;
      box-shadow:0 12px 24px rgba(124,58,237,.18);
    }
    .btn-danger{background:var(--bad); color:#fff; border:0; box-shadow:0 12px 24px rgba(220,38,38,.18);}
    .btn-ghost{background:#fff; color:#111827; border:1px solid #e5e7eb; box-shadow:none}

    .input, textarea, select{
      width:100%;
      border-radius:14px; border:2px solid #e5e7eb;
      padding:11px 12px; font-size:.95rem; font-weight:700;
      outline:none; background:var(--soft);
      transition:border-color .15s ease, box-shadow .15s ease;
      font-family:inherit;
    }
    textarea{min-height:120px; font-family:ui-monospace,Consolas,monospace; font-weight:650}
    .input:focus, textarea:focus, select:focus{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 0 0 5px rgba(124,58,237,.10);
      background:#fff;
    }
    label{display:block; margin-top:10px; font-weight:900}

    .tabs{display:flex; gap:10px; flex-wrap:wrap}
    .tab{padding:10px 14px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; font-weight:950; cursor:pointer; box-shadow:none}
    .tab.active{background:linear-gradient(135deg,#7c3aed,#fb7185); color:#fff; border:0}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1.1fr 1.2fr 1fr; gap:10px}
    @media(max-width:980px){ .grid3{grid-template-columns:1fr} }
    @media(max-width:640px){ .grid2{grid-template-columns:1fr} }

    code{background:#f6f6f6;padding:2px 6px;border-radius:8px;border:1px solid #eee}
    .mono{font-family:ui-monospace,Consolas,monospace}
    .hr{height:1px;background:#e5e7eb;margin:12px 0}

    .topGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:start;}
    @media(max-width:980px){ .topGrid{grid-template-columns:1fr;} }

    .qItem{
      border:1px solid rgba(229,231,235,.95);
      border-radius:16px;
      padding:12px;
      background:#fff;
      box-shadow:none;
      margin:10px 0;
      cursor:pointer;
    }
    .qBadges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .qActions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .mini{padding:8px 10px; border-radius:14px; border:1px solid #e5e7eb; background:#fff; font-weight:900; cursor:pointer}
    .mini.danger{border:0;background:var(--bad);color:#fff}
    .mini.primary{border:0;background:linear-gradient(135deg,#7c3aed,#fb7185);color:#fff}

    .qbHead{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .qbTabs{
      display:flex; gap:8px; flex-wrap:wrap;
      background:rgba(243,244,246,.88);
      border:1px solid rgba(229,231,235,.95);
      padding:6px; border-radius:999px;
    }
    .qbTab{
      border:0;background:transparent;cursor:pointer;border-radius:999px;
      padding:9px 12px;font-weight:950;font-size:.86rem;color:#111827;
      transition:transform .12s ease, filter .12s ease, background-color .12s ease;
      user-select:none; white-space:nowrap;
    }
    .qbTab:hover{ transform:translateY(-1px); filter:brightness(.98); }
    .qbTab:active{ transform:translateY(0); }
    .qbTab.active{
      background:#fff;border:1px solid rgba(229,231,235,.95);
      box-shadow:0 10px 24px rgba(0,0,0,.08);
    }

    .qCard{
      background:#fff;
      border:1px solid rgba(229,231,235,.95);
      border-radius:16px;
      padding:12px;
      box-shadow:none;
      margin:12px 0;
    }
    .qHead{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding-bottom:10px; border-bottom:1px dashed rgba(229,231,235,.95);
      margin-bottom:10px;
    }
    .qType{
      border-radius:999px;
      padding:9px 12px;
      font-weight:950;
      background:rgba(248,250,252,.95);
    }
    .qPrompt{min-height:90px}
    .hint{font-weight:650;color:var(--muted);line-height:1.35; font-size:.88rem}
    .hidden{display:none !important;}

    .imgRow{display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; margin-top:10px}
    .imgDrop{
      flex:1 1 320px;
      border:2px dashed #e5e7eb;
      border-radius:16px;
      padding:12px;
      background:rgba(248,250,252,.8);
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .imgDrop small{color:var(--muted); font-weight:750}
    .imgPreview{
      width:220px; height:132px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#fff;
      object-fit:cover;
      display:none;
      flex:0 0 auto;
    }

    .qFab{
      position:fixed; left:0; right:0;
      bottom:calc(env(safe-area-inset-bottom) + 18px);
      z-index:20010;
      pointer-events:none;
      padding:0 14px;
    }
    .qFabInner{
      max-width:1180px; margin:0 auto;
      pointer-events:auto;
      display:flex; justify-content:flex-end;
    }
    .qFabBtn{
      width:min(520px, 100%);
      border-radius:18px;
      padding:14px 16px;
      font-size:1.04rem;
      font-weight:1000;
      letter-spacing:.02em;
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      color:#fff;
      border:0;
      box-shadow:0 16px 42px rgba(124,58,237,.22);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .qFabBtn:hover{transform:translateY(-1px);filter:brightness(.98)}
    .qFabBtn:active{transform:translateY(0)}
    .qFab.hidden{display:none !important}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(17,24,39,.92); color:#fff;
      padding:10px 12px; border-radius:14px;
      font-weight:800; font-size:.9rem;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width:calc(100% - 28px);
      z-index:20050; text-align:center;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
  </style>
</head>

<body>
  <div id="shell">
    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">A</div>
          <div class="titles">
            <h1>Admin Panel</h1>
            <div class="tiny"><a href="/">‚Üê v·ªÅ k·ªá h√†ng</a></div>
          </div>
        </div>
        <div class="pill" id="mePill">Checking‚Ä¶</div>
      </div>

      <div class="card" id="gate">Checking login...</div>

      <div id="app" style="display:none">
        <div class="card">
          <div class="row1">
            <p class="vi">B·∫£ng ƒëi·ªÅu khi·ªÉn</p>
            <div class="tabs">
              <button class="tab active" id="tabQuizzes">Quizzes</button>
              <button class="tab" id="tabUsers">Users</button>
            </div>
          </div>
        </div>

        <!-- QUIZZES -->
        <div id="viewQuizzes">
          <div class="topGrid">
            <!-- settings -->
            <div class="card">
              <div class="row1">
                <p class="vi">Quiz</p>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                  <span class="idx" id="editModePill">NEW</span>
                  <span class="idx" id="draftPill">DRAFT: ‚Äî</span>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>Quiz ID (5 ch·ªØ)</label>
                  <input class="input mono" id="quizId" placeholder="abcde" maxlength="5" />
                </div>
                <div>
                  <label>Title</label>
                  <input class="input" id="title" placeholder="T√™n quiz" />
                </div>
              </div>

              <label>Sub</label>
              <input class="input" id="sub" placeholder="M√¥ t·∫£ ng·∫Øn" />

              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>Public</label>
                  <select id="isPublic">
                    <option value="true">Public</option>
                    <option value="false">Private</option>
                  </select>
                </div>
                <div>
                  <label>·∫®n quiz (is_hidden)</label>
                  <select id="isHidden">
                    <option value="false">Kh√¥ng ·∫©n</option>
                    <option value="true">·∫®n</option>
                  </select>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>Hi·ªán tr√™n store</label>
                  <select id="showInStore">
                    <option value="true">Hi·ªán</option>
                    <option value="false">·∫®n</option>
                  </select>
                </div>
                <div>
                  <label>Y√™u c·∫ßu login</label>
                  <select id="requireLogin">
                    <option value="true">C·∫ßn login</option>
                    <option value="false">Kh√¥ng c·∫ßn login</option>
                  </select>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>Ghim</label>
                  <select id="pinned">
                    <option value="false">Kh√¥ng</option>
                    <option value="true">Ghim</option>
                  </select>
                </div>
                <div>
                  <label>Chia ƒëi·ªÉm</label>
                  <select id="scoringMode">
                    <option value="equal">Chia ƒë·ªÅu theo s·ªë c√¢u</option>
                    <option value="custom">T·ª± chia (m·ªói c√¢u c√≥ ƒëi·ªÉm)</option>
                  </select>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>M√£ truy c·∫≠p</label>
                  <select id="requireCode">
                    <option value="false">Kh√¥ng</option>
                    <option value="true">C√≥</option>
                  </select>
                </div>
                <div>
                  <label>Code</label>
                  <input class="input mono" id="accessCode" placeholder="vd: 1234" />
                </div>
              </div>

              <label>T·ªïng ƒëi·ªÉm</label>
              <input class="input mono" id="totalScore" value="10" />

              <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn" id="btnNewQuiz" type="button">‚ú® T·∫°o m·ªõi</button>
                <button class="btn btn-ghost" id="btnClearDraft" type="button">üßΩ X√≥a nh√°p</button>
                <button class="btn btn-primary" id="btnSaveQuiz" type="button">üíæ L∆∞u quiz</button>
              </div>
            </div>

            <!-- list -->
            <div class="card">
              <div class="row1">
                <p class="vi">Danh s√°ch quiz</p>
                <button class="btn" id="btnReloadQuizzes" type="button">Reload</button>
              </div>
              <div id="quizList" style="margin-top:10px"></div>
            </div>
          </div>

          <!-- Question editor -->
          <div class="card" style="margin-top:10px">
            <div class="qbHead">
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <p class="vi" style="margin:0">So·∫°n c√¢u h·ªèi</p>
                <span class="idx" id="qCountPill">0</span>
              </div>
              <div class="qbTabs" aria-label="Ch·∫ø ƒë·ªô">
                <button class="qbTab active" id="qbTabManual" type="button">üìù Th·ªß c√¥ng</button>
                <button class="qbTab" id="qbTabImport" type="button">üì• Import</button>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn btn-primary" id="btnPublishAll" type="button">üöÄ Publish</button>
              </div>
            </div>

            <div id="qbManualArea" style="margin-top:10px">
              <div class="hint" style="margin-top:6px">
                G√µ k√Ω hi·ªáu to√°n h·ªçc b·∫±ng <code>$...$</code> (vd: <code>$x^2$</code>, <code>$(x+y)/2$</code>).<br>
                ·∫¢nh l√† ·∫£nh c·ªßa t·ª´ng c√¢u (paste/k√©o th·∫£/ch·ªçn file ngay trong c√¢u).
              </div>

              <div id="qList" style="margin-top:12px"></div>

              <div class="hr"></div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn btn-primary" id="btnPublishAllBottom" type="button">üöÄ Publish</button>
              </div>
            </div>

            <div id="qbImportArea" style="display:none; margin-top:10px">
              <div class="hint" style="margin-top:0">
                Import theo ƒë·ªãnh d·∫°ng (m·ªói block b·∫Øt ƒë·∫ßu b·∫±ng tag):
                <div class="mono" style="white-space:pre-wrap; margin-top:8px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:10px">
&lt;tn&gt;@1: C√¢u tr·∫Øc nghi·ªám
A
B
*C*  (d√≤ng c√≥ *...* l√† ƒë√°p √°n ƒë√∫ng)

&lt;tl&gt;@2: C√¢u t·ª± lu·∫≠n
*ƒê√°p √°n ƒë√∫ng*

&lt;tln&gt;@3: Tr·∫£ l·ªùi ng·∫Øn
*0,02*

&lt;tf&gt;@4: ƒê√∫ng/Sai
|A: ... *T*|
|B: ... *F*|
                </div>
              </div>

              <label>Paste n·ªôi dung</label>
              <textarea id="importBox" placeholder="D√°n n·ªôi dung import v√†o ƒë√¢y..."></textarea>

              <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn" id="btnImportReplace" type="button">‚¨áÔ∏è Import (thay th·∫ø danh s√°ch)</button>
                <button class="btn btn-primary" id="btnImportAppend" type="button">‚ûï Import (th√™m v√†o cu·ªëi)</button>
              </div>

              <div class="hint" style="margin-top:10px">
                Import xong b·∫°n c√≥ th·ªÉ chuy·ªÉn qua tab ‚ÄúTh·ªß c√¥ng‚Äù ƒë·ªÉ ch·ªânh t·ª´ng c√¢u.
              </div>

              <div class="hr"></div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn btn-primary" id="btnPublishAll2" type="button">üöÄ Publish</button>
              </div>
            </div>
          </div>
        </div>

        <!-- USERS -->
        <div id="viewUsers" style="display:none">
          <div class="card">
            <div class="row1">
              <p class="vi">Users</p>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <input class="input" id="userSearch" placeholder="Search username..." style="max-width:320px"/>
                <button class="btn" id="btnReloadUsers" type="button">Reload</button>
              </div>
            </div>
            <div id="userList" style="margin-top:10px"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="qFab" id="qFab">
    <div class="qFabInner">
      <button class="qFabBtn" id="btnAddQFab" type="button">‚ûï TH√äM C√ÇU H·ªéI</button>
    </div>
  </div>

  <input id="qImgPick" type="file" accept="image/*" style="display:none" />
  <div class="toast" id="toast"></div>

<script>
/* ================== CONFIG ================== */
const SUPABASE_URL = "https://aidvlydhbdtwunyreqak.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZHZseWRoYmR0d3VueXJlcWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzM5NzYsImV4cCI6MjA4NDIwOTk3Nn0.LMKGjKlUbC5qoY7hqDpaDFQrFWfwKemBTpxjTNp_L8o";
const TOKEN_KEY = "tk_token_v2";

/* RPC names */
const RPC = {
  // auth
  me: "api_me",
  loginPin: "api_login_pin",
  logout: "api_logout",

  // quizzes
  adminUpsertQuiz: "admin_upsert_quiz",
  adminListQuizzes: "admin_list_quizzes",
  adminDeleteQuiz: "admin_delete_quiz",
  adminGetQuestions: "admin_get_questions",
  adminReplaceQuestions: "admin_replace_questions",
  adminImportQuestions: "admin_import_questions",

  // users
  adminListUsers: "admin_list_users",
  adminDeleteUser: "admin_delete_user",
  adminForceRename: "admin_force_rename",
  adminForceSetPin: "admin_force_set_pin"
};

/* ================== UI HELPERS ================== */
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=String(msg||"");
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1300);
}
function esc(s){
  return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function getToken(){ return (localStorage.getItem(TOKEN_KEY) || "").trim(); }
function setToken(t){ localStorage.setItem(TOKEN_KEY, String(t||"").trim()); }
function clearToken(){ localStorage.removeItem(TOKEN_KEY); }
function normalizeQuizId(x){
  x = String(x||"").trim().toLowerCase();
  x = x.replace(/[^a-z]/g,"").slice(0,5);
  return x;
}
function genQuizId5(){
  const letters="abcdefghijklmnopqrstuvwxyz";
  let s="";
  for(let i=0;i<5;i++) s += letters[Math.floor(Math.random()*letters.length)];
  return s;
}

/* ================== SUPABASE RPC ================== */
async function rpc(fn, args){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{
    method:"POST",
    headers:{
      "apikey": SUPABASE_ANON_KEY,
      "Authorization":"Bearer " + SUPABASE_ANON_KEY,
      "Content-Type":"application/json"
    },
    body: JSON.stringify(args||{})
  });
  const txt = await res.text();
  let data=null;
  try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || `RPC failed: ${fn}`);
  }
  return data;
}

/* ================== DOM ================== */
const mePill = document.getElementById("mePill");
const gate = document.getElementById("gate");
const app = document.getElementById("app");

const tabQuizzes = document.getElementById("tabQuizzes");
const tabUsers = document.getElementById("tabUsers");
const viewQuizzes = document.getElementById("viewQuizzes");
const viewUsers = document.getElementById("viewUsers");
function setTab(which){
  const isQ = which==="q";
  tabQuizzes.classList.toggle("active", isQ);
  tabUsers.classList.toggle("active", !isQ);
  viewQuizzes.style.display = isQ ? "" : "none";
  viewUsers.style.display = isQ ? "none" : "";
}
tabQuizzes.onclick = ()=>setTab("q");
tabUsers.onclick = ()=>setTab("u");

/* ================== STATE ================== */
let ME = null;
let QUIZZES = [];
let USERS = [];

let CURRENT_QID = "";
let CURRENT_MODE = "NEW"; // NEW | EDIT
let QUESTIONS = [];       // array of {type,prompt,answers,points,meta}

/* ================== DRAFT ================== */
const DRAFT_NS = "admin_draft_v6_sql";
function draftKeyFor(qid){ return `${DRAFT_NS}::${qid || "NEW"}`; }
const draftPill = document.getElementById("draftPill");
let draftTimer = null;

function setDraftPill(text, cls=""){
  draftPill.textContent = text;
  draftPill.className = "idx " + (cls||"");
}
function saveDraftSoon(){
  if(draftTimer) clearTimeout(draftTimer);
  draftTimer = setTimeout(saveDraftNow, 250);
}
function getFormSnapshot(){
  return {
    v: 1,
    ts: Date.now(),
    mode: CURRENT_MODE,
    qid: CURRENT_QID || normalizeQuizId(quizIdEl.value),
    form: {
      quiz_id: normalizeQuizId(quizIdEl.value),
      title: titleEl.value,
      sub: subEl.value,
      is_public: isPublicEl.value,
      is_hidden: isHiddenEl.value,
      show_in_store: showInStoreEl.value,
      require_login: requireLoginEl.value,
      pinned: pinnedEl.value,
      require_access_code: requireCodeEl.value,
      access_code: accessCodeEl.value,
      scoring_mode: scoringModeEl.value,
      total_score: totalScoreEl.value
    },
    questions: QUESTIONS
  };
}
function saveDraftNow(){
  try{
    const snap = getFormSnapshot();
    const key = draftKeyFor(CURRENT_QID || snap.form.quiz_id || "NEW");
    localStorage.setItem(key, JSON.stringify(snap));
    const d = new Date(snap.ts);
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    const ss = String(d.getSeconds()).padStart(2,"0");
    setDraftPill(`DRAFT: ${hh}:${mm}:${ss}`, "ok");
  }catch{
    setDraftPill("DRAFT: OFF", "warn");
  }
}
function clearDraft(){
  const key1 = draftKeyFor(CURRENT_QID || normalizeQuizId(quizIdEl.value) || "NEW");
  localStorage.removeItem(key1);
  setDraftPill("DRAFT: ‚Äî");
}
function tryLoadDraft(qid){
  const raw = localStorage.getItem(draftKeyFor(qid || "NEW"));
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}

/* ================== SIMPLE LOGIN UI (PIN) ================== */
function renderLoginUI(msg){
  const lastU = localStorage.getItem("admin_last_username") || "tuankhoi";
  gate.innerHTML = `
    <div class="row1">
      <p class="vi" style="margin:0">ƒêƒÉng nh·∫≠p Admin</p>
      <span class="idx warn">${esc(msg || "Ch∆∞a ƒëƒÉng nh·∫≠p")}</span>
    </div>

    <div class="hint" style="margin-top:8px">
      Nh·∫≠p <b>username</b> + <b>PIN 6 s·ªë</b>. Token s·∫Ω t·ª± l∆∞u (b·∫°n kh√¥ng c·∫ßn quan t√¢m).
    </div>

    <div class="grid2" style="margin-top:12px">
      <div>
        <label>Username</label>
        <input class="input mono" id="loginUsername" placeholder="tuankhoi" value="${esc(lastU)}" autocomplete="username" />
      </div>
      <div>
        <label>PIN (6 s·ªë)</label>
        <input class="input mono" id="loginPin" placeholder="072008" inputmode="numeric" maxlength="6" autocomplete="one-time-code" />
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn btn-ghost" id="btnClearToken" type="button">üßπ X√≥a login</button>
      <button class="btn btn-primary" id="btnDoLogin" type="button">üîì V√†o Admin</button>
    </div>
  `;

  const uEl = gate.querySelector("#loginUsername");
  const pEl = gate.querySelector("#loginPin");

  pEl.addEventListener("input", ()=>{
    pEl.value = String(pEl.value||"").replace(/[^0-9]/g,"").slice(0,6);
  }, {passive:true});

  gate.querySelector("#btnClearToken").onclick = ()=>{
    clearToken();
    toast("ƒê√£ x√≥a login");
    renderLoginUI("ƒê√£ x√≥a token");
  };

  gate.querySelector("#btnDoLogin").onclick = ()=>doLoginPin();

  pEl.addEventListener("keydown",(e)=>{
    if(e.key==="Enter") doLoginPin();
  });
  uEl.addEventListener("keydown",(e)=>{
    if(e.key==="Enter") doLoginPin();
  });
}

async function doLoginPin(){
  const u = (gate.querySelector("#loginUsername")?.value || "").trim().toLowerCase();
  const pin = (gate.querySelector("#loginPin")?.value || "").trim();
  if(!u) return toast("Thi·∫øu username");
  if(!/^[0-9]{6}$/.test(pin)) return toast("PIN ph·∫£i ƒë√∫ng 6 s·ªë (vd: 072008)");

  try{
    gate.querySelector("#btnDoLogin").setAttribute("disabled","disabled");
    const out = await rpc(RPC.loginPin, { p_username: u, p_pin: pin });
    if(!out?.ok) throw new Error(out?.error || "login failed");
    if(!out?.token) throw new Error("RPC kh√¥ng tr·∫£ token");

    setToken(out.token);
    localStorage.setItem("admin_last_username", u);

    toast("Login OK");
    await boot(); // ch·∫°y v√†o panel
  }catch(e){
    toast(e.message || "Login error");
    renderLoginUI(e.message || "Login error");
  }finally{
    try{ gate.querySelector("#btnDoLogin")?.removeAttribute("disabled"); }catch{}
  }
}

async function doLogout(){
  const tk = getToken();
  clearToken();
  try{ if(tk) await rpc(RPC.logout, { p_token: tk }); }catch{}
  app.style.display = "none";
  mePill.textContent = "Logged out";
  renderLoginUI("B·∫°n ƒë√£ logout");
}

/* ================== AUTH GATE ================== */
async function gateCheck(){
  const token = getToken();
  if(!token){
    mePill.textContent = "No login";
    renderLoginUI("Ch∆∞a c√≥ token");
    return false;
  }
  try{
    const meOut = await rpc(RPC.me,{p_token:token});
    if(!meOut?.ok) throw new Error(meOut?.error || "not logged");
    ME = meOut.me;

    const isAdmin = (String(ME.role||"").toLowerCase()==="admin") || (String(ME.username||"").toLowerCase()==="tuankhoi");
    if(!isAdmin){
      mePill.innerHTML = `Xin ch√†o <b>${esc(ME.username)}</b> <span class="idx warn">NOT ADMIN</span>`;
      gate.innerHTML = `B·∫°n kh√¥ng ph·∫£i admin. <button class="btn btn-ghost" id="btnLogoutGate" type="button">Logout</button>`;
      gate.querySelector("#btnLogoutGate").onclick = doLogout;
      return false;
    }

    mePill.innerHTML = `
      Xin ch√†o <b>${esc(ME.username)}</b>
      <span class="badge-admin">ADMIN</span>
      <button class="btn btn-ghost" id="btnLogoutTop" type="button" style="padding:8px 10px;box-shadow:none">Logout</button>
    `;
    mePill.querySelector("#btnLogoutTop").onclick = doLogout;

    gate.innerHTML = `<span class="idx ok">OK</span> Admin: <b>${esc(ME.username)}</b>`;
    app.style.display = "";
    return true;
  }catch(e){
    mePill.textContent = "Login error";
    renderLoginUI("Token l·ªói / h·∫øt h·∫°n: " + (e.message||""));
    return false;
  }
}

/* ================== QUIZ FORM ================== */
const quizIdEl = document.getElementById("quizId");
const titleEl = document.getElementById("title");
const subEl = document.getElementById("sub");
const isPublicEl = document.getElementById("isPublic");
const isHiddenEl = document.getElementById("isHidden");
const showInStoreEl = document.getElementById("showInStore");
const requireLoginEl = document.getElementById("requireLogin");
const pinnedEl = document.getElementById("pinned");
const requireCodeEl = document.getElementById("requireCode");
const accessCodeEl = document.getElementById("accessCode");
const scoringModeEl = document.getElementById("scoringMode");
const totalScoreEl = document.getElementById("totalScore");

const editModePill = document.getElementById("editModePill");

quizIdEl.addEventListener("input", ()=>{
  const v = normalizeQuizId(quizIdEl.value);
  if(quizIdEl.value !== v) quizIdEl.value = v;
  if(CURRENT_MODE==="NEW") saveDraftSoon();
},{passive:true});

[
  titleEl, subEl, isPublicEl, isHiddenEl, showInStoreEl, requireLoginEl,
  pinnedEl, requireCodeEl, accessCodeEl, scoringModeEl, totalScoreEl
].forEach(el=>{
  el.addEventListener("input", saveDraftSoon, {passive:true});
  el.addEventListener("change", saveDraftSoon, {passive:true});
});

function setMode(mode){
  CURRENT_MODE = mode;
  editModePill.textContent = mode;
  editModePill.className = "idx " + (mode==="EDIT" ? "ok" : "");
  if(mode==="EDIT"){
    quizIdEl.setAttribute("disabled","disabled");
  }else{
    quizIdEl.removeAttribute("disabled");
  }
}

function validateQuiz(){
  const title = titleEl.value.trim();
  if(!title) return "Thi·∫øu title";
  let qid = (CURRENT_MODE==="EDIT") ? CURRENT_QID : normalizeQuizId(quizIdEl.value);
  if(CURRENT_MODE==="NEW" && !qid) return "Quiz ID tr·ªëng (b·∫•m T·∫°o m·ªõi ho·∫∑c nh·∫≠p 5 ch·ªØ)";
  if(qid && qid.length!==5) return "Quiz ID ph·∫£i ƒë√∫ng 5 ch·ªØ a-z";
  return null;
}

/* ================== QUESTION BUILDER ================== */
const qList = document.getElementById("qList");
const qCountPill = document.getElementById("qCountPill");

const qbTabManual = document.getElementById("qbTabManual");
const qbTabImport = document.getElementById("qbTabImport");
const qbManualArea = document.getElementById("qbManualArea");
const qbImportArea = document.getElementById("qbImportArea");
const qFab = document.getElementById("qFab");

const LS_QB_MODE = "admin_qb_mode_v2";
const LS_QB_LASTTYPE = "admin_qb_lasttype_v2";

function isAllowedQType(t){ return (t==="mcq1" || t==="essay" || t==="short4" || t==="tf4"); }

let QB_MODE = (localStorage.getItem(LS_QB_MODE)||"manual").toLowerCase();
if(QB_MODE!=="manual" && QB_MODE!=="import") QB_MODE="manual";

let LAST_QTYPE = (localStorage.getItem(LS_QB_LASTTYPE)||"mcq1").toLowerCase();
if(!isAllowedQType(LAST_QTYPE)) LAST_QTYPE="mcq1";

function setLastType(t){
  t = String(t||"").toLowerCase();
  if(!isAllowedQType(t)) return;
  LAST_QTYPE = t;
  try{ localStorage.setItem(LS_QB_LASTTYPE, LAST_QTYPE); }catch{}
}

function setQBMode(mode){
  mode = String(mode||"manual").toLowerCase();
  if(mode!=="manual" && mode!=="import") mode="manual";
  QB_MODE = mode;
  try{ localStorage.setItem(LS_QB_MODE, QB_MODE); }catch{}

  qbTabManual.classList.toggle("active", QB_MODE==="manual");
  qbTabImport.classList.toggle("active", QB_MODE==="import");
  qbManualArea.style.display = (QB_MODE==="manual") ? "" : "none";
  qbImportArea.style.display = (QB_MODE==="import") ? "" : "none";
  qFab.classList.toggle("hidden", QB_MODE!=="manual");
}
qbTabManual.addEventListener("click", ()=>setQBMode("manual"));
qbTabImport.addEventListener("click", ()=>setQBMode("import"));

function updateQCount(){ qCountPill.textContent = String(QUESTIONS.length || 0); }

function defaultQuestion(){
  const t = LAST_QTYPE || "mcq1";
  if(t==="mcq1"){
    return { type:"mcq1", prompt:"", answers:[], points:null, meta:{ options:["A","B","C","D"], correct:1, image_data_url:"" } };
  }
  if(t==="short4"){
    return { type:"short4", prompt:"", answers:[""], points:null, meta:{ format:"4boxes", image_data_url:"" } };
  }
  if(t==="tf4"){
    return { type:"tf4", prompt:"", answers:[], points:null, meta:{
      statements:["","","",""], keys:[true,false,false,false],
      rule:{ byCorrectCount:{ "0":0, "1":0.25, "2":0.5, "3":0.5, "4":1 } },
      image_data_url:""
    }};
  }
  return { type:"essay", prompt:"", answers:[""], points:null, meta:{ fuzzy:true, image_data_url:"" } };
}
function ensureMetaImage(q){
  q.meta = q.meta || {};
  if(typeof q.meta.image_data_url !== "string") q.meta.image_data_url = "";
}

function renderQuestions(){
  updateQCount();
  if(!QUESTIONS.length){
    qList.innerHTML = `<div class="muted">Ch∆∞a c√≥ c√¢u h·ªèi. B·∫•m ‚ÄúTH√äM C√ÇU H·ªéI‚Äù.</div>`;
    return;
  }
  const isCustom = (scoringModeEl.value === "custom");

  qList.innerHTML = QUESTIONS.map((q, idx)=>{
    ensureMetaImage(q);
    const no = idx+1;
    const img = q.meta.image_data_url || "";
    return `
      <div class="qCard" data-i="${idx}">
        <div class="qHead">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <span class="idx">#${no}</span>
            <select class="qType">
              <option value="mcq1" ${q.type==="mcq1"?"selected":""}>Tr·∫Øc nghi·ªám 1 ƒë√°p √°n</option>
              <option value="essay" ${q.type==="essay"?"selected":""}>T·ª± lu·∫≠n</option>
              <option value="short4" ${q.type==="short4"?"selected":""}>Tr·∫£ l·ªùi ng·∫Øn (4 √¥)</option>
              <option value="tf4" ${q.type==="tf4"?"selected":""}>ƒê√∫ng/Sai 4 √Ω</option>
            </select>
            ${isCustom ? `<input class="qPoints input mono" style="max-width:110px" placeholder="ƒêi·ªÉm" value="${q.points??0}">` : ``}
          </div>

          <div class="qActions">
            <button class="mini" data-act="up" type="button">‚¨ÜÔ∏è</button>
            <button class="mini" data-act="down" type="button">‚¨áÔ∏è</button>
            <button class="mini" data-act="dup" type="button">üìÑ</button>
            <button class="mini danger" data-act="del" type="button">üóëÔ∏è</button>
          </div>
        </div>

        <label>C√¢u h·ªèi</label>
        <textarea class="qPrompt" placeholder="B·∫°n c√≥ th·ªÉ d√πng $...$ cho to√°n (vd: $x^2$)">${esc(q.prompt||"")}</textarea>

        <div class="imgRow">
          <div class="imgDrop" data-imgdrop="1">
            <div style="min-width:220px">
              <div style="font-weight:950">·∫¢nh c√¢u h·ªèi</div>
              <small>Paste / k√©o th·∫£ / ch·ªçn file ‚Ä¢ t·ª± resize max 1200px</small>
              <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn" data-act="pickimg" type="button">üì∑ Ch·ªçn ·∫£nh</button>
                <button class="btn btn-ghost" data-act="removeimg" type="button">üóëÔ∏è X√≥a ·∫£nh</button>
              </div>
            </div>
          </div>
          <img class="imgPreview" data-imgpreview="1" alt="preview" src="${img ? esc(img) : ""}" style="${img ? "display:block" : "display:none"}"/>
        </div>

        <div class="qEssay ${q.type==="essay"?"":"hidden"}">
          <label>ƒê√°p √°n (nhi·ªÅu ƒë√°p √°n d√πng d·∫•u |)</label>
          <input class="qAnswers input mono" placeholder="vd: th√≠ch nghi|thich nghi" value="${esc((q.answers||[]).join("|"))}">
        </div>

        <div class="qMcq ${q.type==="mcq1"?"":"hidden"}">
          <label>4 l·ª±a ch·ªçn</label>
          <div class="grid2">
            <input class="qOpt input" data-k="0" placeholder="A" value="${esc(q.meta?.options?.[0]||"")}">
            <input class="qOpt input" data-k="1" placeholder="B" value="${esc(q.meta?.options?.[1]||"")}">
            <input class="qOpt input" data-k="2" placeholder="C" value="${esc(q.meta?.options?.[2]||"")}">
            <input class="qOpt input" data-k="3" placeholder="D" value="${esc(q.meta?.options?.[3]||"")}">
          </div>
          <label>ƒê√°p √°n ƒë√∫ng</label>
          <select class="qCorrect">
            <option value="1" ${(q.meta?.correct||1)==1?"selected":""}>A</option>
            <option value="2" ${(q.meta?.correct||1)==2?"selected":""}>B</option>
            <option value="3" ${(q.meta?.correct||1)==3?"selected":""}>C</option>
            <option value="4" ${(q.meta?.correct||1)==4?"selected":""}>D</option>
          </select>
        </div>

        <div class="qShort4 ${q.type==="short4"?"":"hidden"}">
          <label>ƒê√°p √°n (nhi·ªÅu ƒë√°p √°n d√πng d·∫•u |)</label>
          <input class="qAnswers input mono" placeholder='vd: -0,3|9999|0,02' value="${esc((q.answers||[]).join("|"))}">
          <div class="hint" style="margin-top:6px">Khi l√†m quiz s·∫Ω hi·ªán 4 √¥ nh·∫≠p (0-9, d·∫•u ph·∫©y, d·∫•u tr·ª´).</div>
        </div>

        <div class="qTf4 ${q.type==="tf4"?"":"hidden"}">
          <label>4 √Ω (m·ªói √Ω 1 d√≤ng)</label>
          <div style="display:grid;gap:8px">
            <input class="qStmt input" data-k="0" placeholder="√ù A" value="${esc(q.meta?.statements?.[0]||"")}">
            <input class="qStmt input" data-k="1" placeholder="√ù B" value="${esc(q.meta?.statements?.[1]||"")}">
            <input class="qStmt input" data-k="2" placeholder="√ù C" value="${esc(q.meta?.statements?.[2]||"")}">
            <input class="qStmt input" data-k="3" placeholder="√ù D" value="${esc(q.meta?.statements?.[3]||"")}">
          </div>
          <label>ƒê√∫ng(1) / Sai(0)</label>
          <div class="grid2">
            <select class="qKey" data-k="0"><option value="1">A: ƒê√∫ng</option><option value="0">A: Sai</option></select>
            <select class="qKey" data-k="1"><option value="1">B: ƒê√∫ng</option><option value="0">B: Sai</option></select>
            <select class="qKey" data-k="2"><option value="1">C: ƒê√∫ng</option><option value="0">C: Sai</option></select>
            <select class="qKey" data-k="3"><option value="1">D: ƒê√∫ng</option><option value="0">D: Sai</option></select>
          </div>
          <div class="hint" style="margin-top:6px">
            Rule: ƒë√∫ng 1 √Ω=0.25, 2 √Ω=0.5, 3 √Ω=0.5, 4 √Ω=1 (nh√¢n theo points n·∫øu custom).
          </div>
        </div>
      </div>
    `;
  }).join("");

  qList.querySelectorAll(".qCard").forEach(card=>{
    const i = Number(card.getAttribute("data-i"));
    const q = QUESTIONS[i];
    if(q?.type==="tf4"){
      ensureMetaImage(q);
      const keys = q.meta?.keys || [true,false,false,false];
      card.querySelectorAll(".qKey").forEach(sel=>{
        const k = Number(sel.getAttribute("data-k"));
        sel.value = keys[k] ? "1" : "0";
      });
    }
  });
}

function syncQuestionFromCard(card){
  const i = Number(card.getAttribute("data-i"));
  const q = QUESTIONS[i];
  if(!q) return;
  ensureMetaImage(q);

  const type = card.querySelector(".qType")?.value || "mcq1";
  q.type = type;

  q.prompt = card.querySelector(".qPrompt")?.value || "";

  if(scoringModeEl.value === "custom"){
    q.points = Number(card.querySelector(".qPoints")?.value || "0") || 0;
  }else{
    q.points = null;
  }

  if(type==="essay"){
    const raw = card.querySelector(".qAnswers")?.value || "";
    q.answers = raw.split("|").map(s=>s.trim()).filter(Boolean);
    q.meta = { ...(q.meta||{}), fuzzy:true };
  }else if(type==="short4"){
    const raw = card.querySelector(".qAnswers")?.value || "";
    q.answers = raw.split("|").map(s=>s.trim()).filter(Boolean);
    q.meta = { ...(q.meta||{}), format:"4boxes" };
  }else if(type==="mcq1"){
    const opts = Array.from(card.querySelectorAll(".qOpt")).map(x=>x.value.trim());
    const correct = Number(card.querySelector(".qCorrect")?.value || "1") || 1;
    q.answers = [];
    q.meta = { ...(q.meta||{}), options: opts, correct };
  }else if(type==="tf4"){
    const stmts = Array.from(card.querySelectorAll(".qStmt")).map(x=>x.value.trim());
    const keys = Array.from(card.querySelectorAll(".qKey")).map(x=>x.value==="1");
    q.answers = [];
    q.meta = { ...(q.meta||{}),
      statements: stmts,
      keys,
      rule: { byCorrectCount: { "0":0, "1":0.25, "2":0.5, "3":0.5, "4":1 } }
    };
  }
}

qList.addEventListener("input",(e)=>{
  const card = e.target.closest(".qCard");
  if(!card) return;
  syncQuestionFromCard(card);
  saveDraftSoon();
},{passive:true});

qList.addEventListener("change",(e)=>{
  const card = e.target.closest(".qCard");
  if(!card) return;
  if(e.target.classList.contains("qType")){
    setLastType(e.target.value);
    syncQuestionFromCard(card);
    renderQuestions();
  }else{
    syncQuestionFromCard(card);
  }
  saveDraftSoon();
},{passive:true});

qList.addEventListener("click",(e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  const card = btn.closest(".qCard");
  if(!card) return;
  const i = Number(card.getAttribute("data-i"));
  const act = btn.getAttribute("data-act");
  if(!act) return;

  if(act==="del"){
    QUESTIONS.splice(i,1);
    renderQuestions(); saveDraftSoon(); return;
  }
  if(act==="dup"){
    const clone = JSON.parse(JSON.stringify(QUESTIONS[i]));
    QUESTIONS.splice(i+1,0,clone);
    renderQuestions(); saveDraftSoon(); return;
  }
  if(act==="up" && i>0){
    [QUESTIONS[i-1], QUESTIONS[i]] = [QUESTIONS[i], QUESTIONS[i-1]];
    renderQuestions(); saveDraftSoon(); return;
  }
  if(act==="down" && i<QUESTIONS.length-1){
    [QUESTIONS[i+1], QUESTIONS[i]] = [QUESTIONS[i], QUESTIONS[i+1]];
    renderQuestions(); saveDraftSoon(); return;
  }
  if(act==="removeimg"){
    QUESTIONS[i].meta = QUESTIONS[i].meta || {};
    QUESTIONS[i].meta.image_data_url = "";
    renderQuestions(); saveDraftSoon(); toast("ƒê√£ x√≥a ·∫£nh"); return;
  }
  if(act==="pickimg"){
    IMG_PICK_FOR_INDEX = i;
    qImgPick.click();
    return;
  }
});

function scrollToLastQuestionAndFocus(){
  const cards = qList.querySelectorAll(".qCard");
  const last = cards[cards.length-1];
  if(!last) return;
  last.scrollIntoView({behavior:"smooth", block:"center"});
  setTimeout(()=> last.querySelector(".qPrompt")?.focus?.(), 250);
}

document.getElementById("btnAddQFab").onclick = ()=>{
  QUESTIONS.push(defaultQuestion());
  renderQuestions();
  saveDraftSoon();
  scrollToLastQuestionAndFocus();
};

scoringModeEl.addEventListener("change", ()=>{
  renderQuestions();
  saveDraftSoon();
},{passive:true});

/* ================== IMAGE (per question) ================== */
const qImgPick = document.getElementById("qImgPick");
let IMG_PICK_FOR_INDEX = -1;

function readImageToDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(String(fr.result||""));
    fr.onerror = ()=>reject(new Error("read file error"));
    fr.readAsDataURL(file);
  });
}
async function downscaleDataURL(dataUrl, maxW=1200){
  const img = new Image();
  img.src = dataUrl;
  await new Promise((res,rej)=>{ img.onload=res; img.onerror=()=>rej(new Error("image load error")); });
  const w = img.naturalWidth || img.width;
  const h = img.naturalHeight || img.height;
  if(!w || !h) return dataUrl;
  if(w <= maxW) return dataUrl;
  const ratio = maxW / w;
  const nw = Math.round(w * ratio);
  const nh = Math.round(h * ratio);
  const c = document.createElement("canvas");
  c.width = nw; c.height = nh;
  const ctx = c.getContext("2d");
  ctx.drawImage(img, 0, 0, nw, nh);
  return c.toDataURL("image/jpeg", 0.86);
}
async function setQuestionImage(i, file){
  if(i<0 || i>=QUESTIONS.length) return;
  if(!file || !/^image\//.test(file.type)) return toast("Ch·ªâ nh·∫≠n ·∫£nh");
  const raw = await readImageToDataURL(file);
  const scaled = await downscaleDataURL(raw);
  QUESTIONS[i].meta = QUESTIONS[i].meta || {};
  QUESTIONS[i].meta.image_data_url = scaled;
  renderQuestions();
  saveDraftSoon();
  toast("ƒê√£ g·∫Øn ·∫£nh cho c√¢u");
}

qImgPick.addEventListener("change", async ()=>{
  const f = qImgPick.files?.[0];
  if(!f) return;
  const i = IMG_PICK_FOR_INDEX;
  IMG_PICK_FOR_INDEX = -1;
  qImgPick.value = "";
  try{ await setQuestionImage(i, f); }catch(e){ toast("L·ªói ·∫£nh"); }
});

qList.addEventListener("dragover",(e)=>{
  const card = e.target.closest(".qCard");
  if(!card) return;
  const drop = e.target.closest("[data-imgdrop]");
  if(!drop) return;
  e.preventDefault();
},{passive:false});

qList.addEventListener("drop", async (e)=>{
  const card = e.target.closest(".qCard");
  const drop = e.target.closest("[data-imgdrop]");
  if(!card || !drop) return;
  e.preventDefault();
  const i = Number(card.getAttribute("data-i"));
  const f = e.dataTransfer?.files?.[0];
  if(!f) return;
  try{ await setQuestionImage(i, f); }catch{ toast("L·ªói ·∫£nh"); }
},{passive:false});

window.addEventListener("paste", async (e)=>{
  const items = e.clipboardData?.items || [];
  const imgItem = Array.from(items).find(it=>it.type && it.type.startsWith("image/"));
  if(!imgItem) return;
  const f = imgItem.getAsFile();
  if(!f) return;

  const active = document.activeElement;
  const card = active ? active.closest?.(".qCard") : null;
  if(!card) return;
  const i = Number(card.getAttribute("data-i"));
  try{ await setQuestionImage(i, f); }catch{ toast("L·ªói ·∫£nh"); }
},{passive:true});

/* ================== IMPORT PARSER ================== */
const importBox = document.getElementById("importBox");
document.getElementById("btnImportReplace").onclick = ()=>{
  const parsed = parseImportText(importBox.value);
  if(!parsed.length) return toast("Kh√¥ng parse ƒë∆∞·ª£c g√¨");
  QUESTIONS = parsed;
  renderQuestions();
  saveDraftSoon();
  setQBMode("manual");
  toast("ƒê√£ import (thay th·∫ø)");
};
document.getElementById("btnImportAppend").onclick = ()=>{
  const parsed = parseImportText(importBox.value);
  if(!parsed.length) return toast("Kh√¥ng parse ƒë∆∞·ª£c g√¨");
  QUESTIONS = QUESTIONS.concat(parsed);
  renderQuestions();
  saveDraftSoon();
  setQBMode("manual");
  toast("ƒê√£ import (th√™m)");
};

function isHeaderLine(line){
  const s = line.trim();
  return /^<(tn|tl|tln|tf)>\s*@\d+\s*:/.test(s);
}
function stripStars(s){
  let t = String(s||"").trim();
  if(t.startsWith("*") && t.endsWith("*") && t.length>=2){
    t = t.slice(1,-1).trim();
  }
  return t;
}
function parseImportText(text){
  const lines = String(text||"").replace(/\r/g,"").split("\n");
  const blocks = [];
  let cur = null;

  function pushCur(){
    if(!cur) return;
    blocks.push(cur);
    cur = null;
  }

  for(let i=0;i<lines.length;i++){
    const raw = lines[i];
    const line = raw.trimEnd();

    if(isHeaderLine(line)){
      pushCur();
      const m = line.trim().match(/^<(tn|tl|tln|tf)>\s*@(\d+)\s*:\s*(.*)$/);
      if(!m) continue;
      cur = { tag:m[1], n:Number(m[2]||0), head:(m[3]||"").trim(), body:[] };
      continue;
    }
    if(!cur) continue;
    cur.body.push(line);
  }
  pushCur();

  const out = [];
  for(const b of blocks){
    const tag = b.tag;
    const head = b.head || "";
    const body = (b.body||[]).map(x=>x.trim()).filter(x=>x.length>0);

    if(tag==="tn"){
      const opts = [];
      let correctIdx = 1;
      for(const ln of body){
        let isCorrect = false;
        let t = ln.trim();
        if(t.startsWith("*") && t.endsWith("*") && t.length>=2){
          isCorrect = true;
          t = stripStars(t);
        }
        opts.push(t);
        if(isCorrect) correctIdx = opts.length;
      }
      while(opts.length<4) opts.push("");
      const options4 = opts.slice(0,4);
      if(correctIdx<1 || correctIdx>4) correctIdx = 1;

      out.push({
        type:"mcq1",
        prompt: head,
        answers: [],
        points: null,
        meta: { options: options4, correct: correctIdx, image_data_url:"" }
      });
      continue;
    }

    if(tag==="tl"){
      let answers = body
        .filter(x=>x.includes("*") && x.trim().startsWith("*") && x.trim().endsWith("*"))
        .map(x=>stripStars(x));
      if(!answers.length){
        if(body.length) answers = [ body.join(" ").trim() ];
      }
      answers = answers.map(x=>x.trim()).filter(Boolean);
      out.push({
        type:"essay",
        prompt: head,
        answers,
        points: null,
        meta: { fuzzy:true, image_data_url:"" }
      });
      continue;
    }

    if(tag==="tln"){
      let answers = body
        .filter(x=>x.trim().startsWith("*") && x.trim().endsWith("*"))
        .map(x=>stripStars(x));
      if(!answers.length){
        if(body.length) answers = [ body.join(" ").trim() ];
      }
      answers = answers.map(x=>x.trim()).filter(Boolean);
      out.push({
        type:"short4",
        prompt: head,
        answers,
        points: null,
        meta: { format:"4boxes", image_data_url:"" }
      });
      continue;
    }

    if(tag==="tf"){
      const stmts = ["","","",""];
      const keys = [false,false,false,false];

      for(const ln of body){
        const s = ln.trim();
        const mm = s.match(/^\|?\s*([A-D])\s*:\s*(.*?)\s*\*([TF])\*\s*\|?\s*$/i);
        if(!mm) continue;
        const letter = mm[1].toUpperCase();
        const textPart = (mm[2]||"").trim();
        const tf = mm[3].toUpperCase();
        const idx = "ABCD".indexOf(letter);
        if(idx>=0){
          stmts[idx] = textPart;
          keys[idx] = (tf==="T");
        }
      }

      out.push({
        type:"tf4",
        prompt: head,
        answers: [],
        points: null,
        meta: {
          statements: stmts,
          keys,
          rule:{ byCorrectCount:{ "0":0, "1":0.25, "2":0.5, "3":0.5, "4":1 } },
          image_data_url:""
        }
      });
      continue;
    }
  }
  const last = out[out.length-1];
  if(last && isAllowedQType(last.type)) setLastType(last.type);
  return out;
}

/* ================== APPLY SCORING ================== */
function applyScoring(items){
  const mode = scoringModeEl.value;
  const total = Number(totalScoreEl.value || "10") || 10;
  if(!items.length) return items;

  if(mode === "equal"){
    const per = total / items.length;
    let sum = 0;
    return items.map((q,i)=>{
      const p = (i === items.length-1) ? (total - sum) : Math.round(per*100)/100;
      if(i !== items.length-1) sum += p;
      return { ...q, points: Math.round(p*100)/100 };
    });
  }
  return items.map(q=>({ ...q, points: (q.points==null?0:Number(q.points)||0) }));
}

/* ================== SAVE / PUBLISH ================== */
document.getElementById("btnNewQuiz").onclick = ()=>{
  CURRENT_QID = "";
  setMode("NEW");

  quizIdEl.value = "";
  titleEl.value = "";
  subEl.value = "";
  isPublicEl.value = "true";
  isHiddenEl.value = "false";
  showInStoreEl.value = "true";
  requireLoginEl.value = "true";
  pinnedEl.value = "false";
  requireCodeEl.value = "false";
  accessCodeEl.value = "";
  scoringModeEl.value = "equal";
  totalScoreEl.value = "10";

  QUESTIONS = [];
  renderQuestions();
  setDraftPill("DRAFT: ‚Äî");
  setLastType("mcq1");
  setQBMode("manual");
  toast("T·∫°o m·ªõi: OK");
};

document.getElementById("btnClearDraft").onclick = ()=>{
  clearDraft();
  toast("ƒê√£ x√≥a nh√°p");
};

async function saveQuizOnly(){
  const token = getToken();
  if(!token) throw new Error("Ch∆∞a login");

  let qid = (CURRENT_MODE==="EDIT") ? CURRENT_QID : normalizeQuizId(quizIdEl.value);
  if(CURRENT_MODE==="NEW" && !qid){
    qid = genQuizId5();
    quizIdEl.value = qid;
  }
  if(!qid || qid.length!==5) throw new Error("Quiz ID ph·∫£i ƒë√∫ng 5 ch·ªØ a-z");

  const payload = {
    p_token: token,
    p_quiz_id: qid,
    p_title: titleEl.value.trim(),
    p_sub: subEl.value.trim(),
    p_is_public: (isPublicEl.value === "true"),
    p_is_hidden: (isHiddenEl.value === "true"),
    p_show_in_store: (showInStoreEl.value === "true"),
    p_require_login: (requireLoginEl.value === "true"),
    p_pinned: (pinnedEl.value === "true"),
    p_require_access_code: (requireCodeEl.value === "true"),
    p_access_code: accessCodeEl.value.trim(),
    p_scoring_mode: scoringModeEl.value,
    p_total_score: Number(totalScoreEl.value || "10") || 10
  };

  const out = await rpc(RPC.adminUpsertQuiz, payload);

  CURRENT_QID = out.quiz_id || qid;
  quizIdEl.value = CURRENT_QID;
  setMode("EDIT");
  saveDraftNow();
  return CURRENT_QID;
}

document.getElementById("btnSaveQuiz").onclick = async ()=>{
  try{
    const err = validateQuiz();
    if(err) return toast(err);
    const qid = await saveQuizOnly();
    toast("Saved: " + qid);
    await reloadQuizzes();
  }catch(e){
    toast(e.message || "Save error");
  }
};

async function publishAll(){
  try{
    const err = validateQuiz();
    if(err) return toast(err);
    if(!QUESTIONS.length) return toast("Ch∆∞a c√≥ c√¢u h·ªèi");

    const qid = await saveQuizOnly();
    const token = getToken();

    const items = applyScoring(QUESTIONS).map((q, idx)=>({
      no: idx+1,
      q_type: q.type,
      prompt: (q.prompt||"").trim(),
      answers: Array.isArray(q.answers)?q.answers:[],
      points: q.points ?? 0,
      meta: q.meta || {}
    }));

    let out2 = null;
    try{
      out2 = await rpc(RPC.adminReplaceQuestions, { p_token: token, p_quiz_id: qid, p_items: items });
    }catch(e){
      out2 = await rpc(RPC.adminImportQuestions, { p_token: token, p_quiz_id: qid, p_items: items });
      toast("‚ö†Ô∏è DB ch∆∞a c√≥ replace (ƒë√£ import, coi ch·ª´ng tr√πng n·∫øu DB kh√¥ng clear).");
    }

    toast(`Published: ${qid}`);
    await reloadQuizzes();

    localStorage.removeItem(draftKeyFor(qid));
    setDraftPill("DRAFT: ‚Äî");
    location.href = `/q/${qid}`;
  }catch(e){
    toast(e.message || "Publish error");
  }
}

document.getElementById("btnPublishAll").onclick = publishAll;
document.getElementById("btnPublishAllBottom").onclick = publishAll;
document.getElementById("btnPublishAll2").onclick = publishAll;

/* ================== QUIZ LIST ================== */
const quizList = document.getElementById("quizList");

function renderQuizList(){
  if(!QUIZZES.length){
    quizList.innerHTML = `<div class="muted">Ch∆∞a c√≥ quiz.</div>`;
    return;
  }
  quizList.innerHTML = QUIZZES.map(q=>{
    const badges = [
      q.pinned ? `<span class="idx ok">PIN</span>` : "",
      q.is_hidden ? `<span class="idx warn">HIDDEN</span>` : "",
      q.is_public ? `<span class="idx ok">PUBLIC</span>` : `<span class="idx warn">PRIVATE</span>`,
      q.show_in_store ? `<span class="idx ok">STORE</span>` : `<span class="idx warn">STORE-OFF</span>`,
      q.require_login ? `<span class="idx">LOGIN</span>` : `<span class="idx ok">OPEN</span>`,
      q.require_access_code ? `<span class="idx warn">CODE</span>` : ""
    ].filter(Boolean).join(" ");

    return `
      <div class="qItem" data-qid="${esc(q.quiz_id)}">
        <div class="row1">
          <div style="min-width:0">
            <div class="vi" style="font-size:1rem"><b>${esc(q.title||q.quiz_id)}</b></div>
            <div class="muted" style="margin-top:4px">${esc(q.sub||"")}</div>
            <div class="qBadges">${badges}</div>
          </div>
          <div class="qActions">
            <button class="mini" data-act="load" type="button">S·ª≠a</button>
            <button class="mini danger" data-act="del" type="button">Delete</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  quizList.querySelectorAll('[data-qid]').forEach(el=>{
    el.addEventListener("click",(ev)=>{
      const act = ev.target?.getAttribute?.("data-act");
      const qid = el.getAttribute("data-qid");
      if(act==="del"){ ev.stopPropagation(); delQuiz(qid); return; }
      loadQuizToForm(qid);
    });
  });
}

async function reloadQuizzes(){
  const token = getToken();
  const out = await rpc(RPC.adminListQuizzes,{p_token: token});
  QUIZZES = out.items || [];
  renderQuizList();
}
document.getElementById("btnReloadQuizzes").onclick = ()=>reloadQuizzes().catch(e=>toast(e.message));

async function delQuiz(qid){
  const ok = confirm("X√≥a quiz " + qid + " ?");
  if(!ok) return;
  const token = getToken();
  await rpc(RPC.adminDeleteQuiz,{p_token:token, p_quiz_id:qid});
  toast("Deleted " + qid);
  await reloadQuizzes();
}

async function loadQuizToForm(qid){
  const q = QUIZZES.find(x=>x.quiz_id===qid);
  if(!q) return;

  CURRENT_QID = qid;
  setMode("EDIT");

  quizIdEl.value = q.quiz_id;
  titleEl.value = q.title || "";
  subEl.value = q.sub || "";
  isPublicEl.value = String(!!q.is_public);
  isHiddenEl.value = String(!!q.is_hidden);
  showInStoreEl.value = String(!!q.show_in_store);
  requireLoginEl.value = String(!!q.require_login);
  pinnedEl.value = String(!!q.pinned);
  requireCodeEl.value = String(!!q.require_access_code);
  accessCodeEl.value = "";
  scoringModeEl.value = q.scoring_mode || "equal";
  totalScoreEl.value = String(q.total_score ?? 10);

  const d = tryLoadDraft(qid);
  if(d && d.questions){
    const ok = confirm("Quiz n√†y c√≥ NH√ÅP tr√™n m√°y. Kh√¥i ph·ª•c nh√°p?");
    if(ok){
      titleEl.value = d.form?.title ?? titleEl.value;
      subEl.value = d.form?.sub ?? subEl.value;
      isPublicEl.value = d.form?.is_public ?? isPublicEl.value;
      isHiddenEl.value = d.form?.is_hidden ?? isHiddenEl.value;
      showInStoreEl.value = d.form?.show_in_store ?? showInStoreEl.value;
      requireLoginEl.value = d.form?.require_login ?? requireLoginEl.value;
      pinnedEl.value = d.form?.pinned ?? pinnedEl.value;
      requireCodeEl.value = d.form?.require_access_code ?? requireCodeEl.value;
      accessCodeEl.value = d.form?.access_code ?? accessCodeEl.value;
      scoringModeEl.value = d.form?.scoring_mode ?? scoringModeEl.value;
      totalScoreEl.value = d.form?.total_score ?? totalScoreEl.value;

      QUESTIONS = Array.isArray(d.questions) ? d.questions : [];
      renderQuestions();
      saveDraftSoon();

      const last = QUESTIONS[QUESTIONS.length-1];
      setLastType(last?.type || "mcq1");
      setQBMode(QB_MODE);
      toast("ƒê√£ kh√¥i ph·ª•c nh√°p");
      return;
    }
  }

  QUESTIONS = [];
  try{
    const token = getToken();
    const out = await rpc(RPC.adminGetQuestions,{p_token: token, p_quiz_id: qid});
    const items = out.items || [];
    QUESTIONS = items.map(x=>({
      type: x.q_type || x.type || "mcq1",
      prompt: x.prompt || "",
      answers: x.answers || [],
      points: x.points ?? null,
      meta: x.meta || {}
    }));
  }catch{}
  renderQuestions();
  saveDraftSoon();

  const last = QUESTIONS[QUESTIONS.length-1];
  setLastType(last?.type || "mcq1");
  setQBMode(QB_MODE);
  toast("Loaded " + qid);
}

/* ================== USERS ================== */
const userList = document.getElementById("userList");
const userSearch = document.getElementById("userSearch");

function renderUsers(){
  const q = (userSearch.value||"").trim().toLowerCase();
  const arr = q ? USERS.filter(u=>String(u.username||"").includes(q)) : USERS;

  if(!arr.length){
    userList.innerHTML = `<div class="muted">No users.</div>`;
    return;
  }

  userList.innerHTML = arr.map(u=>{
    const role = (String(u.role||"").toLowerCase()==="admin") ? `<span class="idx ok">ADMIN</span>` : `<span class="idx">USER</span>`;
    return `
      <div class="card" style="box-shadow:none;border-width:1px;margin:10px 0">
        <div class="row1">
          <div style="min-width:0">
            <div class="vi" style="font-size:1rem"><b>${esc(u.username)}</b> ${role}</div>
            <div class="muted" style="margin-top:6px">id: <code>${esc(u.id)}</code></div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn" data-act="rename" data-id="${esc(u.id)}" type="button">Rename</button>
            <button class="btn" data-act="reset" data-id="${esc(u.id)}" type="button">Reset PIN</button>
            <button class="btn btn-danger" data-act="del" data-id="${esc(u.id)}" type="button">Delete</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  userList.querySelectorAll("button[data-act]").forEach(b=>{
    b.onclick = async ()=>{
      const act = b.getAttribute("data-act");
      const id = b.getAttribute("data-id");
      if(act==="del") return delUser(id);
      if(act==="rename") return renameUser(id);
      if(act==="reset") return resetPin(id);
    };
  });
}

async function reloadUsers(){
  const token = getToken();
  const out = await rpc(RPC.adminListUsers,{p_token: token});
  USERS = out.items || [];
  renderUsers();
}
document.getElementById("btnReloadUsers").onclick = ()=>reloadUsers().catch(e=>toast(e.message));
userSearch.addEventListener("input", ()=>renderUsers(), {passive:true});

async function delUser(id){
  const ok = confirm("X√≥a user n√†y? (m·∫•t progress/attempts/comments)");
  if(!ok) return;
  const token = getToken();
  await rpc(RPC.adminDeleteUser,{p_token:token, p_user_id:id});
  toast("Deleted user");
  await reloadUsers();
}
async function renameUser(id){
  const newU = prompt("New username (lowercase, a-z0-9_):");
  if(!newU) return;
  const token = getToken();
  await rpc(RPC.adminForceRename,{p_token:token, p_user_id:id, p_new_username:newU});
  toast("Renamed");
  await reloadUsers();
}
async function resetPin(id){
  const pin = prompt("Set new PIN (6 digits, v√≠ d·ª• 072008).");
  if(!pin) return;
  const token = getToken();
  await rpc(RPC.adminForceSetPin,{p_token:token, p_user_id:id, p_new_pin:pin});
  toast("PIN reset");
  await reloadUsers();
}

/* ================== BOOT ================== */
async function boot(){
  const ok = await gateCheck();
  if(!ok) return;

  setQBMode(QB_MODE || "manual");
  setLastType(LAST_QTYPE || "mcq1");

  const d = tryLoadDraft("NEW");
  if(d){
    setMode("NEW");
    quizIdEl.value = d.form?.quiz_id ?? "";
    titleEl.value = d.form?.title ?? "";
    subEl.value = d.form?.sub ?? "";
    isPublicEl.value = d.form?.is_public ?? "true";
    isHiddenEl.value = d.form?.is_hidden ?? "false";
    showInStoreEl.value = d.form?.show_in_store ?? "true";
    requireLoginEl.value = d.form?.require_login ?? "true";
    pinnedEl.value = d.form?.pinned ?? "false";
    requireCodeEl.value = d.form?.require_access_code ?? "false";
    accessCodeEl.value = d.form?.access_code ?? "";
    scoringModeEl.value = d.form?.scoring_mode ?? "equal";
    totalScoreEl.value = d.form?.total_score ?? "10";

    QUESTIONS = Array.isArray(d.questions) ? d.questions : [];
    renderQuestions();
    setDraftPill("DRAFT: restored", "ok");

    const last = QUESTIONS[QUESTIONS.length-1];
    setLastType(last?.type || "mcq1");
  }else{
    setMode("NEW");
    isHiddenEl.value = "false";
    QUESTIONS = [];
    renderQuestions();
    setDraftPill("DRAFT: ‚Äî");
    setLastType("mcq1");
  }

  document.getElementById("btnPublishAll2").addEventListener("click", ()=>document.getElementById("btnPublishAll").click());
  await reloadQuizzes();
  await reloadUsers();
  setTab("q");
}

(async ()=>{ await boot(); })();
</script>
</body>
</html>
