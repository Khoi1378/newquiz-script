<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
  <title>ƒêƒÉng k√Ω ch·ªó ng·ªìi 12A11</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#ffecd2; --bg2:#fcb69f;
      --card:#fff; --text:#1f2937; --muted:#6b7280;
      --primary:#7c3aed;
      --border:#e5e7eb; --soft:#f8fafc;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --radius:18px;

      --c-free-bg1:rgba(34,197,94,.18);
      --c-free-bg2:rgba(34,197,94,.06);
      --c-free-br:rgba(34,197,94,.45);
      --c-free-glow:rgba(34,197,94,.08);

      --c-confirm-bg1:rgba(156,163,175,.28);
      --c-confirm-bg2:rgba(156,163,175,.12);
      --c-confirm-br:rgba(156,163,175,.65);

      --c-myhold-bg1:rgba(251,113,133,.30);
      --c-myhold-bg2:rgba(124,58,237,.10);
      --c-myhold-br:rgba(251,113,133,.70);
      --c-myhold-glow:rgba(251,113,133,.12);

      --c-otherhold-bg1:rgba(245,158,11,.26);
      --c-otherhold-bg2:rgba(245,158,11,.10);
      --c-otherhold-br:rgba(245,158,11,.70);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
                linear-gradient(120deg,var(--bg1) 0%,var(--bg2) 100%);
      overflow:hidden;
      touch-action:pan-y;
    }
    #shell{ height:100vh; overflow:auto; -webkit-overflow-scrolling:touch; padding:12px 0 160px; }
    .wrap{ max-width:980px; margin:0 auto; padding:0 14px; }

    .actionbar{
      position:sticky; top:10px; z-index:9999;
      display:flex; justify-content:flex-end; gap:10px; padding:0 14px;
    }
    .btn{
      border:0; cursor:pointer;
      border-radius:999px; padding:10px 14px;
      font-weight:900; font-size:.9rem;
      transition:transform .10s ease, filter .10s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none; white-space:nowrap;
      box-shadow:0 12px 24px rgba(0,0,0,.12);
      background:#fff; color:#111827; border:1px solid #e5e7eb;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:hover{ transform:translateY(-1px); filter:brightness(.98); }
    .btn:active{ transform:translateY(0px); }
    .btn-reset{ background:#111827; color:#fff; border:0; }
    .btn-primary{
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      color:#fff; border:0;
      box-shadow:0 12px 24px rgba(124,58,237,.18);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none !important; }

    .topbar{
      margin-top:10px;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(229,231,235,.9);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .titlebox{ display:flex; gap:10px; align-items:center; flex:1 1 360px; min-width:240px; }
    .logo{
      width:42px; height:42px; border-radius:16px;
      background:linear-gradient(135deg,#a78bfa,#fb7185);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:900;
      box-shadow:0 10px 22px rgba(124,58,237,.18);
      user-select:none;
    }
    .titles h1{ font-size:1.02rem; margin:0; font-weight:800; }
    .titles .tiny{ margin-top:3px; font-size:.86rem; color:var(--muted); font-weight:650; }

    .stats{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill{
      background:#f3f4f6; border:1px solid #e5e7eb;
      border-radius:999px; padding:8px 12px;
      font-weight:800; font-size:.9rem; color:#374151; white-space:nowrap;
    }
    .pill strong{ color:var(--primary); }
    .progressline{
      height:10px; border-radius:999px; background:#f3f4f6; overflow:hidden;
      border:1px solid #e5e7eb; width:100%; max-width:360px;
    }
    .progressfill{
      height:100%; width:0%;
      background:linear-gradient(90deg,#22c55e,#a78bfa);
      transition:width .18s ease;
    }

    .content{ padding:12px 0 0; }
    .card{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px; margin:12px 0;
    }
    .row1{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .vi{ margin:0; font-weight:900; font-size:1.04rem; line-height:1.25; }
    .meta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .idx{
      font-size:.78rem; font-weight:900;
      padding:6px 10px; border-radius:999px;
      background:#eff6ff; color:#1d4ed8; border:1px solid #dbeafe;
      white-space:nowrap;
    }
    .muted{ color:var(--muted); font-weight:650; }

    .input{
      width:100%;
      border-radius:14px; border:2px solid #e5e7eb;
      padding:11px 12px; font-size:.95rem; font-weight:700;
      outline:none; background:var(--soft);
      transition:border-color .12s ease, box-shadow .12s ease;
    }
    .input:focus{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 0 0 5px rgba(124,58,237,.10);
      background:#fff;
    }

    .submitbar{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:10002;
      padding:10px 14px 14px;
      background:linear-gradient(180deg,rgba(255,255,255,0),rgba(255,255,255,.92) 25%,rgba(255,255,255,.98));
      backdrop-filter:blur(6px);
    }
    .submitwrap{ max-width:980px; margin:0 auto; }
    .btn-big{
      width:100%;
      border-radius:18px;
      padding:14px 16px;
      font-size:1.05rem;
      font-weight:950;
      justify-content:center;
    }
    .subhint{
      margin-top:8px;
      text-align:center;
      color:var(--muted);
      font-weight:700;
      font-size:.86rem;
      line-height:1.35;
    }

    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:10001;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width:100%; max-width:520px;
      background:#fff;
      border-radius:18px;
      border:1px solid #e5e7eb;
      box-shadow:0 20px 60px rgba(0,0,0,.18);
      padding:14px;
      max-height:82vh;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .modal h3{ margin:4px 0 6px; font-size:1.02rem; }
    .modal p{ margin:0 0 12px; color:var(--muted); font-weight:650; font-size:.92rem; line-height:1.35; }
    .modal-actions{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .btn-ghost{ background:#fff; color:#111827; border:1px solid #e5e7eb; box-shadow:none; }

    .toast{
      position:fixed; left:50%; bottom:88px; transform:translateX(-50%);
      background:rgba(17,24,39,.92); color:#fff;
      padding:10px 12px; border-radius:14px;
      font-weight:800; font-size:.9rem;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width:calc(100% - 28px);
      z-index:10003;
      text-align:center;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

    .bus{
      border:2px solid rgba(17,24,39,.9);
      border-radius:18px;
      padding:12px;
      background:rgba(255,255,255,.72);
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    .busTop{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
      align-items:stretch;
    }
    .driver,.door{
      border-radius:16px;
      border:2px dashed rgba(229,231,235,.95);
      background:#fff;
      padding:10px 12px;
      font-weight:950;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .driver{ justify-content:flex-start; }
    .door{ justify-content:flex-end; }

    .seatHeader{
      display:grid;
      grid-template-columns:1fr 1fr .7fr 1fr 1fr .6fr;
      gap:10px;
      padding:0 2px 8px;
      align-items:center;
    }
    .sideLabel{
      font-weight:950;
      font-size:.82rem;
      color:#374151;
      text-transform:uppercase;
      letter-spacing:.06em;
      user-select:none;
    }
    .sideLabel.left{ grid-column:1 / span 2; }
    .sideLabel.right{ grid-column:4 / span 2; text-align:right; }
    .rowLabelTop{ grid-column:6; text-align:right; color:var(--muted); font-weight:900; font-size:.78rem; }

    .seatRow{
      display:grid;
      grid-template-columns:1fr 1fr .7fr 1fr 1fr .6fr;
      gap:10px;
      align-items:stretch;
      margin:8px 0;
    }
    .seatRow.five{ grid-template-columns:1fr 1fr 1fr 1fr 1fr .6fr; }

    .aisle{
      border-radius:14px;
      background:rgba(229,231,235,.45);
      border:1px solid rgba(229,231,235,.9);
    }
    .rowTag{
      display:flex; align-items:center; justify-content:flex-end;
      font-weight:950; color:#111827;
      user-select:none;
    }

    .seat{
      width:100%;
      border-radius:16px;
      border:2px solid rgba(229,231,235,.95);
      background:#fff;
      padding:10px 10px;
      cursor:pointer;
      text-align:left;
      display:grid;
      gap:2px;
      align-content:start;
      user-select:none;
      min-height:56px;
      transition:transform .06s ease, filter .06s ease, border-color .08s ease, background-color .08s ease;
      will-change:transform;
      -webkit-tap-highlight-color:transparent;
    }
    .seat:hover{ transform:translateY(-1px); }
    .seat:active{ transform:translateY(0px) scale(.995); }
    .seat .id{ font-weight:1000; letter-spacing:.01em; }
    .seat .sub{
      font-weight:850;
      font-size:.75rem;
      color:rgba(17,24,39,.72);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .free{
      background:linear-gradient(135deg,var(--c-free-bg1),var(--c-free-bg2));
      border-color:var(--c-free-br);
      box-shadow:0 0 0 5px var(--c-free-glow);
    }
    .confirmed{
      background:linear-gradient(135deg,var(--c-confirm-bg1),var(--c-confirm-bg2));
      border-color:var(--c-confirm-br);
      opacity:.92;
      cursor:not-allowed;
      box-shadow:none;
    }
    .myhold{
      background:linear-gradient(135deg,var(--c-myhold-bg1),var(--c-myhold-bg2));
      border-color:var(--c-myhold-br);
      box-shadow:0 0 0 6px var(--c-myhold-glow);
    }
    .otherhold{
      background:linear-gradient(135deg,var(--c-otherhold-bg1),var(--c-otherhold-bg2));
      border-color:var(--c-otherhold-br);
      cursor:not-allowed;
      box-shadow:none;
    }
    .seat[disabled]{ opacity:.95; transform:none !important; }

    .legendBar{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px dashed rgba(229,231,235,.95);
      background:#fff;
      font-weight:850;
      align-items:center;
    }
    .legendItem{ display:flex; gap:8px; align-items:center; white-space:nowrap; }
    .dot{
      width:14px; height:14px; border-radius:6px; border:1px solid rgba(0,0,0,.12);
      box-shadow:0 10px 22px rgba(0,0,0,.06);
      flex:0 0 auto;
    }
    .dot.free{ background:rgba(34,197,94,.75); }
    .dot.confirmed{ background:rgba(156,163,175,.70); }
    .dot.myhold{ background:rgba(251,113,133,.70); }
    .dot.otherhold{ background:rgba(245,158,11,.80); }

    @media (max-width:820px){
      .progressline{ max-width:100%; }
      .btn{ padding:9px 12px; font-size:.85rem; }
      .btn-big{ font-size:1.02rem; padding:14px 14px; }
      .seat{ min-height:54px; padding:10px 10px; }
      .seatRow,.seatHeader{ gap:8px; }
      .bus{ padding:10px; }
      .seat .sub{ font-size:.73rem; }
      .seatRow.five{ grid-template-columns:1fr 1fr 1fr 1fr 1fr .6fr; }
    }

    /* =========================
       Question Builder UI (ADD-ON)
       ========================= */

    .qb-card{
      position:relative;
      overflow:hidden;
    }
    .qb-card::before{
      content:"";
      position:absolute; inset:-2px;
      background:linear-gradient(135deg, rgba(124,58,237,.35), rgba(251,113,133,.25), rgba(34,197,94,.18));
      filter:blur(18px);
      opacity:.55;
      pointer-events:none;
    }
    .qb-card > *{ position:relative; }

    .qb-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding:6px 2px 12px;
      border-bottom:1px dashed rgba(229,231,235,.95);
    }
    .qb-title{
      font-weight:950;
      font-size:1.08rem;
      margin:0;
      line-height:1.15;
    }
    .qb-sub{
      margin-top:4px;
      color:var(--muted);
      font-weight:700;
      font-size:.88rem;
      line-height:1.35;
    }

    .qb-tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      background:rgba(243,244,246,.85);
      border:1px solid rgba(229,231,235,.95);
      padding:6px;
      border-radius:999px;
    }
    .qb-tab{
      border:0;
      background:transparent;
      cursor:pointer;
      border-radius:999px;
      padding:9px 12px;
      font-weight:950;
      font-size:.86rem;
      color:#111827;
      transition:transform .10s ease, filter .10s ease, background-color .10s ease;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      white-space:nowrap;
    }
    .qb-tab:hover{ transform:translateY(-1px); filter:brightness(.98); }
    .qb-tab:active{ transform:translateY(0px); }
    .qb-tab.is-active{
      background:#fff;
      border:1px solid rgba(229,231,235,.95);
      box-shadow:0 10px 24px rgba(0,0,0,.08);
    }

    .qb-body{ padding-top:12px; display:grid; gap:12px; }

    .qb-panel{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(229,231,235,.95);
      border-radius:16px;
      padding:12px;
      box-shadow:0 10px 26px rgba(0,0,0,.06);
    }

    .qb-grid{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:10px;
    }
    @media (max-width:820px){
      .qb-grid{ grid-template-columns:1fr; }
    }

    .qb-label{
      font-weight:950;
      font-size:.86rem;
      color:#111827;
      margin:0 0 6px;
    }
    .qb-help{
      margin-top:6px;
      color:var(--muted);
      font-weight:700;
      font-size:.82rem;
      line-height:1.35;
    }

    .qb-select{
      width:100%;
      border-radius:14px;
      border:2px solid #e5e7eb;
      padding:11px 12px;
      font-size:.92rem;
      font-weight:850;
      outline:none;
      background:var(--soft);
      transition:border-color .12s ease, box-shadow .12s ease;
    }
    .qb-select:focus{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 0 0 5px rgba(124,58,237,.10);
      background:#fff;
    }

    .qb-optlist{ display:grid; gap:8px; margin-top:10px; }
    .qb-opt{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:10px;
      align-items:center;
      background:rgba(248,250,252,.9);
      border:1px solid rgba(229,231,235,.95);
      border-radius:14px;
      padding:10px;
    }
    .qb-radio{
      width:18px; height:18px;
      accent-color:var(--primary);
      cursor:pointer;
    }
    .qb-mini{
      border:0;
      background:#fff;
      border:1px solid rgba(229,231,235,.95);
      border-radius:12px;
      padding:9px 10px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 10px 20px rgba(0,0,0,.06);
      -webkit-tap-highlight-color:transparent;
      transition:transform .10s ease, filter .10s ease;
    }
    .qb-mini:hover{ transform:translateY(-1px); filter:brightness(.98); }
    .qb-mini:active{ transform:translateY(0px); }

    .qb-divider{
      height:1px;
      background:rgba(229,231,235,.95);
      margin:12px 0;
    }

    .qb-list{
      display:grid;
      gap:10px;
    }
    .qb-item{
      border:1px solid rgba(229,231,235,.95);
      border-radius:16px;
      padding:12px;
      background:#fff;
      box-shadow:0 10px 22px rgba(0,0,0,.05);
    }
    .qb-itemTop{
      display:flex; gap:10px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap;
    }
    .qb-badge{
      font-size:.78rem;
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      background:linear-gradient(135deg, rgba(124,58,237,.14), rgba(251,113,133,.10));
      border:1px solid rgba(124,58,237,.25);
      white-space:nowrap;
    }
    .qb-itemTitle{
      font-weight:950;
      margin:0;
      line-height:1.25;
    }
    .qb-itemMeta{
      margin-top:6px;
      color:var(--muted);
      font-weight:750;
      font-size:.86rem;
      line-height:1.35;
    }

    /* N√∫t Th√™m c√¢u b√°m theo ng∆∞·ªùi t·∫°o c√¢u */
    .qb-fab{
      position:fixed;
      left:0; right:0;
      bottom:calc(env(safe-area-inset-bottom) + 14px);
      z-index:10001; /* d∆∞·ªõi submitbar (10002) ƒë·ªÉ kh√¥ng ƒë√® n√∫t x√°c nh·∫≠n gh·∫ø */
      padding:0 14px;
      pointer-events:none;
    }
    .qb-fabInner{
      max-width:980px;
      margin:0 auto;
      pointer-events:auto;
    }
    .qb-addBtn{
      width:100%;
      border-radius:20px !important;
      padding:14px 16px !important;
      font-size:1.06rem !important;
      font-weight:1000 !important;
      letter-spacing:.02em;
      box-shadow:0 16px 40px rgba(124,58,237,.22) !important;
      justify-content:center;
    }
    .qb-fabHint{
      margin-top:8px;
      text-align:center;
      color:var(--muted);
      font-weight:750;
      font-size:.84rem;
      line-height:1.35;
    }
    .qb-fab.is-hidden{ display:none; }
  </style>
</head>

<body>
  <div id="shell">
    <div class="actionbar">
      <button class="btn" id="btnScrollTop">‚¨ÜÔ∏è L√™n ƒë·∫ßu</button>
      <button class="btn btn-reset" id="btnRename">‚úèÔ∏è ƒê·ªïi t√™n</button>
    </div>

    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">üöå</div>
          <div class="titles">
            <h1 id="appTitle">ƒêƒÉng k√Ω ch·ªó ng·ªìi 12A11</h1>
            <div class="tiny" id="appSub">Xe kh√°ch 29 ch·ªó ‚Ä¢ Live realtime</div>
          </div>
        </div>

        <div class="stats">
          <div class="pill">T√™n: <strong id="whoName">‚Äî</strong></div>
          <div class="pill">Ch·ªó b·∫°n: <strong id="mySeat">‚Äî</strong></div>
          <div class="pill">ƒê√£ ƒë·∫∑t: <strong id="confirmedCount">0</strong>/29</div>
          <div class="progressline"><div class="progressfill" id="progressFill"></div></div>
        </div>
      </div>

      <div class="content" id="content"></div>

      <!-- =========================
           Question Builder UI
           (Import vs Manual lo·∫°i tr·ª´ nhau)
           ========================= -->
      <div class="card qb-card" id="qbRoot" style="margin-top:12px;">
        <div class="qb-head">
          <div style="flex:1 1 360px; min-width:260px;">
            <p class="qb-title" style="margin:0;">üéØ Th√™m c√¢u h·ªèi</p>
            <div class="qb-sub">M·∫∑c ƒë·ªãnh: Tr·∫Øc nghi·ªám 1 ƒë√°p √°n ‚Ä¢ H·ªá th·ªëng s·∫Ω nh·ªõ lo·∫°i c√¢u b·∫°n v·ª´a ch·ªçn cho c√¢u k·∫ø ti·∫øp.</div>
          </div>

          <div class="qb-tabs" role="tablist" aria-label="Ch·ªçn c√°ch th√™m c√¢u h·ªèi">
            <button class="qb-tab is-active" type="button" data-qb-mode="manual">üìù Th√™m th·ªß c√¥ng</button>
            <button class="qb-tab" type="button" data-qb-mode="import">üì• Import HTML</button>
          </div>
        </div>

        <div class="qb-body">
          <!-- MANUAL -->
          <section class="qb-panel" id="qbPanelManual">
            <div class="qb-grid">
              <div>
                <div class="qb-label">N·ªôi dung c√¢u h·ªèi</div>
                <input class="input" id="qbQuestionText" placeholder="Nh·∫≠p c√¢u h·ªèi..." maxlength="220" />
                <div class="qb-help">Tip: Vi·∫øt ng·∫Øn g·ªçn, r√µ √Ω. C√≥ th·ªÉ th√™m (A, B, C, D) trong ƒë√°p √°n n·∫øu c·∫ßn.</div>
              </div>

              <div>
                <div class="qb-label">Lo·∫°i c√¢u h·ªèi</div>
                <select class="qb-select" id="qbType">
                  <option value="mcq1">Tr·∫Øc nghi·ªám (1 ƒë√°p √°n)</option>
                  <option value="essay">T·ª± lu·∫≠n</option>
                  <option value="tf">ƒê√∫ng / Sai</option>
                </select>
                <div class="qb-help">B·∫°n ch·ªçn lo·∫°i n√†o th√¨ c√¢u k·∫ø ti·∫øp s·∫Ω m·∫∑c ƒë·ªãnh lo·∫°i ƒë√≥.</div>
              </div>
            </div>

            <!-- MCQ 1 -->
            <div id="qbMcqBox" style="margin-top:12px;">
              <div class="qb-label">ƒê√°p √°n (ch·ªçn 1 ƒë√°p √°n ƒë√∫ng)</div>
              <div class="qb-optlist" id="qbOptList"></div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                <button class="qb-mini" type="button" id="qbAddOpt">‚ûï Th√™m ƒë√°p √°n</button>
                <button class="qb-mini" type="button" id="qbResetOpt">‚Ü©Ô∏è Reset 4 ƒë√°p √°n</button>
              </div>
            </div>

            <!-- ESSAY -->
            <div id="qbEssayBox" style="margin-top:12px; display:none;">
              <div class="qb-label">G·ª£i √Ω / ƒë√°p √°n tham kh·∫£o (tu·ª≥ ch·ªçn)</div>
              <textarea class="input" id="qbEssayHint" rows="4" placeholder="Nh·∫≠p g·ª£i √Ω ch·∫•m / ƒë√°p √°n m·∫´u..."></textarea>
            </div>

            <!-- TRUE/FALSE -->
            <div id="qbTfBox" style="margin-top:12px; display:none;">
              <div class="qb-label">Ch·ªçn ƒë√°p √°n ƒë√∫ng</div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" type="button" id="qbTfTrue">‚úÖ ƒê√∫ng</button>
                <button class="btn" type="button" id="qbTfFalse">‚ùå Sai</button>
              </div>
              <div class="qb-help" id="qbTfPicked">Ch∆∞a ch·ªçn</div>
            </div>

            <div class="qb-divider"></div>

            <div class="qb-label">Danh s√°ch c√¢u ƒë√£ th√™m</div>
            <div class="qb-list" id="qbList"></div>
          </section>

          <!-- IMPORT -->
          <section class="qb-panel" id="qbPanelImport" hidden>
            <div class="qb-label">Import HTML</div>
            <div class="muted" style="font-weight:750; line-height:1.45; margin-bottom:10px;">
              D√°n HTML v√†o ƒë√¢y. Khi b·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô Import th√¨ h·ªá th·ªëng s·∫Ω <b>·∫©n</b> ph·∫ßn th√™m th·ªß c√¥ng ƒë·ªÉ tr√°nh nh·∫ßm l·∫´n.
            </div>
            <textarea class="input" id="qbImportHtml" rows="10" placeholder="D√°n HTML c√¢u h·ªèi..."></textarea>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; justify-content:flex-end;">
              <button class="btn btn-primary" type="button" id="qbDoImport">‚úÖ Import</button>
            </div>

            <div class="qb-help">N·∫øu mu·ªën quay l·∫°i th√™m th·ªß c√¥ng, b·∫•m tab ‚ÄúTh√™m th·ªß c√¥ng‚Äù.</div>
          </section>
        </div>
      </div>
      <!-- /Question Builder -->
    </div>
  </div>

  <div class="submitbar" id="submitBar" style="display:none;">
    <div class="submitwrap">
      <button class="btn btn-primary btn-big" id="btnConfirm">
        <span id="btnConfirmLabel">‚úÖ X√ÅC NH·∫¨N CH·ªñ</span>
      </button>
      <div class="subhint" id="submitHint">B·∫•m gh·∫ø ƒë·ªÉ ch·ªçn ‚Ä¢ B·∫•m ‚ÄúX√°c nh·∫≠n ch·ªó‚Äù ƒë·ªÉ ch·ªët</div>
    </div>
  </div>

  <!-- FAB: N√∫t Th√™m c√¢u b√°m theo ng∆∞·ªùi t·∫°o -->
  <div class="qb-fab" id="qbFab">
    <div class="qb-fabInner">
      <button class="btn btn-primary qb-addBtn" type="button" id="qbAddQuestionBtn">‚ûï TH√äM C√ÇU</button>
      <div class="qb-fabHint" id="qbFabHint">Nh·∫≠p c√¢u h·ªèi ‚Üí ch·ªçn lo·∫°i ‚Üí b·∫•m ‚ÄúTH√äM C√ÇU‚Äù</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal-backdrop" id="nameBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="nameTitle">
      <h3 id="nameTitle">Nh·∫≠p T√äN ƒë·ªÉ ƒëƒÉng nh·∫≠p</h3>
      <p>T√™n l√† <b>b·∫Øt bu·ªôc</b>. Nh·∫≠p t√™n th·∫≠t ho·∫∑c bi·ªát danh m√† ai c≈©ng bi·∫øt nha.</p>
      <div style="display:grid; gap:10px; margin-top:10px;">
        <input id="nameInput" class="input" placeholder="VD: Kh√¥i" autocomplete="name" maxlength="24" />
        <div class="modal-actions">
          <button class="btn btn-primary" id="btnSaveName">‚úÖ Xong</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="renameBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="renameTitle">
      <h3 id="renameTitle">ƒê·ªïi t√™n ƒëƒÉng nh·∫≠p?</h3>
      <p>T√™n m·ªõi s·∫Ω c·∫≠p nh·∫≠t l√™n gh·∫ø b·∫°n ƒëang gi·ªØ / ƒë√£ x√°c nh·∫≠n.</p>
      <div style="display:grid; gap:10px; margin-top:10px;">
        <input id="renameInput" class="input" placeholder="Nh·∫≠p t√™n m·ªõi..." maxlength="24" />
        <div class="modal-actions">
          <button class="btn btn-ghost" id="btnRenameCancel">H·ªßy</button>
          <button class="btn btn-primary" id="btnRenameOk">‚úÖ ƒê·ªïi t√™n</button>
        </div>
      </div>
    </div>
  </div>

<script>
const GAS_EXEC_URL="https://script.google.com/macros/s/AKfycbz1cw-l4lJaO5F-NzQqlehJ1v8PGXaw4nK0yMe-F90Z5b2EMnBdmI-UMG67LYbzGijLyg/exec";
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));

function escapeHtml(s){
  return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}
function randId(prefix="id"){ return prefix+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }
function normalizeName(s){ return String(s||"").trim().replace(/\s+/g," "); }
function shortNameForSeat(full){
  const parts=normalizeName(full).split(" ").filter(Boolean);
  if(!parts.length) return "";
  if(parts.length===1) return parts[0];
  const first=parts[0], last=parts[parts.length-1];
  const ch=first[0]?first[0].toUpperCase():"";
  return (ch?(ch+" "+last):last);
}
function preventZoom(){
  window.addEventListener("keydown",(e)=>{
    if(e.ctrlKey||e.metaKey){
      const k=e.key;
      if(k==="+"||k==="-"||k==="="||k==="_"||k==="0") e.preventDefault();
    }
  },{passive:false});
  window.addEventListener("wheel",(e)=>{ if(e.ctrlKey||e.metaKey) e.preventDefault(); },{passive:false});
}

function buildUrl(params){
  const u=new URL(GAS_EXEC_URL);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  u.searchParams.set("_",Date.now().toString(16));
  return u.toString();
}
function jsonp(params,timeoutMs=12000){
  return new Promise((resolve,reject)=>{
    const cb="__cb_"+Math.random().toString(16).slice(2);
    const url=buildUrl(Object.assign({},params,{callback:cb}));
    const s=document.createElement("script");
    let done=false;
    const timer=setTimeout(()=>{
      if(done) return;
      done=true;
      try{ delete window[cb]; }catch(e){}
      try{ s.remove(); }catch(e){}
      reject(new Error("JSONP timeout"));
    },timeoutMs);
    window[cb]=(data)=>{
      if(done) return;
      done=true;
      clearTimeout(timer);
      try{ delete window[cb]; }catch(e){}
      try{ s.remove(); }catch(e){}
      resolve(data);
    };
    s.onerror=()=>{
      if(done) return;
      done=true;
      clearTimeout(timer);
      try{ delete window[cb]; }catch(e){}
      try{ s.remove(); }catch(e){}
      reject(new Error("JSONP network error"));
    };
    s.src=url;
    document.head.appendChild(s);
  });
}
async function api(params){
  const url=buildUrl(Object.assign({},params,{fmt:"json"}));
  try{
    const r=await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const txt=await r.text();
    try{ return JSON.parse(txt); }
    catch(e){ throw new Error("Not JSON"); }
  }catch(e){
    return await jsonp(params);
  }
}

const LS_PREFIX="seat_12A11_v5::";
const LS_NAME=LS_PREFIX+"name";
const LS_CLIENT=LS_PREFIX+"client";
const LS_TS=LS_PREFIX+"ts";
const MAX_AGE_MS=30*24*3600*1000;

const me={name:"",client:""};
function loadLocal(){
  let ts=0;
  try{ ts=Number(localStorage.getItem(LS_TS)||0); }catch(e){}
  if(ts&&(Date.now()-ts<=MAX_AGE_MS)){
    try{ me.name=String(localStorage.getItem(LS_NAME)||""); }catch(e){}
    try{ me.client=String(localStorage.getItem(LS_CLIENT)||""); }catch(e){}
  }else{
    try{ localStorage.removeItem(LS_NAME); localStorage.removeItem(LS_CLIENT); localStorage.removeItem(LS_TS); }catch(e){}
    me.name=""; me.client="";
  }
  if(!me.client) me.client=randId("c");
}
function saveLocal(){
  try{
    localStorage.setItem(LS_NAME,me.name);
    localStorage.setItem(LS_CLIENT,me.client);
    localStorage.setItem(LS_TS,String(Date.now()));
  }catch(e){}
}

const FIXED_SEATS=new Map([
  ["A1","HDV"],
  ["A2","HDV"],
  ["F3","B Long"],
  ["F4","B Long"],
]);

const ROWS_LAYOUT=[
  {label:"A",type:"std"},
  {label:"B",type:"std"},
  {label:"C",type:"std"},
  {label:"D",type:"std"},
  {label:"E",type:"std"},
  {label:"F",type:"std"},
  {label:"G",type:"std"},
  {label:"H",type:"five"},
];

const SEATS=(()=>{
  const out=[];
  for(const row of ROWS_LAYOUT){
    if(row.type==="std"){ for(let i=1;i<=4;i++) out.push(row.label+i); }
    else if(row.type==="five"){ for(let i=1;i<=5;i++) out.push(row.label+i); }
  }
  return out;
})();
const TOTAL_SEATS=SEATS.length;

let snapshot=null;
let seatIndex=new Map();
let pollTimer=null;

const content=document.getElementById("content");
const submitBar=document.getElementById("submitBar");
const btnConfirm=document.getElementById("btnConfirm");
const btnConfirmLabel=document.getElementById("btnConfirmLabel");
const submitHint=document.getElementById("submitHint");

const seatDom=new Map();
let appRendered=false;

let localHoldSeat="";
let localHoldTs=0;

let inflight={hold:false,confirm:false};
let confirmQueued=false;
let confirmQueuedSeat="";

let confirmUiState="ready";
function setConfirmUiState(state){
  confirmUiState=state;
  if(state==="loading") btnConfirmLabel.textContent="‚è≥ ƒêANG X√ÅC NH·∫¨N...";
  else if(state==="done") btnConfirmLabel.textContent="‚úÖ ƒê√É X√ÅC NH·∫¨N";
  else btnConfirmLabel.textContent="‚úÖ X√ÅC NH·∫¨N CH·ªñ";
}
function showSubmitBar(show){ submitBar.style.display=show?"":"none"; }

function mySeatNow(){
  const my=snapshot&&snapshot.my?snapshot.my:{confirmed:"",hold:""};
  return (my.confirmed||my.hold||localHoldSeat||"");
}

function seatIsBlocked(id){ return FIXED_SEATS.has(String(id||"").toUpperCase()); }

function calcConfirmedCount(){
  let c=0;
  for(const id of SEATS){
    if(seatIsBlocked(id)){ c++; continue; }
    const s=seatIndex.get(id);
    if(s&&String(s.confirmedBy||"")) c++;
  }
  return c;
}

function updateTopbar(){
  document.getElementById("whoName").textContent=me.name?me.name:"‚Äî";
  const mySeat=mySeatNow();
  document.getElementById("mySeat").textContent=mySeat?mySeat:"‚Äî";

  const cc=snapshot?calcConfirmedCount():0;
  document.getElementById("confirmedCount").textContent=String(cc);

  const pct=TOTAL_SEATS?Math.round((cc/TOTAL_SEATS)*100):0;
  document.getElementById("progressFill").style.width=pct+"%";
}

function setLoadingView(){
  showSubmitBar(false);
  content.innerHTML=`
    <div class="card">
      <div class="row1">
        <p class="vi">ƒêang t·∫£i s∆° ƒë·ªì gh·∫ø‚Ä¶</p>
        <div class="meta"><span class="idx">LOADING</span></div>
      </div>
      <div class="muted" style="margin-top:10px">Vui l√≤ng ch·ªù‚Ä¶</div>
    </div>
  `;
}

function showExecErrorView(title,detail,extra=""){
  showSubmitBar(false);
  content.innerHTML=`
    <div class="card">
      <div class="row1">
        <p class="vi">${escapeHtml(title)}</p>
        <div class="meta"><span class="idx">L·ªñI</span></div>
      </div>
      <div class="muted" style="margin-top:10px; line-height:1.45">
        ${escapeHtml(detail||"Kh√¥ng r√µ nguy√™n nh√¢n")}
        ${extra?`<div style="margin-top:8px"><b>Chi ti·∫øt:</b> ${escapeHtml(extra)}</div>`:""}
      </div>
    </div>
  `;
}

function classifySeat(seatObj){
  const now=snapshot?Number(snapshot.ts||Date.now()):Date.now();
  const id=String(seatObj.id||"").toUpperCase();

  if(seatIsBlocked(id)){
    return {cls:"confirmed",disabled:true,sub:FIXED_SEATS.get(id)||""};
  }

  const confirmedBy=String(seatObj.confirmedBy||"");
  const confirmedName=String(seatObj.confirmedName||"");
  const holdBy=String(seatObj.holdBy||"");
  const holdName=String(seatObj.holdName||"");
  const holdAt=seatObj.holdAt?Number(seatObj.holdAt):0;

  if(confirmedBy){
    const nm=confirmedName?shortNameForSeat(confirmedName):"ƒê√£ ƒë·∫∑t";
    return {cls:"confirmed",disabled:true,sub:nm};
  }

  if(localHoldSeat){
    if(id===localHoldSeat) return {cls:"myhold",disabled:false,sub:"B·∫°n ƒëang ch·ªçn"};
    if(holdBy===me.client&&holdAt&&(now-holdAt<=60*1000+5000)) return {cls:"free",disabled:false,sub:""};
  }

  if(holdBy&&holdAt&&(now-holdAt<=60*1000+5000)){
    if(holdBy===me.client) return {cls:"myhold",disabled:false,sub:"B·∫°n ƒëang ch·ªçn"};
    return {cls:"otherhold",disabled:true,sub:holdName?shortNameForSeat(holdName):"ƒêang ch·ªçn"};
  }

  return {cls:"free",disabled:false,sub:""};
}

function seatButtonHTML_(id){
  const seatObj=seatIndex.get(id)||{id};
  const st=classifySeat(seatObj);
  const disabled=st.disabled||!me.name;
  return `
    <button class="seat ${st.cls}" data-seat="${id}" ${disabled?"disabled":""}>
      <div class="id">${escapeHtml(id)}</div>
      <div class="sub">${escapeHtml(st.sub||"")}</div>
    </button>
  `;
}

function renderMainViewOnce(){
  updateTopbar();
  showSubmitBar(!!me.name);

  content.innerHTML=`
    <div class="card">
      <div class="row1">
        <p class="vi">S∆° ƒë·ªì gh·∫ø (${TOTAL_SEATS} ch·ªó)</p>
        <div class="meta"><span class="idx">LIVE</span></div>
      </div>

      <div class="legendBar" style="margin-top:10px">
        <div class="legendItem"><span class="dot free"></span> Ch·ªó tr·ªëng</div>
        <div class="legendItem"><span class="dot myhold"></span> B·∫°n ƒëang ch·ªçn</div>
        <div class="legendItem"><span class="dot otherhold"></span> Ng∆∞·ªùi kh√°c ƒëang ch·ªçn</div>
        <div class="legendItem"><span class="dot confirmed"></span> ƒê√£ x√°c nh·∫≠n</div>
      </div>

      <div style="margin-top:12px" class="bus" id="busMap"></div>
    </div>
  `;

  const bus=document.getElementById("busMap");
  const html=[];

  html.push(`
    <div class="busTop">
      <div class="driver">üë®‚Äç‚úàÔ∏è T√ÄI X·∫æ</div>
      <div class="door">C·ª¨Aüö™</div>
    </div>
    <div class="seatHeader">
      <div class="sideLabel left">TR√ÅI (1‚Äì2)</div>
      <div class="sideLabel right">PH·∫¢I (3‚Äì4)</div>
      <div class="rowLabelTop">H√ÄNG</div>
    </div>
  `);

  for(const row of ROWS_LAYOUT){
    const r=row.label;
    if(row.type==="std"){
      const ids=[r+"1",r+"2",r+"3",r+"4"];
      html.push(`<div class="seatRow">`);
      html.push(seatButtonHTML_(ids[0]));
      html.push(seatButtonHTML_(ids[1]));
      html.push(`<div class="aisle" aria-hidden="true"></div>`);
      html.push(seatButtonHTML_(ids[2]));
      html.push(seatButtonHTML_(ids[3]));
      html.push(`<div class="rowTag">${escapeHtml(r)}</div>`);
      html.push(`</div>`);
    }else if(row.type==="five"){
      const ids=[r+"1",r+"2",r+"3",r+"4",r+"5"];
      html.push(`<div class="seatRow five">`);
      html.push(seatButtonHTML_(ids[0]));
      html.push(seatButtonHTML_(ids[1]));
      html.push(seatButtonHTML_(ids[2]));
      html.push(seatButtonHTML_(ids[3]));
      html.push(seatButtonHTML_(ids[4]));
      html.push(`<div class="rowTag">${escapeHtml(r)}</div>`);
      html.push(`</div>`);
    }
  }

  bus.innerHTML=html.join("");

  seatDom.clear();
  bus.querySelectorAll(".seat").forEach(btn=>{
    const id=btn.getAttribute("data-seat");
    seatDom.set(id,{btn,subEl:btn.querySelector(".sub")});
  });

  bus.addEventListener("click",onSeatClick,{passive:true});
  appRendered=true;
  patchAllSeats();
}

function updateSubmitHint(){
  const my=snapshot&&snapshot.my?snapshot.my:{confirmed:"",hold:""};
  const confirmed=String(my.confirmed||"");
  const hold=String(my.hold||localHoldSeat||"");

  if(confirmUiState==="loading"){ submitHint.textContent="ƒêang x√°c nh·∫≠n‚Ä¶ vui l√≤ng ch·ªù"; return; }
  if(confirmed&&(!hold||hold===confirmed)) submitHint.textContent="ƒê√£ x√°c nh·∫≠n. Mu·ªën ƒë·ªïi ch·ªó: ch·ªçn gh·∫ø kh√°c r·ªìi b·∫•m x√°c nh·∫≠n.";
  else submitHint.textContent="B·∫•m gh·∫ø ƒë·ªÉ ch·ªçn ‚Ä¢ B·∫•m ‚ÄúX√°c nh·∫≠n ch·ªó‚Äù";
}

function patchConfirmBar(){
  const my=snapshot&&snapshot.my?snapshot.my:{confirmed:"",hold:""};
  const confirmed=String(my.confirmed||"");
  const hold=String(my.hold||localHoldSeat||"");

  const changing=!!(confirmed&&hold&&hold!==confirmed);
  const canPress=!!(me.name&&hold&&(changing||!confirmed));

  showSubmitBar(!!me.name);

  if(inflight.confirm||confirmQueued){
    setConfirmUiState("loading");
    btnConfirm.disabled=true;
    updateSubmitHint();
    return;
  }

  if(confirmed&&!changing){
    setConfirmUiState("done");
    btnConfirm.disabled=true;
    updateSubmitHint();
    return;
  }

  setConfirmUiState("ready");
  btnConfirm.disabled=!canPress;
  updateSubmitHint();
}

function patchSeat(id){
  const dom=seatDom.get(id);
  if(!dom) return;

  const seatObj=seatIndex.get(id)||{id};
  const st=classifySeat(seatObj);
  const disabled=st.disabled||!me.name;

  const btn=dom.btn, subEl=dom.subEl;

  if(!btn.classList.contains(st.cls)||btn._lastCls!==st.cls){
    btn.classList.remove("free","confirmed","myhold","otherhold");
    btn.classList.add(st.cls);
    btn._lastCls=st.cls;
  }
  if(!!btn.disabled!==!!disabled) btn.disabled=!!disabled;

  const subText=st.sub||"";
  if(subEl&&subEl.textContent!==subText) subEl.textContent=subText;
}

function patchAllSeats(){
  for(const id of SEATS) patchSeat(id);
  patchConfirmBar();
  updateTopbar();
}

const nameBackdrop=document.getElementById("nameBackdrop");
const nameInput=document.getElementById("nameInput");
const btnSaveName=document.getElementById("btnSaveName");

function openNameModal(prefill=""){
  nameInput.value=prefill||"";
  nameBackdrop.classList.add("show");
  nameBackdrop.setAttribute("aria-hidden","false");
  setTimeout(()=>nameInput.focus(),50);
}
function closeNameModal(){
  nameBackdrop.classList.remove("show");
  nameBackdrop.setAttribute("aria-hidden","true");
}

btnSaveName.addEventListener("click",async()=>{
  let nm=normalizeName(nameInput.value);
  if(!nm){ toast("B·∫°n ch∆∞a nh·∫≠p t√™n"); return; }
  if(nm.length>24) nm=nm.slice(0,24).trim();

  me.name=nm;
  saveLocal();
  closeNameModal();

  try{
    const res=await api({action:"login",name:me.name,client:me.client,ua:navigator.userAgent||""});
    if(res&&res.ok) applySnapshot(res.data);
    else toast("Login l·ªói: "+(res?.code||"UNKNOWN"));
  }catch(e){
    toast("Login l·ªói: "+(e?.message||e));
  }

  if(!appRendered) renderMainViewOnce();
  else patchAllSeats();
});

nameInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); btnSaveName.click(); } });

const renameBackdrop=document.getElementById("renameBackdrop");
const renameInput=document.getElementById("renameInput");
const btnRenameCancel=document.getElementById("btnRenameCancel");
const btnRenameOk=document.getElementById("btnRenameOk");

function openRenameModal(){
  renameInput.value=me.name||"";
  renameBackdrop.classList.add("show");
  renameBackdrop.setAttribute("aria-hidden","false");
  setTimeout(()=>renameInput.focus(),50);
}
function closeRenameModal(){
  renameBackdrop.classList.remove("show");
  renameBackdrop.setAttribute("aria-hidden","true");
}

btnRenameCancel.addEventListener("click",closeRenameModal);
renameBackdrop.addEventListener("click",(e)=>{ if(e.target===renameBackdrop) closeRenameModal(); });

btnRenameOk.addEventListener("click",async()=>{
  let nm=normalizeName(renameInput.value);
  if(!nm){ toast("B·∫°n ch∆∞a nh·∫≠p t√™n"); return; }
  if(nm.length>24) nm=nm.slice(0,24).trim();

  me.name=nm;
  saveLocal();
  closeRenameModal();

  try{
    const res=await api({action:"setName",name:me.name,client:me.client,ua:navigator.userAgent||""});
    if(res&&res.ok) applySnapshot(res.data);
    else toast("ƒê·ªïi t√™n l·ªói: "+(res?.code||"UNKNOWN"));
  }catch(e){
    toast("ƒê·ªïi t√™n l·ªói: "+(e?.message||e));
  }

  patchAllSeats();
});

renameInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); btnRenameOk.click(); } });

function applySnapshot(data){
  snapshot=data;
  seatIndex=new Map();
  (snapshot.seats||[]).forEach(s=>seatIndex.set(String(s.id||"").toUpperCase(),s));

  const my=snapshot&&snapshot.my?snapshot.my:null;
  const srvHold=String(my?.hold||"");
  const srvConf=String(my?.confirmed||"");

  if(localHoldSeat){
    if((srvHold&&srvHold===localHoldSeat)||(srvConf&&srvConf===localHoldSeat)){
      localHoldSeat=""; localHoldTs=0;
    }else if(localHoldTs&&(Date.now()-localHoldTs>6500)&&(srvHold||srvConf)){
      localHoldSeat=""; localHoldTs=0;
    }
  }
}

async function loadSnapshotFirst(){
  setLoadingView();
  updateTopbar();
  try{
    const res=await api({action:"snapshot",client:me.client});
    if(!res){ showExecErrorView("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu","Exec tr·∫£ r·ªóng","Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ /exec"); return false; }
    if(!res.ok){ showExecErrorView("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu","Exec b√°o l·ªói",`${res.code||"UNKNOWN"}: ${res.message||""}`); return false; }
    applySnapshot(res.data);
    return true;
  }catch(e){
    showExecErrorView("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu","Kh√¥ng g·ªçi ƒë∆∞·ª£c exec ho·∫∑c exec tr·∫£ HTML/redirect",String(e?.message||e));
    return false;
  }
}

function onSeatClick(e){
  if(inflight.confirm||confirmQueued){ toast("ƒêang x√°c nh·∫≠n‚Ä¶ ch·ªù x√≠u nha"); return; }
  const btn=e.target.closest(".seat");
  if(!btn) return;
  const id=btn.getAttribute("data-seat");
  if(!id) return;
  if(seatIsBlocked(id)) return;
  holdSeatUltraFast(id);
}

async function holdSeatUltraFast(seatId){
  if(!me.name){ openNameModal(""); return; }
  if(seatIsBlocked(seatId)) return;

  const seatObj=seatIndex.get(seatId)||{id:seatId};
  const stNow=classifySeat(seatObj);
  if(stNow.cls==="confirmed"||stNow.cls==="otherhold") return;

  const prev=localHoldSeat;
  localHoldSeat=seatId;
  localHoldTs=Date.now();

  if(prev&&prev!==seatId) patchSeat(prev);
  patchSeat(seatId);
  patchConfirmBar();
  updateTopbar();

  const reqId=Date.now().toString(16)+Math.random().toString(16).slice(2);
  holdSeatUltraFast._lastReq=reqId;

  inflight.hold=true;
  try{
    const res=await api({action:"hold",seat:seatId,name:me.name,client:me.client});
    if(holdSeatUltraFast._lastReq!==reqId) return;

    if(!res||!res.ok){
      inflight.hold=false;
      toast(
        res?.code==="TAKEN"?"Gh·∫ø ƒë√£ c√≥ ng∆∞·ªùi x√°c nh·∫≠n":
        res?.code==="HELD"?"Gh·∫ø ƒëang c√≥ ng∆∞·ªùi ch·ªçn":
        ("L·ªói gi·ªØ ch·ªó: "+(res?.code||"UNKNOWN"))
      );

      try{
        const snap=await api({action:"snapshot",client:me.client});
        if(snap&&snap.ok) applySnapshot(snap.data);
      }catch(e){}

      localHoldSeat=""; localHoldTs=0;
      patchAllSeats();

      confirmQueued=false; confirmQueuedSeat="";
      patchConfirmBar();
      return;
    }

    applySnapshot(res.data);
    inflight.hold=false;
    patchAllSeats();

    if(confirmQueued){
      const target=confirmQueuedSeat||(snapshot?.my?.hold||localHoldSeat||"");
      confirmQueued=false; confirmQueuedSeat="";
      if(target) confirmFlow(target);
      else patchConfirmBar();
    }
  }catch(e){
    if(holdSeatUltraFast._lastReq!==reqId) return;

    inflight.hold=false;
    toast("L·ªói m·∫°ng khi gi·ªØ ch·ªó");

    localHoldSeat=""; localHoldTs=0;

    try{
      const snap=await api({action:"snapshot",client:me.client});
      if(snap&&snap.ok) applySnapshot(snap.data);
    }catch(e){}
    patchAllSeats();

    confirmQueued=false; confirmQueuedSeat="";
    patchConfirmBar();
  }
}

function seatHasMyHoldNow(seatId){
  const s=seatIndex.get(seatId);
  if(!s) return false;
  const now=snapshot?Number(snapshot.ts||Date.now()):Date.now();
  return String(s.holdBy||"")===me.client && s.holdAt && (now-Number(s.holdAt)<=60*1000+5000);
}

function finalizeConfirmSuccess(targetSeat){
  inflight.confirm=false;
  confirmQueued=false;
  confirmQueuedSeat="";
  localHoldSeat=""; localHoldTs=0;
  setConfirmUiState("done");
  toast("ƒê√£ x√°c nh·∫≠n!");
  patchAllSeats();
}

async function confirmWatchLoop(reqId,targetSeat){
  const start=Date.now();
  while(inflight.confirm&&confirmFlow._lastReq===reqId&&(Date.now()-start)<12000){
    await sleep(650);
    if(!inflight.confirm||confirmFlow._lastReq!==reqId) return;

    try{
      const snap=await api({action:"snapshot",client:me.client});
      if(!inflight.confirm||confirmFlow._lastReq!==reqId) return;

      if(snap&&snap.ok){
        applySnapshot(snap.data);

        const my=snapshot&&snapshot.my?snapshot.my:{};
        const conf=String(my.confirmed||"");
        if(conf===targetSeat){ finalizeConfirmSuccess(targetSeat); return; }

        const s=seatIndex.get(targetSeat);
        if(s&&s.confirmedBy&&String(s.confirmedBy)!==me.client){
          inflight.confirm=false;
          toast("Gh·∫ø ƒë√£ c√≥ ng∆∞·ªùi x√°c nh·∫≠n");
          patchAllSeats();
          return;
        }
      }
    }catch(e){}
  }

  if(inflight.confirm&&confirmFlow._lastReq===reqId){
    inflight.confirm=false;
    toast("X√°c nh·∫≠n ƒëang ch·∫≠m, h·ªá th·ªëng s·∫Ω t·ª± c·∫≠p nh·∫≠t‚Ä¶");
    patchAllSeats();
  }
}

async function confirmFlow(targetSeat){
  if(!me.name) return;
  if(!targetSeat){ toast("B·∫°n ch∆∞a ch·ªçn gh·∫ø"); return; }
  if(inflight.confirm) return;
  if(seatIsBlocked(targetSeat)) return;

  const reqId=Date.now().toString(16)+Math.random().toString(16).slice(2);
  confirmFlow._lastReq=reqId;

  inflight.confirm=true;
  patchConfirmBar();
  confirmWatchLoop(reqId,targetSeat);

  try{
    if(!seatHasMyHoldNow(targetSeat)){
      inflight.hold=true;
      const hres=await api({action:"hold",seat:targetSeat,name:me.name,client:me.client});
      inflight.hold=false;

      if(confirmFlow._lastReq!==reqId) return;

      if(!hres||!hres.ok){
        inflight.confirm=false;
        toast(
          hres?.code==="TAKEN"?"Gh·∫ø ƒë√£ c√≥ ng∆∞·ªùi x√°c nh·∫≠n":
          hres?.code==="HELD"?"Gh·∫ø ƒëang c√≥ ng∆∞·ªùi ch·ªçn":
          ("Kh√¥ng gi·ªØ ƒë∆∞·ª£c gh·∫ø: "+(hres?.code||"UNKNOWN"))
        );

        try{
          const snap=await api({action:"snapshot",client:me.client});
          if(snap&&snap.ok) applySnapshot(snap.data);
        }catch(e){}
        patchAllSeats();
        return;
      }

      applySnapshot(hres.data);
      patchAllSeats();
    }

    api({action:"confirm",seat:targetSeat,name:me.name,client:me.client})
      .then(res=>{
        if(confirmFlow._lastReq!==reqId) return;
        if(!inflight.confirm) return;

        if(res&&res.ok){
          applySnapshot(res.data);
          const my=snapshot&&snapshot.my?snapshot.my:{};
          if(String(my.confirmed||"")===targetSeat) finalizeConfirmSuccess(targetSeat);
          else patchAllSeats();
        }else{
          inflight.confirm=false;
          toast("L·ªói x√°c nh·∫≠n: "+(res?.code||"UNKNOWN"));
          patchAllSeats();
        }
      })
      .catch(()=>{
        if(confirmFlow._lastReq!==reqId) return;
        if(!inflight.confirm) return;
        inflight.confirm=false;
        toast("L·ªói m·∫°ng khi x√°c nh·∫≠n");
        patchAllSeats();
      });

  }catch(e){
    if(confirmFlow._lastReq!==reqId) return;
    inflight.confirm=false;
    toast("L·ªói khi x√°c nh·∫≠n");
    patchAllSeats();
  }
}

function onConfirmClick(){
  if(!me.name){ openNameModal(""); return; }

  const my=snapshot&&snapshot.my?snapshot.my:{confirmed:"",hold:""};
  const confirmed=String(my.confirmed||"");
  const hold=String(my.hold||localHoldSeat||"");

  if(inflight.confirm) return;
  if(confirmed&&(!hold||hold===confirmed)) return;

  const target=hold||"";
  if(!target){ toast("B·∫°n ch∆∞a ch·ªçn gh·∫ø"); return; }
  if(seatIsBlocked(target)) return;

  if(inflight.hold){
    confirmQueued=true;
    confirmQueuedSeat=target;
    patchConfirmBar();
    return;
  }
  confirmFlow(target);
}

function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer=setInterval(async()=>{
    if(inflight.hold||inflight.confirm||confirmQueued) return;
    try{
      const res=await api({action:"snapshot",client:me.client});
      if(res&&res.ok){
        applySnapshot(res.data);
        if(!appRendered) renderMainViewOnce();
        else patchAllSeats();
      }
    }catch(e){}
  },900);
}

document.getElementById("btnScrollTop").addEventListener("click",()=>{
  document.getElementById("shell").scrollTo({top:0,behavior:"smooth"});
});
document.getElementById("btnRename").addEventListener("click",()=>{
  if(!snapshot) return;
  if(inflight.confirm||confirmQueued){ toast("ƒêang x√°c nh·∫≠n‚Ä¶"); return; }
  openRenameModal();
});
btnConfirm.addEventListener("click",onConfirmClick);

(async()=>{
  preventZoom();
  loadLocal();

  const ok=await loadSnapshotFirst();
  if(!ok) return;

  if(!appRendered) renderMainViewOnce();

  if(me.name){
    api({action:"login",name:me.name,client:me.client,ua:navigator.userAgent||""})
      .then(res=>{ if(res&&res.ok){ applySnapshot(res.data); patchAllSeats(); } })
      .catch(()=>{});
  }else{
    openNameModal("");
  }

  startPolling();
})();

/* =========================
   Question Builder Logic
   - M·∫∑c ƒë·ªãnh mcq1
   - Nh·ªõ lo·∫°i c√¢u v·ª´a ch·ªçn cho c√¢u k·∫ø ti·∫øp
   - Import vs Manual lo·∫°i tr·ª´ nhau
   - N√∫t TH√äM C√ÇU b√°m theo ng∆∞·ªùi t·∫°o
   ========================= */
(()=>{
  const $=(id)=>document.getElementById(id);

  const LS_QB_MODE="qb::mode";
  const LS_QB_LASTTYPE="qb::lastType";

  const state={
    mode:"manual",
    lastType:"mcq1",
    questions:[],
    tfCorrect:null,
    mcq:{opts:["ƒê√°p √°n A","ƒê√°p √°n B","ƒê√°p √°n C","ƒê√°p √°n D"], correct:0}
  };

  function loadPrefs(){
    try{
      const m=localStorage.getItem(LS_QB_MODE);
      const t=localStorage.getItem(LS_QB_LASTTYPE);
      if(m==="manual"||m==="import") state.mode=m;
      if(t==="mcq1"||t==="essay"||t==="tf") state.lastType=t;
    }catch(e){}
  }
  function savePrefs(){
    try{
      localStorage.setItem(LS_QB_MODE,state.mode);
      localStorage.setItem(LS_QB_LASTTYPE,state.lastType);
    }catch(e){}
  }

  function setMode(mode){
    state.mode=mode;
    savePrefs();
    document.querySelectorAll("[data-qb-mode]").forEach(btn=>{
      btn.classList.toggle("is-active", btn.getAttribute("data-qb-mode")===mode);
    });
    $("qbPanelManual").hidden=(mode!=="manual");
    $("qbPanelImport").hidden=(mode!=="import");
    $("qbFab").classList.toggle("is-hidden", mode!=="manual");
  }

  function setType(type){
    state.lastType=type;   // nh·ªõ lo·∫°i c√¢u cho c√¢u ti·∫øp theo
    savePrefs();

    $("qbType").value=type;
    $("qbMcqBox").style.display=(type==="mcq1")?"":"none";
    $("qbEssayBox").style.display=(type==="essay")?"":"none";
    $("qbTfBox").style.display=(type==="tf")?"":"none";
    updateFabHint();
  }

  function updateFabHint(){
    const type=state.lastType;
    $("qbFabHint").textContent =
      type==="mcq1" ? "Nh·∫≠p c√¢u h·ªèi ‚Üí ch·ªçn ƒë√°p √°n ƒë√∫ng ‚Üí b·∫•m ‚ÄúTH√äM C√ÇU‚Äù"
    : type==="essay" ? "Nh·∫≠p c√¢u h·ªèi ‚Üí (tu·ª≥ ch·ªçn) g·ª£i √Ω ch·∫•m ‚Üí b·∫•m ‚ÄúTH√äM C√ÇU‚Äù"
    : "Nh·∫≠p c√¢u h·ªèi ‚Üí ch·ªçn ƒê√∫ng/Sai ‚Üí b·∫•m ‚ÄúTH√äM C√ÇU‚Äù";
  }

  function renderMcq(){
    const wrap=$("qbOptList");
    wrap.innerHTML="";
    state.mcq.opts.forEach((txt,idx)=>{
      const row=document.createElement("div");
      row.className="qb-opt";
      row.innerHTML=`
        <input class="qb-radio" type="radio" name="qb_mcq_correct" ${state.mcq.correct===idx?"checked":""} aria-label="Ch·ªçn ƒë√°p √°n ƒë√∫ng">
        <input class="input" style="padding:10px 12px; border-radius:12px;" value="${escapeHtml(txt)}" maxlength="120">
        <button class="qb-mini" type="button" title="X√≥a ƒë√°p √°n">üóëÔ∏è</button>
      `;
      const radio=row.children[0];
      const input=row.children[1];
      const del=row.children[2];

      radio.addEventListener("change",()=>{ state.mcq.correct=idx; });
      input.addEventListener("input",()=>{ state.mcq.opts[idx]=input.value; });
      del.addEventListener("click",()=>{
        if(state.mcq.opts.length<=2) return;
        state.mcq.opts.splice(idx,1);
        if(state.mcq.correct>=state.mcq.opts.length) state.mcq.correct=0;
        renderMcq();
      });

      wrap.appendChild(row);
    });
  }

  function resetMcq(){
    state.mcq.opts=["ƒê√°p √°n A","ƒê√°p √°n B","ƒê√°p √°n C","ƒê√°p √°n D"];
    state.mcq.correct=0;
    renderMcq();
  }

  function pickTf(val){
    state.tfCorrect=!!val;
    $("qbTfPicked").textContent="ƒê√°p √°n ƒë√∫ng: "+(state.tfCorrect?"ƒê√öNG ‚úÖ":"SAI ‚ùå");
  }

  function badgeLabel(q){
    if(q.type==="mcq1") return "TR·∫ÆC NGHI·ªÜM 1 ƒê√ÅP √ÅN";
    if(q.type==="essay") return "T·ª∞ LU·∫¨N";
    return "ƒê√öNG / SAI";
  }

  function renderList(){
    const list=$("qbList");
    list.innerHTML="";
    if(!state.questions.length){
      list.innerHTML=`<div class="muted" style="font-weight:750;">Ch∆∞a c√≥ c√¢u n√†o. H√£y th√™m c√¢u ƒë·∫ßu ti√™n üëá</div>`;
      return;
    }
    state.questions.forEach((q,i)=>{
      const item=document.createElement("div");
      item.className="qb-item";

      let meta="";
      if(q.type==="mcq1"){
        const correct=q.options[q.correctIndex]??"";
        meta=`‚Ä¢ ${q.options.length} ƒë√°p √°n ‚Ä¢ ƒê√∫ng: <b>${escapeHtml(correct)}</b>`;
      }else if(q.type==="essay"){
        meta=q.hint?`‚Ä¢ C√≥ g·ª£i √Ω ch·∫•m`:`‚Ä¢ Kh√¥ng c√≥ g·ª£i √Ω`;
      }else{
        meta=`‚Ä¢ ƒê√∫ng: <b>${q.correct?"ƒê√öNG":"SAI"}</b>`;
      }

      item.innerHTML=`
        <div class="qb-itemTop">
          <div>
            <div class="qb-badge">#${i+1} ‚Ä¢ ${badgeLabel(q)}</div>
            <p class="qb-itemTitle" style="margin-top:8px;">${escapeHtml(q.text)}</p>
            <div class="qb-itemMeta">${meta}</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="qb-mini" type="button" title="X√≥a c√¢u">üóëÔ∏è X√≥a</button>
          </div>
        </div>
      `;

      item.querySelector("button").addEventListener("click",()=>{
        state.questions.splice(i,1);
        renderList();
      });

      list.appendChild(item);
    });
  }

  function addQuestion(){
    const qText=($("qbQuestionText").value||"").trim();
    if(!qText){ toast("B·∫°n ch∆∞a nh·∫≠p c√¢u h·ªèi"); return; }

    const type=state.lastType;

    if(type==="mcq1"){
      const opts=state.mcq.opts.map(s=>String(s||"").trim()).filter(Boolean);
      if(opts.length<2){ toast("C·∫ßn √≠t nh·∫•t 2 ƒë√°p √°n"); return; }
      const correct=Math.min(state.mcq.correct, opts.length-1);

      state.questions.push({type,text:qText,options:opts,correctIndex:correct});
      $("qbQuestionText").value="";
      resetMcq();
    }
    else if(type==="essay"){
      const hint=($("qbEssayHint").value||"").trim();
      state.questions.push({type,text:qText,hint});
      $("qbQuestionText").value="";
      $("qbEssayHint").value="";
    }
    else if(type==="tf"){
      if(state.tfCorrect===null){ toast("B·∫°n ch∆∞a ch·ªçn ƒê√∫ng/Sai"); return; }
      state.questions.push({type,text:qText,correct:state.tfCorrect});
      $("qbQuestionText").value="";
      state.tfCorrect=null;
      $("qbTfPicked").textContent="Ch∆∞a ch·ªçn";
    }

    renderList();
    setType(type); // gi·ªØ nguy√™n lo·∫°i c√¢u cho c√¢u sau
    toast("ƒê√£ th√™m c√¢u!");
  }

  function doImport(){
    const html=($("qbImportHtml").value||"").trim();
    if(!html){ toast("B·∫°n ch∆∞a d√°n HTML"); return; }
    toast("ƒê√£ nh·∫≠n HTML (c·∫ßn parser theo ƒë·ªãnh d·∫°ng c·ªßa b·∫°n)");
  }

  function initQB(){
    if(!$("qbRoot")) return;

    loadPrefs();
    setMode(state.mode);
    setType(state.lastType);

    document.querySelectorAll("[data-qb-mode]").forEach(btn=>{
      btn.addEventListener("click",()=>setMode(btn.getAttribute("data-qb-mode")));
    });

    $("qbType").addEventListener("change",()=>setType($("qbType").value));
    $("qbAddOpt").addEventListener("click",()=>{ state.mcq.opts.push("ƒê√°p √°n m·ªõi"); renderMcq(); });
    $("qbResetOpt").addEventListener("click",resetMcq);

    $("qbTfTrue").addEventListener("click",()=>pickTf(true));
    $("qbTfFalse").addEventListener("click",()=>pickTf(false));

    $("qbAddQuestionBtn").addEventListener("click",addQuestion);
    $("qbDoImport").addEventListener("click",doImport);

    renderMcq();
    renderList();
  }

  initQB();
})();
</script>
</body>
</html>
