<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Admin Panel</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <!-- KaTeX (render $...$ preview ngay trong admin) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <style>
    :root{
      --bg1:#ffecd2; --bg2:#fcb69f;
      --card:#fff; --text:#1f2937; --muted:#6b7280;
      --primary:#7c3aed; --bad:#dc2626; --ok:#16a34a;
      --border:#e5e7eb; --soft:#f8fafc;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --radius:18px; --admin:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
        linear-gradient(120deg,var(--bg1) 0%, var(--bg2) 100%);
      overflow:hidden;
    }
    #shell{height:100vh; overflow:auto; -webkit-overflow-scrolling:touch; padding:12px 0 110px}
    .wrap{max-width:1180px; margin:0 auto; padding:0 14px}

    .topbar{
      margin-top:10px;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(229,231,235,.9);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .titlebox{display:flex; gap:10px; align-items:center; flex:1 1 420px; min-width:240px}
    .logo{
      width:42px; height:42px; border-radius:16px;
      background:linear-gradient(135deg,#a78bfa,#fb7185);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:900;
      box-shadow:0 10px 22px rgba(124,58,237,.18);
      user-select:none;
    }
    .titles h1{font-size:1.02rem; margin:0; font-weight:800}
    .titles .tiny{margin-top:3px; font-size:.86rem; color:var(--muted); font-weight:650}
    a{color:#4c1d95; text-decoration:none; font-weight:950}
    a:hover{text-decoration:underline}

    .pill{
      background:#f3f4f6; border:1px solid #e5e7eb;
      border-radius:999px; padding:8px 12px;
      font-weight:900; font-size:.9rem; color:#374151; white-space:nowrap;
      display:flex; gap:8px; align-items:center;
    }
    .badge-admin{
      padding:4px 8px; border-radius:999px; font-weight:950; font-size:.78rem;
      background:rgba(37,99,235,.12);
      border:1px solid rgba(37,99,235,.35);
      color:var(--admin); white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin:12px 0;
    }
    .row1{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .vi{margin:0; font-weight:900; font-size:1.04rem; line-height:1.25}
    .muted{color:var(--muted); font-weight:650}
    .idx{
      font-size:.78rem; font-weight:900;
      padding:6px 10px; border-radius:999px;
      background:#eff6ff; color:#1d4ed8; border:1px solid #dbeafe;
      white-space:nowrap;
    }
    .idx.ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .idx.warn{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .idx.bad{background:#fee2e2;color:#991b1b;border-color:#fecaca}

    .btn{
      border:0; cursor:pointer;
      border-radius:999px; padding:10px 14px;
      font-weight:900; font-size:.9rem;
      transition:transform .16s ease, filter .16s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none; white-space:nowrap;
      box-shadow:0 12px 24px rgba(0,0,0,.12);
      background:#fff; color:#111827; border:1px solid #e5e7eb;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(.98)}
    .btn:active{transform:translateY(0)}
    .btn[disabled]{opacity:.6; cursor:not-allowed; transform:none !important; filter:none !important}
    .btn-primary{
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      color:#fff; border:0;
      box-shadow:0 12px 24px rgba(124,58,237,.18);
    }
    .btn-danger{background:var(--bad); color:#fff; border:0; box-shadow:0 12px 24px rgba(220,38,38,.18);}
    .btn-ghost{background:#fff; color:#111827; border:1px solid #e5e7eb; box-shadow:none}

    .mini{padding:8px 10px; border-radius:14px; border:1px solid #e5e7eb; background:#fff; font-weight:900; cursor:pointer}
    .mini.danger{border:0;background:var(--bad);color:#fff}
    .mini.primary{border:0;background:linear-gradient(135deg,#7c3aed,#fb7185);color:#fff}

    .input, textarea, select{
      width:100%;
      border-radius:14px; border:2px solid #e5e7eb;
      padding:11px 12px; font-size:.95rem; font-weight:700;
      outline:none; background:var(--soft);
      transition:border-color .15s ease, box-shadow .15s ease;
      font-family:inherit;
    }
    textarea{min-height:120px; font-family:ui-monospace,Consolas,monospace; font-weight:650}
    .input:focus, textarea:focus, select:focus{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 0 0 5px rgba(124,58,237,.10);
      background:#fff;
    }
    label{display:block; margin-top:10px; font-weight:900}

    .tabs{display:flex; gap:10px; flex-wrap:wrap}
    .tab{padding:10px 14px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; font-weight:950; cursor:pointer; box-shadow:none}
    .tab.active{background:linear-gradient(135deg,#7c3aed,#fb7185); color:#fff; border:0}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .topGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:start;}
    @media(max-width:980px){ .topGrid{grid-template-columns:1fr;} }
    @media(max-width:640px){ .grid2{grid-template-columns:1fr} }

    .hr{height:1px;background:#e5e7eb;margin:12px 0}
    .mono{font-family:ui-monospace,Consolas,monospace}

    /* Quiz list cards */
    .qItem{
      border:1px solid rgba(229,231,235,.95);
      border-radius:16px;
      padding:12px;
      background:#fff;
      box-shadow:none;
      margin:10px 0;
      cursor:pointer;
    }
    .qBadges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .qActions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    /* Builder header */
    .qbHead{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .qbTabs{
      display:flex; gap:8px; flex-wrap:wrap;
      background:rgba(243,244,246,.88);
      border:1px solid rgba(229,231,235,.95);
      padding:6px; border-radius:999px;
    }
    .qbTab{
      border:0;background:transparent;cursor:pointer;border-radius:999px;
      padding:9px 12px;font-weight:950;font-size:.86rem;color:#111827;
      user-select:none; white-space:nowrap;
    }
    .qbTab.active{
      background:#fff;border:1px solid rgba(229,231,235,.95);
      box-shadow:0 10px 24px rgba(0,0,0,.08);
    }

    .qCard{
      background:#fff;
      border:1px solid rgba(229,231,235,.95);
      border-radius:16px;
      padding:12px;
      box-shadow:none;
      margin:12px 0;
    }
    .qHead{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding-bottom:10px; border-bottom:1px dashed rgba(229,231,235,.95);
      margin-bottom:10px;
    }
    .qType{
      border-radius:999px;
      padding:9px 12px;
      font-weight:950;
      background:rgba(248,250,252,.95);
    }
    .hint{font-weight:650;color:var(--muted);line-height:1.35; font-size:.88rem}
    .hidden{display:none !important;}

    /* Image */
    .imgRow{display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; margin-top:10px}
    .imgDrop{
      flex:1 1 320px;
      border:2px dashed #e5e7eb;
      border-radius:16px;
      padding:12px;
      background:rgba(248,250,252,.8);
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .imgDrop small{color:var(--muted); font-weight:750}
    .imgPreview{
      width:220px; height:132px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#fff;
      object-fit:cover;
      display:none;
      flex:0 0 auto;
    }

    /* Preview */
    .previewBox{
      margin-top:10px;
      border:1px dashed rgba(229,231,235,.95);
      border-radius:16px;
      padding:10px;
      background:#fff;
    }
    .previewTitle{font-weight:950;color:#111827;margin:0 0 6px;font-size:.9rem}
    .previewBody{color:#111827; font-weight:650; line-height:1.45}
    .previewBody .muted{font-weight:700}
    .previewBody img{max-width:100%;border-radius:12px;border:1px solid #e5e7eb;margin-top:8px}

    /* FAB add question */
    .qFab{
      position:fixed; left:0; right:0;
      bottom:calc(env(safe-area-inset-bottom) + 18px);
      z-index:20010;
      pointer-events:none;
      padding:0 14px;
    }
    .qFabInner{max-width:1180px; margin:0 auto; pointer-events:auto; display:flex; justify-content:flex-end;}
    .qFabBtn{
      width:min(520px, 100%);
      border-radius:18px;
      padding:14px 16px;
      font-size:1.04rem;
      font-weight:1000;
      letter-spacing:.02em;
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      color:#fff;
      border:0;
      box-shadow:0 16px 42px rgba(124,58,237,.22);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .qFabBtn:hover{transform:translateY(-1px);filter:brightness(.98)}
    .qFabBtn:active{transform:translateY(0)}
    .qFab.hidden{display:none !important}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(17,24,39,.92); color:#fff;
      padding:10px 12px; border-radius:14px;
      font-weight:800; font-size:.9rem;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width:calc(100% - 28px);
      z-index:20050; text-align:center;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
  </style>
</head>

<body>
  <div id="shell">
    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">A</div>
          <div class="titles">
            <h1>Admin Panel</h1>
            <div class="tiny"><a href="/">‚Üê v·ªÅ k·ªá h√†ng</a></div>
          </div>
        </div>
        <div class="pill" id="mePill">Checking‚Ä¶</div>
      </div>

      <div class="card" id="gate">Checking login...</div>

      <div id="app" style="display:none">
        <div class="card">
          <div class="row1">
            <p class="vi">B·∫£ng ƒëi·ªÅu khi·ªÉn</p>
            <div class="tabs">
              <button class="tab active" id="tabQuizzes">Quizzes</button>
              <button class="tab" id="tabUsers">Users</button>
            </div>
          </div>
        </div>

        <!-- QUIZZES -->
        <div id="viewQuizzes">
          <div class="topGrid">
            <!-- settings -->
            <div class="card">
              <div class="row1">
                <p class="vi">Quiz</p>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                  <span class="idx" id="editModePill">NEW</span>
                  <span class="idx" id="qidPill">QID: ‚Äî</span>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>Quiz ID (5 ch·ªØ)</label>
                  <input class="input mono" id="quizId" placeholder="abcde" maxlength="5" />
                </div>
                <div>
                  <label>Title</label>
                  <input class="input" id="title" placeholder="T√™n quiz" />
                </div>
              </div>

              <label>Sub</label>
              <input class="input" id="sub" placeholder="M√¥ t·∫£ ng·∫Øn" />

              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>Public</label>
                  <select id="isPublic">
                    <option value="true">Public</option>
                    <option value="false">Private</option>
                  </select>
                </div>
                <div>
                  <label>Hi·ªán tr√™n store</label>
                  <select id="showInStore">
                    <option value="true">Hi·ªán</option>
                    <option value="false">·∫®n</option>
                  </select>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>Y√™u c·∫ßu login</label>
                  <select id="requireLogin">
                    <option value="true">C·∫ßn login</option>
                    <option value="false">Kh√¥ng c·∫ßn login</option>
                  </select>
                </div>
                <div>
                  <label>Ghim</label>
                  <select id="pinned">
                    <option value="false">Kh√¥ng</option>
                    <option value="true">Ghim</option>
                  </select>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>M√£ truy c·∫≠p</label>
                  <select id="requireCode">
                    <option value="false">Kh√¥ng</option>
                    <option value="true">C√≥</option>
                  </select>
                </div>
                <div>
                  <label>Code</label>
                  <input class="input mono" id="accessCode" placeholder="vd: 1234" />
                </div>
              </div>

              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>ƒê·∫£o c√¢u/ƒë√°p √°n</label>
                  <select id="shuffleMode">
                    <option value="none">Kh√¥ng ƒë·∫£o</option>
                    <option value="q">Ch·ªâ ƒë·∫£o c√¢u h·ªèi</option>
                    <option value="qa">ƒê·∫£o c√¢u h·ªèi + ƒë√°p √°n</option>
                  </select>
                </div>
                <div>
                  <label>Chia ƒëi·ªÉm</label>
                  <select id="scoringMode">
                    <option value="equal">Chia ƒë·ªÅu theo s·ªë c√¢u</option>
                    <option value="custom">T·ª± chia (m·ªói c√¢u c√≥ ƒëi·ªÉm)</option>
                  </select>
                </div>
              </div>

              <label>T·ªïng ƒëi·ªÉm</label>
              <input class="input mono" id="totalScore" value="10" />

              <div class="hint" style="margin-top:10px">
                ·∫¢nh s·∫Ω ƒë∆∞·ª£c upload l√™n <b>Supabase Storage</b> (kh√¥ng nh√©t base64 v√†o DB n·ªØa).<br>
                LaTeX nh·∫≠p b·∫±ng <code>$...$</code> (vd: <code>$x^2$</code>, <code>$(x+y)/2$</code>) ‚Äî c√≥ preview ngay b√™n d∆∞·ªõi.
              </div>

              <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn" id="btnNewQuiz" type="button">‚ú® T·∫°o m·ªõi</button>
                <button class="btn btn-primary" id="btnSaveQuiz" type="button">üíæ L∆∞u quiz</button>
              </div>
            </div>

            <!-- list -->
            <div class="card">
              <div class="row1">
                <p class="vi">Danh s√°ch quiz</p>
                <button class="btn" id="btnReloadQuizzes" type="button">Reload</button>
              </div>
              <div id="quizList" style="margin-top:10px"></div>
            </div>
          </div>

          <!-- question editor -->
          <div class="card" style="margin-top:10px">
            <div class="qbHead">
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <p class="vi" style="margin:0">So·∫°n c√¢u h·ªèi</p>
                <span class="idx" id="qCountPill">0</span>
              </div>
              <div class="qbTabs" aria-label="Ch·∫ø ƒë·ªô">
                <button class="qbTab active" id="qbTabManual" type="button">üìù Th·ªß c√¥ng</button>
                <button class="qbTab" id="qbTabImport" type="button">üì• Import</button>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn btn-primary" id="btnPublishAll" type="button">üöÄ Publish</button>
              </div>
            </div>

            <div id="qbManualArea" style="margin-top:10px">
              <div id="qList" style="margin-top:12px"></div>

              <div class="hr"></div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn btn-primary" id="btnPublishAllBottom" type="button">üöÄ Publish</button>
              </div>
            </div>

            <div id="qbImportArea" style="display:none; margin-top:10px">
              <div class="hint" style="margin-top:0">
                Import (d√≤ng c√≥ <code>*...*</code> l√† ƒë√∫ng). Sau import: h·ªá th·ªëng t·ª± x√≥a <code>*</code> ƒë·ªÉ kh·ªèi l√≤i ƒë√°p √°n.
                <div class="mono" style="white-space:pre-wrap; margin-top:8px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:10px">
&lt;tn&gt;@1: C√¢u tr·∫Øc nghi·ªám
A
B
*C*
D

&lt;tl&gt;@2: C√¢u t·ª± lu·∫≠n
*ƒê√°p √°n ƒë√∫ng 1*|*ƒê√°p √°n ƒë√∫ng 2*

&lt;tln&gt;@3: Tr·∫£ l·ªùi ng·∫Øn
*0,02*|*-0,3*

&lt;tf&gt;@4: ƒê√∫ng/Sai
|A: ... *T*|
|B: ... *F*|
|C: ... *T*|
|D: ... *F*|
                </div>
              </div>

              <label>Paste n·ªôi dung</label>
              <textarea id="importBox" placeholder="D√°n n·ªôi dung import v√†o ƒë√¢y..."></textarea>

              <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn" id="btnImportReplace" type="button">‚¨áÔ∏è Import (thay th·∫ø danh s√°ch)</button>
                <button class="btn btn-primary" id="btnImportAppend" type="button">‚ûï Import (th√™m v√†o cu·ªëi)</button>
              </div>

              <div class="hr"></div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn btn-primary" id="btnPublishAll2" type="button">üöÄ Publish</button>
              </div>
            </div>
          </div>
        </div>

        <!-- USERS -->
        <div id="viewUsers" style="display:none">
          <div class="card">
            <div class="row1">
              <p class="vi">Users</p>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <input class="input" id="userSearch" placeholder="Search username..." style="max-width:320px"/>
                <button class="btn" id="btnReloadUsers" type="button">Reload</button>
              </div>
            </div>
            <div id="userList" style="margin-top:10px"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- FAB add question -->
  <div class="qFab" id="qFab">
    <div class="qFabInner">
      <button class="qFabBtn" id="btnAddQFab" type="button">‚ûï TH√äM C√ÇU H·ªéI</button>
    </div>
  </div>

  <input id="qImgPick" type="file" accept="image/*" style="display:none" />

  <div class="toast" id="toast"></div>

<script>
/* ================== CONFIG ================== */
const SUPABASE_URL = "https://aidvlydhbdtwunyreqak.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmR0d3VueXJlcWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzM5NzYsImV4cCI6MjA4NDIwOTk3Nn0.LMKGjKlUbC5qoY7hqDpaDFQrFWfwKemBTpxjTNp_L8o";
const TOKEN_KEY = "tk_token_v2";

/* Storage bucket ƒë·ªÉ upload ·∫£nh c√¢u h·ªèi.
   -> T·∫†O bucket n√†y trong Supabase Storage, set PUBLIC = true.
   -> N·∫øu bucket private th√¨ ·∫£nh kh√¥ng hi·ªán (v√¨ link public). */
const STORAGE_BUCKET = "quiz";

/* RPC names */
const RPC = {
  me: "api_me",
  adminUpsertQuiz: "admin_upsert_quiz",
  adminListQuizzes: "admin_list_quizzes",
  adminDeleteQuiz: "admin_delete_quiz",
  adminGetQuestions: "admin_get_questions",
  adminReplaceQuestions: "admin_replace_questions",
  adminImportQuestions: "admin_import_questions",

  adminListUsers: "admin_list_users",
  adminDeleteUser: "admin_delete_user",
  adminForceRename: "admin_force_rename",
  adminForceSetPin: "admin_force_set_pin",

  // optional (n·∫øu c√≥ th√¨ s·∫Ω t·ª± g·ªçi sau publish)
  adminRegradeQuiz: "admin_regrade_quiz"
};

/* ================== UI HELPERS ================== */
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=String(msg||"");
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1400);
}
function esc(s){
  return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function getToken(){ return (localStorage.getItem(TOKEN_KEY) || "").trim(); }
function normalizeQuizId(x){
  x = String(x||"").trim().toLowerCase();
  x = x.replace(/[^a-z]/g,"").slice(0,5);
  return x;
}
function genQuizId5(){
  const letters="abcdefghijklmnopqrstuvwxyz";
  let s="";
  for(let i=0;i<5;i++) s += letters[Math.floor(Math.random()*letters.length)];
  return s;
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ================== KaTeX preview ================== */
function katexRenderSafe(root){
  try{
    if(!root) return;
    if(typeof window.renderMathInElement !== "function") return;
    window.renderMathInElement(root, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false},
        {left: "\\[", right: "\\]", display: true},
      ],
      throwOnError: false
    });
  }catch{}
}

/* ================== SUPABASE RPC ================== */
async function rpc(fn, args){
  const token = getToken(); // JWT user ƒë√£ login

  if (!token) {
    throw new Error("No auth token");
  }

  const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + token, // ‚úÖ ƒê√öNG
      "Content-Type": "application/json"
    },
    body: JSON.stringify(args || {})
  });

  const txt = await res.text();
  let data = null;
  try { data = txt ? JSON.parse(txt) : null; } catch {}

  if (!res.ok) {
    throw new Error(
      data?.message ||
      data?.error ||
      data?.hint ||
      txt ||
      `RPC failed: ${fn}`
    );
  }
  return data;
}

  const txt = await res.text();
  let data=null;
  try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || `RPC failed: ${fn}`);
  }
  return data;
}

async function rpcOptional(fn, args){
  try{ return await rpc(fn,args); }
  catch(e){
    const m = String(e?.message||"");
    if(m.includes("Could not find the function") || m.includes("schema cache")){
      return null;
    }
    return null;
  }
}

/* ================== STORAGE (upload image) ================== */
function encodePath(path){
  return String(path||"").split("/").map(encodeURIComponent).join("/");
}
function dataUrlToBytes(dataUrl){
  const m = String(dataUrl||"").match(/^data:([^;]+);base64,(.+)$/);
  if(!m) throw new Error("Bad dataUrl");
  const mime = m[1];
  const b64 = m[2];
  const bin = atob(b64);
  const len = bin.length;
  const bytes = new Uint8Array(len);
  for(let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
  return { mime, bytes };
}
function extFromMime(mime){
  mime = String(mime||"").toLowerCase();
  if(mime.includes("png")) return "png";
  if(mime.includes("webp")) return "webp";
  if(mime.includes("gif")) return "gif";
  return "jpg";
}
function publicObjectUrl(bucket, path){
  return `${SUPABASE_URL}/storage/v1/object/public/${bucket}/${encodePath(path)}`;
}
async function storagePutObject(bucket, path, mime, bytes){
  const url = `${SUPABASE_URL}/storage/v1/object/${bucket}/${encodePath(path)}`;
  const res = await fetch(url, {
    method: "PUT",
    headers: {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": mime
    },
    body: bytes
  });
  const txt = await res.text();
  if(res.ok) return txt;
  // n·∫øu PUT fail (m·ªôt s·ªë c·∫•u h√¨nh), th·ª≠ POST t·∫°o m·ªõi
  const url2 = `${SUPABASE_URL}/storage/v1/object/${bucket}/${encodePath(path)}`;
  const res2 = await fetch(url2, {
    method: "POST",
    headers: {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": mime
    },
    body: bytes
  });
  const txt2 = await res2.text();
  if(!res2.ok){
    throw new Error(txt2 || txt || "Upload image failed");
  }
  return txt2;
}
function randId(){
  const a = new Uint8Array(6);
  crypto.getRandomValues(a);
  return Array.from(a).map(x=>x.toString(16).padStart(2,"0")).join("");
}

/* ================== DOM ================== */
const mePill = document.getElementById("mePill");
const gate = document.getElementById("gate");
const app = document.getElementById("app");

const tabQuizzes = document.getElementById("tabQuizzes");
const tabUsers = document.getElementById("tabUsers");
const viewQuizzes = document.getElementById("viewQuizzes");
const viewUsers = document.getElementById("viewUsers");
function setTab(which){
  const isQ = which==="q";
  tabQuizzes.classList.toggle("active", isQ);
  tabUsers.classList.toggle("active", !isQ);
  viewQuizzes.style.display = isQ ? "" : "none";
  viewUsers.style.display = isQ ? "none" : "";
}
tabQuizzes.onclick = ()=>setTab("q");
tabUsers.onclick = ()=>setTab("u");

/* ================== STATE ================== */
let ME = null;
let QUIZZES = [];
let USERS = [];

let CURRENT_QID = "";
let CURRENT_MODE = "NEW"; // NEW | EDIT
let QUESTIONS = [];       // array of {type,prompt,answers,points,meta}

/* ================== AUTH GATE ================== */
async function gateCheck(){
  const token = getToken();
  if(!token){
    gate.innerHTML = `B·∫°n ch∆∞a login. V√†o <a href="/">trang ch·ªß</a> ƒë·ªÉ login admin.`;
    mePill.textContent = "No token";
    return false;
  }
  try{
    const meOut = await rpc(RPC.me,{p_token:token});
    if(!meOut.ok) throw new Error(meOut.error||"not logged");
    ME = meOut.me;
    const isAdmin = (ME.role==="admin") || (String(ME.username||"").toLowerCase()==="tuankhoi");
    mePill.innerHTML = `Xin ch√†o <b>${esc(ME.username)}</b> <span class="badge-admin">ADMIN</span>`;
    if(!isAdmin){
      gate.textContent = "B·∫°n kh√¥ng ph·∫£i admin.";
      return false;
    }
    gate.innerHTML = `<span class="idx ok">OK</span> Admin: <b>${esc(ME.username)}</b>`;
    app.style.display = "";
    return true;
  }catch(e){
    gate.innerHTML = `L·ªói gate: ${esc(e.message)}. V·ªÅ <a href="/">trang ch·ªß</a> ƒë·ªÉ login l·∫°i.`;
    mePill.textContent = "Gate error";
    return false;
  }
}

/* ================== QUIZ FORM ================== */
const quizIdEl = document.getElementById("quizId");
const titleEl = document.getElementById("title");
const subEl = document.getElementById("sub");
const isPublicEl = document.getElementById("isPublic");
const showInStoreEl = document.getElementById("showInStore");
const requireLoginEl = document.getElementById("requireLogin");
const pinnedEl = document.getElementById("pinned");
const requireCodeEl = document.getElementById("requireCode");
const accessCodeEl = document.getElementById("accessCode");
const scoringModeEl = document.getElementById("scoringMode");
const totalScoreEl = document.getElementById("totalScore");
const shuffleModeEl = document.getElementById("shuffleMode");

const editModePill = document.getElementById("editModePill");
const qidPill = document.getElementById("qidPill");

quizIdEl.addEventListener("input", ()=>{
  const v = normalizeQuizId(quizIdEl.value);
  if(quizIdEl.value !== v) quizIdEl.value = v;
},{passive:true});

function setMode(mode){
  CURRENT_MODE = mode;
  editModePill.textContent = mode;
  editModePill.className = "idx " + (mode==="EDIT" ? "ok" : "");
  if(mode==="EDIT") quizIdEl.setAttribute("disabled","disabled");
  else quizIdEl.removeAttribute("disabled");
  qidPill.textContent = "QID: " + (CURRENT_QID || normalizeQuizId(quizIdEl.value) || "‚Äî");
}
function validateQuiz(){
  const title = titleEl.value.trim();
  if(!title) return "Thi·∫øu title";
  let qid = (CURRENT_MODE==="EDIT") ? CURRENT_QID : normalizeQuizId(quizIdEl.value);
  if(CURRENT_MODE==="NEW" && !qid) return "Quiz ID tr·ªëng (b·∫•m T·∫°o m·ªõi ho·∫∑c nh·∫≠p 5 ch·ªØ)";
  if(qid && qid.length!==5) return "Quiz ID ph·∫£i ƒë√∫ng 5 ch·ªØ a-z";
  return null;
}

/* ================== QUESTION BUILDER ================== */
const qList = document.getElementById("qList");
const qCountPill = document.getElementById("qCountPill");

const qbTabManual = document.getElementById("qbTabManual");
const qbTabImport = document.getElementById("qbTabImport");
const qbManualArea = document.getElementById("qbManualArea");
const qbImportArea = document.getElementById("qbImportArea");
const qFab = document.getElementById("qFab");

const LS_QB_MODE = "admin_qb_mode_v3";
const LS_QB_LASTTYPE = "admin_qb_lasttype_v3";

function isAllowedQType(t){ return (t==="mcq1" || t==="essay" || t==="short4" || t==="tf4"); }

let QB_MODE = (localStorage.getItem(LS_QB_MODE)||"manual").toLowerCase();
if(QB_MODE!=="manual" && QB_MODE!=="import") QB_MODE="manual";

let LAST_QTYPE = (localStorage.getItem(LS_QB_LASTTYPE)||"mcq1").toLowerCase();
if(!isAllowedQType(LAST_QTYPE)) LAST_QTYPE="mcq1";

function setLastType(t){
  t = String(t||"").toLowerCase();
  if(!isAllowedQType(t)) return;
  LAST_QTYPE = t;
  try{ localStorage.setItem(LS_QB_LASTTYPE, LAST_QTYPE); }catch{}
}

function setQBMode(mode){
  mode = String(mode||"manual").toLowerCase();
  if(mode!=="manual" && mode!=="import") mode="manual";
  QB_MODE = mode;
  try{ localStorage.setItem(LS_QB_MODE, QB_MODE); }catch{}

  qbTabManual.classList.toggle("active", QB_MODE==="manual");
  qbTabImport.classList.toggle("active", QB_MODE==="import");
  qbManualArea.style.display = (QB_MODE==="manual") ? "" : "none";
  qbImportArea.style.display = (QB_MODE==="import") ? "" : "none";
  qFab.classList.toggle("hidden", QB_MODE!=="manual");
}
qbTabManual.addEventListener("click", ()=>setQBMode("manual"));
qbTabImport.addEventListener("click", ()=>setQBMode("import"));

function updateQCount(){ qCountPill.textContent = String(QUESTIONS.length || 0); }

function defaultQuestion(){
  const t = LAST_QTYPE || "mcq1";
  if(t==="mcq1"){
    return { type:"mcq1", prompt:"", answers:["A"], points:null, meta:{ options:["A","B","C","D"], correct:1, image_data_url:"", image_url:"" } };
  }
  if(t==="short4"){
    return { type:"short4", prompt:"", answers:[""], points:null, meta:{ format:"4boxes", image_data_url:"", image_url:"" } };
  }
  if(t==="tf4"){
    return { type:"tf4", prompt:"", answers:[], points:null, meta:{
      statements:["","","",""], keys:[true,false,false,false],
      rule:{ byCorrectCount:{ "0":0, "1":0.25, "2":0.5, "3":0.5, "4":1 } },
      image_data_url:"", image_url:""
    }};
  }
  return { type:"essay", prompt:"", answers:[""], points:null, meta:{ fuzzy:true, image_data_url:"", image_url:"" } };
}
function ensureMeta(q){
  q.meta = q.meta || {};
  if(typeof q.meta.image_data_url !== "string") q.meta.image_data_url = "";
  if(typeof q.meta.image_url !== "string") q.meta.image_url = "";
}

function insertAtCursor(el, text, afterSelOffset=0){
  if(!el) return;
  el.focus();
  const start = el.selectionStart ?? el.value.length;
  const end = el.selectionEnd ?? el.value.length;
  const before = el.value.slice(0,start);
  const sel = el.value.slice(start,end);
  const after = el.value.slice(end);
  el.value = before + text.replace("$SEL$", sel) + after;
  const pos = start + text.length - "$SEL$".length + afterSelOffset;
  try{ el.setSelectionRange(pos,pos); }catch{}
  el.dispatchEvent(new Event("input",{bubbles:true}));
}
function latexButtonHtml(){
  return `<button class="mini" data-act="latex" type="button">‚àë C√¥ng th·ª©c</button>`;
}

/* Preview content builder */
function nl2br(s){ return esc(String(s||"")).replace(/\n/g,"<br>"); }

function buildPreviewHtml(q){
  ensureMeta(q);
  const img = q.meta.image_url || q.meta.image_data_url || "";
  let html = `<div class="previewTitle">Preview (render $...$)</div>`;
  html += `<div class="previewBody">`;

  html += `<div><span class="muted">C√¢u h·ªèi:</span> ${nl2br(q.prompt||"")}</div>`;

  if(q.type==="mcq1"){
    const opts = (q.meta.options||[]).slice(0,4);
    const correct = Number(q.meta.correct||1)||1;
    html += `<div style="margin-top:8px"><span class="muted">Tr·∫Øc nghi·ªám:</span></div>`;
    html += `<ol style="margin:6px 0 0 18px">` + opts.map((t,i)=>{
      const mark = (i+1===correct) ? " ‚úÖ" : "";
      return `<li>${nl2br(t||"")}${mark}</li>`;
    }).join("") + `</ol>`;
  }

  if(q.type==="essay"){
    html += `<div style="margin-top:8px"><span class="muted">ƒê√°p √°n (·∫©n khi l√†m):</span> ${esc((q.answers||[]).join(" | "))}</div>`;
  }
  if(q.type==="short4"){
    html += `<div style="margin-top:8px"><span class="muted">ƒê√°p √°n (·∫©n khi l√†m):</span> ${esc((q.answers||[]).join(" | "))}</div>`;
  }
  if(q.type==="tf4"){
    const stmts = q.meta.statements||["","","",""];
    const keys = q.meta.keys||[false,false,false,false];
    html += `<div style="margin-top:8px"><span class="muted">ƒê√∫ng/Sai:</span></div>`;
    html += `<ul style="margin:6px 0 0 18px">` + stmts.map((t,i)=>{
      const mark = keys[i] ? "T" : "F";
      return `<li>${nl2br(t||"")} <b style="margin-left:6px">(${mark})</b></li>`;
    }).join("") + `</ul>`;
  }

  if(img){
    html += `<img alt="img" src="${esc(img)}">`;
  }
  html += `</div>`;
  return html;
}

function renderQuestions(){
  updateQCount();
  setMode(CURRENT_MODE);

  if(!QUESTIONS.length){
    qList.innerHTML = `<div class="muted">Ch∆∞a c√≥ c√¢u h·ªèi. B·∫•m ‚ÄúTH√äM C√ÇU H·ªéI‚Äù.</div>`;
    return;
  }
  const isCustom = (scoringModeEl.value === "custom");

  qList.innerHTML = QUESTIONS.map((q, idx)=>{
    ensureMeta(q);
    const no = idx+1;

    // choose preview image
    const img = q.meta.image_url || q.meta.image_data_url || "";

    return `
      <div class="qCard" data-i="${idx}">
        <div class="qHead">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <span class="idx">#${no}</span>
            <select class="qType">
              <option value="mcq1" ${q.type==="mcq1"?"selected":""}>Tr·∫Øc nghi·ªám 1 ƒë√°p √°n</option>
              <option value="essay" ${q.type==="essay"?"selected":""}>T·ª± lu·∫≠n</option>
              <option value="short4" ${q.type==="short4"?"selected":""}>Tr·∫£ l·ªùi ng·∫Øn (4 √¥)</option>
              <option value="tf4" ${q.type==="tf4"?"selected":""}>ƒê√∫ng/Sai 4 √Ω</option>
            </select>
            ${isCustom ? `<input class="qPoints input mono" style="max-width:110px" placeholder="ƒêi·ªÉm" value="${q.points??0}">` : ``}
          </div>

          <div class="qActions">
            <button class="mini" data-act="up" type="button">‚¨ÜÔ∏è</button>
            <button class="mini" data-act="down" type="button">‚¨áÔ∏è</button>
            <button class="mini" data-act="dup" type="button">üìÑ</button>
            <button class="mini danger" data-act="del" type="button">üóëÔ∏è</button>
          </div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <label style="margin:0">C√¢u h·ªèi</label>
          ${latexButtonHtml()}
        </div>
        <textarea class="qPrompt" placeholder="D√πng $...$ cho to√°n (vd: $x^2$)">${esc(q.prompt||"")}</textarea>

        <div class="imgRow">
          <div class="imgDrop" data-imgdrop="1">
            <div style="min-width:220px">
              <div style="font-weight:950">·∫¢nh c√¢u h·ªèi</div>
              <small>Paste / k√©o th·∫£ / ch·ªçn file ‚Ä¢ t·ª± resize max 1200px</small>
              <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn" data-act="pickimg" type="button">üì∑ Ch·ªçn ·∫£nh</button>
                <button class="btn btn-ghost" data-act="removeimg" type="button">üóëÔ∏è X√≥a ·∫£nh</button>
              </div>
            </div>
          </div>
          <img class="imgPreview" alt="preview" src="${img ? esc(img) : ""}" style="${img ? "display:block" : "display:none"}"/>
        </div>

        <div class="qEssay ${q.type==="essay"?"":"hidden"}">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <label style="margin:10px 0 0">ƒê√°p √°n (nhi·ªÅu ƒë√°p √°n d√πng d·∫•u |)</label>
            ${latexButtonHtml()}
          </div>
          <input class="qAnswers input mono" placeholder="vd: th√≠ch nghi|thich nghi" value="${esc((q.answers||[]).join("|"))}">
        </div>

        <div class="qMcq ${q.type==="mcq1"?"":"hidden"}">
          <label>4 l·ª±a ch·ªçn</label>
          <div class="grid2">
            <input class="qOpt input" data-k="0" placeholder="A" value="${esc(q.meta?.options?.[0]||"")}">
            <input class="qOpt input" data-k="1" placeholder="B" value="${esc(q.meta?.options?.[1]||"")}">
            <input class="qOpt input" data-k="2" placeholder="C" value="${esc(q.meta?.options?.[2]||"")}">
            <input class="qOpt input" data-k="3" placeholder="D" value="${esc(q.meta?.options?.[3]||"")}">
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between">
            <label style="margin:10px 0 0">ƒê√°p √°n ƒë√∫ng</label>
            ${latexButtonHtml()}
          </div>
          <select class="qCorrect">
            <option value="1" ${(q.meta?.correct||1)==1?"selected":""}>A</option>
            <option value="2" ${(q.meta?.correct||1)==2?"selected":""}>B</option>
            <option value="3" ${(q.meta?.correct||1)==3?"selected":""}>C</option>
            <option value="4" ${(q.meta?.correct||1)==4?"selected":""}>D</option>
          </select>
        </div>

        <div class="qShort4 ${q.type==="short4"?"":"hidden"}">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <label style="margin:10px 0 0">ƒê√°p √°n (nhi·ªÅu ƒë√°p √°n d√πng d·∫•u |)</label>
            ${latexButtonHtml()}
          </div>
          <input class="qAnswers input mono" placeholder='vd: -0,3|9999|0,02' value="${esc((q.answers||[]).join("|"))}">
          <div class="hint" style="margin-top:6px">Khi l√†m quiz s·∫Ω hi·ªán 4 √¥ nh·∫≠p (0-9, d·∫•u ph·∫©y, d·∫•u tr·ª´).</div>
        </div>

        <div class="qTf4 ${q.type==="tf4"?"":"hidden"}">
          <label>4 √Ω (m·ªói √Ω 1 d√≤ng)</label>
          <div style="display:grid;gap:8px">
            <input class="qStmt input" data-k="0" placeholder="√ù A" value="${esc(q.meta?.statements?.[0]||"")}">
            <input class="qStmt input" data-k="1" placeholder="√ù B" value="${esc(q.meta?.statements?.[1]||"")}">
            <input class="qStmt input" data-k="2" placeholder="√ù C" value="${esc(q.meta?.statements?.[2]||"")}">
            <input class="qStmt input" data-k="3" placeholder="√ù D" value="${esc(q.meta?.statements?.[3]||"")}">
          </div>

          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between">
            <label style="margin:10px 0 0">ƒê√∫ng(1) / Sai(0)</label>
            ${latexButtonHtml()}
          </div>

          <div class="grid2">
            <select class="qKey" data-k="0"><option value="1">A: ƒê√∫ng</option><option value="0">A: Sai</option></select>
            <select class="qKey" data-k="1"><option value="1">B: ƒê√∫ng</option><option value="0">B: Sai</option></select>
            <select class="qKey" data-k="2"><option value="1">C: ƒê√∫ng</option><option value="0">C: Sai</option></select>
            <select class="qKey" data-k="3"><option value="1">D: ƒê√∫ng</option><option value="0">D: Sai</option></select>
          </div>

          <div class="hint" style="margin-top:6px">
            Rule: ƒë√∫ng 1 √Ω=0.25, 2 √Ω=0.5, 3 √Ω=0.5, 4 √Ω=1 (nh√¢n theo points n·∫øu custom).
          </div>
        </div>

        <div class="previewBox" data-preview="1"></div>
      </div>
    `;
  }).join("");

  // Set tf4 selects values + render preview + render katex
  qList.querySelectorAll(".qCard").forEach(card=>{
    const i = Number(card.getAttribute("data-i"));
    const q = QUESTIONS[i];
    ensureMeta(q);

    if(q?.type==="tf4"){
      const keys = q.meta?.keys || [true,false,false,false];
      card.querySelectorAll(".qKey").forEach(sel=>{
        const k = Number(sel.getAttribute("data-k"));
        sel.value = keys[k] ? "1" : "0";
      });
    }

    const pv = card.querySelector('[data-preview="1"]');
    pv.innerHTML = buildPreviewHtml(q);
    katexRenderSafe(pv);
  });
}

function syncQuestionFromCard(card){
  const i = Number(card.getAttribute("data-i"));
  const q = QUESTIONS[i];
  if(!q) return;
  ensureMeta(q);

  const type = card.querySelector(".qType")?.value || "mcq1";
  q.type = type;

  q.prompt = card.querySelector(".qPrompt")?.value || "";

  if(scoringModeEl.value === "custom"){
    q.points = Number(card.querySelector(".qPoints")?.value || "0") || 0;
  }else{
    q.points = null;
  }

  if(type==="essay"){
    const raw = card.querySelector(".qAnswers")?.value || "";
    q.answers = raw.split("|").map(s=>s.trim()).filter(Boolean);
    q.meta = { ...(q.meta||{}), fuzzy:true, image_data_url:q.meta.image_data_url||"", image_url:q.meta.image_url||"" };
  }else if(type==="short4"){
    const raw = card.querySelector(".qAnswers")?.value || "";
    q.answers = raw.split("|").map(s=>s.trim()).filter(Boolean);
    q.meta = { ...(q.meta||{}), format:"4boxes", image_data_url:q.meta.image_data_url||"", image_url:q.meta.image_url||"" };
  }else if(type==="mcq1"){
    const opts = Array.from(card.querySelectorAll(".qOpt")).map(x=>x.value);
    const correct = Number(card.querySelector(".qCorrect")?.value || "1") || 1;
    // IMPORTANT: set answers ƒë·ªÉ backend n√†o c≈©ng ch·∫•m ƒë∆∞·ª£c
    const letter = ["A","B","C","D"][Math.max(1,Math.min(4,correct))-1];
    q.answers = [letter];
    q.meta = { ...(q.meta||{}), options: opts, correct, image_data_url:q.meta.image_data_url||"", image_url:q.meta.image_url||"" };
  }else if(type==="tf4"){
    const stmts = Array.from(card.querySelectorAll(".qStmt")).map(x=>x.value);
    const keys = Array.from(card.querySelectorAll(".qKey")).map(x=>x.value==="1");
    // answers c≈©ng g·∫Øn keys ƒë·ªÉ backend n√†o c≈©ng ‚ÄúƒÉn‚Äù
    q.answers = keys.map(v=>v? "T":"F");
    q.meta = { ...(q.meta||{}),
      statements: stmts,
      keys,
      rule: { byCorrectCount: { "0":0, "1":0.25, "2":0.5, "3":0.5, "4":1 } },
      image_data_url:q.meta.image_data_url||"", image_url:q.meta.image_url||""
    };
  }

  // update preview
  const pv = card.querySelector('[data-preview="1"]');
  if(pv){
    pv.innerHTML = buildPreviewHtml(q);
    katexRenderSafe(pv);
  }
}

qList.addEventListener("input",(e)=>{
  const card = e.target.closest(".qCard");
  if(!card) return;
  syncQuestionFromCard(card);
},{passive:true});

qList.addEventListener("change",(e)=>{
  const card = e.target.closest(".qCard");
  if(!card) return;

  if(e.target.classList.contains("qType")){
    setLastType(e.target.value);
    syncQuestionFromCard(card);
    renderQuestions();
  }else{
    syncQuestionFromCard(card);
  }
},{passive:true});

qList.addEventListener("click",(e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  const card = btn.closest(".qCard");
  if(!card) return;
  const i = Number(card.getAttribute("data-i"));
  const act = btn.getAttribute("data-act");
  if(!act) return;

  if(act==="del"){
    QUESTIONS.splice(i,1);
    renderQuestions();
    return;
  }
  if(act==="dup"){
    const clone = JSON.parse(JSON.stringify(QUESTIONS[i]));
    QUESTIONS.splice(i+1,0,clone);
    renderQuestions();
    return;
  }
  if(act==="up" && i>0){
    [QUESTIONS[i-1], QUESTIONS[i]] = [QUESTIONS[i], QUESTIONS[i-1]];
    renderQuestions();
    return;
  }
  if(act==="down" && i<QUESTIONS.length-1){
    [QUESTIONS[i+1], QUESTIONS[i]] = [QUESTIONS[i], QUESTIONS[i+1]];
    renderQuestions();
    return;
  }
  if(act==="removeimg"){
    ensureMeta(QUESTIONS[i]);
    QUESTIONS[i].meta.image_data_url = "";
    QUESTIONS[i].meta.image_url = "";
    renderQuestions();
    toast("ƒê√£ x√≥a ·∫£nh");
    return;
  }
  if(act==="pickimg"){
    IMG_PICK_FOR_INDEX = i;
    qImgPick.click();
    return;
  }
  if(act==="latex"){
    // ch√®n $ $ v√†o input/textarea g·∫ßn nh·∫•t (∆∞u ti√™n element ƒëang focus)
    const active = document.activeElement;
    const target = (active && (active.tagName==="TEXTAREA" || active.tagName==="INPUT")) ? active : card.querySelector(".qPrompt");
    if(!target) return;
    insertAtCursor(target, "$$SEL$$", -1); // ƒë·∫∑t con tr·ªè v√†o gi·ªØa
    return;
  }
});

function scrollToLastQuestionAndFocus(){
  const cards = qList.querySelectorAll(".qCard");
  const last = cards[cards.length-1];
  if(!last) return;
  last.scrollIntoView({behavior:"smooth", block:"center"});
  setTimeout(()=> last.querySelector(".qPrompt")?.focus?.(), 250);
}

document.getElementById("btnAddQFab").onclick = ()=>{
  QUESTIONS.push(defaultQuestion());
  renderQuestions();
  scrollToLastQuestionAndFocus();
};

/* scoring mode rerender */
scoringModeEl.addEventListener("change", ()=>{
  renderQuestions();
},{passive:true});

/* ================== IMAGE (per question) ================== */
const qImgPick = document.getElementById("qImgPick");
let IMG_PICK_FOR_INDEX = -1;

function readImageToDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(String(fr.result||""));
    fr.onerror = ()=>reject(new Error("read file error"));
    fr.readAsDataURL(file);
  });
}
async function downscaleDataURL(dataUrl, maxW=1200){
  const img = new Image();
  img.src = dataUrl;
  await new Promise((res,rej)=>{ img.onload=res; img.onerror=()=>rej(new Error("image load error")); });
  const w = img.naturalWidth || img.width;
  const h = img.naturalHeight || img.height;
  if(!w || !h) return dataUrl;
  if(w <= maxW) return dataUrl;

  const ratio = maxW / w;
  const nw = Math.round(w * ratio);
  const nh = Math.round(h * ratio);
  const c = document.createElement("canvas");
  c.width = nw; c.height = nh;
  const ctx = c.getContext("2d");
  ctx.drawImage(img, 0, 0, nw, nh);

  // l∆∞u jpeg cho nh·∫π
  return c.toDataURL("image/jpeg", 0.86);
}
async function setQuestionImage(i, file){
  if(i<0 || i>=QUESTIONS.length) return;
  if(!file || !/^image\//.test(file.type)) return toast("Ch·ªâ nh·∫≠n ·∫£nh");
  const raw = await readImageToDataURL(file);
  const scaled = await downscaleDataURL(raw);
  ensureMeta(QUESTIONS[i]);
  QUESTIONS[i].meta.image_data_url = scaled;  // local preview
  // KH√îNG set image_url ·ªü ƒë√¢y, publish m·ªõi upload
  renderQuestions();
  toast("ƒê√£ g·∫Øn ·∫£nh (s·∫Ω upload khi Publish)");
}

qImgPick.addEventListener("change", async ()=>{
  const f = qImgPick.files?.[0];
  if(!f) return;
  const i = IMG_PICK_FOR_INDEX;
  IMG_PICK_FOR_INDEX = -1;
  qImgPick.value = "";
  try{ await setQuestionImage(i, f); }catch(e){ toast("L·ªói ·∫£nh"); }
});

qList.addEventListener("dragover",(e)=>{
  const card = e.target.closest(".qCard");
  const drop = e.target.closest("[data-imgdrop]");
  if(!card || !drop) return;
  e.preventDefault();
},{passive:false});

qList.addEventListener("drop", async (e)=>{
  const card = e.target.closest(".qCard");
  const drop = e.target.closest("[data-imgdrop]");
  if(!card || !drop) return;
  e.preventDefault();
  const i = Number(card.getAttribute("data-i"));
  const f = e.dataTransfer?.files?.[0];
  if(!f) return;
  try{ await setQuestionImage(i, f); }catch{ toast("L·ªói ·∫£nh"); }
},{passive:false});

// paste image: g·∫Øn v√†o c√¢u ƒëang focus
window.addEventListener("paste", async (e)=>{
  const items = e.clipboardData?.items || [];
  const imgItem = Array.from(items).find(it=>it.type && it.type.startsWith("image/"));
  if(!imgItem) return;
  const f = imgItem.getAsFile();
  if(!f) return;

  const active = document.activeElement;
  const card = active ? active.closest?.(".qCard") : null;
  if(!card) return;
  const i = Number(card.getAttribute("data-i"));
  try{ await setQuestionImage(i, f); }catch{ toast("L·ªói ·∫£nh"); }
},{passive:true});

/* ================== IMPORT PARSER (strip *) ================== */
const importBox = document.getElementById("importBox");
document.getElementById("btnImportReplace").onclick = ()=>{
  const parsed = parseImportText(importBox.value);
  if(!parsed.length) return toast("Kh√¥ng parse ƒë∆∞·ª£c g√¨");
  QUESTIONS = parsed;
  renderQuestions();
  setQBMode("manual");
  toast("ƒê√£ import (thay th·∫ø)");
};
document.getElementById("btnImportAppend").onclick = ()=>{
  const parsed = parseImportText(importBox.value);
  if(!parsed.length) return toast("Kh√¥ng parse ƒë∆∞·ª£c g√¨");
  QUESTIONS = QUESTIONS.concat(parsed);
  renderQuestions();
  setQBMode("manual");
  toast("ƒê√£ import (th√™m)");
};

function isHeaderLine(line){
  const s = line.trim();
  return /^<(tn|tl|tln|tf)>\s*@\d+\s*:/.test(s);
}
function stripStarsAll(s){
  // x√≥a *...* ·ªü ƒë·∫ßu/cu·ªëi ho·∫∑c trong chu·ªói (case import d√≠nh ‚Äú*C*  bla‚Äù)
  let t = String(s||"");
  t = t.replace(/\*(.*?)\*/g, "$1");
  return t.trim();
}
function parseImportText(text){
  const lines = String(text||"").replace(/\r/g,"").split("\n");
  const blocks = [];
  let cur = null;

  function pushCur(){
    if(!cur) return;
    blocks.push(cur);
    cur = null;
  }

  for(let i=0;i<lines.length;i++){
    const line = lines[i].trimEnd();
    if(isHeaderLine(line)){
      pushCur();
      const m = line.trim().match(/^<(tn|tl|tln|tf)>\s*@(\d+)\s*:\s*(.*)$/);
      if(!m) continue;
      cur = { tag:m[1], n:Number(m[2]||0), head:(m[3]||"").trim(), body:[] };
      continue;
    }
    if(!cur) continue;
    const t = line.trim();
    if(t.length===0) continue;
    cur.body.push(t);
  }
  pushCur();

  const out = [];
  for(const b of blocks){
    const tag = b.tag;
    const head = stripStarsAll(b.head || "");
    const body = (b.body||[]).map(x=>x.trim()).filter(Boolean);

    if(tag==="tn"){
      const opts = [];
      let correctIdx = 1;
      for(const ln0 of body){
        const ln = String(ln0);
        const isCorrect = /\*.*\*/.test(ln) && ln.includes("*");
        const cleaned = stripStarsAll(ln);
        if(cleaned) opts.push(cleaned);
        if(isCorrect && cleaned) correctIdx = opts.length;
      }
      while(opts.length<4) opts.push("");
      const options4 = opts.slice(0,4);
      if(correctIdx<1 || correctIdx>4) correctIdx = 1;
      const letter = ["A","B","C","D"][correctIdx-1];

      out.push({
        type:"mcq1",
        prompt: head,
        answers: [letter],
        points: null,
        meta: { options: options4, correct: correctIdx, image_data_url:"", image_url:"" }
      });
      continue;
    }

    if(tag==="tl"){
      let answers = [];
      // ch·∫•p nh·∫≠n d·∫°ng: "*a*|*b*" trong 1 d√≤ng ho·∫∑c nhi·ªÅu d√≤ng
      const joined = body.join("\n");
      const parts = joined.split("|").map(x=>x.trim()).filter(Boolean);
      answers = parts.map(stripStarsAll).filter(Boolean);
      out.push({
        type:"essay",
        prompt: head,
        answers,
        points: null,
        meta: { fuzzy:true, image_data_url:"", image_url:"" }
      });
      continue;
    }

    if(tag==="tln"){
      const joined = body.join("\n");
      const parts = joined.split("|").map(x=>x.trim()).filter(Boolean);
      const answers = parts.map(stripStarsAll).filter(Boolean);
      out.push({
        type:"short4",
        prompt: head,
        answers,
        points: null,
        meta: { format:"4boxes", image_data_url:"", image_url:"" }
      });
      continue;
    }

    if(tag==="tf"){
      const stmts = ["","","",""];
      const keys = [false,false,false,false];
      for(const ln0 of body){
        const s = String(ln0).trim();
        const mm = s.match(/^\|?\s*([A-D])\s*:\s*(.*?)\s*\*([TF])\*\s*\|?\s*$/i);
        if(!mm) continue;
        const letter = mm[1].toUpperCase();
        const textPart = stripStarsAll(mm[2]||"");
        const tf = mm[3].toUpperCase();
        const idx = "ABCD".indexOf(letter);
        if(idx>=0){
          stmts[idx] = textPart;
          keys[idx] = (tf==="T");
        }
      }
      out.push({
        type:"tf4",
        prompt: head,
        answers: keys.map(v=>v?"T":"F"),
        points: null,
        meta: {
          statements: stmts,
          keys,
          rule:{ byCorrectCount:{ "0":0, "1":0.25, "2":0.5, "3":0.5, "4":1 } },
          image_data_url:"", image_url:""
        }
      });
      continue;
    }
  }

  const last = out[out.length-1];
  if(last && isAllowedQType(last.type)) setLastType(last.type);
  return out;
}

/* ================== APPLY SCORING ================== */
function applyScoring(items){
  const mode = scoringModeEl.value;
  const total = Number(totalScoreEl.value || "10") || 10;
  if(!items.length) return items;

  if(mode === "equal"){
    const per = total / items.length;
    let sum = 0;
    return items.map((q,i)=>{
      const p = (i === items.length-1) ? (total - sum) : Math.round(per*100)/100;
      if(i !== items.length-1) sum += p;
      return { ...q, points: Math.round(p*100)/100 };
    });
  }
  return items.map(q=>({ ...q, points: (q.points==null?0:Number(q.points)||0) }));
}

/* ================== SAVE / PUBLISH ================== */
document.getElementById("btnNewQuiz").onclick = ()=>{
  CURRENT_QID = "";
  setMode("NEW");

  quizIdEl.value = "";
  titleEl.value = "";
  subEl.value = "";
  isPublicEl.value = "true";
  showInStoreEl.value = "true";
  requireLoginEl.value = "true";
  pinnedEl.value = "false";
  requireCodeEl.value = "false";
  accessCodeEl.value = "";
  shuffleModeEl.value = "none";
  scoringModeEl.value = "equal";
  totalScoreEl.value = "10";

  QUESTIONS = [];
  renderQuestions();
  setLastType("mcq1");
  setQBMode("manual");
  toast("T·∫°o m·ªõi: OK");
};

async function saveQuizOnly(){
  const token = getToken();
  if(!token) throw new Error("Ch∆∞a login");

  let qid = (CURRENT_MODE==="EDIT") ? CURRENT_QID : normalizeQuizId(quizIdEl.value);
  if(CURRENT_MODE==="NEW" && !qid){
    qid = genQuizId5();
    quizIdEl.value = qid;
  }
  if(!qid || qid.length!==5) throw new Error("Quiz ID ph·∫£i ƒë√∫ng 5 ch·ªØ a-z");

  const payload = {
    p_token: token,
    p_quiz_id: qid,
    p_title: titleEl.value.trim(),
    p_sub: subEl.value.trim(),
    p_is_public: (isPublicEl.value === "true"),
    p_show_in_store: (showInStoreEl.value === "true"),
    p_require_login: (requireLoginEl.value === "true"),
    p_pinned: (pinnedEl.value === "true"),
    p_require_access_code: (requireCodeEl.value === "true"),
    p_access_code: accessCodeEl.value.trim(),
    p_scoring_mode: scoringModeEl.value,
    p_total_score: Number(totalScoreEl.value || "10") || 10,
    p_shuffle_mode: shuffleModeEl.value  // none | q | qa
  };

  // n·∫øu DB ch∆∞a k·ªãp update signature: th·ª≠ fallback b·ªè p_shuffle_mode
  let out = null;
  try{
    out = await rpc(RPC.adminUpsertQuiz, payload);
  }catch(e){
    const m = String(e?.message||"");
    if(m.includes("Could not find the function") || m.includes("schema cache")){
      const payloadOld = { ...payload };
      delete payloadOld.p_shuffle_mode;
      out = await rpc(RPC.adminUpsertQuiz, payloadOld);
      toast("‚ö†Ô∏è DB ch∆∞a c·∫≠p nh·∫≠t shuffle_mode (ƒë√£ l∆∞u ph·∫ßn c∆° b·∫£n).");
    }else{
      throw e;
    }
  }

  CURRENT_QID = out.quiz_id || qid;
  quizIdEl.value = CURRENT_QID;
  setMode("EDIT");
  return CURRENT_QID;
}

document.getElementById("btnSaveQuiz").onclick = async ()=>{
  try{
    const err = validateQuiz();
    if(err) return toast(err);
    const qid = await saveQuizOnly();
    toast("Saved: " + qid);
    await reloadQuizzes();
  }catch(e){
    toast(e.message || "Save error");
  }
};

async function uploadAllImagesIfNeeded(qid, items){
  // items l√† list publish (ƒë√£ apply scoring). meta.image_data_url -> upload -> meta.image_url
  for(let i=0;i<items.length;i++){
    const it = items[i];
    const meta = it.meta || {};
    const dataUrl = meta.image_data_url;
    if(!dataUrl) continue;

    try{
      const { mime, bytes } = dataUrlToBytes(dataUrl);
      const ext = extFromMime(mime);
      const path = `q/${qid}/q${String(it.no).padStart(3,"0")}-${randId()}.${ext}`;

      await storagePutObject(STORAGE_BUCKET, path, mime, bytes);

      meta.image_url = publicObjectUrl(STORAGE_BUCKET, path);
      meta.image_data_url = ""; // b·ªè base64 ƒë·ªÉ payload nh·ªè
      it.meta = meta;

      // nh·∫π nh√†ng tr√°nh rate-limit
      await sleep(60);
    }catch(e){
      // N·∫øu upload fail: v·∫´n ƒë·ªÉ data_url (nh∆∞ng c√≥ th·ªÉ publish fail n·∫øu payload l·ªõn)
      toast("‚ö†Ô∏è Upload ·∫£nh fail: " + (e.message||""));
    }
  }
  return items;
}

function buildPublishItems(){
  const scored = applyScoring(QUESTIONS).map((q, idx)=>{
    ensureMeta(q);

    // ƒë·∫£m b·∫£o lu√¥n c√≥ correct/options/keys/answers ƒë√∫ng format
    let meta = q.meta || {};
    let answers = Array.isArray(q.answers) ? q.answers : [];

    if(q.type==="mcq1"){
      const correct = Number(meta.correct||1)||1;
      const letter = ["A","B","C","D"][Math.max(1,Math.min(4,correct))-1];
      answers = [letter];
      meta.options = (meta.options||["","","",""]).slice(0,4);
      meta.correct = correct;
    }
    if(q.type==="tf4"){
      const keys = Array.isArray(meta.keys) ? meta.keys : [false,false,false,false];
      meta.keys = keys.slice(0,4);
      meta.statements = (meta.statements||["","","",""]).slice(0,4);
      answers = meta.keys.map(v=>v?"T":"F");
      meta.rule = meta.rule || { byCorrectCount:{ "0":0, "1":0.25, "2":0.5, "3":0.5, "4":1 } };
    }
    if(q.type==="essay"){
      answers = (answers||[]).map(s=>String(s).trim()).filter(Boolean);
      meta.fuzzy = true;
    }
    if(q.type==="short4"){
      answers = (answers||[]).map(s=>String(s).trim()).filter(Boolean);
      meta.format = "4boxes";
    }

    return {
      no: idx+1,

      // nhi·ªÅu backend kh√°c nhau: g·ª≠i ƒë·ªß alias
      type: q.type,
      qtype: q.type,

      prompt: (q.prompt||"").trim(),
      word: (q.prompt||"").trim(),

      answers: answers,
      points: q.points,

      meta: meta,
      q_json: meta
    };
  });

  return scored;
}

async function publishAll(){
  try{
    const err = validateQuiz();
    if(err) return toast(err);
    if(!QUESTIONS.length) return toast("Ch∆∞a c√≥ c√¢u h·ªèi");

    const qid = await saveQuizOnly();
    const token = getToken();

    let items = buildPublishItems();
    items = await uploadAllImagesIfNeeded(qid, items);

    // Replace questions
    let out2 = null;
    try{
      out2 = await rpc(RPC.adminReplaceQuestions, { p_token: token, p_quiz_id: qid, p_items: items });
    }catch(e){
      // fallback import (nh∆∞ng c·∫£nh b√°o c√≥ th·ªÉ tr√πng n·∫øu DB kh√¥ng clear)
      const m = String(e?.message||"");
      if(m.includes("Could not find the function") || m.includes("schema cache")){
        out2 = await rpc(RPC.adminImportQuestions, { p_token: token, p_quiz_id: qid, p_items: items, p_replace: true });
        toast("‚ö†Ô∏è DB ch∆∞a c√≥ replace (ƒë√£ import, nh·ªõ ki·ªÉm tra tr√πng).");
      }else{
        throw e;
      }
    }

    // Optional: regrade attempts n·∫øu DB c√≥ function
    const rg = await rpcOptional(RPC.adminRegradeQuiz, { p_token: token, p_quiz_id: qid });
    if(rg && rg.ok) toast("Regrade: OK");

    toast(`Published: ${qid}`);
    await reloadQuizzes();

    // m·ªü quiz
    location.href = `/q/${qid}`;
  }catch(e){
    toast(e.message || "Publish error");
  }
}

document.getElementById("btnPublishAll").onclick = publishAll;
document.getElementById("btnPublishAllBottom").onclick = publishAll;
document.getElementById("btnPublishAll2").onclick = publishAll;

/* ================== QUIZ LIST ================== */
const quizList = document.getElementById("quizList");

function renderQuizList(){
  if(!QUIZZES.length){
    quizList.innerHTML = `<div class="muted">Ch∆∞a c√≥ quiz.</div>`;
    return;
  }
  quizList.innerHTML = QUIZZES.map(q=>{
    const badges = [
      q.pinned ? `<span class="idx ok">PIN</span>` : "",
      q.is_public ? `<span class="idx ok">PUBLIC</span>` : `<span class="idx warn">PRIVATE</span>`,
      q.show_in_store ? `<span class="idx ok">STORE</span>` : `<span class="idx warn">HIDDEN</span>`,
      q.require_login ? `<span class="idx">LOGIN</span>` : `<span class="idx ok">OPEN</span>`,
      q.require_access_code ? `<span class="idx warn">CODE</span>` : "",
      q.shuffle_mode ? `<span class="idx">${esc(String(q.shuffle_mode).toUpperCase())}</span>` : ""
    ].filter(Boolean).join(" ");

    return `
      <div class="qItem" data-qid="${esc(q.quiz_id)}">
        <div class="row1">
          <div style="min-width:0">
            <div class="vi" style="font-size:1rem"><b>${esc(q.title||q.quiz_id)}</b></div>
            <div class="muted" style="margin-top:4px">${esc(q.sub||"")}</div>
            <div class="qBadges">${badges}</div>
          </div>
          <div class="qActions">
            <button class="mini" data-act="load" type="button">S·ª≠a</button>
            <button class="mini danger" data-act="del" type="button">Delete</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  quizList.querySelectorAll('[data-qid]').forEach(el=>{
    el.addEventListener("click",(ev)=>{
      const act = ev.target?.getAttribute?.("data-act");
      const qid = el.getAttribute("data-qid");
      if(act==="del"){ ev.stopPropagation(); delQuiz(qid); return; }
      loadQuizToForm(qid);
    });
  });
}

async function reloadQuizzes(){
  const token = getToken();
  const out = await rpc(RPC.adminListQuizzes,{p_token: token});
  QUIZZES = out.items || [];
  renderQuizList();
}
document.getElementById("btnReloadQuizzes").onclick = ()=>reloadQuizzes().catch(e=>toast(e.message));

async function delQuiz(qid){
  const ok = confirm("X√≥a quiz " + qid + " ?");
  if(!ok) return;
  const token = getToken();
  await rpc(RPC.adminDeleteQuiz,{p_token:token, p_quiz_id:qid});
  toast("Deleted " + qid);
  await reloadQuizzes();
}

function fromDbQuestion(x){
  // ch·ªëng m·ªçi ki·ªÉu schema: prompt/word, meta/q_json, type/qtype...
  const type = (x.type || x.qtype || "mcq1");
  const prompt = (x.prompt || x.word || "");
  const points = (x.points ?? null);
  const meta = (x.meta || x.q_json || {});
  const answers = (x.answers || meta.answers || []);
  return { type, prompt, points, answers, meta };
}

async function loadQuizToForm(qid){
  const q = QUIZZES.find(x=>x.quiz_id===qid);
  if(!q) return;

  CURRENT_QID = qid;
  setMode("EDIT");

  quizIdEl.value = q.quiz_id;
  titleEl.value = q.title || "";
  subEl.value = q.sub || "";
  isPublicEl.value = String(!!q.is_public);
  showInStoreEl.value = String(!!q.show_in_store);
  requireLoginEl.value = String(!!q.require_login);
  pinnedEl.value = String(!!q.pinned);
  requireCodeEl.value = String(!!q.require_access_code);
  accessCodeEl.value = "";
  scoringModeEl.value = q.scoring_mode || "equal";
  totalScoreEl.value = String(q.total_score ?? 10);
  shuffleModeEl.value = q.shuffle_mode || "none";

  // load questions from DB (KH√îNG nu·ªët l·ªói)
  QUESTIONS = [];
  renderQuestions();
  toast("ƒêang t·∫£i c√¢u h·ªèi...");

  try{
    const token = getToken();
    const out = await rpc(RPC.adminGetQuestions,{p_token: token, p_quiz_id: qid});
    const items = out.items || [];
    QUESTIONS = items.map(fromDbQuestion);

    // normalize meta image keys
    QUESTIONS.forEach(qx=>{
      ensureMeta(qx);
      // n·∫øu backend l∆∞u image_url nh∆∞ng kh√¥ng c√≥ key chu·∫©n
      if(!qx.meta.image_url && qx.meta.image) qx.meta.image_url = qx.meta.image;
      if(!qx.meta.image_url && qx.meta.img_url) qx.meta.image_url = qx.meta.img_url;
      // kh√¥ng gi·ªØ base64 t·ª´ db
      if(qx.meta.image_data_url && qx.meta.image_data_url.length > 50) qx.meta.image_data_url = "";
      // mcq: n·∫øu meta.correct c√≥ m√† answers r·ªóng => set answers
      if(qx.type==="mcq1"){
        const c = Number(qx.meta.correct||1)||1;
        const letter = ["A","B","C","D"][Math.max(1,Math.min(4,c))-1];
        if(!Array.isArray(qx.answers) || qx.answers.length===0) qx.answers = [letter];
        if(!qx.meta.options) qx.meta.options = ["","","",""];
      }
      // tf4: n·∫øu meta.keys c√≥ m√† answers r·ªóng => set answers
      if(qx.type==="tf4"){
        const keys = Array.isArray(qx.meta.keys) ? qx.meta.keys : [false,false,false,false];
        qx.meta.keys = keys.slice(0,4);
        if(!Array.isArray(qx.answers) || qx.answers.length===0) qx.answers = qx.meta.keys.map(v=>v?"T":"F");
        qx.meta.statements = (qx.meta.statements||["","","",""]).slice(0,4);
      }
    });

    renderQuestions();
    setQBMode(QB_MODE);
    toast("Loaded " + qid);
  }catch(e){
    QUESTIONS = [];
    renderQuestions();
    toast("Load c√¢u h·ªèi l·ªói: " + (e.message||""));
  }
}

/* ================== USERS ================== */
const userList = document.getElementById("userList");
const userSearch = document.getElementById("userSearch");

function renderUsers(){
  const q = (userSearch.value||"").trim().toLowerCase();
  const arr = q ? USERS.filter(u=>String(u.username||"").includes(q)) : USERS;

  if(!arr.length){
    userList.innerHTML = `<div class="muted">No users.</div>`;
    return;
  }

  userList.innerHTML = arr.map(u=>{
    const role = (u.role==="admin") ? `<span class="idx ok">ADMIN</span>` : `<span class="idx">USER</span>`;
    return `
      <div class="card" style="box-shadow:none;border-width:1px;margin:10px 0">
        <div class="row1">
          <div style="min-width:0">
            <div class="vi" style="font-size:1rem"><b>${esc(u.username)}</b> ${role}</div>
            <div class="muted" style="margin-top:6px">id: <code>${esc(u.id)}</code></div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn" data-act="rename" data-id="${esc(u.id)}" type="button">Rename</button>
            <button class="btn" data-act="reset" data-id="${esc(u.id)}" type="button">Reset PIN</button>
            <button class="btn btn-danger" data-act="del" data-id="${esc(u.id)}" type="button">Delete</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  userList.querySelectorAll("button[data-act]").forEach(b=>{
    b.onclick = async ()=>{
      const act = b.getAttribute("data-act");
      const id = b.getAttribute("data-id");
      if(act==="del") return delUser(id);
      if(act==="rename") return renameUser(id);
      if(act==="reset") return resetPin(id);
    };
  });
}

async function reloadUsers(){
  const token = getToken();
  const out = await rpc(RPC.adminListUsers,{p_token: token});
  USERS = out.items || [];
  renderUsers();
}
document.getElementById("btnReloadUsers").onclick = ()=>reloadUsers().catch(e=>toast(e.message));
userSearch.addEventListener("input", ()=>renderUsers(), {passive:true});

async function delUser(id){
  const ok = confirm("X√≥a user n√†y? (m·∫•t progress/attempts/comments)");
  if(!ok) return;
  const token = getToken();
  await rpc(RPC.adminDeleteUser,{p_token:token, p_user_id:id});
  toast("Deleted user");
  await reloadUsers();
}
async function renameUser(id){
  const newU = prompt("New username (lowercase, a-z0-9_):");
  if(!newU) return;
  const token = getToken();
  await rpc(RPC.adminForceRename,{p_token:token, p_user_id:id, p_new_username:newU});
  toast("Renamed");
  await reloadUsers();
}
async function resetPin(id){
  const pin = prompt("Set new PIN (4-6 digits).");
  if(!pin) return;
  const token = getToken();
  await rpc(RPC.adminForceSetPin,{p_token:token, p_user_id:id, p_new_pin:pin});
  toast("PIN reset");
}

/* ================== BOOT ================== */
(async () => {
  try {
    const ok = await gateCheck();
    if (!ok) return;

    setMode("NEW");
    setQBMode(QB_MODE || "manual");
    setLastType(LAST_QTYPE || "mcq1");

    QUESTIONS = [];
    renderQuestions();

    document
      .getElementById("btnPublishAll2")
      ?.addEventListener("click", () =>
        document.getElementById("btnPublishAll")?.click()
      );

    await reloadQuizzes();
    await reloadUsers();
    setTab("q");

    // KaTeX render l·∫°i l·∫ßn n·ªØa cho ch·∫Øc
    setTimeout(() => {
      document
        .querySelectorAll('[data-preview="1"]')
        .forEach(pv => katexRenderSafe(pv));
    }, 400);

  } catch (e) {
    console.error("BOOT ERROR", e);
    toast("Boot error: " + (e.message || e));
  }
})();

</script>
</body>
</html>
