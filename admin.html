<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Admin Panel</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <!-- MathJax: render LaTeX -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true
      },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <style>
    :root{
      --bg1:#ffecd2; --bg2:#fcb69f;
      --card:#fff; --text:#1f2937; --muted:#6b7280;
      --primary:#7c3aed; --bad:#dc2626; --ok:#16a34a;
      --border:#e5e7eb; --soft:#f8fafc;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --radius:18px; --admin:#2563eb;
      --purple:#7c3aed;
      --purpleSoft: rgba(124,58,237,.12);
      --purpleLine: rgba(124,58,237,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
        linear-gradient(120deg,var(--bg1) 0%, var(--bg2) 100%);
      overflow:hidden;
    }

    /* lock scroll for overlays */
    .noScroll #shell{ overflow:hidden !important; }

    #shell{height:100vh; overflow:auto; -webkit-overflow-scrolling:touch; padding:12px 0 130px}
    .wrap{max-width:1180px; margin:0 auto; padding:0 14px}

    .topbar{
      margin-top:10px;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(229,231,235,.9);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .titlebox{display:flex; gap:10px; align-items:center; flex:1 1 420px; min-width:240px}
    .logo{
      width:42px; height:42px; border-radius:16px;
      background:linear-gradient(135deg,#a78bfa,#fb7185);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:900;
      box-shadow:0 10px 22px rgba(124,58,237,.18);
      user-select:none;
    }
    .titles h1{font-size:1.02rem; margin:0; font-weight:800}
    .titles .tiny{margin-top:3px; font-size:.86rem; color:var(--muted); font-weight:650}
    a{color:#4c1d95; text-decoration:none; font-weight:950}
    a:hover{text-decoration:underline}

    .pill{
      background:#f3f4f6; border:1px solid #e5e7eb;
      border-radius:999px; padding:8px 12px;
      font-weight:900; font-size:.9rem; color:#374151; white-space:nowrap;
      display:flex; gap:8px; align-items:center;
    }
    .badge-admin{
      padding:4px 8px; border-radius:999px; font-weight:950; font-size:.78rem;
      background:rgba(37,99,235,.12);
      border:1px solid rgba(37,99,235,.35);
      color:var(--admin); white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin:12px 0;
    }
    .row1{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .vi{margin:0; font-weight:900; font-size:1.04rem; line-height:1.25}
    .muted{color:var(--muted); font-weight:650}
    .idx{
      font-size:.78rem; font-weight:900;
      padding:6px 10px; border-radius:999px;
      background:#eff6ff; color:#1d4ed8; border:1px solid #dbeafe;
      white-space:nowrap;
    }
    .idx.ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .idx.warn{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .idx.bad{background:#fee2e2;color:#991b1b;border-color:#fecaca}

    .btn{
      border:0; cursor:pointer;
      border-radius:999px; padding:10px 14px;
      font-weight:900; font-size:.9rem;
      transition:transform .16s ease, filter .16s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none; white-space:nowrap;
      box-shadow:0 12px 24px rgba(0,0,0,.12);
      background:#fff; color:#111827; border:1px solid #e5e7eb;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(.98)}
    .btn:active{transform:translateY(0)}
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none !important; filter:none !important}
    .btn-primary{
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      color:#fff; border:0;
      box-shadow:0 12px 24px rgba(124,58,237,.18);
    }
    .btn-danger{background:var(--bad); color:#fff; border:0; box-shadow:0 12px 24px rgba(220,38,38,.18);}
    .btn-ok{background:var(--ok); color:#fff; border:0; box-shadow:0 12px 24px rgba(22,163,74,.18);}
    .btn-ghost{background:#fff; color:#111827; border:1px solid #e5e7eb; box-shadow:none}

    .input, textarea, select{
      width:100%;
      border-radius:14px; border:2px solid #e5e7eb;
      padding:11px 12px; font-size:.95rem; font-weight:700;
      outline:none; background:var(--soft);
      transition:border-color .15s ease, box-shadow .15s ease;
      font-family:inherit;
    }
    textarea{min-height:110px; font-family:ui-monospace,Consolas,monospace; font-weight:650}
    .input:focus, textarea:focus, select:focus{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 0 0 5px rgba(124,58,237,.10);
      background:#fff;
    }
    label{display:block; margin-top:10px; font-weight:900}

    .tabs{display:flex; gap:10px; flex-wrap:wrap}
    .tab{padding:10px 14px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; font-weight:950; cursor:pointer; box-shadow:none}
    .tab.active{background:linear-gradient(135deg,#7c3aed,#fb7185); color:#fff; border:0}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:640px){ .grid2{grid-template-columns:1fr} }

    code{background:#f6f6f6;padding:2px 6px;border-radius:8px;border:1px solid #eee}
    .mono{font-family:ui-monospace,Consolas,monospace}
    .hr{height:1px;background:#e5e7eb;margin:12px 0}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(17,24,39,.92); color:#fff;
      padding:10px 12px; border-radius:14px;
      font-weight:800; font-size:.9rem;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width:calc(100% - 28px);
      z-index:20050; text-align:center;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}

    /* ===== Quiz pages ===== */
    .hidden{display:none !important;}
    .quizPage{display:none;}
    .quizPage.show{display:block;}

    /* ===== Editor (All questions) ===== */
    .editorHeader{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .editorHeaderLeft{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      min-width:240px;
    }
    .editorTitle{
      font-weight:1000;
      font-size:1.02rem;
      line-height:1.2;
    }
    .editorSub{
      color:var(--muted);
      font-weight:700;
      font-size:.86rem;
      margin-top:4px;
    }

    .qAllHost{
      margin-top:12px;
      display:grid;
      gap:12px;
    }
    .qCard{
      border:2px solid var(--purpleLine);
      border-radius:18px;
      background:#fff;
      box-shadow:0 18px 50px rgba(0,0,0,.10);
      padding:14px;
    }
    .qCardHead{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding-bottom:10px;
      border-bottom:1px dashed rgba(229,231,235,.95);
      margin-bottom:10px;
    }
    .qHeadLeft{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .qHeadRight{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .mini{
      padding:8px 10px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#fff;
      font-weight:900;
      cursor:pointer;
      box-shadow:none;
    }
    .mini.primary{
      border:0;
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      color:#fff;
    }
    .mini.ok{ border:0; background:var(--ok); color:#fff; }
    .mini.danger{border:0;background:var(--bad);color:#fff}

    .qTypeSel{ padding:9px 12px; border-radius:14px; border:2px solid #e5e7eb; background:var(--soft); font-weight:900; }
    .qPoints{ max-width:120px; }

    .qPromptGrid{
      display:grid;
      grid-template-columns: 1fr 240px;
      gap:10px;
      align-items:start;
      margin-top:8px;
    }
    @media(max-width:780px){
      .qPromptGrid{ grid-template-columns: 1fr; }
    }

    .imgSide{
      border:1px solid rgba(229,231,235,.95);
      border-radius:16px;
      padding:10px;
      background:rgba(248,250,252,.7);
    }
    .imgSideHead{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      margin-bottom:8px;
    }
    .imgPreviewSmall{
      width:100%;
      height:140px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#fff;
      object-fit:cover;
      display:block;
    }
    .imgSideBtns{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .mathPreviewBox{
      margin-top:8px;
      border:1px solid rgba(229,231,235,.95);
      border-radius:14px;
      padding:10px;
      background:#fff;
    }
    .mathPreview{
      font-weight:700;
      line-height:1.5;
      min-height:24px;
      overflow:auto;
    }

    .hint{font-weight:650;color:var(--muted);line-height:1.35; font-size:.88rem}

    /* Floating add button */
    .fabAdd{
      position:fixed;
      right:16px;
      bottom:calc(env(safe-area-inset-bottom) + 16px);
      z-index:20040;
      border:0;
      border-radius:999px;
      padding:12px 14px;
      font-weight:1000;
      cursor:pointer;
      color:#fff;
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      box-shadow:0 18px 40px rgba(124,58,237,.22);
      display:none;
      gap:10px;
      align-items:center;
    }
    .fabAdd.show{display:inline-flex;}
    .fabDot{
      width:34px;height:34px;border-radius:999px;
      background:rgba(255,255,255,.18);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;font-weight:1000;
    }

    /* ===== Modals ===== */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(17,24,39,.55);
      z-index:20100;
      display:none;
      padding:16px;
      overflow:auto; /* IMPORTANT: scroll inside overlay */
    }
    .modalBack.show{display:flex; align-items:center; justify-content:center;}
    .modal{
      width:min(980px, 100%);
      background:rgba(255,255,255,.98);
      border:1px solid rgba(229,231,235,.95);
      box-shadow:0 18px 50px rgba(0,0,0,.25);
      border-radius:18px;
      overflow:hidden;
      max-height:calc(100vh - 32px);
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding:12px 14px;
      border-bottom:1px solid rgba(229,231,235,.95);
      background:rgba(248,250,252,.9);
    }
    .modalTitle{font-weight:1000}
    .modalClose{
      border:1px solid #e5e7eb;
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      font-weight:1000;
      cursor:pointer;
    }
    .modalBody{
      padding:14px;
      overflow:auto; /* IMPORTANT: scroll inside modal body */
      -webkit-overflow-scrolling:touch;
    }
    .modalBackBtn{
      border:1px solid #e5e7eb;
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      font-weight:1000;
      cursor:pointer;
      box-shadow:none;
    }

    /* ===== LaTeX modal tweaks ===== */
    .latexTplGrid{ display:flex; gap:8px; flex-wrap:wrap; }
    .latexChip{
      border:1px solid #e5e7eb;
      background:#fff;
      border-radius:999px;
      padding:9px 12px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      box-shadow:none;
    }
    .latexTiny{font-size:.86rem; color:var(--muted); font-weight:750}
    .latexPreviewWrap{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:start;
    }
    @media(max-width:860px){
      .latexPreviewWrap{ grid-template-columns: 1fr; }
    }
    .latexPreviewBox{
      border:1px solid rgba(229,231,235,.95);
      border-radius:14px;
      padding:10px;
      background:#fff;
      min-height:64px;
      overflow:auto;
    }
    .btnCloseRed{
      background:var(--bad);
      color:#fff;
      border:0;
      border-radius:12px;
      padding:8px 10px;
      font-weight:1000;
      cursor:pointer;
      box-shadow:none;
    }
  </style>
</head>

<body>
  <div id="shell">
    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">A</div>
          <div class="titles">
            <h1>Admin Panel</h1>
            <div class="tiny"><a href="/">← về kệ hàng</a></div>
          </div>
        </div>
        <div class="pill" id="mePill">Checking…</div>
      </div>

      <div class="card" id="gate">Checking login...</div>

      <div id="app" style="display:none">
        <div class="card">
          <div class="row1">
            <p class="vi">Bảng điều khiển</p>
            <div class="tabs">
              <button class="tab active" id="tabQuizzes" type="button">Quizzes</button>
              <button class="tab" id="tabUsers" type="button">Users</button>
            </div>
          </div>
        </div>

        <!-- QUIZZES -->
        <div id="viewQuizzes">
          <!-- PAGE: LIST (default) -->
          <div id="quizListPage" class="quizPage show">
            <div class="card">
              <div class="row1">
                <p class="vi">Danh sách quiz</p>
                <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                  <button class="btn" id="btnGoCreate" type="button">Tạo mới</button>
                  <button class="btn" id="btnReloadQuizzes" type="button">Reload</button>
                </div>
              </div>
              <div id="quizList" style="margin-top:10px"></div>
            </div>

            <div class="hint" style="margin-top:4px">
              Vào admin sẽ hiện danh sách quiz. Bấm “Tạo mới” để tạo quiz, sau đó vào trang soạn câu hỏi.
            </div>
          </div>

          <!-- PAGE: CREATE (step 1) -->
          <div id="quizCreatePage" class="quizPage">
            <div class="card">
              <div class="row1">
                <div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap">
                  <button class="btn btn-ghost" id="btnCreateCancelTop" type="button">← Quay lại</button>
                  <div>
                    <p class="vi" style="margin-bottom:4px">Tạo quiz</p>
                    <div class="muted">Quiz ID sẽ tự tạo ngẫu nhiên (không trùng). Lưu xong sẽ chuyển sang trang soạn câu hỏi.</div>
                  </div>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px">
                <div style="grid-column:1 / -1">
                  <label>Title</label>
                  <input class="input" id="createTitle" placeholder="Tên quiz" />
                </div>
              </div>

              <label>Sub</label>
              <input class="input" id="createSub" placeholder="Mô tả ngắn" />

              <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn" id="btnCreateSaveOnly" type="button">Lưu</button>
                <button class="btn btn-primary" id="btnCreateNext" type="button">Tiếp tục soạn câu hỏi</button>
              </div>

              <div class="hint" style="margin-top:10px">
                Các cài đặt (Public, hiện trên store, yêu cầu login, trộn câu hỏi...) chỉnh trong nút “Cài đặt” ở trang soạn.
              </div>
            </div>
          </div>

          <!-- PAGE: EDITOR -->
          <div id="quizEditorPage" class="quizPage">
            <div class="card">
              <div class="editorHeader">
                <div class="editorHeaderLeft">
                  <button class="btn btn-ghost" id="btnBackToList" type="button">← Quay lại</button>
                  <div>
                    <div class="editorTitle" id="editorTitle">Soạn câu hỏi</div>
                    <div class="editorSub" id="editorSub"></div>
                  </div>
                  <span class="idx" id="qCountPill">0</span>
                </div>

                <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                  <button class="btn" id="btnOpenSettings" type="button">Cài đặt</button>
                  <button class="btn" id="btnOpenImport" type="button">Import</button>
                  <button class="btn btn-primary" id="btnPublishAll" type="button">Publish</button>
                </div>
              </div>

              <div class="hint" style="margin-top:10px">
                Trang này hiển thị <b>tất cả</b> câu hỏi để sửa trực tiếp. LaTeX: dùng <code>$...$</code> hoặc <code>$$...$$</code>. Ảnh sẽ upload lên bucket <code>quiz</code>.
              </div>

              <div id="qAllHost" class="qAllHost"></div>
            </div>
          </div>
        </div>

        <!-- USERS -->
        <div id="viewUsers" style="display:none">
          <div class="card">
            <div class="row1">
              <p class="vi">Users</p>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <input class="input" id="userSearch" placeholder="Search username..." style="max-width:320px"/>
                <button class="btn" id="btnReloadUsers" type="button">Reload</button>
              </div>
            </div>
            <div id="userList" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- floating add question (always follow) -->
  <button class="fabAdd" id="fabAddQuestion" type="button" aria-label="Thêm câu hỏi">
    <span class="fabDot">+</span>
    Thêm câu hỏi
  </button>

  <input id="qImgPick" type="file" accept="image/*" style="display:none" />
  <div class="toast" id="toast"></div>

  <!-- MODAL: Quiz settings (popup) -->
  <div class="modalBack" id="settingsModalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <button class="modalBackBtn" id="btnBackSettings" type="button">← Quay lại</button>
        <div class="modalTitle">Cài đặt quiz</div>
        <button class="modalClose" id="btnCloseSettings" type="button">X</button>
      </div>
      <div class="modalBody">
        <div class="hint">
          Chỉnh Title/Sub và các cài đặt. Bấm “Lưu” để áp dụng.
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Quiz ID</label>
            <input class="input mono" id="quizId" disabled />
          </div>
          <div>
            <label>Title</label>
            <input class="input" id="title" placeholder="Tên quiz" />
          </div>
        </div>

        <label>Sub</label>
        <input class="input" id="sub" placeholder="Mô tả ngắn" />

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Public</label>
            <select id="isPublic">
              <option value="true">Public</option>
              <option value="false">Private</option>
            </select>
          </div>
          <div>
            <label>Hiện trên store</label>
            <select id="showInStore">
              <option value="true">Hiện</option>
              <option value="false">Ẩn</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Yêu cầu login</label>
            <select id="requireLogin">
              <option value="true">Cần login</option>
              <option value="false">Không cần login</option>
            </select>
          </div>
          <div>
            <label>Ghim</label>
            <select id="pinned">
              <option value="false">Không</option>
              <option value="true">Ghim</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Chia điểm</label>
            <select id="scoringMode">
              <option value="equal">Chia đều theo số câu</option>
              <option value="custom">Tự chia (mỗi câu có điểm)</option>
            </select>
          </div>
          <div>
            <label>Trộn câu hỏi / đáp án</label>
            <select id="shuffleMode">
              <option value="none">Không đảo</option>
              <option value="q">Đảo câu hỏi</option>
              <option value="qa">Đảo câu hỏi + đáp án</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Mã truy cập</label>
            <select id="requireCode">
              <option value="false">Không</option>
              <option value="true">Có</option>
            </select>
          </div>
          <div>
            <label>Code</label>
            <input class="input mono" id="accessCode" placeholder="vd: 1234" />
          </div>
        </div>

        <div id="totalScoreWrap">
          <label>Tổng điểm</label>
          <input class="input mono" id="totalScore" value="10" />
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btn-ghost" id="btnCloseSettings2" type="button">Đóng</button>
          <button class="btn btn-primary" id="btnSaveQuiz" type="button">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Import -->
  <div class="modalBack" id="importModalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <button class="modalBackBtn" id="btnBackImport" type="button">← Quay lại</button>
        <div class="modalTitle">Import câu hỏi</div>
        <button class="modalClose" id="btnCloseImport" type="button">X</button>
      </div>
      <div class="modalBody">
        <div class="hint">
          Import theo định dạng (mỗi block bắt đầu bằng tag). Hệ thống tự xoá *...* / **...** quanh đáp án đúng.
          <div class="mono" style="white-space:pre-wrap; margin-top:8px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:10px">
&lt;tn&gt;@1: Câu trắc nghiệm
A
B
**C**

&lt;tl&gt;@2: Câu tự luận
**Đáp án đúng**

&lt;tln&gt;@3: Trả lời ngắn
**0,02**

&lt;tf&gt;@4: Đúng/Sai 4 ý
|A: Nội dung *T*|
|B: Nội dung *F*|
|C: Nội dung *T*|
|D: Nội dung *F*|
          </div>
        </div>

        <label>Paste nội dung</label>
        <textarea id="importBox" placeholder="Dán nội dung import vào đây..."></textarea>

        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn" id="btnImportReplace" type="button">Import (thay thế)</button>
          <button class="btn btn-primary" id="btnImportAppend" type="button">Import (thêm)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: LaTeX (click outside to close, insert must press button) -->
  <div class="modalBack" id="latexModalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div class="modalTitle">Chèn LaTeX</div>
          <div class="latexTiny">Chọn mẫu → chỉnh → bấm <b>Chèn</b> để đưa vào ô đang gõ.</div>
        </div>
        <button class="btnCloseRed" id="btnCloseLatex" type="button">Đóng</button>
      </div>
      <div class="modalBody">
        <div class="latexTplGrid" id="latexGrid"></div>

        <div class="latexPreviewWrap">
          <div>
            <div class="latexTiny" style="margin-bottom:6px">Nội dung LaTeX</div>
            <textarea id="latexPreviewSrc" class="input mono" style="min-height:90px" placeholder="vd: $x^2 + \\frac{1}{2}$"></textarea>

            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
              <button class="btn btn-ghost" id="btnLatexClear" type="button">Clear</button>
              <button class="btn btn-ok" id="btnLatexInsert" type="button">Chèn</button>
            </div>
          </div>
          <div>
            <div class="latexTiny" style="margin-bottom:6px">Xem trước</div>
            <div id="latexPreview" class="latexPreviewBox"></div>
          </div>
        </div>

        <div class="hint" style="margin-top:10px">
          Tip: nếu muốn công thức inline thì dùng <code>$...$</code>, công thức khối thì <code>$$...$$</code>.
        </div>
      </div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
const SUPABASE_URL = "https://aidvlydhbdtwunyreqak.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZHZseWRoYmR0d3VueXJlcWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzM5NzYsImV4cCI6MjA4NDIwOTk3Nn0.LMKGjKlUbC5qoY7hqDpaDFQrFWfwKemBTpxjTNp_L8o";

const TOKEN_KEY = "tk_token_v2";
const TOKEN_COOKIE = "tk_token_v2";
const STORAGE_BUCKET = "quiz";

const RPC = {
  me: "api_me",
  logout: "api_logout",
  adminUpsertQuiz: "admin_upsert_quiz",
  adminListQuizzes: "admin_list_quizzes",
  adminDeleteQuiz: "admin_delete_quiz",
  adminGetQuestions: "admin_get_questions",
  adminReplaceQuestions: "admin_replace_questions_v3",
  adminImportQuestions: "admin_import_questions_v3",
  adminListUsers: "admin_list_users",
  adminDeleteUser: "admin_delete_user",
  adminForceRename: "admin_force_rename",
  adminForceSetPin: "admin_force_set_pin"
};

/* ================== UI HELPERS ================== */
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=String(msg||"");
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1300);
}
function esc(s){
  return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function lockScroll(on){
  document.body.classList.toggle("noScroll", !!on);
}

/* ====== TOKEN PERSIST ====== */
function cookieDomainHint(){
  const host = String(location.hostname||"").trim();
  if(!host || host==="localhost" || host.endsWith(".localhost")) return "";
  if(/^\d+\.\d+\.\d+\.\d+$/.test(host)) return "";
  const parts = host.split(".").filter(Boolean);
  if(parts.length < 2) return "";
  return "." + parts.slice(-2).join(".");
}
function setCookie(name, value){
  const v = encodeURIComponent(String(value||""));
  const maxAge = 60*60*24*365*20;
  const base = cookieDomainHint();
  const common = `${name}=${v}; Max-Age=${maxAge}; Path=/; SameSite=Lax`;
  document.cookie = common;
  if(base && base !== location.hostname){
    document.cookie = `${common}; Domain=${base}`;
  }
}
function getCookie(name){
  const cs = document.cookie ? document.cookie.split(";") : [];
  let found = "";
  for(const raw of cs){
    const s = raw.trim();
    if(!s) continue;
    const eq = s.indexOf("=");
    const k = (eq>=0 ? s.slice(0,eq) : s).trim();
    if(k === name) found = (eq>=0 ? s.slice(eq+1) : "");
  }
  try{ return found ? decodeURIComponent(found) : ""; }catch{ return found || ""; }
}
function delCookie(name){
  const base = cookieDomainHint();
  document.cookie = `${name}=; Max-Age=0; Path=/; SameSite=Lax`;
  if(base && base !== location.hostname){
    document.cookie = `${name}=; Max-Age=0; Path=/; SameSite=Lax; Domain=${base}`;
  }
}
function setToken(t){
  t = String(t||"").trim();
  if(!t) return;
  try{ localStorage.setItem(TOKEN_KEY, t); }catch{}
  try{ sessionStorage.setItem(TOKEN_KEY, t); }catch{}
  try{ setCookie(TOKEN_COOKIE, t); }catch{}
  try{ window.name = "tk:" + t; }catch{}
}
function clearToken(){
  try{ localStorage.removeItem(TOKEN_KEY); }catch{}
  try{ sessionStorage.removeItem(TOKEN_KEY); }catch{}
  try{ delCookie(TOKEN_COOKIE); }catch{}
  try{ if(String(window.name||"").startsWith("tk:")) window.name = ""; }catch{}
}
function getToken(){
  let t = "";
  try{ t = (localStorage.getItem(TOKEN_KEY) || "").trim(); }catch{}
  if(!t){ try{ t = (sessionStorage.getItem(TOKEN_KEY) || "").trim(); }catch{} }
  if(!t) t = (getCookie(TOKEN_COOKIE) || "").trim();
  if(!t){
    const wn = String(window.name||"");
    if(wn.startsWith("tk:")) t = wn.slice(3).trim();
  }
  try{
    const u = new URL(location.href);
    if(!t){
      const q = (u.searchParams.get("tk") || u.searchParams.get("token") || "").trim();
      if(q) t = q;
    }
    if(!t && u.hash){
      const hs = u.hash.replace(/^#/,"");
      const p = new URLSearchParams(hs);
      const q2 = (p.get("tk") || p.get("token") || "").trim();
      if(q2) t = q2;
    }
  }catch{}
  if(t) setToken(t);
  return t;
}
async function requestPersistentStorage(){
  try{
    if(navigator.storage && navigator.storage.persist){
      await navigator.storage.persist();
    }
  }catch{}
}

/* ================== MathJax helper ================== */
function typesetElement(el){
  try{
    if(window.MathJax && MathJax.typesetPromise){
      return MathJax.typesetPromise([el]).catch(()=>{});
    }
  }catch{}
  setTimeout(()=>{
    try{
      if(window.MathJax && MathJax.typesetPromise){
        MathJax.typesetPromise([el]).catch(()=>{});
      }
    }catch{}
  }, 600);
}
function hasLatex(s){
  const t = String(s||"");
  if(!t.trim()) return false;
  // heuristic: show preview only if likely latex
  return (t.includes("$") || t.includes("\\(") || t.includes("\\[") || t.includes("\\frac") || t.includes("\\sqrt") || t.includes("\\int") || t.includes("\\log") || t.includes("\\sum") || t.includes("\\lim"));
}

/* ================== SUPABASE RPC ================== */
async function rpc(fn, args){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{
    method:"POST",
    headers:{
      "apikey": SUPABASE_ANON_KEY,
      "Authorization":"Bearer " + SUPABASE_ANON_KEY,
      "Content-Type":"application/json"
    },
    body: JSON.stringify(args||{})
  });
  const txt = await res.text();
  let data=null;
  try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || `RPC failed: ${fn}`);
  }
  return data;
}

/* ================== STORAGE UPLOAD ================== */
function publicObjectUrl(bucket, path){
  const safe = path.split("/").map(encodeURIComponent).join("/");
  return `${SUPABASE_URL}/storage/v1/object/public/${bucket}/${safe}`;
}
async function uploadToBucket(bucket, path, blob, contentType){
  const url = `${SUPABASE_URL}/storage/v1/object/${bucket}/${path.split("/").map(encodeURIComponent).join("/")}`;
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": contentType || "application/octet-stream",
      "x-upsert": "true"
    },
    body: blob
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`Upload failed (${res.status}): ${t || "check bucket policy"}`);
  }
  return publicObjectUrl(bucket, path);
}

/* ================== NEED LOGIN ================== */
function renderNeedLogin(msg){
  const gate = document.getElementById("gate");
  const curTk = getToken();

  gate.innerHTML = `
    <div class="row1">
      <p class="vi" style="margin:0">Chưa đăng nhập</p>
      <span class="idx warn">${esc(msg || "Bạn cần đăng nhập ở trang chủ")}</span>
    </div>

    <div class="hint" style="margin-top:8px">
      Admin panel không đăng nhập ở đây nữa.<br>
      Vui lòng đăng nhập tài khoản tuankhoi ở trang chủ, rồi mở lại <code>/admin.html</code>.
    </div>

    <label style="margin-top:12px">Token (tùy chọn – dán thủ công nếu browser không share storage)</label>
    <input class="input mono" id="manualToken" placeholder="dán token vào đây..." value="${esc(curTk||"")}"/>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn" id="btnRetry" type="button">Thử lại</button>
      <button class="btn btn-primary" id="btnSaveManual" type="button">Lưu token</button>
      <button class="btn btn-ghost" id="btnGoHome" type="button">Về trang chủ</button>
      <button class="btn btn-ghost" id="btnClearToken" type="button">Xóa phiên</button>
    </div>
  `;

  gate.querySelector("#btnGoHome").onclick = ()=> location.href = "/";
  gate.querySelector("#btnRetry").onclick = ()=> location.reload();
  gate.querySelector("#btnSaveManual").onclick = ()=>{
    const v = (gate.querySelector("#manualToken")?.value || "").trim();
    if(!v) return toast("Token trống");
    setToken(v);
    toast("Đã lưu token");
    setTimeout(()=>location.reload(), 300);
  };
  gate.querySelector("#btnClearToken").onclick = ()=>{
    clearToken();
    toast("Đã xóa phiên");
    renderNeedLogin("Đã xóa token");
  };
}

/* ================== DOM ================== */
const mePill = document.getElementById("mePill");
const gate = document.getElementById("gate");
const app = document.getElementById("app");

const tabQuizzes = document.getElementById("tabQuizzes");
const tabUsers = document.getElementById("tabUsers");
const viewQuizzes = document.getElementById("viewQuizzes");
const viewUsers = document.getElementById("viewUsers");

function setTab(which){
  const isQ = which==="q";
  tabQuizzes.classList.toggle("active", isQ);
  tabUsers.classList.toggle("active", !isQ);
  viewQuizzes.style.display = isQ ? "" : "none";
  viewUsers.style.display = isQ ? "none" : "";
}
tabQuizzes.onclick = ()=>setTab("q");
tabUsers.onclick = ()=>setTab("u");

/* ================== STATE ================== */
let ME = null;
let QUIZZES = [];
let USERS = [];

let CURRENT_QID = "";
let CURRENT_MODE = "NEW"; // NEW/EDIT
let QUESTIONS = [];
let ACTIVE_Q_INDEX = -1;
let ACTIVE_TEXTAREA = null;

/* ================== PAGES ================== */
const quizListPage = document.getElementById("quizListPage");
const quizCreatePage = document.getElementById("quizCreatePage");
const quizEditorPage = document.getElementById("quizEditorPage");

function setQuizPage(p){
  for(const el of [quizListPage, quizCreatePage, quizEditorPage]){
    el.classList.remove("show");
  }
  if(p==="list") quizListPage.classList.add("show");
  if(p==="create") quizCreatePage.classList.add("show");
  if(p==="editor") quizEditorPage.classList.add("show");

  // floating add shows only in editor
  document.getElementById("fabAddQuestion").classList.toggle("show", p==="editor");
}

/* ================== LOGOUT ================== */
async function doLogout(){
  const tk = getToken();
  clearToken();
  try{ if(tk) await rpc(RPC.logout, { p_token: tk }); }catch{}
  toast("Đã logout");
  setTimeout(()=>location.href="/", 350);
}

/* ================== AUTH GATE ================== */
async function gateCheck(){
  const token = getToken();
  if(!token){
    mePill.textContent = "No login";
    renderNeedLogin("Chưa có phiên đăng nhập");
    return false;
  }
  try{
    const meOut = await rpc(RPC.me,{p_token:token});
    if(!meOut?.ok) throw new Error(meOut?.error || "not logged");
    ME = meOut.me;
    if(meOut.token) setToken(meOut.token);

    const isAdmin =
      (String(ME.role||"").toLowerCase()==="admin") ||
      (String(ME.username||"").toLowerCase()==="tuankhoi");

    if(!isAdmin){
      mePill.innerHTML = `Xin chào <b>${esc(ME.username)}</b> <span class="idx warn">NOT ADMIN</span>`;
      gate.innerHTML = `Bạn không phải admin. <button class="btn btn-ghost" id="btnLogoutGate" type="button">Logout</button>`;
      gate.querySelector("#btnLogoutGate").onclick = doLogout;
      return false;
    }

    mePill.innerHTML = `
      Xin chào <b>${esc(ME.username)}</b>
      <span class="badge-admin">ADMIN</span>
      <button class="btn btn-ghost" id="btnLogoutTop" type="button" style="padding:8px 10px;box-shadow:none">Logout</button>
    `;
    mePill.querySelector("#btnLogoutTop").onclick = doLogout;

    gate.innerHTML = `<span class="idx ok">OK</span> Admin: <b>${esc(ME.username)}</b>`;
    app.style.display = "";
    return true;
  }catch(e){
    mePill.textContent = "Login required";
    renderNeedLogin("Phiên lỗi / không check được: " + (e.message||""));
    return false;
  }
}

/* ================== QUIZ FORM (settings modal inputs) ================== */
const quizIdEl = document.getElementById("quizId");
const titleEl = document.getElementById("title");
const subEl = document.getElementById("sub");
const isPublicEl = document.getElementById("isPublic");
const showInStoreEl = document.getElementById("showInStore");
const requireLoginEl = document.getElementById("requireLogin");
const pinnedEl = document.getElementById("pinned");
const scoringModeEl = document.getElementById("scoringMode");
const shuffleModeEl = document.getElementById("shuffleMode");
const requireCodeEl = document.getElementById("requireCode");
const accessCodeEl = document.getElementById("accessCode");
const totalScoreEl = document.getElementById("totalScore");
const totalScoreWrap = document.getElementById("totalScoreWrap");

function genQuizId5(){
  const letters="abcdefghijklmnopqrstuvwxyz";
  let s="";
  for(let i=0;i<5;i++) s += letters[Math.floor(Math.random()*letters.length)];
  return s;
}
function isQuizIdTakenLocal(id){
  return QUIZZES.some(q=>String(q.quiz_id||"").toLowerCase()===String(id||"").toLowerCase());
}
function genUniqueQuizId5(){
  for(let t=0;t<80;t++){
    const id = genQuizId5();
    if(!isQuizIdTakenLocal(id)) return id;
  }
  return genQuizId5();
}

/* ================== SHORT ANSWER FIX (short4) ================== */
function normalizeNumericLike(s){
  let t = String(s||"").trim();
  t = t.replace(/\s+/g,"");
  t = t.replace(/[−–—]/g,"-");
  return t;
}
function variantsForShort4(s){
  const base = normalizeNumericLike(s);
  const out = new Set();
  if(base) out.add(base);

  if(base.includes(",")) out.add(base.replace(/,/g,"."));
  if(base.includes(".")) out.add(base.replace(/\./g,","));

  if(base.startsWith("+")) out.add(base.slice(1));
  if(/^0[,.]/.test(base)) out.add(base.slice(1));
  if(/^[,.]/.test(base)) out.add("0"+base);

  if(/^-?\d+$/.test(base)){
    const sign = base.startsWith("-") ? "-" : "";
    const num = base.replace(/^-?/,"").replace(/^0+(?=\d)/,"");
    out.add(sign + (num || "0"));
  }
  return Array.from(out).filter(Boolean);
}
function parseShort4Answers(raw){
  const parts = String(raw||"").split("|").map(s=>s.trim()).filter(Boolean);
  const all = [];
  const seen = new Set();
  for(const p of parts){
    for(const v of variantsForShort4(p)){
      if(!seen.has(v)){
        seen.add(v);
        all.push(v);
      }
    }
  }
  return all;
}

/* ================== SCORE HELPERS ================== */
function calcCustomTotal(){
  let sum = 0;
  for(const q of (QUESTIONS||[])){
    const p = Number(q?.points ?? 0);
    if(Number.isFinite(p)) sum += p;
  }
  return Math.round(sum*100)/100;
}
function updateTotalScoreUI(){
  const mode = String(scoringModeEl.value||"equal");
  if(mode === "custom"){
    if(totalScoreWrap) totalScoreWrap.classList.add("hidden");
    if(totalScoreEl) totalScoreEl.value = String(calcCustomTotal());
  }else{
    if(totalScoreWrap) totalScoreWrap.classList.remove("hidden");
    if(totalScoreEl && !String(totalScoreEl.value||"").trim()) totalScoreEl.value = "10";
  }
}
scoringModeEl.addEventListener("change", ()=>{
  updateTotalScoreUI();
  renderAllQuestions();
},{passive:true});

/* ================== SETTINGS MODAL ================== */
const settingsModalBack = document.getElementById("settingsModalBack");
function openSettingsModal(){
  settingsModalBack.classList.add("show");
  settingsModalBack.setAttribute("aria-hidden","false");
  lockScroll(true);
  updateTotalScoreUI();
}
function closeSettingsModal(){
  settingsModalBack.classList.remove("show");
  settingsModalBack.setAttribute("aria-hidden","true");
  lockScroll(false);
}
document.getElementById("btnCloseSettings").onclick = closeSettingsModal;
document.getElementById("btnCloseSettings2").onclick = closeSettingsModal;
document.getElementById("btnBackSettings").onclick = closeSettingsModal;
settingsModalBack.addEventListener("click",(e)=>{
  if(e.target === settingsModalBack) closeSettingsModal();
});

/* ================== IMPORT MODAL ================== */
const importModalBack = document.getElementById("importModalBack");
function openImportModal(){
  importModalBack.classList.add("show");
  importModalBack.setAttribute("aria-hidden","false");
  lockScroll(true);
}
function closeImportModal(){
  importModalBack.classList.remove("show");
  importModalBack.setAttribute("aria-hidden","true");
  lockScroll(false);
}
document.getElementById("btnCloseImport").onclick = closeImportModal;
document.getElementById("btnBackImport").onclick = closeImportModal;
importModalBack.addEventListener("click",(e)=>{
  if(e.target === importModalBack) closeImportModal();
});

/* ================== CREATE PAGE ================== */
const createTitleEl = document.getElementById("createTitle");
const createSubEl = document.getElementById("createSub");

document.getElementById("btnCreateCancelTop").onclick = ()=> setQuizPage("list");

function resetSettingsToDefaults(){
  quizIdEl.value = "";
  titleEl.value = "";
  subEl.value = "";
  isPublicEl.value = "true";
  showInStoreEl.value = "true";
  requireLoginEl.value = "true";
  pinnedEl.value = "false";
  scoringModeEl.value = "equal";
  shuffleModeEl.value = "none";
  requireCodeEl.value = "false";
  accessCodeEl.value = "";
  totalScoreEl.value = "10";
  updateTotalScoreUI();
}
function setMode(mode){
  CURRENT_MODE = mode;
  // quiz id always readonly UI
  quizIdEl.setAttribute("disabled","disabled");
}
function validateQuiz(){
  const title = titleEl.value.trim();
  if(!title) return "Thiếu title";
  const sm = String(shuffleModeEl.value||"none");
  if(!["none","q","qa"].includes(sm)) return "Shuffle mode không hợp lệ";
  if(String(scoringModeEl.value||"equal")==="equal"){
    const total = Number(totalScoreEl.value || "");
    if(!Number.isFinite(total) || total<=0) return "Tổng điểm không hợp lệ";
  }
  return null;
}

/* ================== QUIZ CRUD ================== */
async function saveQuizOnly(){
  const token = getToken();
  if(!token) throw new Error("Chưa login");

  // quiz id: auto random (NEW) and must not duplicate
  if(CURRENT_MODE !== "EDIT"){
    if(!CURRENT_QID) CURRENT_QID = genUniqueQuizId5();
    quizIdEl.value = CURRENT_QID;
  }
  let qid = (CURRENT_MODE==="EDIT") ? CURRENT_QID : CURRENT_QID;

  // totalScore: equal dùng input, custom dùng sum(points)
  let totalScore = Number(totalScoreEl.value || "10") || 10;
  if(String(scoringModeEl.value||"equal")==="custom"){
    totalScore = calcCustomTotal();
    totalScoreEl.value = String(totalScore);
  }

  const payload = {
    p_token: token,
    p_quiz_id: qid,
    p_title: titleEl.value.trim(),
    p_sub: subEl.value.trim(),
    p_is_public: (isPublicEl.value === "true"),
    p_is_hidden: false, // removed UI
    p_show_in_store: (showInStoreEl.value === "true"),
    p_require_login: (requireLoginEl.value === "true"),
    p_pinned: (pinnedEl.value === "true"),
    p_scoring_mode: scoringModeEl.value,
    p_total_score: totalScore,
    p_shuffle_mode: String(shuffleModeEl.value || "none"),
    p_require_access_code: (requireCodeEl.value === "true"),
    p_access_code: accessCodeEl.value.trim()
  };

  // if collision happens, retry a few times
  for(let attempt=0; attempt<5; attempt++){
    try{
      const out = await rpc(RPC.adminUpsertQuiz, payload);
      CURRENT_QID = out.quiz_id || payload.p_quiz_id;
      quizIdEl.value = CURRENT_QID;
      setMode("EDIT");
      return CURRENT_QID;
    }catch(e){
      const msg = String(e?.message||"");
      const maybeDup = /duplicate|already exists|unique/i.test(msg);
      if(CURRENT_MODE !== "EDIT" && maybeDup){
        payload.p_quiz_id = genUniqueQuizId5();
        CURRENT_QID = payload.p_quiz_id;
        quizIdEl.value = CURRENT_QID;
        continue;
      }
      throw e;
    }
  }
  throw new Error("Không tạo được Quiz ID không trùng (thử lại).");
}

document.getElementById("btnSaveQuiz").onclick = async ()=>{
  try{
    const err = validateQuiz();
    if(err) return toast(err);
    const qid = await saveQuizOnly();
    toast("Đã lưu: " + qid);
    await reloadQuizzes();
    syncEditorHeader();
    closeSettingsModal();
  }catch(e){
    toast(e.message || "Save error");
  }
};

/* ================== QUIZ LIST ================== */
const quizList = document.getElementById("quizList");

function shuffleBadge(sm){
  if(sm==="q") return `<span class="idx">SHUFFLE-Q</span>`;
  if(sm==="qa") return `<span class="idx">SHUFFLE-QA</span>`;
  return "";
}

function renderQuizList(){
  if(!QUIZZES.length){
    quizList.innerHTML = `<div class="muted">Chưa có quiz.</div>`;
    return;
  }
  quizList.innerHTML = QUIZZES.map(q=>{
    const badges = [
      q.pinned ? `<span class="idx ok">PIN</span>` : "",
      q.is_public ? `<span class="idx ok">PUBLIC</span>` : `<span class="idx warn">PRIVATE</span>`,
      q.show_in_store ? `<span class="idx ok">STORE</span>` : `<span class="idx warn">STORE-OFF</span>`,
      q.require_login ? `<span class="idx">LOGIN</span>` : `<span class="idx ok">OPEN</span>`,
      q.require_access_code ? `<span class="idx warn">CODE</span>` : "",
      shuffleBadge(q.shuffle_mode)
    ].filter(Boolean).join(" ");

    return `
      <div class="card" style="box-shadow:none;border-width:1px;margin:10px 0">
        <div class="row1">
          <div style="min-width:0">
            <div class="vi" style="font-size:1rem"><b>${esc(q.title||q.quiz_id)}</b></div>
            <div class="muted" style="margin-top:4px">${esc(q.sub||"")}</div>
            <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">${badges}</div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn" data-act="open" data-qid="${esc(q.quiz_id)}" type="button">Sửa</button>
            <button class="btn" data-act="settings" data-qid="${esc(q.quiz_id)}" type="button">Cài đặt</button>
            <button class="btn btn-danger" data-act="del" data-qid="${esc(q.quiz_id)}" type="button">Xóa</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  quizList.querySelectorAll("button[data-act]").forEach(b=>{
    b.onclick = async ()=>{
      const act = b.getAttribute("data-act");
      const qid = b.getAttribute("data-qid");
      if(act==="del") return delQuiz(qid);
      if(act==="settings") return openSettingsFromList(qid);
      if(act==="open") return openEditorForQuiz(qid);
    };
  });
}

async function reloadQuizzes(){
  const token = getToken();
  const out = await rpc(RPC.adminListQuizzes,{p_token: token});
  QUIZZES = out.items || [];
  renderQuizList();
}
document.getElementById("btnReloadQuizzes").onclick = ()=>reloadQuizzes().catch(e=>toast(e.message));

async function delQuiz(qid){
  const ok = confirm("Xóa quiz " + qid + " ?");
  if(!ok) return;
  const token = getToken();
  await rpc(RPC.adminDeleteQuiz,{p_token:token, p_quiz_id:qid});
  toast("Đã xóa " + qid);
  await reloadQuizzes();
}

function fillSettingsFromQuiz(q){
  CURRENT_QID = q.quiz_id;
  setMode("EDIT");
  quizIdEl.value = q.quiz_id;
  titleEl.value = q.title || "";
  subEl.value = q.sub || "";
  isPublicEl.value = String(!!q.is_public);
  showInStoreEl.value = String(!!q.show_in_store);
  requireLoginEl.value = String(!!q.require_login);
  pinnedEl.value = String(!!q.pinned);
  scoringModeEl.value = q.scoring_mode || "equal";
  totalScoreEl.value = String(q.total_score ?? 10);
  shuffleModeEl.value = (q.shuffle_mode || "none");
  requireCodeEl.value = String(!!q.require_access_code);
  accessCodeEl.value = "";
  updateTotalScoreUI();
}

async function openSettingsFromList(qid){
  const q = QUIZZES.find(x=>x.quiz_id===qid);
  if(!q) return;
  fillSettingsFromQuiz(q);
  openSettingsModal();
  setQuizPage("list");
}

function syncEditorHeader(){
  const elT = document.getElementById("editorTitle");
  const elS = document.getElementById("editorSub");
  const title = titleEl.value.trim() || CURRENT_QID || "Soạn câu hỏi";
  elT.textContent = title;
  elS.textContent = subEl.value.trim() || (CURRENT_QID ? ("Quiz: " + CURRENT_QID) : "");
}

/* ================== CREATE FLOW ================== */
document.getElementById("btnGoCreate").onclick = ()=>{
  CURRENT_QID = "";
  setMode("NEW");
  QUESTIONS = [];
  ACTIVE_Q_INDEX = -1;

  resetSettingsToDefaults();
  createTitleEl.value = "";
  createSubEl.value = "";

  setQuizPage("create");
  setTimeout(()=>createTitleEl.focus(), 50);
};

document.getElementById("btnCreateSaveOnly").onclick = async ()=>{
  try{
    // map basic fields to settings modal fields
    CURRENT_QID = ""; // force regen
    quizIdEl.value = "";
    titleEl.value = (createTitleEl.value || "").trim();
    subEl.value = (createSubEl.value || "").trim();
    setMode("NEW");

    const err = validateQuiz();
    if(err) return toast(err);

    const qid = await saveQuizOnly();
    toast("Đã tạo: " + qid);
    await reloadQuizzes();
    setQuizPage("list");
  }catch(e){
    toast(e.message || "Create error");
  }
};

document.getElementById("btnCreateNext").onclick = async ()=>{
  try{
    CURRENT_QID = ""; // force regen
    quizIdEl.value = "";
    titleEl.value = (createTitleEl.value || "").trim();
    subEl.value = (createSubEl.value || "").trim();
    setMode("NEW");

    const err = validateQuiz();
    if(err) return toast(err);

    const qid = await saveQuizOnly();
    toast("Đã tạo: " + qid);
    await reloadQuizzes();

    QUESTIONS = [];
    ACTIVE_Q_INDEX = -1;
    syncEditorHeader();
    setQuizPage("editor");
    renderAllQuestions();
  }catch(e){
    toast(e.message || "Create error");
  }
};

document.getElementById("btnBackToList").onclick = ()=> setQuizPage("list");

/* ================== OPEN EDITOR ================== */
async function openEditorForQuiz(qid){
  const q = QUIZZES.find(x=>x.quiz_id===qid);
  if(!q) return;

  fillSettingsFromQuiz(q);
  QUESTIONS = [];
  ACTIVE_Q_INDEX = -1;

  syncEditorHeader();
  setQuizPage("editor");
  renderAllQuestions();

  try{
    const token = getToken();
    const out = await rpc(RPC.adminGetQuestions,{p_token: token, p_quiz_id: qid});
    if(!out?.ok) throw new Error(out?.error || "admin_get_questions failed");
    const items = out.items || [];

    QUESTIONS = items.map(x=>{
      const meta = x.meta || {};
      if(meta.image_data_url && !meta.image_url) meta.image_url = meta.image_data_url;
      return {
        type: x.q_type || x.type || "mcq1",
        prompt: x.prompt || "",
        answers: x.answers || [],
        points: x.points ?? null,
        meta
      };
    });

    if(QUESTIONS.length) ACTIVE_Q_INDEX = 0;
    renderAllQuestions();
    toast("Đã load " + qid);
  }catch(e){
    toast("Load câu hỏi lỗi: " + (e.message||""));
  }
}

/* ================== QUESTION EDITOR (ALL) ================== */
const qAllHost = document.getElementById("qAllHost");
const qCountPill = document.getElementById("qCountPill");

function isAllowedQType(t){ return (t==="mcq1" || t==="essay" || t==="short4" || t==="tf4"); }

function ensureMeta(q){
  q.meta = q.meta || {};
  if(typeof q.meta.image_url !== "string") q.meta.image_url = "";
  if(typeof q.meta.image_path !== "string") q.meta.image_path = "";
  if(q.type==="mcq1"){
    q.meta.options = Array.isArray(q.meta.options) ? q.meta.options : ["","","",""];
    if(!Number.isFinite(Number(q.meta.correct))) q.meta.correct = 1;
  }
  if(q.type==="tf4"){
    q.meta.statements = Array.isArray(q.meta.statements) ? q.meta.statements : ["","","",""];
    q.meta.keys = Array.isArray(q.meta.keys) ? q.meta.keys : [false,false,false,false];
    // NEW RULE
    q.meta.rule = q.meta.rule || { byCorrectCount:{ "0":0,"1":0.1,"2":0.25,"3":0.5,"4":1 } };
  }
}

function qTypeLabel(t){
  if(t==="mcq1") return "Trắc nghiệm";
  if(t==="essay") return "Tự luận";
  if(t==="short4") return "Trả lời ngắn";
  if(t==="tf4") return "Đúng/Sai";
  return "Câu hỏi";
}

function defaultQuestion(){
  return { type:"mcq1", prompt:"", answers:[], points:0, meta:{ options:["","","",""], correct:1, image_url:"", image_path:"" } };
}

function updateQCount(){
  qCountPill.textContent = String(QUESTIONS.length || 0);
}

function renderAllQuestions(){
  updateTotalScoreUI();
  updateQCount();

  if(!QUESTIONS.length){
    qAllHost.innerHTML = `
      <div class="qCard">
        <div class="vi" style="margin:0">Chưa có câu hỏi</div>
        <div class="hint" style="margin-top:8px">
          Bấm nút “Thêm câu hỏi” (góc phải dưới) để bắt đầu.
        </div>
      </div>
    `;
    return;
  }

  const isCustom = (String(scoringModeEl.value||"equal")==="custom");

  qAllHost.innerHTML = QUESTIONS.map((q,i)=>{
    ensureMeta(q);
    const img = q.meta.image_url || "";
    const showImg = !!img;
    const showPrev = hasLatex(q.prompt);

    return `
      <div class="qCard" data-i="${i}" data-imgdrop="1">
        <div class="qCardHead">
          <div class="qHeadLeft">
            <span class="idx">Câu ${i+1}</span>
            <span class="idx" style="background:${esc("rgba(124,58,237,.12)")};border-color:${esc("rgba(124,58,237,.25)")};color:#4c1d95">${esc(qTypeLabel(q.type))}</span>
            <select class="qTypeSel">
              <option value="mcq1" ${q.type==="mcq1"?"selected":""}>Trắc nghiệm 1 đáp án</option>
              <option value="essay" ${q.type==="essay"?"selected":""}>Tự luận</option>
              <option value="short4" ${q.type==="short4"?"selected":""}>Trả lời ngắn (4 ô)</option>
              <option value="tf4" ${q.type==="tf4"?"selected":""}>Đúng/Sai 4 ý</option>
            </select>
            ${isCustom ? `<input class="qPoints input mono" style="max-width:120px" placeholder="Điểm" value="${esc(String(q.points??0))}">` : ``}
          </div>

          <div class="qHeadRight">
            <button class="mini" data-act="up" type="button" ${i===0?"disabled":""}>Lên</button>
            <button class="mini" data-act="down" type="button" ${i===QUESTIONS.length-1?"disabled":""}>Xuống</button>
            <button class="mini" data-act="dup" type="button">Nhân bản</button>
            <button class="mini danger" data-act="del" type="button">Xóa</button>
          </div>
        </div>

        <div class="qPromptGrid">
          <div>
            <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
              <label style="margin-top:0">Câu hỏi</label>
              <button class="mini ok" data-act="openLatex" type="button">Chèn LaTeX</button>
            </div>
            <textarea class="qPrompt" placeholder="Nhập câu hỏi...">${esc(q.prompt||"")}</textarea>

            <div class="mathPreviewBox ${showPrev?"":"hidden"}" data-role="mathPrevBox">
              <div class="latexTiny" style="margin-bottom:6px">Xem trước</div>
              <div class="mathPreview" data-role="mathPrev">${esc(q.prompt||"") || " "}</div>
            </div>
          </div>

          <div class="imgSide">
            <div class="imgSideHead">
              <div style="font-weight:950">Ảnh câu hỏi</div>
              <small style="color:var(--muted);font-weight:750">${showImg ? "preview" : "chưa có ảnh"}</small>
            </div>

            ${showImg ? `<img class="imgPreviewSmall" alt="preview" src="${esc(img)}"/>` : ``}

            <div class="imgSideBtns">
              <button class="btn" data-act="pickimg" type="button" style="box-shadow:none">Chọn ảnh</button>
              <button class="btn btn-ghost" data-act="removeimg" type="button" style="box-shadow:none" ${showImg?"":"disabled"}>Xóa ảnh</button>
            </div>
          </div>
        </div>

        <div class="qEssay ${q.type==="essay"?"":"hidden"}">
          <label>Đáp án (nhiều đáp án dùng dấu |)</label>
          <input class="qAnswers input mono" placeholder="vd: thích nghi|thich nghi" value="${esc((q.answers||[]).join("|"))}">
        </div>

        <div class="qMcq ${q.type==="mcq1"?"":"hidden"}">
          <label>4 lựa chọn</label>
          <div class="grid2">
            <input class="qOpt input" data-k="0" placeholder="Lựa chọn 1" value="${esc(q.meta?.options?.[0]||"")}">
            <input class="qOpt input" data-k="1" placeholder="Lựa chọn 2" value="${esc(q.meta?.options?.[1]||"")}">
            <input class="qOpt input" data-k="2" placeholder="Lựa chọn 3" value="${esc(q.meta?.options?.[2]||"")}">
            <input class="qOpt input" data-k="3" placeholder="Lựa chọn 4" value="${esc(q.meta?.options?.[3]||"")}">
          </div>
          <label>Đáp án đúng</label>
          <select class="qCorrect">
            <option value="1" ${(q.meta?.correct||1)==1?"selected":""}>A (1)</option>
            <option value="2" ${(q.meta?.correct||1)==2?"selected":""}>B (2)</option>
            <option value="3" ${(q.meta?.correct||1)==3?"selected":""}>C (3)</option>
            <option value="4" ${(q.meta?.correct||1)==4?"selected":""}>D (4)</option>
          </select>
        </div>

        <div class="qShort4 ${q.type==="short4"?"":"hidden"}">
          <label>Đáp án (nhiều đáp án dùng dấu |)</label>
          <input class="qAnswers input mono" placeholder='vd: -0,3|9999|0,02' value="${esc((q.answers||[]).join("|"))}">
          <div class="hint" style="margin-top:6px">
            Short4: tự sinh thêm biến thể dấu phẩy/chấm và chuẩn hóa để giảm “chấm sai”.
          </div>
        </div>

        <div class="qTf4 ${q.type==="tf4"?"":"hidden"}">
          <label>4 ý (mỗi ý 1 dòng)</label>
          <div style="display:grid;gap:8px">
            <input class="qStmt input" data-k="0" placeholder="Ý A" value="${esc(q.meta?.statements?.[0]||"")}">
            <input class="qStmt input" data-k="1" placeholder="Ý B" value="${esc(q.meta?.statements?.[1]||"")}">
            <input class="qStmt input" data-k="2" placeholder="Ý C" value="${esc(q.meta?.statements?.[2]||"")}">
            <input class="qStmt input" data-k="3" placeholder="Ý D" value="${esc(q.meta?.statements?.[3]||"")}">
          </div>
          <label>Đúng / Sai</label>
          <div class="grid2">
            <select class="qKey" data-k="0"><option value="1">A: Đúng</option><option value="0">A: Sai</option></select>
            <select class="qKey" data-k="1"><option value="1">B: Đúng</option><option value="0">B: Sai</option></select>
            <select class="qKey" data-k="2"><option value="1">C: Đúng</option><option value="0">C: Sai</option></select>
            <select class="qKey" data-k="3"><option value="1">D: Đúng</option><option value="0">D: Sai</option></select>
          </div>
          <div class="hint" style="margin-top:6px">
            Rule: đúng 1 ý = 0.1, 2 ý = 0.25, 3 ý = 0.5, 4 ý = 1 (nhân theo points nếu custom).
          </div>
        </div>
      </div>
    `;
  }).join("");

  // set tf keys selects + typeset previews
  qAllHost.querySelectorAll(".qCard").forEach(card=>{
    const i = Number(card.getAttribute("data-i"));
    const q = QUESTIONS[i];
    if(!q) return;

    if(q.type==="tf4"){
      const keys = q.meta?.keys || [false,false,false,false];
      card.querySelectorAll(".qKey").forEach(sel=>{
        const k = Number(sel.getAttribute("data-k"));
        sel.value = keys[k] ? "1" : "0";
      });
    }

    const prevBox = card.querySelector('[data-role="mathPrevBox"]');
    const prev = card.querySelector('[data-role="mathPrev"]');
    if(prevBox && prev){
      const show = hasLatex(q.prompt);
      prevBox.classList.toggle("hidden", !show);
      if(show){
        prev.textContent = String(q.prompt||"").trim() || " ";
        typesetElement(prev);
      }
    }
  });
}

function syncQuestionFromCard(card){
  const i = Number(card.getAttribute("data-i"));
  const q = QUESTIONS[i];
  if(!q) return;
  ensureMeta(q);

  const type = card.querySelector(".qTypeSel")?.value || "mcq1";
  if(!isAllowedQType(type)) return;

  q.type = type;
  q.prompt = card.querySelector(".qPrompt")?.value || "";

  // points
  if(String(scoringModeEl.value||"equal")==="custom"){
    q.points = Number(card.querySelector(".qPoints")?.value || "0") || 0;
  }else{
    q.points = 0;
  }

  if(type==="essay"){
    const raw = card.querySelector(".qAnswers")?.value || "";
    q.answers = raw.split("|").map(s=>s.trim()).filter(Boolean);
    q.meta = { ...(q.meta||{}), fuzzy:true, image_url:q.meta.image_url||"", image_path:q.meta.image_path||"" };
  }else if(type==="short4"){
    const raw = card.querySelector(".qAnswers")?.value || "";
    q.answers = parseShort4Answers(raw);
    q.meta = { ...(q.meta||{}), format:"4boxes", image_url:q.meta.image_url||"", image_path:q.meta.image_path||"" };
  }else if(type==="mcq1"){
    const opts = Array.from(card.querySelectorAll(".qOpt")).map(x=>x.value.trim());
    const correct = Number(card.querySelector(".qCorrect")?.value || "1") || 1;
    q.answers = [];
    q.meta = { ...(q.meta||{}), options: opts, correct, image_url:q.meta.image_url||"", image_path:q.meta.image_path||"" };
  }else if(type==="tf4"){
    const stmts = Array.from(card.querySelectorAll(".qStmt")).map(x=>x.value.trim());
    const keys = Array.from(card.querySelectorAll(".qKey")).map(x=>x.value==="1");
    q.answers = [];
    q.meta = { ...(q.meta||{}),
      statements: stmts,
      keys,
      rule: { byCorrectCount: { "0":0, "1":0.1, "2":0.25, "3":0.5, "4":1 } },
      image_url:q.meta.image_url||"",
      image_path:q.meta.image_path||""
    };
  }

  // preview: only show if has latex
  const prevBox = card.querySelector('[data-role="mathPrevBox"]');
  const prev = card.querySelector('[data-role="mathPrev"]');
  if(prevBox && prev){
    const show = hasLatex(q.prompt);
    prevBox.classList.toggle("hidden", !show);
    if(show){
      prev.textContent = String(q.prompt||"").trim() || " ";
      typesetElement(prev);
    }
  }

  updateTotalScoreUI();
}

qAllHost.addEventListener("focusin",(e)=>{
  const ta = e.target.closest("textarea");
  if(ta) ACTIVE_TEXTAREA = ta;

  const card = e.target.closest(".qCard");
  if(card){
    const i = Number(card.getAttribute("data-i"));
    if(Number.isFinite(i)) ACTIVE_Q_INDEX = i;
  }
},{passive:true});

qAllHost.addEventListener("input",(e)=>{
  const card = e.target.closest(".qCard");
  if(!card) return;
  syncQuestionFromCard(card);
},{passive:true});

qAllHost.addEventListener("change",(e)=>{
  const card = e.target.closest(".qCard");
  if(!card) return;

  if(e.target.classList.contains("qTypeSel")){
    // rerender to show correct section UI
    syncQuestionFromCard(card);
    renderAllQuestions();
    return;
  }
  syncQuestionFromCard(card);
},{passive:true});

qAllHost.addEventListener("click",(e)=>{
  const b = e.target.closest("button");
  if(!b) return;
  const act = b.getAttribute("data-act");
  const card = e.target.closest(".qCard");
  if(!card) return;

  const i = Number(card.getAttribute("data-i"));
  if(!Number.isFinite(i)) return;

  if(act==="up" && i>0){
    [QUESTIONS[i-1], QUESTIONS[i]] = [QUESTIONS[i], QUESTIONS[i-1]];
    renderAllQuestions();
    // keep focus near moved card
    setTimeout(()=> scrollToQuestion(i-1), 40);
    return;
  }
  if(act==="down" && i<QUESTIONS.length-1){
    [QUESTIONS[i+1], QUESTIONS[i]] = [QUESTIONS[i], QUESTIONS[i+1]];
    renderAllQuestions();
    setTimeout(()=> scrollToQuestion(i+1), 40);
    return;
  }
  if(act==="dup"){
    const clone = JSON.parse(JSON.stringify(QUESTIONS[i]));
    QUESTIONS.splice(i+1,0,clone);
    renderAllQuestions();
    toast("Đã nhân bản");
    setTimeout(()=> scrollToQuestion(i+1), 40);
    return;
  }
  if(act==="del"){
    const ok = confirm("Xóa câu này?");
    if(!ok) return;
    QUESTIONS.splice(i,1);
    renderAllQuestions();
    toast("Đã xóa câu");
    return;
  }

  if(act==="pickimg"){
    IMG_PICK_FOR_INDEX = i;
    document.getElementById("qImgPick").click();
    return;
  }
  if(act==="removeimg"){
    ensureMeta(QUESTIONS[i]);
    QUESTIONS[i].meta.image_url = "";
    QUESTIONS[i].meta.image_path = "";
    renderAllQuestions();
    toast("Đã xóa ảnh (chỉ xóa link)");
    return;
  }

  if(act==="openLatex"){
    ACTIVE_Q_INDEX = i;
    // prefer prompt textarea
    const prompt = card.querySelector("textarea.qPrompt");
    if(prompt){ prompt.focus(); ACTIVE_TEXTAREA = prompt; }
    openLatexModal();
    return;
  }
},{passive:true});

function scrollToQuestion(i){
  const el = qAllHost.querySelector(`.qCard[data-i="${i}"]`);
  if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
}

/* Floating add */
document.getElementById("fabAddQuestion").onclick = ()=>{
  QUESTIONS.push(defaultQuestion());
  renderAllQuestions();
  toast("Đã thêm câu hỏi");
  setTimeout(()=> scrollToQuestion(QUESTIONS.length-1), 60);
};

/* Editor top buttons */
document.getElementById("btnOpenSettings").onclick = ()=>{
  openSettingsModal();
};
document.getElementById("btnOpenImport").onclick = ()=>{
  openImportModal();
};

/* ================== IMAGE upload ================== */
const qImgPick = document.getElementById("qImgPick");
let IMG_PICK_FOR_INDEX = -1;

async function fileToDownscaledJpegBlob(file, maxW=1200, quality=0.86){
  const dataUrl = await new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(String(fr.result||""));
    fr.onerror = ()=>reject(new Error("read file error"));
    fr.readAsDataURL(file);
  });

  const img = new Image();
  img.src = dataUrl;
  await new Promise((res,rej)=>{ img.onload=res; img.onerror=()=>rej(new Error("image load error")); });

  const w = img.naturalWidth || img.width;
  const h = img.naturalHeight || img.height;
  if(!w || !h) throw new Error("invalid image");

  const ratio = (w > maxW) ? (maxW / w) : 1;
  const nw = Math.round(w * ratio);
  const nh = Math.round(h * ratio);

  const c = document.createElement("canvas");
  c.width = nw; c.height = nh;
  const ctx = c.getContext("2d");
  ctx.drawImage(img, 0, 0, nw, nh);

  const blob = await new Promise((resolve)=> c.toBlob(resolve, "image/jpeg", quality));
  if(!blob) throw new Error("toBlob failed");
  return blob;
}

async function ensureQuizIdSaved(){
  if(CURRENT_MODE==="EDIT" && CURRENT_QID) return CURRENT_QID;
  await saveQuizOnly();
  return CURRENT_QID;
}

async function setQuestionImage(i, file){
  if(i<0 || i>=QUESTIONS.length) return;
  if(!file || !/^image\//.test(file.type)) return toast("Chỉ nhận ảnh");

  const qid = await ensureQuizIdSaved();
  const blob = await fileToDownscaledJpegBlob(file, 1200, 0.86);

  const ts = Date.now();
  const path = `${qid}/q${String(i+1).padStart(3,"0")}_${ts}.jpg`;
  const url = await uploadToBucket(STORAGE_BUCKET, path, blob, "image/jpeg");

  ensureMeta(QUESTIONS[i]);
  QUESTIONS[i].meta.image_path = path;
  QUESTIONS[i].meta.image_url = url;

  renderAllQuestions();
  toast("Đã upload ảnh");
}

qImgPick.addEventListener("change", async ()=>{
  const f = qImgPick.files?.[0];
  if(!f) return;
  const i = IMG_PICK_FOR_INDEX;
  IMG_PICK_FOR_INDEX = -1;
  qImgPick.value = "";
  try{ await setQuestionImage(i, f); }catch(e){ toast(e.message || "Lỗi upload ảnh"); }
});

qAllHost.addEventListener("dragover",(e)=>{
  const drop = e.target.closest("[data-imgdrop]");
  if(!drop) return;
  e.preventDefault();
},{passive:false});

qAllHost.addEventListener("drop", async (e)=>{
  const drop = e.target.closest("[data-imgdrop]");
  if(!drop) return;
  e.preventDefault();
  const i = Number(drop.getAttribute("data-i"));
  const f = e.dataTransfer?.files?.[0];
  if(!f) return;
  try{ await setQuestionImage(i, f); }catch(err){ toast(err.message || "Lỗi upload ảnh"); }
},{passive:false});

window.addEventListener("paste", async (e)=>{
  const items = e.clipboardData?.items || [];
  const imgItem = Array.from(items).find(it=>it.type && it.type.startsWith("image/"));
  if(!imgItem) return;
  const f = imgItem.getAsFile();
  if(!f) return;

  // only in editor page
  if(!quizEditorPage.classList.contains("show")) return;

  // paste goes to last focused question index
  if(ACTIVE_Q_INDEX<0) return;
  try{ await setQuestionImage(ACTIVE_Q_INDEX, f); }catch(err){ toast(err.message || "Lỗi upload ảnh"); }
},{passive:true});

/* ================== IMPORT PARSER ================== */
const importBox = document.getElementById("importBox");

document.getElementById("btnImportReplace").onclick = ()=>{
  const parsed = parseImportText(importBox.value);
  if(!parsed.length) return toast("Không parse được gì");
  QUESTIONS = parsed;
  ACTIVE_Q_INDEX = QUESTIONS.length ? 0 : -1;
  renderAllQuestions();
  closeImportModal();
  toast("Đã import (thay thế)");
};
document.getElementById("btnImportAppend").onclick = ()=>{
  const parsed = parseImportText(importBox.value);
  if(!parsed.length) return toast("Không parse được gì");
  QUESTIONS = QUESTIONS.concat(parsed);
  if(ACTIVE_Q_INDEX<0 && QUESTIONS.length) ACTIVE_Q_INDEX = 0;
  renderAllQuestions();
  closeImportModal();
  toast("Đã import (thêm)");
};

function isHeaderLine(line){
  const s = line.trim();
  return /^<(tn|tl|tln|tf)>\s*@\d+\s*:/.test(s);
}
function stripStars(s){
  let t = String(s||"").trim();
  for(let k=0;k<3;k++){
    t = t.trim();
    if((t.startsWith("**") && t.includes("**", 2))){
      const m = t.match(/^\*\*(.+?)\*\*/);
      if(m){ t = m[1].trim(); continue; }
    }
    if((t.startsWith("*") && t.includes("*", 1))){
      const m = t.match(/^\*(.+?)\*/);
      if(m){ t = m[1].trim(); continue; }
    }
    if((t.startsWith("**") && t.endsWith("**") && t.length>=4)){ t = t.slice(2,-2).trim(); continue; }
    if((t.startsWith("*") && t.endsWith("*") && t.length>=2)){ t = t.slice(1,-1).trim(); continue; }
    break;
  }
  return t;
}
function cleanLine(s){ return stripStars(String(s||"").trim()); }
function extractStarWrapped(line){
  const s = String(line||"");
  let m = s.match(/\*\*(.+?)\*\*/);
  if(m) return String(m[1]||"").trim();
  m = s.match(/\*(.+?)\*/);
  if(m) return String(m[1]||"").trim();
  return "";
}

function parseImportText(text){
  const lines = String(text||"").replace(/\r/g,"").split("\n");
  const blocks = [];
  let cur = null;
  function pushCur(){ if(cur){ blocks.push(cur); cur=null; } }

  for(let i=0;i<lines.length;i++){
    const line = lines[i].trimEnd();
    if(isHeaderLine(line)){
      pushCur();
      const m = line.trim().match(/^<(tn|tl|tln|tf)>\s*@(\d+)\s*:\s*(.*)$/);
      if(!m) continue;
      cur = { tag:m[1], n:Number(m[2]||0), head:(m[3]||"").trim(), body:[] };
      continue;
    }
    if(!cur) continue;
    if(line.trim().length===0) continue;
    cur.body.push(line);
  }
  pushCur();

  const out = [];
  for(const b of blocks){
    const tag = b.tag;
    const head = b.head || "";
    const body = (b.body||[]).map(x=>x.trim()).filter(x=>x.length>0);

    if(tag==="tn"){
      const opts = [];
      let correctIdx = 1;
      for(const ln0 of body){
        let raw = ln0.trim();
        let isCorrect = false;

        let m = raw.match(/^\s*\*\*(.+?)\*\*/);
        if(m){
          isCorrect = true;
          raw = String(m[1]||"").trim();
        }else{
          m = raw.match(/^\s*\*(.+?)\*/);
          if(m){
            isCorrect = true;
            raw = String(m[1]||"").trim();
          }else{
            raw = cleanLine(raw);
          }
        }
        opts.push(raw);
        if(isCorrect) correctIdx = opts.length;
      }
      while(opts.length<4) opts.push("");
      const options4 = opts.slice(0,4);
      if(correctIdx<1 || correctIdx>4) correctIdx = 1;

      out.push({ type:"mcq1", prompt: head, answers: [], points: 0, meta: { options: options4, correct: correctIdx, image_url:"", image_path:"" }});
      continue;
    }

    if(tag==="tl"){
      let answers = body.map(extractStarWrapped).filter(Boolean).map(x=>cleanLine(x));
      if(!answers.length && body.length) answers = [ cleanLine(body.join(" ")) ];
      answers = answers.map(x=>x.trim()).filter(Boolean);
      out.push({ type:"essay", prompt: head, answers, points: 0, meta: { fuzzy:true, image_url:"", image_path:"" }});
      continue;
    }

    if(tag==="tln"){
      let answers = body.map(extractStarWrapped).filter(Boolean).map(x=>cleanLine(x));
      if(!answers.length && body.length) answers = [ cleanLine(body.join(" ")) ];
      answers = answers.map(x=>x.trim()).filter(Boolean);

      const merged = [];
      const seen = new Set();
      for(const a of answers){
        for(const v of variantsForShort4(a)){
          if(!seen.has(v)){
            seen.add(v);
            merged.push(v);
          }
        }
      }
      out.push({ type:"short4", prompt: head, answers: merged, points: 0, meta: { format:"4boxes", image_url:"", image_path:"" }});
      continue;
    }

    if(tag==="tf"){
      const stmts = ["","","",""];
      const keys = [false,false,false,false];

      for(const ln of body){
        const s = ln.trim();
        const mm = s.match(/^\|?\s*([A-D])\s*:\s*(.*?)\s*\*([TF])\*\s*\|?\s*$/i);
        if(!mm) continue;
        const letter = mm[1].toUpperCase();
        const textPart = cleanLine(mm[2]||"");
        const tf = mm[3].toUpperCase();
        const idx = "ABCD".indexOf(letter);
        if(idx>=0){
          stmts[idx] = textPart;
          keys[idx] = (tf==="T");
        }
      }

      out.push({
        type:"tf4", prompt: head, answers: [], points: 0,
        meta: {
          statements: stmts,
          keys,
          rule:{ byCorrectCount:{ "0":0, "1":0.1, "2":0.25, "3":0.5, "4":1 } },
          image_url:"", image_path:""
        }
      });
      continue;
    }
  }
  return out;
}

/* ================== APPLY SCORING ================== */
function applyScoring(items){
  const mode = scoringModeEl.value;
  const total = Number(totalScoreEl.value || "10") || 10;
  if(!items.length) return items;

  if(mode === "equal"){
    const per = total / items.length;
    let sum = 0;
    return items.map((q,i)=>{
      const p = (i === items.length-1) ? (total - sum) : Math.round(per*100)/100;
      if(i !== items.length-1) sum += p;
      return { ...q, points: Math.round(p*100)/100 };
    });
  }
  return items.map(q=>({ ...q, points: (q.points==null?0:Number(q.points)||0) }));
}

/* ================== PUBLISH ================== */
async function publishAll(){
  try{
    const err = validateQuiz();
    if(err) return toast(err);
    if(!QUESTIONS.length) return toast("Chưa có câu hỏi");

    const qid = await saveQuizOnly();
    const token = getToken();

    const items = applyScoring(QUESTIONS).map((q, idx)=>{
      ensureMeta(q);
      const meta = { ...(q.meta||{}) };
      delete meta.image_data_url;
      return {
        no: idx+1,
        q_type: q.type,
        prompt: (q.prompt||"").trim(),
        answers: Array.isArray(q.answers)?q.answers:[],
        points: q.points ?? 0,
        meta
      };
    });

    await rpc(RPC.adminReplaceQuestions, { p_token: token, p_quiz_id: qid, p_items: items });

    toast(`Published: ${qid}`);
    await reloadQuizzes();
    location.href = `/q/${qid}`;
  }catch(e){
    toast(e.message || "Publish error");
  }
}
document.getElementById("btnPublishAll").onclick = publishAll;

/* ================== USERS ================== */
const userList = document.getElementById("userList");
const userSearch = document.getElementById("userSearch");

function isAdminUser(u){
  const role = String(u.role||"").toLowerCase();
  const uname = String(u.username||"").toLowerCase();
  return role==="admin" || uname==="tuankhoi";
}

function renderUsers(){
  const q = (userSearch.value||"").trim().toLowerCase();
  const arr = q ? USERS.filter(u=>String(u.username||"").includes(q)) : USERS;

  if(!arr.length){
    userList.innerHTML = `<div class="muted">No users.</div>`;
    return;
  }

  userList.innerHTML = arr.map(u=>{
    const admin = isAdminUser(u);
    const role = admin ? `<span class="idx ok">ADMIN</span>` : `<span class="idx">USER</span>`;
    const delBtn = admin
      ? `<button class="btn btn-danger" disabled title="Admin không xóa được" type="button">Delete</button>`
      : `<button class="btn btn-danger" data-act="del" data-id="${esc(u.id)}" type="button">Delete</button>`;

    return `
      <div class="card" style="box-shadow:none;border-width:1px;margin:10px 0">
        <div class="row1">
          <div style="min-width:0">
            <div class="vi" style="font-size:1rem"><b>${esc(u.username)}</b> ${role}</div>
            <div class="muted" style="margin-top:6px">id: <code>${esc(u.id)}</code></div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn" data-act="rename" data-id="${esc(u.id)}" type="button">Rename</button>
            <button class="btn" data-act="reset" data-id="${esc(u.id)}" type="button">Reset PIN</button>
            ${delBtn}
          </div>
        </div>
      </div>
    `;
  }).join("");

  userList.querySelectorAll("button[data-act]").forEach(b=>{
    b.onclick = async ()=>{
      const act = b.getAttribute("data-act");
      const id = b.getAttribute("data-id");
      if(act==="del") return delUser(id);
      if(act==="rename") return renameUser(id);
      if(act==="reset") return resetPin(id);
    };
  });
}

async function reloadUsers(){
  const token = getToken();
  const out = await rpc(RPC.adminListUsers,{p_token: token});
  USERS = out.items || [];
  renderUsers();
}
document.getElementById("btnReloadUsers").onclick = ()=>reloadUsers().catch(e=>toast(e.message));
userSearch.addEventListener("input", ()=>renderUsers(), {passive:true});

async function delUser(id){
  const u = USERS.find(x=>String(x.id)===String(id));
  if(u && isAdminUser(u)) return toast("Admin không xóa được");
  const ok = confirm("Xóa user này? (mất progress/attempts/comments)");
  if(!ok) return;
  const token = getToken();
  await rpc(RPC.adminDeleteUser,{p_token:token, p_user_id:id});
  toast("Deleted user");
  await reloadUsers();
}
async function renameUser(id){
  const newU = prompt("New username (lowercase, a-z0-9_):");
  if(!newU) return;
  const token = getToken();
  await rpc(RPC.adminForceRename,{p_token:token, p_user_id:id, p_new_username:newU});
  toast("Renamed");
  await reloadUsers();
}
async function resetPin(id){
  const pin = prompt("Set new PIN (6 digits, ví dụ 072008).");
  if(!pin) return;
  const token = getToken();
  await rpc(RPC.adminForceSetPin,{p_token:token, p_user_id:id, p_new_pin:pin});
  toast("PIN reset");
  await reloadUsers();
}

/* ================== LaTeX modal (must press insert) ================== */
const latexModalBack = document.getElementById("latexModalBack");
const latexGrid = document.getElementById("latexGrid");
const latexPreviewSrc = document.getElementById("latexPreviewSrc");
const latexPreview = document.getElementById("latexPreview");
let LATEX_TARGET_EL = null;

function openLatexModal(){
  LATEX_TARGET_EL = getActiveTextTarget();
  if(!LATEX_TARGET_EL) return;

  latexModalBack.classList.add("show");
  latexModalBack.setAttribute("aria-hidden","false");
  lockScroll(true);

  // load selection or keep current
  const start = LATEX_TARGET_EL.selectionStart ?? 0;
  const end = LATEX_TARGET_EL.selectionEnd ?? 0;
  const sel = (end>start) ? LATEX_TARGET_EL.value.slice(start,end) : "";
  latexPreviewSrc.value = sel.trim() || latexPreviewSrc.value || "";
  updateLatexPreview();
}
function closeLatexModal(){
  latexModalBack.classList.remove("show");
  latexModalBack.setAttribute("aria-hidden","true");
  lockScroll(false);
}
document.getElementById("btnCloseLatex").onclick = closeLatexModal;
latexModalBack.addEventListener("click",(e)=>{
  if(e.target === latexModalBack) closeLatexModal(); // click outside => close
});

function getActiveTextTarget(){
  const el = ACTIVE_TEXTAREA && document.contains(ACTIVE_TEXTAREA) ? ACTIVE_TEXTAREA : qAllHost.querySelector("textarea.qPrompt");
  if(!el) toast("Click vào ô nhập trước");
  return el;
}

function insertAtCursor(el, text){
  const start = el.selectionStart ?? el.value.length;
  const end = el.selectionEnd ?? el.value.length;
  const before = el.value.slice(0,start);
  const after = el.value.slice(end);
  el.value = before + text + after;
  const pos = before.length + text.length;
  el.focus();
  el.setSelectionRange(pos,pos);
}

function insertTemplateToLatexSrc(tpl){
  const el = latexPreviewSrc;
  if(!el) return;
  insertAtCursor(el, tpl);
  updateLatexPreview();
}

function updateLatexPreview(){
  const s = String(latexPreviewSrc.value||"").trim();
  latexPreview.textContent = s ? s : " ";
  typesetElement(latexPreview);
}
latexPreviewSrc.addEventListener("input", updateLatexPreview, {passive:true});

document.getElementById("btnLatexClear").onclick = ()=>{
  latexPreviewSrc.value = "";
  updateLatexPreview();
  toast("Đã clear");
};
document.getElementById("btnLatexInsert").onclick = ()=>{
  const el = LATEX_TARGET_EL || getActiveTextTarget();
  if(!el) return;

  const s = String(latexPreviewSrc.value||"").trim();
  if(!s) return toast("Chưa có LaTeX để chèn");

  insertAtCursor(el, s);

  // sync question data after insert
  const card = el.closest(".qCard");
  if(card) syncQuestionFromCard(card);

  closeLatexModal();
  toast("Đã chèn LaTeX");
};

const LATEX_TEMPLATES = [
  { label: "x²", tpl: "$x^{2}$" },
  { label: "xⁿ", tpl: "$x^{n}$" },
  { label: "xᵢ", tpl: "$x_{i}$" },
  { label: "phân số", tpl: "$\\frac{a}{b}$" },
  { label: "căn", tpl: "$\\sqrt{x}$" },
  { label: "căn bậc n", tpl: "$\\sqrt[n]{x}$" },
  { label: "logₐ(x)", tpl: "$\\log_{a}(x)$" },
  { label: "ln(x)", tpl: "$\\ln(x)$" },
  { label: "mũ e", tpl: "$e^{x}$" },
  { label: "π", tpl: "$\\pi$" },
  { label: "θ", tpl: "$\\theta$" },
  { label: "Σ", tpl: "$\\sum_{i=1}^{n} x_i$" },
  { label: "∫", tpl: "$\\int_{a}^{b} f(x)\\,dx$" },
  { label: "d/dx", tpl: "$\\frac{d}{dx} f(x)$" },
  { label: "lim", tpl: "$\\lim_{x\\to 0} f(x)$" },
  { label: "≥", tpl: "$\\ge$" },
  { label: "≤", tpl: "$\\le$" },
  { label: "≠", tpl: "$\\ne$" },
  { label: "≈", tpl: "$\\approx$" },
  { label: "vector", tpl: "$\\vec{v}$" },
  { label: "công thức khối", tpl: "$$x^2 + y^2 = z^2$$" }
];

latexGrid.innerHTML = LATEX_TEMPLATES.map(x=>{
  return `<button class="latexChip" type="button" data-tpl="${esc(x.tpl)}">${esc(x.label)}</button>`;
}).join("");

latexGrid.addEventListener("click",(e)=>{
  const b = e.target.closest("[data-tpl]");
  if(!b) return;
  insertTemplateToLatexSrc(b.getAttribute("data-tpl"));
});

updateLatexPreview();

/* ================== BOOT ================== */
async function boot(){
  await requestPersistentStorage();

  const ok = await gateCheck();
  if(!ok) return;

  setTab("q");
  setQuizPage("list");
  resetSettingsToDefaults();
  setMode("NEW");
  QUESTIONS = [];
  ACTIVE_Q_INDEX = -1;
  renderAllQuestions();

  await reloadQuizzes();
  await reloadUsers();
}
(async ()=>{ await boot(); })();
</script>
</body>
</html>
