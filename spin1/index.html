<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
  <title>tuankhoi.site - Spin1</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#ffecd2; --bg2:#fcb69f;
      --card:#fff; --text:#1f2937; --muted:#6b7280;
      --primary:#7c3aed; --ok:#16a34a; --bad:#dc2626;
      --border:#e5e7eb; --soft:#f8fafc;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --radius:18px;
      --admin:#2563eb;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0;
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
        linear-gradient(120deg,var(--bg1) 0%, var(--bg2) 100%);
      overflow:hidden;
      touch-action: pan-x pan-y;
    }

    .btn,.btn-x{touch-action:manipulation;-webkit-tap-highlight-color:transparent}

    #shell{height:100vh;overflow:auto;-webkit-overflow-scrolling:touch;padding:12px 0 90px;touch-action:pan-y}
    .wrap{max-width:1120px;margin:0 auto;padding:0 14px}

    .btn{
      border:0;cursor:pointer;border-radius:999px;padding:10px 14px;
      font-weight:900;font-size:.92rem;
      transition:transform .16s ease, filter .16s ease;
      display:inline-flex;align-items:center;gap:8px;
      user-select:none;white-space:nowrap;
      box-shadow:0 12px 24px rgba(0,0,0,.12);
      background:#fff;color:#111827;border:1px solid #e5e7eb;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(.98)}
    .btn:active{transform:translateY(0)}
    .btn-primary{
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      color:#fff;border:0;
      box-shadow:0 12px 24px rgba(124,58,237,.18);
    }
    .btn-ghost{background:#fff;color:#111827;border:1px solid #e5e7eb;box-shadow:none}
    .btn-danger{background:var(--bad);color:#fff;border:0}
    .btn[disabled]{opacity:.6;cursor:not-allowed;transform:none !important;filter:none !important}

    .topbar{
      margin-top:10px;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(229,231,235,.9);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:14px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .titlebox{display:flex;gap:10px;align-items:center;flex:1 1 360px;min-width:240px}
    .logo{
      width:42px;height:42px;border-radius:16px;
      background:linear-gradient(135deg,#a78bfa,#fb7185);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;
      box-shadow:0 10px 22px rgba(124,58,237,.18);
      user-select:none;
    }
    .titles h1{font-size:1.02rem;margin:0;font-weight:800}
    .titles .tiny{margin-top:3px;font-size:.86rem;color:var(--muted);font-weight:650}

    .pill{
      font-size:.86rem;font-weight:900;
      padding:8px 12px;border-radius:999px;
      background:rgba(255,255,255,.65);
      border:1px solid rgba(229,231,235,.9);
      color:rgba(31,41,55,.75);
      user-select:none;
      display:inline-flex;align-items:center;gap:8px;
      white-space:nowrap;
    }
    .adminBadgeInline{
      padding:4px 8px;border-radius:999px;font-weight:950;font-size:.78rem;
      background:rgba(37,99,235,.12);border:1px solid rgba(37,99,235,.35);
      color:var(--admin);white-space:nowrap;
    }

    .content{padding:12px 0 0}
    .card{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;margin:12px 0;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row-between{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .vi{margin:0;font-weight:900;font-size:1.04rem;line-height:1.25}
    .muted{color:var(--muted);font-weight:650}

    .input{
      width:280px;max-width:100%;
      border-radius:14px;border:2px solid #e5e7eb;
      padding:11px 12px;font-size:.95rem;font-weight:800;
      outline:none;background:var(--soft);
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .input:focus{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 0 0 5px rgba(124,58,237,.10);
      background:#fff;
    }

    .grid{display:grid;grid-template-columns:620px 1fr;gap:12px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .wheelBox{position:relative;display:flex;justify-content:center}
    canvas{
      width:100%;
      max-width:600px; /* l√†m v√≤ng quay to h∆°n */
      height:auto;
      aspect-ratio:1/1;
      background:linear-gradient(180deg, rgba(248,250,252,.9), rgba(255,255,255,.6));
      border-radius:18px;
      border:2px solid rgba(229,231,235,.95);
      box-shadow:0 16px 40px rgba(0,0,0,.08);
    }

    /* KIM ·ªû D∆Ø·ªöI */
    .pointer{
      position:absolute;
      bottom:-10px; left:50%;
      transform:translateX(-50%);
      width:0;height:0;
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-top:30px solid var(--warn);
      filter:drop-shadow(0 14px 18px rgba(0,0,0,.25));
      z-index:5;
      pointer-events:none;
    }

    table{width:100%;border-collapse:separate;border-spacing:0;border:2px solid var(--border);border-radius:16px;overflow:hidden;background:#fff}
    th,td{padding:10px;border-bottom:1px solid rgba(229,231,235,.9);text-align:left;font-weight:750;vertical-align:top}
    th{background:#f8fafc;font-weight:950}
    tr:last-child td{border-bottom:0}

    .tag{
      display:inline-flex;gap:8px;align-items:center;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(229,231,235,.95);
      background:rgba(255,255,255,.65);
      font-weight:900;
      user-select:none;
      white-space:nowrap;
    }
    .ok{color:var(--ok)} .bad{color:var(--bad)}

    /* popup + toast (gi·ªëng style c≈©) */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;align-items:center;justify-content:center;
      padding:16px;z-index:20000;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      width:100%;max-width:520px;
      background:#fff;border-radius:18px;border:1px solid #e5e7eb;
      box-shadow:0 20px 60px rgba(0,0,0,.18);
      padding:14px;max-height:82vh;overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .modal h3{margin:4px 0 6px;font-size:1.02rem}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(17,24,39,.92);color:#fff;
      padding:10px 12px;border-radius:14px;
      font-weight:800;font-size:.9rem;
      opacity:0;pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width:calc(100% - 28px);
      z-index:20050;text-align:center;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
  </style>
</head>

<body>
  <div id="shell">
    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">üé°</div>
          <div class="titles">
            <h1>Spin1</h1>
            <div class="tiny">V√≤ng quay ch·ªß ƒë·ªÅ (1‚Äì12) ‚Ä¢ M·ªói ng∆∞·ªùi 1 l·∫ßn ‚Ä¢ Kh√¥ng tr√πng</div>
          </div>
        </div>
        <div class="pill" id="statusPill">ƒêang t·∫£i‚Ä¶</div>
      </div>

      <div class="content">
        <div class="grid">
          <div class="card">
            <div class="row-between">
              <p class="vi">Nh·∫≠p t√™n ƒë·ªÉ quay</p>
              <div class="tag" id="adminTag" style="display:none;">
                <span class="adminBadgeInline">ADMIN</span>
                <span>MODE</span>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <input id="nameInput" class="input" placeholder="Nh·∫≠p t√™n (max 24)" maxlength="24" autocomplete="off"/>
              <button id="btnSave" class="btn btn-ghost">üíæ L∆∞u t√™n</button>
            </div>
            <div class="muted" style="margin-top:8px" id="nameHint">B·∫Øt bu·ªôc nh·∫≠p t√™n r·ªìi m·ªõi cho quay.</div>

            <div style="height:12px"></div>

            <div class="wheelBox">
              <div class="pointer" aria-hidden="true"></div>
              <canvas id="wheel" width="1100" height="1100"></canvas>
            </div>

            <div style="height:12px"></div>

            <div class="row">
              <button class="btn btn-primary" id="btnSpin">üéØ QUAY 1 L·∫¶N</button>
              <div class="tag" id="statusTag">‚Äî</div>
            </div>
            <div class="muted" style="margin-top:8px" id="spinHint"></div>
          </div>

          <div class="card">
            <div class="row-between">
              <p class="vi" style="margin:0">B·∫£ng k·∫øt qu·∫£</p>
              <div class="muted" id="countText">0/12</div>
            </div>

            <div style="overflow:auto;margin-top:10px">
              <table>
                <thead>
                  <tr>
                    <th style="width:52px">#</th>
                    <th>T√™n</th>
                    <th style="width:130px">Ch·ªß ƒë·ªÅ</th>
                    <th style="width:170px">Th·ªùi gian</th>
                    <th id="adminCol" style="display:none;width:90px">Admin</th>
                  </tr>
                </thead>
                <tbody id="rows"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Popup -->
  <div class="modal-backdrop" id="popup" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="popTitle">
      <h3 id="popTitle">üéâ Ch√∫c m·ª´ng!</h3>
      <div id="popupMsg" class="muted" style="font-weight:800;line-height:1.4"></div>
      <div class="modal-actions" style="margin-top:12px">
        <button id="btnClosePop" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const SUPABASE_URL = "https://aidvlydhbdtwunyreqak.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZHZseWRoYmR0d3VueXJlcWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzM5NzYsImV4cCI6MjA4NDIwOTk3Nn0.LMKGjKlUbC5qoY7hqDpaDFQrFWfwKemBTpxjTNp_L8o";

const TOKEN_KEY = "tk_token_v2";
const NAME_KEY  = "spin1_name";
const NAME_EXP  = "spin1_name_exp";

const TOTAL = 12;
const REFRESH_MS = 8000;

/* ====== helpers ====== */
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=String(msg||"");
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}
function esc(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function normName(s){return String(s||"").trim().replace(/\s+/g," ").toLowerCase();}
function nowMs(){return Date.now();}

function setNameCache(name){
  const exp = nowMs() + 30*24*60*60*1000;
  localStorage.setItem(NAME_KEY, name);
  localStorage.setItem(NAME_EXP, String(exp));
}
function getNameCache(){
  const exp = Number(localStorage.getItem(NAME_EXP)||0);
  if(!exp || exp < nowMs()){
    localStorage.removeItem(NAME_KEY); localStorage.removeItem(NAME_EXP);
    return "";
  }
  return localStorage.getItem(NAME_KEY)||"";
}

function fmtTime(ts){
  const d = new Date(ts);
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  const ss = String(d.getSeconds()).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const MM = String(d.getMonth()+1).padStart(2,"0");
  const yy = String(d.getFullYear()).slice(-2);
  return `${hh}/${mm}/${ss}, ${dd}/${MM}/${yy}`;
}

async function rpc(fn,args){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{
    method:"POST",
    headers:{
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type":"application/json"
    },
    body: JSON.stringify(args||{})
  });
  const txt = await res.text();
  let data=null; try{ data = txt?JSON.parse(txt):null; }catch{}
  if(!res.ok) throw new Error(data?.message||data?.error||txt||"RPC error");
  return data;
}

/* ====== state ====== */
const statusPill = document.getElementById("statusPill");
const nameInput = document.getElementById("nameInput");
const btnSave = document.getElementById("btnSave");
const btnSpin = document.getElementById("btnSpin");
const rowsEl = document.getElementById("rows");
const countText = document.getElementById("countText");
const statusTag = document.getElementById("statusTag");
const spinHint = document.getElementById("spinHint");
const adminTag = document.getElementById("adminTag");
const adminCol = document.getElementById("adminCol");

const popup = document.getElementById("popup");
const popupMsg = document.getElementById("popupMsg");
document.getElementById("btnClosePop").onclick = ()=>{ popup.classList.remove("show"); popup.setAttribute("aria-hidden","true"); };
popup.addEventListener("click",(e)=>{ if(e.target===popup){ popup.classList.remove("show"); popup.setAttribute("aria-hidden","true"); } });

let ME = null;
let ROWS = [];
let taken = new Set();
let rotation = 0;
let spinning = false;

/* ====== admin detect ====== */
async function loadMe(){
  const tk = localStorage.getItem(TOKEN_KEY)||"";
  if(!tk) return null;
  const out = await rpc("api_me",{p_token:tk}).catch(()=>null);
  if(out && out.ok) return out.me;
  return null;
}

/* ====== wheel draw ====== */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

function drawWheel(rot){
  const w = canvas.width, h = canvas.height;
  const cx = w/2, cy = h/2;
  const R = Math.min(w,h)*0.46; // to h∆°n
  const step = Math.PI*2/TOTAL;

  ctx.clearRect(0,0,w,h);

  // n·ªÅn v√≤ng
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(rot);

  for(let i=0;i<TOTAL;i++){
    const topic = i+1;
    const a0 = -Math.PI/2 + i*step;
    const a1 = a0 + step;
    const isTaken = taken.has(topic);

    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,R,a0,a1);
    ctx.closePath();

    // m√†u theo UI c≈© (t√≠m / h·ªìng nh·∫°t), taken th√¨ x√°m
    ctx.fillStyle = isTaken
      ? "rgba(107,114,128,.18)"
      : (i%2===0 ? "rgba(124,58,237,.24)" : "rgba(251,113,133,.20)");
    ctx.fill();

    ctx.strokeStyle = "rgba(31,41,55,.14)";
    ctx.lineWidth = 3;
    ctx.stroke();

    // text
    const mid = (a0+a1)/2;
    ctx.save();
    ctx.rotate(mid);
    ctx.translate(R*0.70,0);
    ctx.rotate(Math.PI/2);

    ctx.fillStyle = isTaken ? "rgba(107,114,128,.75)" : "rgba(31,41,55,.88)";
    ctx.font = "900 46px Montserrat, system-ui, Segoe UI, Arial";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(`${topic}`, 0, 0);

    ctx.font = "900 24px Montserrat, system-ui, Segoe UI, Arial";
    ctx.fillText(`CH·ª¶ ƒê·ªÄ`, 0, -40);

    if(isTaken){
      ctx.font = "900 22px Montserrat, system-ui, Segoe UI, Arial";
      ctx.fillText(`(ƒë√£ c√≥)`, 0, 44);
    }
    ctx.restore();
  }

  // hub
  ctx.beginPath();
  ctx.arc(0,0,R*0.12,0,Math.PI*2);
  ctx.fillStyle = "rgba(255,255,255,.95)";
  ctx.fill();
  ctx.strokeStyle = "rgba(229,231,235,.95)";
  ctx.lineWidth = 6;
  ctx.stroke();

  // ch·∫•m gi·ªØa
  ctx.beginPath();
  ctx.arc(0,0,R*0.045,0,Math.PI*2);
  ctx.fillStyle = "rgba(31,41,55,.75)";
  ctx.fill();

  ctx.restore();
}

/* KIM ·ªû D∆Ø·ªöI => target l√† g√≥c +pi/2 */
function targetRotationForTopic(topic){
  const step = Math.PI*2/TOTAL;
  const center = (topic-1)*step + step/2;
  let base = (Math.PI - center); // (-pi/2 + center + rot) = +pi/2
  const spins = 6 + Math.floor(Math.random()*3);
  return base + spins*(Math.PI*2);
}

function animateTo(target, ms=2300){
  return new Promise((resolve)=>{
    const start = performance.now();
    const from = rotation;
    const diff = target - from;
    function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }
    function step(now){
      const p = Math.min(1,(now-start)/ms);
      rotation = from + diff*easeOutCubic(p);
      drawWheel(rotation);
      if(p<1) requestAnimationFrame(step);
      else resolve();
    }
    requestAnimationFrame(step);
  });
}

/* ====== table render ====== */
function renderTable(){
  countText.textContent = `${ROWS.length}/${TOTAL}`;

  const isAdmin = !!(ME && ME.role==="admin");
  rowsEl.innerHTML = ROWS.map((r,idx)=>{
    const t = fmtTime(r.created_at);
    const delBtn = isAdmin
      ? `<button data-del="${r.id}" class="btn btn-ghost" style="padding:8px 10px;border-radius:12px;border:1px solid rgba(220,38,38,.30);background:rgba(220,38,38,.08);color:#991b1b;box-shadow:none">Xo√°</button>`
      : "";
    return `<tr>
      <td>${idx+1}</td>
      <td>${esc(r.name)}</td>
      <td><b>Ch·ªß ƒë·ªÅ ${r.topic}</b></td>
      <td>${esc(t)}</td>
      <td style="display:${isAdmin?"table-cell":"none"}">${delBtn}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="5" class="muted">Ch∆∞a c√≥ ai quay.</td></tr>`;
}

/* ====== state gate ====== */
function updateGateState(){
  const name = nameInput.value.trim().replace(/\s+/g," ");
  const nn = normName(name);
  const mine = nn ? ROWS.find(r=>normName(r.name)===nn) : null;

  if(ROWS.length>=TOTAL){
    statusTag.innerHTML = `<span class="bad">ƒê√£ ƒë·ªß ${TOTAL}/${TOTAL}</span>`;
    spinHint.textContent = "H·∫øt ch·ªß ƒë·ªÅ. Ch·ªù admin xo√° ƒë·ªÉ quay ti·∫øp.";
    btnSpin.disabled = true;
  }else if(!name){
    statusTag.textContent = "Ch∆∞a nh·∫≠p t√™n";
    spinHint.textContent = "Nh·∫≠p t√™n r·ªìi m·ªõi quay.";
    btnSpin.disabled = true;
  }else if(mine){
    statusTag.textContent = "B·∫°n ƒë√£ quay";
    spinHint.textContent = `B·∫°n ƒë√£ ra Ch·ªß ƒë·ªÅ ${mine.topic}. (Admin xo√° th√¨ b·∫°n quay l·∫°i ƒë∆∞·ª£c)`;
    btnSpin.disabled = true;
  }else{
    statusTag.innerHTML = `<span class="ok">S·∫µn s√†ng</span>`;
    spinHint.textContent = `C√≤n ${TOTAL - taken.size} ch·ªß ƒë·ªÅ tr·ªëng.`;
    btnSpin.disabled = false;
  }

  // status pill
  const admin = (ME && ME.role==="admin") ? ` <span class="adminBadgeInline">ADMIN</span>` : "";
  statusPill.innerHTML = `ƒê√£ quay: <b>${ROWS.length}</b>/${TOTAL}${admin}`;
}

/* ====== load list ====== */
async function loadList(){
  const out = await rpc("api_spin1_list",{}).catch((e)=>({ok:false,error:e.message||"list fail"}));
  if(!out || !out.ok) throw new Error(out?.error || "list fail");

  ROWS = (out.rows||[]).map(x=>({
    id: x.id,
    name: x.name,
    topic: Number(x.topic),
    created_at: x.created_at
  })).slice(0,TOTAL);

  taken = new Set(ROWS.map(r=>r.topic));
  drawWheel(rotation);
  renderTable();
  updateGateState();
}

/* ====== actions ====== */
btnSave.onclick = ()=>{
  const nm = nameInput.value.trim().replace(/\s+/g," ");
  if(!nm){ toast("B·∫°n ch∆∞a nh·∫≠p t√™n"); updateGateState(); return; }
  setNameCache(nm);
  toast("ƒê√£ l∆∞u t√™n");
  updateGateState();
};

nameInput.addEventListener("input", ()=>{
  // √©p g·ªçn kho·∫£ng tr·∫Øng, nh∆∞ng kh√¥ng √©p lowercase ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp
  const v = nameInput.value.replace(/\s+/g," ");
  if(nameInput.value !== v) nameInput.value = v;
  updateGateState();
},{passive:true});

nameInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    btnSave.click();
  }
});

btnSpin.onclick = async ()=>{
  if(spinning) return;

  const nm = nameInput.value.trim().replace(/\s+/g," ");
  if(!nm){ toast("Nh·∫≠p t√™n tr∆∞·ªõc"); updateGateState(); return; }

  setNameCache(nm);

  spinning = true;
  btnSpin.disabled = true;
  statusTag.textContent = "ƒêang quay‚Ä¶";
  spinHint.textContent = "Vui l√≤ng ch·ªù‚Ä¶";

  try{
    const out = await rpc("api_spin1_spin",{ p_name: nm });
    if(!out || !out.ok){
      await loadList();
      toast(out?.error || "Kh√¥ng quay ƒë∆∞·ª£c");
      return;
    }
    const row = out.row;
    const topic = Number(row.topic);

    const target = targetRotationForTopic(topic);
    await animateTo(target, 2350);

    popupMsg.innerHTML = `Ch√∫c m·ª´ng <b>${esc(nm)}</b> ƒë√£ ch·ªçn <b>Ch·ªß ƒë·ªÅ ${topic}</b> üéâ`;
    popup.classList.add("show");
    popup.setAttribute("aria-hidden","false");

    await loadList();
  }catch(e){
    toast(e.message||"L·ªói");
    await loadList();
  }finally{
    spinning = false;
    updateGateState();
  }
};

// admin delete
rowsEl.addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-del]");
  if(!btn) return;
  if(!(ME && ME.role==="admin")) return;

  const id = btn.getAttribute("data-del");
  if(!confirm("Xo√° l∆∞·ª£t quay n√†y? (tr·∫£ ch·ªß ƒë·ªÅ v·ªÅ v√≤ng quay)")) return;

  const tk = localStorage.getItem(TOKEN_KEY)||"";
  try{
    const out = await rpc("api_spin1_admin_delete",{ p_token: tk, p_id: id });
    if(!out || !out.ok){ toast(out?.error||"Xo√° l·ªói"); return; }
    toast("ƒê√£ xo√°");
    await loadList();
  }catch(err){
    toast(err.message||"Xo√° l·ªói");
  }
});

/* ====== boot ====== */
(async ()=>{
  if(SUPABASE_ANON_KEY.includes("PASTE_")){
    toast("Ch∆∞a d√°n SUPABASE_ANON_KEY");
    return;
  }

  // load cached name
  nameInput.value = getNameCache();

  // admin
  ME = await loadMe().catch(()=>null);
  if(ME && ME.role==="admin"){
    adminTag.style.display="";
    adminCol.style.display="";
  }

  // initial
  drawWheel(rotation);
  await loadList();

  // auto refresh (KH√îNG hi·ªán h∆∞·ªõng d·∫´n th·ª´a)
  setInterval(()=>loadList().catch(()=>{}), REFRESH_MS);
})();
</script>
</body>
</html>
