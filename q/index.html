<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
  <title>K·∫øt qu·∫£</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#ffecd2; --bg2:#fcb69f;
      --card:#fff; --text:#1f2937; --muted:#6b7280;
      --primary:#7c3aed; --ok:#16a34a; --bad:#dc2626;
      --border:#e5e7eb; --soft:#f8fafc;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --radius:18px;
      --admin:#2563eb;
      --pin:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
                  linear-gradient(120deg,var(--bg1) 0%,var(--bg2) 100%);
      overflow:hidden;
    }
    #shell{height:100vh;overflow:auto;-webkit-overflow-scrolling:touch;padding:12px 0 110px}
    .wrap{max-width:980px;margin:0 auto;padding:0 14px}

    .actionbar{
      position:sticky;top:10px;z-index:9999;
      display:flex;justify-content:flex-end;gap:10px;padding:0 14px;flex-wrap:wrap;
    }
    .btn{
      border:0;cursor:pointer;border-radius:999px;padding:10px 14px;
      font-weight:900;font-size:.9rem;
      transition:transform .16s ease,filter .16s ease;
      display:inline-flex;align-items:center;gap:8px;
      user-select:none;white-space:nowrap;
      box-shadow:0 12px 24px rgba(0,0,0,.12);
      background:#fff;color:#111827;border:1px solid #e5e7eb;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(.98)}
    .btn:active{transform:translateY(0)}
    .btn-primary{background:linear-gradient(135deg,#7c3aed,#fb7185);color:#fff;border:0}
    .btn-ghost{background:#fff;color:#111827;border:1px solid #e5e7eb;box-shadow:none}
    .btn-mini{
      padding:8px 10px;border-radius:999px;
      font-weight:950;font-size:.82rem;
      border:1px solid #e5e7eb;background:#fff;cursor:pointer;
    }
    .btn-mini.danger{background:rgba(220,38,38,.95);color:#fff;border:0}
    .btn-mini.primary{background:linear-gradient(135deg,#7c3aed,#fb7185);color:#fff;border:0}

    .card{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;margin:12px 0;
    }
    .row1{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .vi{margin:0;font-weight:900;font-size:1.04rem;line-height:1.25}
    .muted{color:var(--muted);font-weight:650}
    .idx{
      font-size:.78rem;font-weight:900;
      padding:6px 10px;border-radius:999px;
      background:#eff6ff;color:#1d4ed8;border:1px solid #dbeafe;
      white-space:nowrap;
    }

    .topbar{
      margin-top:10px;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(229,231,235,.9);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:14px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .titlebox{display:flex;gap:10px;align-items:center;flex:1 1 360px;min-width:240px}
    .logo{
      width:42px;height:42px;border-radius:16px;
      background:linear-gradient(135deg,#a78bfa,#fb7185);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;
      box-shadow:0 10px 22px rgba(124,58,237,.18);
      user-select:none;
    }
    .titles h1{font-size:1.02rem;margin:0;font-weight:800}
    .titles .tiny{margin-top:3px;font-size:.86rem;color:var(--muted);font-weight:650}

    .pill{
      background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;
      padding:8px 12px;font-weight:900;font-size:.9rem;color:#374151;white-space:nowrap;
    }
    .pill strong{color:var(--primary)}
    .oktxt{color:var(--ok);font-weight:1000}
    .badtxt{color:var(--bad);font-weight:1000}

    .lbRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:16px;border:1px solid #e5e7eb;background:#fff;
      margin-top:10px;
    }
    .lbLeft{display:flex;align-items:center;gap:10px;min-width:0}
    .lbRank{
      width:34px;height:34px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      font-weight:1000;border:1px solid #e5e7eb;background:#f8fafc;
      flex:0 0 auto;
    }
    .lbName{font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:52vw}
    .lbScore{font-weight:1000}
    .badgeAdmin{
      padding:4px 8px;border-radius:999px;font-weight:950;font-size:.78rem;
      background:rgba(37,99,235,.12);
      border:1px solid rgba(37,99,235,.35);
      color:var(--admin);
      flex:0 0 auto;
    }
    .badgePin{
      padding:4px 8px;border-radius:999px;font-weight:950;font-size:.78rem;
      background:rgba(245,158,11,.14);
      border:1px solid rgba(245,158,11,.35);
      color:#b45309;
      flex:0 0 auto;
    }

    .input{
      width:100%;
      border-radius:14px;border:2px solid #e5e7eb;
      padding:11px 12px;font-size:.95rem;font-weight:700;
      outline:none;background:var(--soft);
    }
    textarea.input{min-height:110px;resize:vertical}

    .cmtItem{
      margin-top:10px;border:1px solid #e5e7eb;background:#fff;
      border-radius:16px;padding:10px 12px;
    }
    .cmtItem.reply{margin-left:22px;border-left:4px solid rgba(124,58,237,.25)}
    .cmtHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .cmtWho{display:flex;align-items:center;gap:8px;min-width:0}
    .cmtName{font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:58vw}
    .cmtTime{color:var(--muted);font-weight:750;font-size:.84rem;white-space:nowrap}
    .cmtText{margin-top:8px;font-weight:750;line-height:1.35;white-space:pre-wrap}
    .cmtActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .replyBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px dashed #e5e7eb;
      background:#fff;
    }

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(17,24,39,.92);color:#fff;
      padding:10px 12px;border-radius:14px;
      font-weight:800;font-size:.9rem;
      opacity:0;pointer-events:none;
      transition:opacity .18s ease,transform .18s ease;
      max-width:calc(100% - 28px);
      z-index:20050;text-align:center;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
  </style>
</head>

<body>
  <div id="shell">
    <div class="actionbar">
      <button class="btn btn-ghost" id="btnHome">üè† Trang ch·ªß</button>
      <button class="btn" id="btnBackQuiz">üìù V·ªÅ quiz</button>
      <button class="btn" id="btnScrollTop">‚¨ÜÔ∏è L√™n ƒë·∫ßu</button>
    </div>

    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">OK</div>
          <div class="titles">
            <h1 id="quizTitle">K·∫øt qu·∫£</h1>
            <div class="tiny" id="quizSub"></div>
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div class="pill">ƒêi·ªÉm: <strong id="score10">0.0</strong>/10</div>
          <div class="pill">ƒê√∫ng: <strong id="correct">0</strong>/<span id="total">0</span></div>
        </div>
      </div>

      <div id="main"></div>

      <div id="leaderboard"></div>

      <div id="comments"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ================== CONFIG ================== */
const HOME_URL = "/";
const SUPABASE_URL = "https://aidvlydhbdtwunyreqak.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZHZseWRoYmR0d3VueXJlcWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzM5NzYsImV4cCI6MjA4NDIwOTk3Nn0.LMKGjKlUbC5qoY7hqDpaDFQrFWfwKemBTpxjTNp_L8o";

const TOKEN_KEY = "tk_token_v2";
const ME_KEY = "tk_me_v2";

const RPC = {
  me: "api_me",
  listLeaderboard: "api_list_leaderboard",
  listComments: "api_list_comments",
  addComment: "api_add_comment",
  deleteComment: "api_delete_comment",
  pinComment: "api_pin_comment"
};

/* ================== HELPERS ================== */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = String(msg||"");
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1300);
}
function escapeHtml(s){
  return String(s??"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function pad2(n){ return String(n).padStart(2,"0"); }
function fmtTime(ts){
  const d = new Date(ts);
  if(!isFinite(d.getTime())) return "‚Äî";
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}/${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)}`;
}
function getToken(){ try{ return (localStorage.getItem(TOKEN_KEY)||"").trim(); }catch{ return ""; } }
function getMeCache(){ try{ return JSON.parse(localStorage.getItem(ME_KEY)||"null"); }catch{ return null; } }
function isAdminUser(me){
  if(!me) return false;
  const u = String(me.username||"").toLowerCase();
  return me.role==="admin" || u==="tuankhoi";
}
function medal(rank){
  if(rank===1) return "ü•á";
  if(rank===2) return "ü•à";
  if(rank===3) return "ü•â";
  return "";
}

/* ================== SUPABASE ================== */
async function sbRpc(fn, args){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{
    method:"POST",
    headers:{
      "apikey": String(SUPABASE_ANON_KEY).trim(),
      "Authorization": "Bearer " + String(SUPABASE_ANON_KEY).trim(),
      "Content-Type":"application/json"
    },
    body: JSON.stringify(args||{})
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "RPC error");
  }
  return data;
}
async function sbGet(path){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{
    headers:{
      "apikey": String(SUPABASE_ANON_KEY).trim(),
      "Authorization": "Bearer " + String(SUPABASE_ANON_KEY).trim()
    }
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST GET error");
  }
  return data;
}

/* ================== STATE ================== */
const mainEl = document.getElementById("main");
const lbEl = document.getElementById("leaderboard");
const cmtEl = document.getElementById("comments");

const qs = new URLSearchParams(location.search);
const quizId = String(qs.get("quiz")||"").toLowerCase().replace(/[^a-z]/g,"").slice(0,5);
const attemptId = String(qs.get("attempt")||"").trim();

let me = null;
let quizMeta = { title:"K·∫øt qu·∫£", sub:"" };
let attempt = null;       // from DB if possible
let answers = [];         // attempt_answers joined vocabs
let LB = [];
let CMTS = [];
let replyingTo = null;    // root comment id

function goHome(){ location.href = HOME_URL; }
function goQuiz(){ location.href = `/q/${quizId}`; }

/* ================== LOADERS ================== */
async function loadMeIfAny(){
  const token = getToken();
  if(!token) return null;
  try{
    const out = await sbRpc(RPC.me, { p_token: token });
    if(!out || out.ok!==true) return null;
    const m = out.me || out.user || out.data || null;
    if(m && m.id && !m.user_id) m.user_id = m.id;
    return m;
  }catch{
    return null;
  }
}

async function loadQuizMeta(){
  const qArr = await sbGet(`quizzes?quiz_id=eq.${quizId}&select=quiz_id,title,sub&limit=1`);
  const q = (Array.isArray(qArr) && qArr[0]) ? qArr[0] : null;
  return {
    title: q?.title || `Quiz ${quizId}`,
    sub: q?.sub || ""
  };
}

async function loadAttemptFromSession(){
  try{
    const raw = sessionStorage.getItem(`tk_last_result::${quizId}`);
    if(!raw) return null;
    const x = JSON.parse(raw);
    if(!x || x.quiz_id !== quizId) return null;
    return x; // {attempt_id,result,me,ts,...}
  }catch{
    return null;
  }
}

async function loadAttemptFromDb(){
  if(!attemptId) return null;

  // attempts row
  const a = await sbGet(`attempts?attempt_id=eq.${encodeURIComponent(attemptId)}&select=attempt_id,quiz_id,user_id,created_at,score10,correct_count,total_count&limit=1`);
  const row = (Array.isArray(a) && a[0]) ? a[0] : null;
  if(!row) return null;

  // attempt_answers embed vocabs
  let ans = [];
  try{
    ans = await sbGet(`attempt_answers?attempt_id=eq.${encodeURIComponent(attemptId)}&select=vocab_id,user_answer,expected,ok,vocabs(word,pos,no)&order=vocab_id.asc`);
  }catch{
    ans = [];
  }

  return { row, ans };
}

async function loadLeaderboard(){
  // ∆∞u ti√™n RPC
  try{
    const out = await sbRpc(RPC.listLeaderboard, { p_quiz_id: quizId, p_limit: 20 });
    if(out && out.ok) return out.rows || [];
  }catch{}

  // fallback view
  try{
    const rows = await sbGet(`v_leaderboard?quiz_id=eq.${quizId}&select=name,is_admin,score10&order=score10.desc&limit=20`);
    return rows || [];
  }catch{
    return [];
  }
}

async function loadComments(){
  try{
    const out = await sbRpc(RPC.listComments, { p_quiz_id: quizId, p_limit: 200 });
    if(out && out.ok) return out.rows || [];
    return [];
  }catch{
    return [];
  }
}

/* ================== RENDERS ================== */
function renderSummary(){
  const titleEl = document.getElementById("quizTitle");
  const subEl = document.getElementById("quizSub");
  titleEl.textContent = quizMeta.title;
  subEl.textContent = quizMeta.sub || "";

  const scoreEl = document.getElementById("score10");
  const correctEl = document.getElementById("correct");
  const totalEl = document.getElementById("total");

  if(attempt?.row){
    scoreEl.textContent = Number(attempt.row.score10||0).toFixed(1);
    correctEl.textContent = String(attempt.row.correct_count||0);
    totalEl.textContent = String(attempt.row.total_count||0);
  }else if(attempt?.result){
    scoreEl.textContent = Number(attempt.result.score10||0).toFixed(1);
    correctEl.textContent = String(attempt.result.correctCount||0);
    totalEl.textContent = String(attempt.result.totalCount||0);
  }else{
    scoreEl.textContent = "0.0";
    correctEl.textContent = "0";
    totalEl.textContent = "0";
  }

  if(!attempt){
    mainEl.innerHTML = `
      <div class="card">
        <div class="row1">
          <p class="vi">Kh√¥ng c√≥ d·ªØ li·ªáu k·∫øt qu·∫£</p>
          <div class="meta"><span class="idx">NO RESULT</span></div>
        </div>
        <div class="muted" style="margin-top:8px;line-height:1.35">
          Link ƒë√∫ng: <b>/result.html?quiz=abcde&amp;attempt=...</b><br/>
          Ho·∫∑c b·∫°n v·ª´a n·ªôp b√†i xong th√¨ m·ªü l·∫°i t·ª´ quiz.
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btn-primary" onclick="location.href='/q/${quizId}'">üìù V·ªÅ quiz</button>
        </div>
      </div>`;
    return;
  }

  const who = (attempt.me?.username || me?.username || "‚Äî");
  const when = attempt.row?.created_at ? fmtTime(attempt.row.created_at) : fmtTime(attempt.ts || Date.now());

  // wrong list
  let wrongHtml = "";
  if(attempt.row && Array.isArray(answers) && answers.length){
    const wrong = answers.filter(x=>x && x.ok===false);
    wrongHtml = wrong.length ? wrong.map(x=>{
      const w = x.vocabs?.word || "";
      const pos = x.vocabs?.pos || "";
      const ua = x.user_answer || "";
      const ex = x.expected || "";
      return `
        <div class="card" style="box-shadow:none;border-width:1px">
          <div class="row1">
            <p class="vi" style="margin:0">${escapeHtml(w)} <span class="muted">(${escapeHtml(pos)})</span></p>
            <div class="meta"><span class="idx">SAI</span></div>
          </div>
          <div class="muted" style="margin-top:8px"><b>B·∫°n:</b> ${escapeHtml(ua || "(tr·ªëng)")}</div>
          <div class="muted" style="margin-top:6px"><b>ƒê√°p √°n:</b> ${escapeHtml(ex)}</div>
        </div>
      `;
    }).join("") : `<div class="muted" style="margin-top:8px">Kh√¥ng c√≥ c√¢u sai üéâ</div>`;
  } else if(attempt.result && Array.isArray(attempt.result.wrong)){
    wrongHtml = attempt.result.wrong.length ? attempt.result.wrong.map(x=>`
      <div class="card" style="box-shadow:none;border-width:1px">
        <div class="row1">
          <p class="vi" style="margin:0">${escapeHtml(x.word||"")}</p>
          <div class="meta"><span class="idx">SAI</span></div>
        </div>
        <div class="muted" style="margin-top:8px"><b>B·∫°n:</b> ${escapeHtml(x.user || "(tr·ªëng)")}</div>
        <div class="muted" style="margin-top:6px"><b>ƒê√°p √°n:</b> ${escapeHtml(x.expected||"")}</div>
      </div>
    `).join("") : `<div class="muted" style="margin-top:8px">Kh√¥ng c√≥ c√¢u sai üéâ</div>`;
  } else {
    wrongHtml = `<div class="muted" style="margin-top:8px">(Kh√¥ng t·∫£i ƒë∆∞·ª£c chi ti·∫øt ƒë√°p √°n)</div>`;
  }

  mainEl.innerHTML = `
    <div class="card">
      <div class="row1">
        <p class="vi">T√≥m t·∫Øt</p>
        <div class="meta"><span class="idx">${escapeHtml(quizId)}</span></div>
      </div>
      <div class="muted" style="margin-top:8px;line-height:1.35">
        <b>T√™n:</b> ${escapeHtml(who)}<br/>
        <b>Th·ªùi gian:</b> ${escapeHtml(when)}<br/>
        <b>Attempt:</b> ${escapeHtml(attempt.row?.attempt_id || attempt.attempt_id || "")}
      </div>
      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn btn-ghost" id="btnRefresh">üîÑ T·∫£i l·∫°i</button>
      </div>
    </div>

    <div class="card">
      <div class="row1">
        <p class="vi">Chi ti·∫øt (c√¢u sai)</p>
        <div class="meta"><span class="idx">DETAIL</span></div>
      </div>
      ${wrongHtml}
    </div>
  `;

  document.getElementById("btnRefresh").onclick = ()=>boot(true);
}

function renderLeaderboard(){
  const rows = Array.isArray(LB) ? LB : [];
  const body = rows.length ? rows.map((r,i)=>{
    const rank=i+1;
    const tag = r.is_admin ? `<span class="badgeAdmin">ADMIN</span>` : ``;
    return `
      <div class="lbRow">
        <div class="lbLeft">
          <div class="lbRank">${medal(rank) || rank}</div>
          <div style="min-width:0">
            <div class="lbName">${escapeHtml(r.name||"‚Äî")} ${tag}</div>
            <div class="muted" style="font-weight:750;font-size:.86rem">ƒêi·ªÉm cao nh·∫•t</div>
          </div>
        </div>
        <div class="lbScore">${Number(r.score10||0).toFixed(1)}/10</div>
      </div>
    `;
  }).join("") : `<div class="muted" style="margin-top:8px">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>`;

  lbEl.innerHTML = `
    <div class="card">
      <div class="row1">
        <p class="vi">B·∫£ng x·∫øp h·∫°ng</p>
        <div class="meta"><span class="idx">TOP 20</span></div>
      </div>
      <div class="muted" style="margin-top:6px">ƒêi·ªÉm = ƒëi·ªÉm cao nh·∫•t c·ªßa m·ªói ng∆∞·ªùi trong quiz n√†y.</div>
      ${body}
    </div>
  `;
}

async function apiAddComment(text, parentId){
  const token = getToken();
  if(!token) throw new Error("B·∫°n c·∫ßn login ƒë·ªÉ b√¨nh lu·∫≠n");
  // ∆∞u ti√™n param chu·∫©n p_quiz_id, p_text, p_token, p_parent_id
  return await sbRpc(RPC.addComment, {
    p_quiz_id: quizId,
    p_text: String(text||""),
    p_token: token,
    p_parent_id: parentId ? String(parentId) : null
  });
}
async function apiDeleteComment(commentId){
  const token = getToken();
  if(!token) throw new Error("B·∫°n c·∫ßn login");
  return await sbRpc(RPC.deleteComment, { p_token: token, p_comment_id: String(commentId).trim() });
}
async function apiPinComment(commentId, pin){
  const token = getToken();
  if(!token) throw new Error("B·∫°n c·∫ßn login");
  return await sbRpc(RPC.pinComment, { p_token: token, p_comment_id: String(commentId).trim(), p_pin: !!pin });
}

function renderComments(){
  const rows = Array.isArray(CMTS) ? CMTS : [];
  const canWrite = !!(me && me.user_id && getToken());
  const isAdmin = isAdminUser(me);

  // build 1-level tree
  const byParent = new Map();
  const roots = [];
  rows.forEach(c=>{
    const pid = c.parent_id || null;
    if(pid){
      if(!byParent.has(pid)) byParent.set(pid, []);
      byParent.get(pid).push(c);
    }else{
      roots.push(c);
    }
  });

  // pinned first if field exists
  roots.sort((a,b)=> (b.pinned===true)-(a.pinned===true) || (new Date(b.created_at)-new Date(a.created_at)));

  function replyBoxHtml(rootId){
    if(replyingTo !== rootId) return "";
    return `
      <div class="replyBox">
        <div class="muted" style="margin-bottom:8px">Tr·∫£ l·ªùi b√¨nh lu·∫≠n</div>
        <textarea class="input" data-replybox="${escapeHtml(rootId)}" placeholder="${canWrite?'Nh·∫≠p tr·∫£ l·ªùi‚Ä¶':'(C·∫ßn login)'}" ${canWrite?'':'disabled'}></textarea>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn-mini" data-cancelreply="${escapeHtml(rootId)}">‚úñÔ∏è H·ªßy</button>
          <button class="btn-mini primary" data-sendreply="${escapeHtml(rootId)}" ${canWrite?'':'disabled'}>üì® G·ª≠i</button>
        </div>
      </div>
    `;
  }

  function itemHtml(c,isReply=false){
    const tagAdmin = c.is_admin ? `<span class="badgeAdmin">ADMIN</span>` : ``;
    const tagPin = c.pinned ? `<span class="badgePin">üìå PIN</span>` : ``;

    const canDel = canWrite && (isAdmin || String(c.user_id||"")===String(me.user_id||""));
    const showPinBtn = isAdmin; // n·∫øu RPC pin ch∆∞a c√≥ th√¨ click s·∫Ω b√°o l·ªói

    const actions = `
      <div class="cmtActions">
        ${(!isReply && canWrite) ? `<button class="btn-mini" data-reply="${escapeHtml(c.id)}">üí¨ Tr·∫£ l·ªùi</button>` : ``}
        ${canDel ? `<button class="btn-mini danger" data-del="${escapeHtml(c.id)}">üóëÔ∏è Xo√°</button>` : ``}
        ${showPinBtn && !isReply ? `<button class="btn-mini ${c.pinned?'':'primary'}" data-pin="${escapeHtml(c.id)}" data-pinval="${c.pinned?0:1}">${c.pinned?'B·ªè ghim':'üìå Ghim'}</button>` : ``}
      </div>
    `;

    const replies = (byParent.get(c.id)||[]).map(rc=>itemHtml(rc,true)).join("");

    return `
      <div class="cmtItem ${isReply?'reply':''}">
        <div class="cmtHead">
          <div class="cmtWho">
            <div class="cmtName">${escapeHtml(c.username||"‚Äî")}</div>
            ${tagAdmin}
            ${tagPin}
          </div>
          <div class="cmtTime">${fmtTime(c.created_at)}</div>
        </div>
        <div class="cmtText">${escapeHtml(c.text||"")}</div>
        ${actions}
        ${!isReply ? replyBoxHtml(c.id) : ""}
        ${replies}
      </div>
    `;
  }

  const listHtml = roots.length ? roots.map(c=>itemHtml(c,false)).join("") : `<div class="muted" style="margin-top:8px">Ch∆∞a c√≥ b√¨nh lu·∫≠n.</div>`;

  cmtEl.innerHTML = `
    <div class="card">
      <div class="row1">
        <p class="vi">B√¨nh lu·∫≠n</p>
        <div class="meta"><span class="idx">COMMENTS</span></div>
      </div>
      <div class="muted" style="margin-top:6px;line-height:1.35">
        ${canWrite ? `B·∫°n ƒëang login: <b>${escapeHtml(me.username)}</b>` : `B·∫°n ch∆∞a login (v·∫´n xem ƒë∆∞·ª£c b√¨nh lu·∫≠n, nh∆∞ng kh√¥ng g·ª≠i/x√≥a/ghim).`}
      </div>

      <div class="card" style="box-shadow:none;border-width:1px;margin-top:12px">
        <div class="row1">
          <p class="vi" style="margin:0">Vi·∫øt b√¨nh lu·∫≠n m·ªõi</p>
          <div class="meta"><span class="idx">ROOT</span></div>
        </div>
        <div style="margin-top:10px;display:grid;gap:10px">
          <textarea class="input" id="rootBox" placeholder="${canWrite?'Nh·∫≠p b√¨nh lu·∫≠n‚Ä¶':'(C·∫ßn login)'}" ${canWrite?'':'disabled'}></textarea>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-ghost" id="btnReloadCmt">üîÑ T·∫£i l·∫°i</button>
            <button class="btn btn-primary" id="btnSendRoot" ${canWrite?'':'disabled'}>üì® G·ª≠i</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        ${listHtml}
      </div>
    </div>
  `;

  // handlers
  document.getElementById("btnReloadCmt").onclick = ()=>refreshComments(true);
  document.getElementById("btnSendRoot").onclick = async ()=>{
    const box = document.getElementById("rootBox");
    const text = String(box.value||"").trim();
    if(!text) return toast("Ch∆∞a nh·∫≠p n·ªôi dung");
    try{
      await apiAddComment(text, null);
      box.value="";
      toast("ƒê√£ g·ª≠i");
      await refreshComments(false);
    }catch(e){
      toast(e?.message || "L·ªói");
    }
  };

  cmtEl.querySelectorAll("[data-reply]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-reply");
      replyingTo = (replyingTo===id) ? null : id;
      renderComments(); // re-render to show inline reply box
      const ta = cmtEl.querySelector(`[data-replybox="${CSS.escape(id)}"]`);
      try{ ta && ta.focus(); }catch{}
    });
  });

  cmtEl.querySelectorAll("[data-cancelreply]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      replyingTo = null;
      renderComments();
    });
  });

  cmtEl.querySelectorAll("[data-sendreply]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const rootId = btn.getAttribute("data-sendreply");
      const ta = cmtEl.querySelector(`[data-replybox="${CSS.escape(rootId)}"]`);
      const text = String(ta?.value||"").trim();
      if(!text) return toast("Ch∆∞a nh·∫≠p n·ªôi dung");
      try{
        await apiAddComment(text, rootId);
        replyingTo = null;
        toast("ƒê√£ g·ª≠i");
        await refreshComments(false);
      }catch(e){
        toast(e?.message || "L·ªói");
      }
    });
  });

  cmtEl.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-del"); // UUID string
      if(!confirm("Xo√° b√¨nh lu·∫≠n n√†y?")) return;
      try{
        const out = await apiDeleteComment(id);
        if(out && out.ok===false) throw new Error(out.error || "Kh√¥ng xo√° ƒë∆∞·ª£c");
        toast("ƒê√£ xo√°");
        await refreshComments(false);
      }catch(e){
        toast(e?.message || "Kh√¥ng xo√° ƒë∆∞·ª£c");
      }
    });
  });

  cmtEl.querySelectorAll("[data-pin]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-pin");
      const val = Number(btn.getAttribute("data-pinval")||"0")===1;
      try{
        const out = await apiPinComment(id, val);
        if(out && out.ok===false) throw new Error(out.error || "Kh√¥ng ghim ƒë∆∞·ª£c");
        toast(val ? "ƒê√£ ghim" : "ƒê√£ b·ªè ghim");
        await refreshComments(false);
      }catch(e){
        toast(e?.message || "Ch∆∞a b·∫≠t t√≠nh nƒÉng ghim");
      }
    });
  });
}

async function refreshComments(showToast){
  if(showToast) toast("ƒêang t·∫£i...");
  CMTS = await loadComments();
  renderComments();
}

/* ================== BOOT ================== */
async function boot(forceReload){
  if(!quizId || quizId.length!==5){
    mainEl.innerHTML = `
      <div class="card">
        <div class="row1"><p class="vi">Sai quiz id</p><div class="meta"><span class="idx">ERROR</span></div></div>
        <div class="muted" style="margin-top:8px">URL ƒë√∫ng: /result.html?quiz=abcde&attempt=...</div>
      </div>`;
    return;
  }

  quizMeta = await loadQuizMeta();

  // me
  me = getMeCache();
  if(me && me.id && !me.user_id) me.user_id = me.id;
  if(getToken() && (!me || !me.user_id)){
    const m2 = await loadMeIfAny();
    if(m2) me = m2;
  }

  // attempt
  attempt = null;
  answers = [];

  const fromDb = await loadAttemptFromDb();
  if(fromDb && fromDb.row){
    attempt = { row: fromDb.row };
    answers = Array.isArray(fromDb.ans) ? fromDb.ans : [];
  }else{
    const fromSess = await loadAttemptFromSession();
    if(fromSess){
      attempt = fromSess;
    }
  }

  renderSummary();

  // leaderboard + comments ch·ªâ khi c√≥ attempt (ƒë√∫ng y√™u c·∫ßu)
  if(attempt){
    LB = await loadLeaderboard();
    renderLeaderboard();

    CMTS = await loadComments();
    renderComments();
  }else{
    lbEl.innerHTML = "";
    cmtEl.innerHTML = "";
  }
}

/* ================== BUTTONS ================== */
document.getElementById("btnHome").onclick = ()=>goHome();
document.getElementById("btnBackQuiz").onclick = ()=>goQuiz();
document.getElementById("btnScrollTop").onclick = ()=>{
  document.getElementById("shell").scrollTo({ top:0, behavior:"smooth" });
};

boot(false);
</script>
</body>
</html>
