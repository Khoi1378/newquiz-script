<!doctype html><html lang="vi"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"/>

<title>Quiz</title>
<meta name="description" content="Quiz • ID quiz: -----"/>

<!-- Open Graph / Zalo / Messenger -->
<meta property="og:type" content="website"/>
<meta property="og:site_name" content="tuankhoi.site"/>
<meta property="og:title" content="Quiz"/>
<meta property="og:description" content="Làm Quiz đii"/>
<meta property="og:url" content="https://www.tuankhoi.site"/>
<meta property="og:image" content=""/>
<meta property="og:image:alt" content="Quiz"/>
<meta name="twitter:image" content=""/>

<!-- Twitter Card (nhiều nền tảng cũng đọc) -->
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Quiz"/>
<meta name="twitter:description" content="Quiz • ID quiz: -----"/>

<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet"><style>:root{--bg1:#ffecd2;--bg2:#fcb69f;--card:#fff;--text:#1f2937;--muted:#6b7280;--primary:#7c3aed;--ok:#16a34a;--bad:#dc2626;--border:#e5e7eb;--soft:#f8fafc;--shadow:0 14px 40px rgba(0,0,0,.10);--radius:18px;--admin:#2563eb;--vh:1vh}*{box-sizing:border-box}html,body{height:100%}html{-webkit-text-size-adjust:100%}
body{margin:0;font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:radial-gradient(1200px 600px at 20% 10%,#fff 0%,rgba(255,255,255,0) 55%),linear-gradient(120deg,var(--bg1) 0%,var(--bg2) 100%);overflow:hidden;touch-action:pan-x pan-y}
button,input,textarea,select{font-family:inherit} /* FIX font button PC */

.btn,.btn-x,.pinKey{touch-action:manipulation;-webkit-tap-highlight-color:transparent}
.hidden{display:none!important}#shell{height:calc(var(--vh,1vh)*100);min-height:100vh;overflow:auto;-webkit-overflow-scrolling:touch;padding:12px 0 calc(170px + env(safe-area-inset-bottom,0px));touch-action:pan-y}.wrap{max-width:980px;margin:0 auto;padding:0 14px}.userCorner{position:fixed;top:10px;left:12px;z-index:10010;display:none;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.55);border:1px solid rgba(229,231,235,.65);backdrop-filter:blur(6px);box-shadow:0 10px 22px rgba(0,0,0,.06);user-select:none;max-width:calc(100vw - 24px);cursor:pointer}.userCorner .name{font-weight:950;font-size:.88rem;color:rgba(31,41,55,.55);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:58vw}.userCorner .adminBadge{padding:4px 8px;border-radius:999px;font-weight:950;font-size:.78rem;background:rgba(37,99,235,.12);border:1px solid rgba(37,99,235,.35);color:var(--admin);white-space:nowrap}.actionbar{position:sticky;top:10px;z-index:9999;display:flex;justify-content:flex-end;gap:10px;padding:0 14px;flex-wrap:wrap}.btn{border:0;cursor:pointer;border-radius:999px;padding:10px 14px;font-weight:900;font-size:.9rem;transition:transform .16s ease,filter .16s ease;display:inline-flex;align-items:center;gap:8px;user-select:none;white-space:nowrap;box-shadow:0 12px 24px rgba(0,0,0,.12);background:#fff;color:#111827;border:1px solid #e5e7eb;font-family:inherit}.btn:hover{transform:translateY(-1px);filter:brightness(.98)}.btn:active{transform:translateY(0)}.btn-reset{background:#111827;color:#fff;border:0}.btn-primary{background:linear-gradient(135deg,#7c3aed,#fb7185);color:#fff;border:0;box-shadow:0 12px 24px rgba(124,58,237,.18)}.btn-ghost{background:#fff;color:#111827;border:1px solid #e5e7eb;box-shadow:none}.btn-danger{background:var(--bad);color:#fff;border:0}.btn[disabled]{opacity:.65;cursor:not-allowed;transform:none!important;filter:none!important}.topbar{margin-top:10px;background:rgba(255,255,255,.86);border:1px solid rgba(229,231,235,.9);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:14px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}.titlebox{display:flex;gap:10px;align-items:center;flex:1 1 360px;min-width:240px}.logo{width:42px;height:42px;border-radius:16px;background:linear-gradient(135deg,#a78bfa,#fb7185);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;box-shadow:0 10px 22px rgba(124,58,237,.18);user-select:none}.titles h1{font-size:1.02rem;margin:0;font-weight:800}.titles .tiny{margin-top:3px;font-size:.86rem;color:var(--muted);font-weight:650}.stats{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.pill{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:8px 12px;font-weight:800;font-size:.9rem;color:#374151;white-space:nowrap}.pill strong{color:var(--primary)}.progressline{height:10px;border-radius:999px;background:#f3f4f6;overflow:hidden;border:1px solid #e5e7eb;width:100%;max-width:360px}.progressfill{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#a78bfa);transition:width .25s ease}.content{padding:12px 0 0}.card{background:var(--card);border:2px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:12px 0}.row1{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}.vi{margin:0;font-weight:900;font-size:1.04rem;line-height:1.25}.meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.idx{font-size:.78rem;font-weight:900;padding:6px 10px;border-radius:999px;background:#eff6ff;color:#1d4ed8;border:1px solid #dbeafe;white-space:nowrap}.muted{color:var(--muted);font-weight:650}.input{width:100%;border-radius:14px;border:2px solid #e5e7eb;padding:11px 12px;font-size:.95rem;font-weight:700;outline:none;background:var(--soft);transition:border-color .15s ease,box-shadow .15s ease;font-family:inherit}.input:focus{border-color:rgba(124,58,237,.55);box-shadow:0 0 0 5px rgba(124,58,237,.10);background:#fff}.resultRow{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;margin-top:10px;padding:10px 12px;border-radius:16px;border:1px dashed #e5e7eb;background:#fff;font-weight:800;line-height:1.35}.oktxt{color:var(--ok);font-weight:1000}.badtxt{color:var(--bad);font-weight:1000}.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(17,24,39,.92);color:#fff;padding:10px 12px;border-radius:14px;font-weight:800;font-size:.9rem;opacity:0;pointer-events:none;transition:opacity .18s ease,transform .18s ease;max-width:calc(100% - 28px);z-index:20050;text-align:center}.toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:20000}.modal-backdrop.show{display:flex}#registerBackdrop{z-index:20015}#pinBackdrop{z-index:20040}#resetBackdrop{z-index:20025}#profileBackdrop{z-index:20030}#submitBackdrop{z-index:20035}#imgBackdrop{z-index:20060}.modal{width:100%;max-width:620px;background:#fff;border-radius:18px;border:1px solid #e5e7eb;box-shadow:0 20px 60px rgba(0,0,0,.18);padding:14px;max-height:82vh;overflow:auto;-webkit-overflow-scrolling:touch}.modal h3{margin:4px 0 6px;font-size:1.02rem}.modal p{margin:0 0 12px;color:var(--muted);font-weight:650;font-size:.92rem;line-height:1.35}.modal-actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}.xclose{position:sticky;top:0;display:flex;justify-content:flex-end;z-index:2;margin-bottom:4px}.btn-x{width:56px;height:56px;border-radius:16px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:1000;font-size:1.8rem;line-height:1;box-shadow:0 12px 24px rgba(0,0,0,.10);font-family:inherit}.pinWrap{display:grid;gap:12px}.pinDots{display:flex;justify-content:center;gap:10px;padding:8px 0 2px;user-select:none}.dot{width:14px;height:14px;border-radius:999px;border:2px solid #e5e7eb;background:#fff;box-shadow:0 10px 22px rgba(0,0,0,.08)}.dot.filled{background:linear-gradient(135deg,#7c3aed,#fb7185);border-color:rgba(124,58,237,.25)}.pinKeypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}.pinKey{height:56px;border-radius:16px;border:1px solid #e5e7eb;background:#fff;font-weight:1000;font-size:1.25rem;cursor:pointer;box-shadow:0 10px 22px rgba(0,0,0,.08);transition:transform .12s ease,filter .12s ease;user-select:none;font-family:inherit}.pinKey:hover{transform:translateY(-1px);filter:brightness(.99)}.pinKey:active{transform:translateY(0)}.pinKey.small{font-size:.95rem;font-weight:950;letter-spacing:.02em}.pinNote{text-align:center;color:var(--muted);font-weight:750;font-size:.9rem;line-height:1.35}@keyframes shakeX{0%{transform:translateX(0)}15%{transform:translateX(-8px)}30%{transform:translateX(8px)}45%{transform:translateX(-6px)}60%{transform:translateX(6px)}75%{transform:translateX(-4px)}90%{transform:translateX(4px)}100%{transform:translateX(0)}}.pinWrap.shake{animation:shakeX .5s ease}.pinDots.error .dot{border-color:rgba(220,38,38,.65)}.pinDots.error .dot.filled{background:linear-gradient(135deg,#fca5a5,#dc2626);border-color:rgba(220,38,38,.55)}.pinNote.error{color:var(--bad)}.divider{height:1px;background:#e5e7eb;margin:12px 0}.btn-red{background:var(--bad);color:#fff;border:0;box-shadow:0 12px 24px rgba(220,38,38,.18)}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media (max-width:520px){.grid2{grid-template-columns:1fr}}.missList{margin:10px 0 12px;padding-left:18px;color:#374151;font-weight:800;line-height:1.35}.missList li{margin:6px 0}.qPrompt{margin-top:10px;white-space:pre-wrap;font-weight:850;line-height:1.35}.qImgThumb{margin-top:10px;width:100%;max-width:320px;height:auto;border-radius:16px;border:1px solid #e5e7eb;box-shadow:0 10px 24px rgba(0,0,0,.08);cursor:pointer;display:block}.optGrid{display:grid;gap:10px;margin-top:10px}.optBtn{text-align:left;border-radius:16px;border:2px solid #e5e7eb;background:#fff;padding:12px;cursor:pointer;font-weight:900;box-shadow:none;transition:transform .12s ease,filter .12s ease;font-family:inherit}.optBtn:hover{transform:translateY(-1px);filter:brightness(.99)}.optBtn.active{border-color:rgba(124,58,237,.55);border-width:3px;box-shadow:0 0 0 5px rgba(124,58,237,.10);background:#fff}.optKey{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;font-weight:1000;margin-right:10px}.boxes4{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}.boxDigit{width:58px;text-align:center;font-size:1.05rem;font-weight:1000;border-radius:16px;padding:12px 8px}.short4.noKb{caret-color:transparent;cursor:pointer}.short4.noKb:focus{box-shadow:none!important;border-color:#e5e7eb!important;background:var(--soft)!important;outline:none!important}.keypad4{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;user-select:none}.kpBtn{border-radius:999px;border:2px solid #e5e7eb;background:#fff;padding:9px 12px;font-weight:1000;cursor:pointer;box-shadow:none;min-width:54px;text-align:center;font-family:inherit}.kpBtn:active{transform:translateY(0)}.kpBtn.small{min-width:74px}@media (max-width:520px){.keypad4{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}.kpBtn,.kpBtn.small{min-width:0;width:100%;padding:10px 0;border-radius:16px}}.tfList{display:grid;gap:10px;margin-top:10px}.tfRow{border:1px solid #e5e7eb;border-radius:16px;padding:12px;background:#fff}.tfTop{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}.tfStmt{font-weight:900;line-height:1.35}.tfBtns{display:flex;gap:8px;flex-wrap:wrap}.tfBtn{border-radius:999px;border:2px solid #e5e7eb;background:#fff;padding:8px 12px;font-weight:1000;cursor:pointer;box-shadow:none;font-family:inherit}.tfBtn.active{border-color:rgba(124,58,237,.55);border-width:3px;box-shadow:0 0 0 5px rgba(124,58,237,.10)}.imgModal{width:100%;max-width:min(980px,100%);background:transparent;border:0;box-shadow:none;padding:0;max-height:88vh;overflow:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px}.imgFrame{background:#fff;border:1px solid rgba(229,231,235,.85);border-radius:18px;box-shadow:0 22px 70px rgba(0,0,0,.22);max-width:100%;max-height:88vh;overflow:hidden;position:relative}.imgFrame img{display:block;max-width:90vw;max-height:78vh;width:auto;height:auto;object-fit:contain}.imgClose{position:absolute;top:10px;right:10px;width:50px;height:50px;border-radius:16px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:1000;font-size:1.6rem;line-height:1;box-shadow:0 12px 24px rgba(0,0,0,.10);font-family:inherit}.submitbar{position:fixed;left:0;right:0;bottom:0;z-index:20010;padding:10px 14px;padding-bottom:calc(10px + env(safe-area-inset-bottom,0px));background:rgba(255,255,255,.86);border-top:1px solid rgba(229,231,235,.9);backdrop-filter:blur(8px);box-shadow:0 -14px 40px rgba(0,0,0,.10);display:none}.submitwrap{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;flex-wrap:nowrap}.btn-big{width:min(560px,100%);border-radius:18px;padding:14px 16px;font-size:1.05rem;font-weight:1000;letter-spacing:.02em;justify-content:center}.subhint{font-weight:850;color:var(--muted);line-height:1.2;text-align:center;width:100%}@media (max-width:820px){.progressline{max-width:100%}.btn{padding:9px 12px;font-size:.85rem}.resultRow{grid-template-columns:120px 1fr}.userCorner .name{max-width:66vw}.boxDigit{width:56px}.subhint{white-space:normal}}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"></head><body><div class="userCorner" id="userCorner" title="Bấm để mở tài khoản"><span class="name" id="userCornerName">—</span><span class="adminBadge" id="userCornerAdmin" style="display:none;">ADMIN</span></div><div id="shell"><div class="actionbar" id="actionbar"><button class="btn btn-ghost" id="btnHome">Trang chủ</button><button class="btn" id="btnScrollTop">Lên đầu</button><button class="btn btn-reset" id="btnReset">Làm lại</button></div><div class="wrap"><div class="topbar"><div class="titlebox"><div class="logo">Hi!</div><div class="titles"><h1 id="quizTitle">Quiz</h1><div class="tiny" id="quizSub"></div></div></div><div class="stats"><div class="pill">Đã làm: <strong id="answeredCount">0</strong>/<span id="totalCount">0</span></div><div class="progressline"><div class="progressfill" id="progressFill"></div></div></div></div><div class="content" id="content"></div></div></div><div class="toast" id="toast"></div><div class="submitbar" id="submitBar"><div class="submitwrap"><button class="btn btn-primary btn-big" id="btnSubmitBig" disabled>NỘP BÀI</button><div class="subhint" id="submitHint"></div></div></div><div class="modal-backdrop" id="registerBackdrop" aria-hidden="true"><div class="modal" role="dialog" aria-modal="true" aria-labelledby="registerTitle"><h3 id="registerTitle">Đăng ký tài khoản?</h3><p id="registerDesc">Username chưa đăng ký. Bạn có muốn đăng ký không?</p><div class="modal-actions"><button class="btn btn-ghost" id="btnRegisterNo">Nhập lại</button><button class="btn btn-primary" id="btnRegisterYes">Đăng ký</button></div></div></div><div class="modal-backdrop" id="pinBackdrop" aria-hidden="true"><div class="modal" role="dialog" aria-modal="true" aria-labelledby="pinTitle"><div class="xclose"><button class="btn-x" id="btnClosePin" aria-label="Đóng">✕</button></div><h3 id="pinTitle">Mật khẩu</h3><p id="pinDesc">Nhập mật khẩu số.</p><div class="pinWrap" id="pinWrap"><div class="pinDots" id="pinDots"></div><div class="pinKeypad" id="pinKeypad"></div><div class="pinNote" id="pinNote"></div></div></div></div><div class="modal-backdrop" id="resetBackdrop" aria-hidden="true"><div class="modal" role="dialog" aria-modal="true"><h3>Làm lại bài?</h3><p>Xóa lần làm hiện tại (trên máy) và làm lại (nếu quiz có đảo thì sẽ đảo lại).</p><div class="modal-actions"><button class="btn btn-ghost" id="btnCancelReset">Hủy</button><button class="btn btn-danger" id="btnConfirmReset">Xóa & Làm lại</button></div></div></div><div class="modal-backdrop" id="submitBackdrop" aria-hidden="true"><div class="modal" role="dialog" aria-modal="true" aria-labelledby="submitTitle"><h3 id="submitTitle">Xác nhận nộp bài</h3><div id="submitBody"></div><div class="modal-actions"><button class="btn btn-ghost" id="btnCancelSubmit">Hủy</button><button class="btn btn-primary" id="btnConfirmSubmit">Nộp</button></div></div></div><div class="modal-backdrop" id="profileBackdrop" aria-hidden="true"><div class="modal" role="dialog" aria-modal="true" aria-labelledby="profileTitle"><div class="xclose"><button class="btn-x" id="btnCloseProfile" aria-label="Đóng">✕</button></div><h3 id="profileTitle">Tài khoản</h3><p id="profileSub">Thông tin user.</p><div class="card" style="margin:10px 0 0;box-shadow:none;"><div class="row1"><p class="vi" style="margin:0">Username: <b id="profileUsername">—</b></p><div class="meta"><span class="idx" id="profileRole">USER</span></div></div></div><div class="divider"></div><div class="grid2"><button class="btn btn-ghost" id="btnProfileHome" style="justify-content:center;">Trang chủ</button><button class="btn btn-red" id="btnLogout" style="justify-content:center;">Đăng xuất</button></div></div></div><div class="modal-backdrop" id="imgBackdrop" aria-hidden="true"><div class="imgModal" role="dialog" aria-modal="true"><div class="imgFrame"><button class="imgClose" id="btnImgClose" aria-label="Đóng">✕</button><img id="imgViewer" alt="image" src=""/></div></div></div><script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script><script>
const HOME_URL="/";const SUPABASE_URL="https://aidvlydhbdtwunyreqak.supabase.co";const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZHZseWRoYmR0d3VueXJlcWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzM5NzYsImV4cCI6MjA4NDIwOTk3Nn0.LMKGjKlUbC5qoY7hqDpaDFQrFWfwKemBTpxjTNp_L8o";const RPC={getQuiz:"api_get_quiz3",checkUsername:"api_check_username",login:"api_login",register:"api_register",me:"api_me"};const TOKEN_KEY="tk_token_v2";const ME_KEY="tk_me_v2";const NAME_KEY="tk_display_name_v1";const LEADERBOARD_VIEW="v_leaderboard_override";const UA=navigator.userAgent||"";const IS_MOBILE=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(UA);const SHORT4_CLICK_ONLY=IS_MOBILE;
function setVhVar(){const h=(window.visualViewport&&window.visualViewport.height)?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--vh",(h*0.01)+"px")}setVhVar();window.addEventListener("resize",setVhVar,{passive:true});if(window.visualViewport){window.visualViewport.addEventListener("resize",setVhVar,{passive:true})}
function _isGenericScriptErrorMessage(m){const s=String(m||"").trim();return /^script error\.?$/i.test(s)}
function renderFatal(err){const msg=(err&&(err.message||err))?(err.message||String(err)):"Unknown error";renderLoading("Lỗi JS: "+msg)}
window.addEventListener("error",(e)=>{const msg=String(e?.message||e?.error?.message||"");if(_isGenericScriptErrorMessage(msg)&&(!e?.error||!e.error.stack))return;renderFatal(e?.error||msg)});
window.addEventListener("unhandledrejection",(e)=>{const r=e?.reason;const msg=String(r?.message||r||"");if(_isGenericScriptErrorMessage(msg)&&(!r||!r.stack))return;renderFatal(r||msg)});
function toast(msg){const t=document.getElementById("toast");t.textContent=String(msg||"");t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1300)}
function escapeHtml(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
function normUsername(u){return String(u||"").trim().toLowerCase()}
function validateUsername(u){u=normUsername(u);if(!u)return"Chưa nhập username.";if(u.length>15)return"Username tối đa 15 ký tự.";if(!/^[a-z0-9_]+$/.test(u))return"Chỉ được dùng a-z 0-9 và dấu _ (không viết hoa).";return null}
function isAdminUser(me){if(!me)return false;const u=String(me.username||"").toLowerCase();return me.role==="admin"||u==="tuankhoi"}
function getToken(){try{return(localStorage.getItem(TOKEN_KEY)||"").trim()}catch{return""}}
function setToken(t){try{if(!t)localStorage.removeItem(TOKEN_KEY);else localStorage.setItem(TOKEN_KEY,String(t))}catch{}}
function getMeCache(){try{return JSON.parse(localStorage.getItem(ME_KEY)||"null")}catch{return null}}
function setMeCache(me){try{if(!me)localStorage.removeItem(ME_KEY);else localStorage.setItem(ME_KEY,JSON.stringify(me))}catch{}}
function setNameCache(name){try{if(!name)localStorage.removeItem(NAME_KEY);else localStorage.setItem(NAME_KEY,String(name))}catch{}}
function clearAuthLocal(){setToken("");setMeCache(null)}
function goHome(){location.href=HOME_URL}
function _pickQuizId(x){const q=String(x||"").toLowerCase().replace(/[^a-z]/g,"").slice(0,5);return(q.length===5)?q:""}
function parseQuizIdFromUrl(){try{const qs=new URLSearchParams(location.search);const keys=["quiz","quiz_id","quizId","qid","id","q","code"];for(const k of keys){const v=_pickQuizId(qs.get(k));if(v)return v}}catch{}const rawHash=String(location.hash||"").replace(/^#/,"").trim();if(rawHash){const direct=_pickQuizId(rawHash);if(direct)return direct;try{const h=rawHash.startsWith("?")?rawHash.slice(1):rawHash;const hqs=new URLSearchParams(h);const keys=["quiz","quiz_id","quizId","qid","id","q","code"];for(const k of keys){const v=_pickQuizId(hqs.get(k));if(v)return v}}catch{}const mH=rawHash.match(/([a-z]{5})/i);if(mH&&mH[1]){const v=_pickQuizId(mH[1]);if(v)return v}}const p=String(location.pathname||"");const m1=p.match(/\/q\/(?:index\.html\/)?([a-z]{5})(?:\/|$)/i);if(m1&&m1[1])return _pickQuizId(m1[1]);if(/\/q\//i.test(p)){const m2=p.match(/\/([a-z]{5})(?:\/|$)/i);if(m2&&m2[1])return _pickQuizId(m2[1])}return""}
const URLP=new URLSearchParams(location.search);const FLAG_START=(URLP.get("start")==="1");const FLAG_RESTART=(URLP.get("restart")==="1");
function dropFlagsFromUrl(){if(!FLAG_START&&!FLAG_RESTART)return;URLP.delete("start");URLP.delete("restart");const qs=URLP.toString();const newUrl=location.pathname+(qs?("?"+qs):"")+(location.hash||"");try{history.replaceState(null,"",newUrl)}catch{}}
function sbHeaders(){const anon=String(SUPABASE_ANON_KEY).trim();return{"apikey":anon,"Authorization":"Bearer "+anon,"Content-Type":"application/json"}}
async function sbRpc(fn,args){const res=await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{method:"POST",headers:sbHeaders(),body:JSON.stringify(args||{})});const txt=await res.text();let data=null;try{data=txt?JSON.parse(txt):null}catch{}if(!res.ok){const msg=(data&&(data.message||data.error||data.hint||data.details))?(data.message||data.error||data.hint||data.details):txt;throw new Error(msg||"RPC error")}return data}
async function sbPost(path,body,{preferReturn=false,upsert=false}={}){const headers=sbHeaders();if(preferReturn)headers["Prefer"]="return=representation";if(upsert){headers["Prefer"]=(headers["Prefer"]?headers["Prefer"]+",":"")+"resolution=merge-duplicates"}const res=await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{method:"POST",headers,body:JSON.stringify(body)});const txt=await res.text();let data=null;try{data=txt?JSON.parse(txt):null}catch{}if(!res.ok){const msg=(data&&(data.message||data.error||data.hint||data.details))?(data.message||data.error||data.hint||data.details):txt;throw new Error(msg||"REST POST error")}return data}

/* NEW: GET (có thể lấy count từ Content-Range) */
async function sbGet(path,{countExact=false}={}){const headers=sbHeaders();if(countExact)headers["Prefer"]="count=exact";const res=await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{method:"GET",headers});const txt=await res.text();let data=null;try{data=txt?JSON.parse(txt):null}catch{}if(!res.ok){const msg=(data&&(data.message||data.error||data.hint||data.details))?(data.message||data.error||data.hint||data.details):txt;throw new Error(msg||"REST GET error")}let count=null;try{const cr=res.headers.get("content-range")||"";const m=cr.match(/\/(\d+|\*)$/);if(m&&m[1]&&m[1]!=="*"){const n=Number(m[1]);if(isFinite(n))count=n}}catch{}return{data,count}}

async function upsertOfficialScore(score10){
  if(!quizId||quizId.length!==5)throw new Error("missing quiz_id");
  if(!me||!me.user_id)throw new Error("need login");
  const v=Number(score10||0);const body={quiz_id:quizId,user_id:me.user_id,score10:isFinite(v)?v:0};
  try{
    await sbPost(`${LEADERBOARD_VIEW}?on_conflict=quiz_id,user_id`,body,{preferReturn:false,upsert:true});
    return true;
  }catch(e1){
    try{
      await sbPost(`leaderboard_overrides?on_conflict=quiz_id,user_id`,body,{preferReturn:false,upsert:true});
      return true;
    }catch(_e2){
      throw e1;
    }
  }
}

const actionbar=document.getElementById("actionbar");const btnHome=document.getElementById("btnHome");const btnScrollTop=document.getElementById("btnScrollTop");const btnReset=document.getElementById("btnReset");const submitBar=document.getElementById("submitBar");const btnSubmitBig=document.getElementById("btnSubmitBig");const submitHint=document.getElementById("submitHint");const content=document.getElementById("content");const quizTitleEl=document.getElementById("quizTitle");const quizSubEl=document.getElementById("quizSub");const userCorner=document.getElementById("userCorner");const userCornerName=document.getElementById("userCornerName");const userCornerAdmin=document.getElementById("userCornerAdmin");
function setUserCorner(me){if(!me||!me.username){userCorner.style.display="none";return}userCornerName.textContent=me.username;userCornerAdmin.style.display=isAdminUser(me)?"inline-flex":"none";userCorner.style.display="inline-flex"}
function renderLoading(msg){const c=document.getElementById("content");if(!c)return;c.innerHTML=`<div class="card"><div class="row1"><p class="vi">${escapeHtml(msg||"Đang tải...")}</p><div class="meta"><span class="idx">LOADING</span></div></div><div class="muted" style="margin-top:8px">Vui lòng chờ...</div></div>`}
function renderQuizLoadError(e){const msg=String(e?.message||e||"");if(/ACCESS_CODE_REQUIRED/i.test(msg)){renderLoading("Lỗi tải đề: ACCESS_CODE_REQUIRED");return}renderLoading("Lỗi tải đề: "+msg)}
function applyMath(rootEl){if(!rootEl)return;if(typeof window.renderMathInElement!=="function")return;try{window.renderMathInElement(rootEl,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\[",right:"\\]",display:true},{left:"$",right:"$",display:false},{left:"\\(",right:"\\)",display:false}],throwOnError:false})}catch{}}
const imgBackdrop=document.getElementById("imgBackdrop");const imgViewer=document.getElementById("imgViewer");const btnImgClose=document.getElementById("btnImgClose");
function openImg(url){if(!url)return;imgViewer.src=url;imgBackdrop.classList.add("show");imgBackdrop.setAttribute("aria-hidden","false")}
function closeImg(){imgBackdrop.classList.remove("show");imgBackdrop.setAttribute("aria-hidden","true");imgViewer.src=""}
btnImgClose.onclick=closeImg;imgBackdrop.addEventListener("click",(e)=>{if(e.target===imgBackdrop)closeImg()});
const quizId=parseQuizIdFromUrl();const PROGRESS_KEY=quizId?`tk_progress::${quizId}`:`tk_progress::unknown`;
let me=null;let QUIZ={quiz_id:quizId,title:"Quiz",sub:"",require_login:true,shuffle_mode:"none",items:[],cover_image:"",cover_data_url:""};let view={started:false};
let state={quiz_id:quizId,answers:{},checked:{},finalized:false,attempt_id:"",ts:0,order:[],mcq_perm:{}};

/* NEW: attempt meta (lượt nộp) */
let ATTEMPT_META={count:0,latestAttemptId:""};
async function refreshAttemptMeta(){
  ATTEMPT_META={count:0,latestAttemptId:""};
  if(!quizId||quizId.length!==5)return;
  if(!me||!me.user_id)return;
  try{
    const q=`attempts?select=attempt_id,created_at&quiz_id=eq.${encodeURIComponent(quizId)}&user_id=eq.${encodeURIComponent(me.user_id)}&order=created_at.desc&limit=1`;
    const out=await sbGet(q,{countExact:true});
    const row=Array.isArray(out.data)?out.data[0]:null;
    const cnt=(typeof out.count==="number"&&isFinite(out.count))?out.count:null;
    ATTEMPT_META.count=(cnt!==null)?cnt:(row?1:0);
    ATTEMPT_META.latestAttemptId=row?.attempt_id?String(row.attempt_id):"";
  }catch{
    ATTEMPT_META={count:0,latestAttemptId:""};
  }
}
function syncActionbar(){const started=!!view.started;btnHome.classList.toggle("hidden",started);btnScrollTop.classList.toggle("hidden",!started);btnReset.classList.toggle("hidden",!started);submitBar.style.display=started?"block":"none"}
function saveLocalProgress(){state.ts=Date.now();try{localStorage.setItem(PROGRESS_KEY,JSON.stringify(state))}catch{}}
function loadLocalProgress(){try{const raw=localStorage.getItem(PROGRESS_KEY);if(!raw)return;const s=JSON.parse(raw);if(s&&s.quiz_id===quizId){state={...state,...s};if(!state.answers||typeof state.answers!=="object")state.answers={};if(!state.checked||typeof state.checked!=="object")state.checked={};if(!Array.isArray(state.order))state.order=[];if(!state.mcq_perm||typeof state.mcq_perm!=="object")state.mcq_perm={}}}catch{}}
function hasLocalWork(){const vals=Object.values(state.answers||{});for(const v of vals){if(Array.isArray(v)){if(v.some(x=>x===true||x===false))return true;continue}if(String(v||"").trim().length>0)return true}return false}
function clearLocalProgressOnly(){try{localStorage.removeItem(PROGRESS_KEY)}catch{}}
function bestAttemptIdForResult(){
  const aMeta=String(ATTEMPT_META.latestAttemptId||"").trim();
  if(aMeta)return aMeta;
  const a1=String(state.attempt_id||"").trim();if(a1)return a1;
  try{const raw=sessionStorage.getItem(`tk_last_result::${quizId}`);if(raw){const x=JSON.parse(raw);if(x&&x.quiz_id===quizId&&x.attempt_id)return String(x.attempt_id)}}catch{}
  return""
}
function goResult(){
  if(!(ATTEMPT_META.count>=1)) { toast("Chưa có lượt nộp"); return; }
  const a=bestAttemptIdForResult();
  if(!a){ toast("Không lấy được kết quả gần nhất"); return; }
  const qs=new URLSearchParams();qs.set("quiz",quizId);qs.set("attempt",a);
  location.href=`/result.html?${qs.toString()}`
}
function shuffleArray(arr){const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function qTypeOf(q){return String(q.q_type||"essay").toLowerCase()}
function normalizeShuffleMode(m){const raw=String(m??"").trim().toLowerCase();if(!raw||raw==="none"||raw==="off"||raw==="no"||raw==="0"||raw==="false")return"none";if(raw==="qa"||raw==="q+a"||raw==="both"||raw==="all"||raw==="2"||raw==="qna"||raw==="questions_answers"||raw==="question_answer"||raw==="answers"||raw==="answer")return"qa";if(raw==="q"||raw==="question"||raw==="questions"||raw==="1"||raw==="q_only"||raw==="qonly"||raw==="questions_only"||raw==="question_only"||raw==="shuffle_q")return"q";return"q"}
function getMcqPerm(qid){const p=state.mcq_perm&&state.mcq_perm[qid];if(Array.isArray(p)&&p.length===4&&p.every(x=>Number.isInteger(x)&&x>=0&&x<=3))return p;return[0,1,2,3]}
function ensureShuffle({force=false}={}){const mode=normalizeShuffleMode(QUIZ.shuffle_mode);const ids=QUIZ.items.map(x=>Number(x.id));if(mode==="none"){state.order=[];state.mcq_perm={};saveLocalProgress();return}const needOrder=force||!Array.isArray(state.order)||state.order.length!==ids.length||state.order.some(id=>!ids.includes(Number(id)));if(needOrder){state.order=shuffleArray(ids)}if(mode==="qa"){const next=(state.mcq_perm&&typeof state.mcq_perm==="object")?{...state.mcq_perm}:{};for(const q of QUIZ.items){const t=qTypeOf(q);if(t==="mcq1"||t==="mcq"){if(force||!Array.isArray(next[q.id])||next[q.id].length!==4){next[q.id]=shuffleArray([0,1,2,3])}}}state.mcq_perm=next}else{state.mcq_perm={}}saveLocalProgress()}
function getViewItems(){const mode=normalizeShuffleMode(QUIZ.shuffle_mode);if(mode==="none")return QUIZ.items;const order=Array.isArray(state.order)?state.order:[];if(!order.length)return QUIZ.items;const map=new Map(QUIZ.items.map(q=>[Number(q.id),q]));const out=[];for(const id of order){const qq=map.get(Number(id));if(qq)out.push(qq)}for(const q of QUIZ.items){if(!order.includes(Number(q.id)))out.push(q)}return out}
function resetForNewAttempt({reshuffle=true}={}){state.answers={};state.checked={};state.finalized=false;state.attempt_id="";if(reshuffle){state.order=[];state.mcq_perm={};ensureShuffle({force:true})}else{saveLocalProgress()}}
function normalizeForCompare(s){let t=String(s||"").trim().toLowerCase();t=t.replace(/đ/g,"d");try{t=t.normalize("NFKD").replace(/[\u0300-\u036f]/g,"")}catch{}t=t.replace(/[“”"']/g," ");t=t.replace(/[^a-z0-9\s\-,.]/g," ");t=t.replace(/\s+/g," ").trim();return t}
function normalizeShort4(s){return String(s||"").replace(/\s+/g,"").replace(/−/g,"-").replace(/[^0-9\-,]/g,"").trim()}
function negFlag(norm){const toks=norm.split(" ").filter(Boolean);if(!toks.length)return false;const set=new Set(toks);for(const n of["khong","ko","hong","chua","chang","deo","not","no","never"]){if(set.has(n))return true}return false}
function levenshtein(a,b){a=String(a||"");b=String(b||"");const m=a.length,n=b.length;if(!m)return n;if(!n)return m;const dp=new Array(n+1);for(let j=0;j<=n;j++)dp[j]=j;for(let i=1;i<=m;i++){let prev=dp[0];dp[0]=i;for(let j=1;j<=n;j++){const tmp=dp[j];const cost=a.charCodeAt(i-1)===b.charCodeAt(j-1)?0:1;dp[j]=Math.min(dp[j]+1,dp[j-1]+1,prev+cost);prev=tmp}}return dp[n]}
function looseEq(user,expected){
  const u=normalizeForCompare(user);
  const a=normalizeForCompare(expected);
  if(!u||!a)return false;
  if(negFlag(u)!==negFlag(a))return false;
  if(u===a)return true;
  const us=u.replace(/\s/g,""),as=a.replace(/\s/g,"");
  if(us===as)return true;

  if(u.length>=3&&a.length>=3&&(u.includes(a)||a.includes(u))){
    const short=Math.min(u.length,a.length),long=Math.max(u.length,a.length);
    if(long<=short+Math.max(2,Math.round(short*0.25)))return true;
  }

  const dist=levenshtein(u,a);
  const maxLen=Math.max(u.length,a.length);
  if(maxLen<=2)return dist===0;
  if(maxLen<=4)return dist<=1;
  if(maxLen<=6)return dist<=1;
  if(maxLen<=12)return dist<=2;
  if(dist/maxLen<=0.15)return true;

  const tu=u.split(" "),ta=a.split(" ");
  if(ta.length>=2){
    let common=0;
    const setU=new Set(tu.filter(Boolean));
    for(const tok of ta){if(tok&&setU.has(tok))common++}
    if(common/ta.length>=0.8)return true
  }
  return false
}
function acceptedAnswersFromQuestion(q){const t=qTypeOf(q);const out=[];if(Array.isArray(q?.meta?.answers))out.push(...q.meta.answers);if(t==="short4"&&Array.isArray(q.answers)&&q.answers.length===4){const cells=q.answers.map(x=>String(x||"").trim()).slice(0,4);if(cells.every(x=>x.length<=1)){out.push(cells.join(""))}}if(Array.isArray(q.answers))out.push(...q.answers);const metaAns=q?.meta?.answer||q?.meta?.correct||q?.meta?.expected;if(metaAns)out.push(String(metaAns));const seen=new Set();const uniq=[];for(const x of out){const k=(t==="short4")?normalizeShort4(x):normalizeForCompare(x);if(!k)continue;if(seen.has(k))continue;seen.add(k);uniq.push(String(x).trim())}return uniq}
function pointsOf(q){const p=Number(q.points??0);return(isFinite(p)&&p>0)?p:1}
function isAnswered(q){const t=qTypeOf(q);const v=state.answers[q.id];if(t==="mcq1"||t==="mcq"){const n=Number(v);return n>=1&&n<=4}if(t==="tf4"){return Array.isArray(v)&&v.some(x=>x===true||x===false)}return String(v||"").trim().length>0}
function gradeOne(q){const t=qTypeOf(q);const max=pointsOf(q);if(t==="mcq1"||t==="mcq"){const userOrig=Number(state.answers[q.id]||0);const correctOrig=Number(q.meta?.correct||1)||1;const ok=(userOrig===correctOrig);const perm=getMcqPerm(q.id);const displayCorrect=Math.max(1,perm.indexOf(correctOrig-1)+1);const expected=`Đáp án: ${"ABCD"[displayCorrect-1]||"A"}`;return{ok,expected,earned:ok?max:0,max}}if(t==="tf4"){const keys=Array.isArray(q.meta?.keys)?q.meta.keys:[true,false,false,false];const user=Array.isArray(state.answers[q.id])?state.answers[q.id]:[null,null,null,null];let correctCount=0;const wrongLetters=[];for(let i=0;i<4;i++){const u=user[i];const k=Boolean(keys[i]);const okPart=(u===true||u===false)&&(u===k);if(okPart)correctCount++;else wrongLetters.push("ABCD"[i])}const earned=Math.round((max*(correctCount/4))*100)/100;const ok=(correctCount===4);const expected=ok?`Đúng 4/4 (điểm: ${earned}/${max})`:`Đúng ${correctCount}/4 • Sai/Trống: ${wrongLetters.join(", ")} (điểm: ${earned}/${max})`;return{ok,expected,earned,max,correctCount}}if(t==="short4"){const userRaw=String(state.answers[q.id]||"");const user=normalizeShort4(userRaw);const accRaw=acceptedAnswersFromQuestion(q);const accNorm=accRaw.map(a=>normalizeShort4(a));const expected=accRaw[0]?`Đáp án: ${accRaw[0]}`:"Đáp án: (chưa set)";if(!user)return{ok:false,expected,earned:0,max};const ok=accNorm.some(a=>a&&user===a);return{ok,expected,earned:ok?max:0,max}}const user=String(state.answers[q.id]||"").trim();const acc=acceptedAnswersFromQuestion(q);const expected=acc[0]?`Đáp án: ${acc[0]}`:"Đáp án: (chưa set)";if(!user)return{ok:false,expected,earned:0,max};let ok=false;for(const a of acc){if(looseEq(user,a)){ok=true;break}}return{ok,expected,earned:ok?max:0,max}}
function updateStats(){const items=getViewItems();const total=items.length;let answered=0;for(const q of items){if(isAnswered(q))answered++}document.getElementById("answeredCount").textContent=String(answered);document.getElementById("totalCount").textContent=String(total);document.getElementById("progressFill").style.width=total?Math.round(answered*100/total)+"%":"0%";const canSubmit=!!view.started&&!state.finalized&&(QUIZ.require_login?(!!me&&!!me.user_id):true);btnSubmitBig.disabled=!canSubmit;syncActionbar()}

/* NEW: cập nhật meta share (title/description + image) */
function _setMeta(sel,val){const el=document.querySelector(sel);if(!el)return;el.setAttribute("content",String(val||""))}
function applyShareMeta(){
  const title=String(QUIZ.title||"Quiz");
  const sub=String(QUIZ.sub||"").trim();
  const ogTitle=`Quiz: ${title}`;
  const desc=(sub?sub+" • ":"")+`ID quiz: ${quizId}`;
  document.title=ogTitle;
  _setMeta('meta[name="description"]',desc);
  _setMeta('meta[property="og:title"]',ogTitle);
  _setMeta('meta[property="og:description"]',desc);
  _setMeta('meta[property="og:url"]',location.href);
  _setMeta('meta[name="twitter:title"]',ogTitle);
  _setMeta('meta[name="twitter:description"]',desc);
  const img=String(QUIZ.cover_data_url||QUIZ.cover_image||"").trim();
  if(img){
    _setMeta('meta[property="og:image"]',img);
    _setMeta('meta[property="og:image:alt"]',ogTitle);
    _setMeta('meta[name="twitter:image"]',img);
  }
  // Zalo/Messenger thường không chạy JS khi crawl link; muốn preview đúng theo quizId thì cần trang share render server-side.
}

function renderGate(){view.started=false;syncActionbar();content.innerHTML=`<div class="card"><div class="row1"><p class="vi">Nhập USERNAME</p><div><span class="idx">BẮT BUỘC</span></div></div><div class="muted" style="margin-top:6px;line-height:1.35">Tối đa 15 ký tự, chỉ <b>a-z 0-9 _</b>.</div><div style="margin-top:10px;display:grid;gap:10px;"><input id="nameInput" class="input" placeholder="vd: tuankhoi123" maxlength="15" autocomplete="off"/><button id="btnContinue" class="btn btn-primary" style="justify-content:center;">Tiếp tục</button><div class="muted" id="gateStatus">Sẵn sàng.</div></div></div>`;const nameInput=document.getElementById("nameInput");const btnContinue=document.getElementById("btnContinue");const gateStatus=document.getElementById("gateStatus");nameInput.addEventListener("input",()=>{const v=normUsername(nameInput.value);if(nameInput.value!==v)nameInput.value=v},{passive:true});try{nameInput.focus()}catch{}const doFlow=async()=>{const u=normUsername(nameInput.value);const err=validateUsername(u);if(err){toast(err);return}btnContinue.disabled=true;btnContinue.textContent="Đang...";gateStatus.textContent="Đang kiểm tra username…";try{const ck=await sbRpc(RPC.checkUsername,{p_username:u});if(!ck||ck.ok===false)throw new Error(ck?.error||"check fail");const exists=(typeof ck.exists==="boolean")?ck.exists:null;const pinLen=(u==="tuankhoi")?6:(Number(ck.pinLen||ck.pin_len||4)||4);if(exists===true){gateStatus.textContent="Đăng nhập…";await openPin({username:u,mode:"login",pinLen});return}if(exists===false){gateStatus.textContent=`Username "${u}" chưa đăng ký.`;const ok=await openRegisterPrompt(u);if(!ok){gateStatus.textContent="Bạn có thể nhập username khác.";return}const regPinLen=(u==="tuankhoi")?6:4;gateStatus.textContent="Tạo mật khẩu…";const pin=await openPin({username:u,mode:"set",pinLen:regPinLen});gateStatus.textContent="Đang tạo tài khoản…";const out=await sbRpc(RPC.register,{p_username:u,p_pin:String(pin||"")});if(!out||!out.ok||!out.token)throw new Error(out?.error||"register fail");toast("Đã đăng ký & đăng nhập");await enterAfterAuth(out);return}gateStatus.textContent="Thử đăng nhập…";await openPin({username:u,mode:"login",pinLen:(u==="tuankhoi")?6:4})}catch(e){if(!(e&&e.message==="cancel"))toast(e.message||"Lỗi");gateStatus.textContent="Sẵn sàng."}finally{btnContinue.disabled=false;btnContinue.textContent="Tiếp tục"}};btnContinue.onclick=doFlow;nameInput.addEventListener("keydown",(e)=>{if(e.key==="Enter"){e.preventDefault();doFlow()}})}
const registerBackdrop=document.getElementById("registerBackdrop");const registerDesc=document.getElementById("registerDesc");document.getElementById("btnRegisterNo").onclick=()=>closeRegisterPrompt(false);document.getElementById("btnRegisterYes").onclick=()=>closeRegisterPrompt(true);registerBackdrop.addEventListener("click",(e)=>{if(e.target===registerBackdrop)closeRegisterPrompt(false)});
let REG_PROMPT={open:false,resolve:null,username:""};
function openRegisterPrompt(username){return new Promise((resolve)=>{REG_PROMPT.open=true;REG_PROMPT.resolve=resolve;REG_PROMPT.username=username;registerDesc.textContent=`Username "${username}" chưa đăng ký, bạn có muốn đăng ký không?`;registerBackdrop.classList.add("show");registerBackdrop.setAttribute("aria-hidden","false")})}
function closeRegisterPrompt(ans){if(!REG_PROMPT.open)return;registerBackdrop.classList.remove("show");registerBackdrop.setAttribute("aria-hidden","true");const r=REG_PROMPT.resolve;REG_PROMPT.open=false;REG_PROMPT.resolve=null;REG_PROMPT.username="";if(r)r(!!ans)}
const pinBackdrop=document.getElementById("pinBackdrop");const pinTitle=document.getElementById("pinTitle");const pinDesc=document.getElementById("pinDesc");const pinDots=document.getElementById("pinDots");const pinKeypad=document.getElementById("pinKeypad");const pinNote=document.getElementById("pinNote");const pinWrap=document.getElementById("pinWrap");
document.getElementById("btnClosePin").onclick=()=>closePin("cancel");pinBackdrop.addEventListener("click",(e)=>{if(e.target===pinBackdrop)closePin("cancel")});
let PIN_KEYS_BUILT=false;let PIN={open:false,resolve:null,reject:null,username:"",mode:"login",step:"one",pinLen:4,value:"",first:"",submitting:false,dotEls:[],payload:null};
function buildPinKeypadOnce(){if(PIN_KEYS_BUILT)return;PIN_KEYS_BUILT=true;pinKeypad.innerHTML="";const keys=["1","2","3","4","5","6","7","8","9","CLEAR","0","⌫"];keys.forEach(k=>{const b=document.createElement("button");b.type="button";b.className="pinKey"+((k==="CLEAR"||k==="⌫")?" small":"");b.textContent=k;b.onclick=()=>onPinKey(k);pinKeypad.appendChild(b)})}
function buildDots(n){pinDots.innerHTML="";PIN.dotEls=[];for(let i=0;i<n;i++){const d=document.createElement("div");d.className="dot";pinDots.appendChild(d);PIN.dotEls.push(d)}}
function updateDots(){const len=PIN.value.length;for(let i=0;i<PIN.dotEls.length;i++){PIN.dotEls[i].classList.toggle("filled",i<len)}}
function setPinNote(msg,type=""){if(type==="error")pinNote.classList.add("error");else pinNote.classList.remove("error");pinNote.textContent=String(msg||"")}
function pinErrorPulse(msg){PIN.value="";updateDots();pinDots.classList.add("error");pinWrap.classList.remove("shake");void pinWrap.offsetWidth;pinWrap.classList.add("shake");setPinNote(msg||"Sai mật khẩu","error");setTimeout(()=>{pinDots.classList.remove("error");pinWrap.classList.remove("shake");updatePinHeader()},520)}
function updatePinHeader(){const note=(normUsername(PIN.username)==="tuankhoi")?"Tài khoản tuankhoi dùng mật khẩu 6 số.":"Mật khẩu chỉ gồm số.";if(PIN.mode==="login"){pinTitle.textContent="Đăng nhập";pinDesc.textContent=`Username: ${PIN.username}`}else{if(PIN.step==="one"){pinTitle.textContent="Đăng ký";pinDesc.textContent=`Tạo mật khẩu ${PIN.pinLen} số`}else{pinTitle.textContent="Xác nhận mật khẩu";pinDesc.textContent=`Nhập lại ${PIN.pinLen} số`}}setPinNote(note)}
function openPin({username,mode="login",pinLen=4}){return new Promise((resolve,reject)=>{PIN.open=true;PIN.resolve=resolve;PIN.reject=reject;PIN.username=String(username||"");PIN.mode=mode;PIN.pinLen=Math.max(4,Number(pinLen)||4);PIN.value="";PIN.first="";PIN.submitting=false;PIN.payload=null;PIN.step="one";buildPinKeypadOnce();buildDots(PIN.pinLen);updatePinHeader();updateDots();pinBackdrop.classList.add("show");pinBackdrop.setAttribute("aria-hidden","false")})}
function closePin(why){if(!PIN.open)return;pinBackdrop.classList.remove("show");pinBackdrop.setAttribute("aria-hidden","true");const rej=PIN.reject;const res=PIN.resolve;const payload=PIN.payload;PIN.open=false;PIN.resolve=null;PIN.reject=null;PIN.payload=null;if(why==="ok"){if(res)res(payload);return}if(rej)rej(new Error("cancel"))}
async function onPinKey(k){if(!PIN.open||PIN.submitting)return;if(k==="CLEAR"){PIN.value="";updateDots();return}if(k==="⌫"){PIN.value=PIN.value.slice(0,-1);updateDots();return}if(PIN.value.length>=PIN.pinLen)return;PIN.value+=String(k);updateDots();if(PIN.value.length!==PIN.pinLen)return;const val=PIN.value;if(!/^[0-9]+$/.test(val)){pinErrorPulse("Mật khẩu chỉ gồm số");return}if(PIN.mode==="login"){PIN.submitting=true;try{setPinNote("Đang kiểm tra…");const out=await sbRpc(RPC.login,{p_username:normUsername(PIN.username),p_pin:val});if(out&&out.ok&&out.token){PIN.payload=val;closePin("ok");toast("Đăng nhập thành công");await enterAfterAuth(out);return}pinErrorPulse(out?.error||"Sai mật khẩu")}catch(e){pinErrorPulse("Sai mật khẩu")}finally{PIN.submitting=false}return}if(PIN.mode==="set"){if(PIN.step==="one"){PIN.first=val;PIN.value="";PIN.step="confirm";updatePinHeader();updateDots();return}else{if(PIN.first!==val){pinErrorPulse("Mật khẩu không khớp");PIN.first="";PIN.step="one";updatePinHeader();updateDots();return}PIN.payload=val;closePin("ok");return}}}

function renderStart(){
  view.started=false;syncActionbar();setUserCorner(me);updateStats();
  const hasResult=(ATTEMPT_META.count>=1);
  const loginNote=QUIZ.require_login?`<div class="muted" style="margin-top:8px;line-height:1.35">Bạn đang đăng nhập: <b>${escapeHtml(me?.username||"")}</b></div>`:`<div class="muted" style="margin-top:8px;line-height:1.35">Quiz này <b>không yêu cầu đăng nhập</b>. Bạn có thể làm ngay.</div>`;
  content.innerHTML=`<div class="card"><div class="row1"><p class="vi">Sẵn sàng làm bài</p><div class="meta"><span class="idx">${escapeHtml(QUIZ.quiz_id||quizId)}</span></div></div>${loginNote}<div class="muted" style="margin-top:10px;line-height:1.35">Tổng số câu: <b>${QUIZ.items.length}</b></div>
  <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
    ${hasResult?`<button class="btn btn-ghost" id="btnViewResult" type="button">Xem lại kết quả</button>`:``}
    <button class="btn btn-primary" id="btnGo" type="button">Vào làm</button>
  </div></div>`;
  document.getElementById("btnGo").onclick=()=>{if(state.finalized){resetForNewAttempt({reshuffle:true})}view.started=true;renderQuiz();scrollToHashIfAny()};
  if(hasResult){document.getElementById("btnViewResult").onclick=()=>goResult()}
}

function renderQuiz(){view.started=true;syncActionbar();setUserCorner(me);if(!QUIZ.items.length){content.innerHTML=`<div class="card"><div class="row1"><p class="vi">Quiz trống</p><div class="meta"><span class="idx">EMPTY</span></div></div><div class="muted" style="margin-top:8px">Chưa có câu hỏi (hoặc quiz yêu cầu login).</div></div>`;updateStats();return}ensureShuffle({force:false});const items=getViewItems();let html="";items.forEach((q,idx)=>{const t=qTypeOf(q);const img=String(q.meta?.image_url||q.meta?.image||q.meta?.img||"").trim();const allowCheck=(t==="essay");const ck=allowCheck?state.checked[q.id]:null;const locked=state.finalized||(allowCheck&&ck&&ck.locked);html+=`<div class="card" id="q${q.id}"><div class="row1"><p class="vi">Câu ${idx+1}</p><div class="meta"><span class="idx">#${idx+1}</span></div></div><div class="qPrompt">${escapeHtml(q.prompt||"")}</div>${img?`<img class="qImgThumb" data-img="${escapeHtml(img)}" src="${escapeHtml(img)}" alt="image">`:``}${t==="mcq1"||t==="mcq"?renderMcq(q,locked):``}${t==="essay"?renderEssay(q,locked):``}${t==="short4"?renderShort4(q,locked):``}${t==="tf4"?renderTf4(q,locked):``}${allowCheck?`<div style="margin-top:12px;display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap"><button class="btn btn-primary" data-check="${q.id}" ${locked?"disabled":""} type="button">${locked?"Đã check":"Check"}</button></div><div class="essayResultHolder" data-essay-result="${q.id}">${locked&&ck?`<div class="resultRow"><div>${ck.ok?`<span class="oktxt">ĐÚNG</span>`:`<span class="badtxt">SAI</span>`}</div><div><span class="muted">${escapeHtml(ck.expected||"")}</span></div></div>`:``}</div>`:``}</div>`});content.innerHTML=html;applyMath(content);updateStats()}
function renderMcq(q,locked){const opts=Array.isArray(q.meta?.options)?q.meta.options:["","","",""];const perm=getMcqPerm(q.id);const userOrig=Number(state.answers[q.id]||0);return`<div class="optGrid" role="group" aria-label="options">${[0,1,2,3].map(d=>{const origIdx=perm[d]??d;const origAns=origIdx+1;const letter="ABCD"[d];const text=String(opts[origIdx]??"");const active=(userOrig===origAns);return`<button class="optBtn ${active?"active":""}" data-mcq="${q.id}" data-orig="${origAns}" ${locked?"disabled":""} type="button"><span class="optKey">${letter}</span><span class="optText">${escapeHtml(text)}</span></button>`}).join("")}</div>`}
function renderEssay(q,locked){const v=String(state.answers[q.id]||"");return`<div style="margin-top:10px"><input class="input ans" data-id="${q.id}" placeholder="Nhập đáp án" value="${escapeHtml(v)}" ${locked?"disabled":""}/></div>`}
function renderShort4(q,locked){const raw=String(state.answers[q.id]||"");const chars=[raw[0]||"",raw[1]||"",raw[2]||"",raw[3]||""];const keys=SHORT4_CLICK_ONLY?["5","6","7","8","9","⌫","CLR","0","1","2","3","4",",","−"]:["-",",","0","1","2","3","4","5","6","7","8","9","<","CLR"];const inputExtra=SHORT4_CLICK_ONLY?`readonly inputmode="none" tabindex="-1" class="input boxDigit short4 noKb"`:`inputmode="numeric" pattern="[0-9]*" class="input boxDigit short4"`;return`<div style="margin-top:10px"><div class="muted">Nhập 4 ô (0-9, dấu −, dấu ,).</div><div class="boxes4">${chars.map((c,i)=>`<input ${inputExtra} data-id="${q.id}" data-k="${i}" maxlength="1" type="text" autocomplete="off" value="${escapeHtml(c)}" ${locked?"disabled":""}/>`).join("")}</div><div class="keypad4" role="group" aria-label="short4 keypad">${keys.map(x=>{const label=escapeHtml(x);const cls=(x==="CLR"||x==="⌫"||x==="<")?"kpBtn small":"kpBtn";return`<button class="${cls}" data-kpid="${q.id}" data-kpkey="${escapeHtml(x)}" ${locked?"disabled":""} type="button">${label}</button>`}).join("")}</div></div>`}
function renderTf4(q,locked){const stmts=Array.isArray(q.meta?.statements)?q.meta.statements:["","","",""];const user=Array.isArray(state.answers[q.id])?state.answers[q.id]:[null,null,null,null];return`<div class="tfList">${[0,1,2,3].map(i=>{const s=String(stmts[i]||"").trim();return`<div class="tfRow"><div class="tfTop"><div class="tfStmt"><b>${"ABCD"[i]}.</b> ${escapeHtml(s||"(trống)")}</div><div class="tfBtns"><button class="tfBtn ${user[i]===true?"active":""}" data-tf="${q.id}" data-k="${i}" data-v="1" ${locked?"disabled":""} type="button">Đúng</button><button class="tfBtn ${user[i]===false?"active":""}" data-tf="${q.id}" data-k="${i}" data-v="0" ${locked?"disabled":""} type="button">Sai</button></div></div></div>`}).join("")}</div>`}
function scrollToHashIfAny(){const h=(location.hash||"").trim();if(!h||h.length<2)return;const el=document.querySelector(h);if(!el)return;setTimeout(()=>{try{el.scrollIntoView({behavior:"smooth",block:"start"})}catch{}},80)}
let SHORT4_FOCUS={id:null,k:0};
function _evtEl(t){if(!t)return null;let x=t;if(x.nodeType===3)x=x.parentElement;return(x&&typeof x.closest==="function")?x:null}

/* FIX: Enter qua câu khác -> scroll card/input vào GIỮA màn hình */
content.addEventListener("keydown",(e)=>{const t=e.target;if(t&&t.classList&&t.classList.contains("ans")&&e.key==="Enter"){e.preventDefault();if(state.finalized)return;const inputs=Array.from(content.querySelectorAll(".ans")).filter(x=>!x.disabled);const idx=inputs.indexOf(t);if(idx>=0&&idx<inputs.length-1){const next=inputs[idx+1];const card=next.closest(".card");if(card){try{card.scrollIntoView({behavior:"smooth",block:"center"})}catch{}}setTimeout(()=>{try{next.focus();if(next.select)next.select()}catch{}},120)}else{try{document.getElementById("btnSubmitBig").scrollIntoView({behavior:"smooth",block:"center"})}catch{}}}},true);

content.addEventListener("focusin",(e)=>{const t=e.target;if(t&&t.classList&&t.classList.contains("short4")){SHORT4_FOCUS.id=Number(t.getAttribute("data-id"));SHORT4_FOCUS.k=Number(t.getAttribute("data-k"));if(SHORT4_CLICK_ONLY){try{t.blur()}catch{}}}},{passive:true});

/* MOBILE: chặn đổi focus khi bấm Check để không làm hạ bàn phím */
let LAST_PD_CHECK={btn:null,ts:0};
content.addEventListener("pointerdown",(e)=>{
  if(!IS_MOBILE)return;
  const tt=_evtEl(e.target);if(!tt)return;
  const b=tt.closest("[data-check]");if(!b||b.disabled)return;
  e.preventDefault();
  LAST_PD_CHECK={btn:b,ts:Date.now()};
  runEssayCheckButton(b);
},{passive:false});

function runEssayCheckButton(b){
  const id=Number(b.dataset.check);
  const q=QUIZ.items.find(x=>Number(x.id)===id);
  if(!q)return;
  if(qTypeOf(q)!=="essay")return;
  if(!isAnswered(q)){toast("Chưa làm câu này");return}

  const card=document.getElementById(`q${id}`);
  let input=null;
  let nextEssay=null;
  if(card){
    input=card.querySelector(`.ans[data-id="${id}"]`);
    if(IS_MOBILE&&input){
      const inputs=Array.from(content.querySelectorAll(".ans")).filter(x=>!x.disabled);
      const idx=inputs.indexOf(input);
      if(idx>=0&&idx<inputs.length-1)nextEssay=inputs[idx+1];
    }
  }

  const g=gradeOne(q);
  state.checked[id]={ok:!!g.ok,expected:String(g.expected||""),locked:true};
  saveLocalProgress();
  toast(g.ok?"ĐÚNG":"SAI");

  if(card){
    if(input)input.setAttribute("disabled","disabled");
    b.setAttribute("disabled","disabled");
    b.textContent="Đã check";
    const holder=card.querySelector(`[data-essay-result="${id}"]`);
    if(holder){
      holder.innerHTML=`<div class="resultRow"><div>${g.ok?`<span class="oktxt">ĐÚNG</span>`:`<span class="badtxt">SAI</span>`}</div><div><span class="muted">${escapeHtml(g.expected||"")}</span></div></div>`;
      applyMath(holder);
    }
  }

  if(IS_MOBILE&&nextEssay){
    const nextCard=nextEssay.closest(".card");
    if(nextCard){try{nextCard.scrollIntoView({behavior:"smooth",block:"center"})}catch{}}
    setTimeout(()=>{try{nextEssay.focus({preventScroll:true});if(nextEssay.select)nextEssay.select()}catch{}},90);
  }
}

content.addEventListener("click",(e)=>{
  const tt=_evtEl(e.target);if(!tt)return;

  const s4=tt.closest(".short4");
  if(s4){SHORT4_FOCUS.id=Number(s4.getAttribute("data-id"));SHORT4_FOCUS.k=Number(s4.getAttribute("data-k"));if(SHORT4_CLICK_ONLY){e.preventDefault();try{s4.blur()}catch{}}return}

  const img=tt.closest("[data-img]");
  if(img){openImg(img.getAttribute("data-img"));return}

  const mcq=tt.closest("[data-mcq]");
  if(mcq){const id=Number(mcq.getAttribute("data-mcq"));const orig=Number(mcq.getAttribute("data-orig"));state.answers[id]=orig;saveLocalProgress();updateStats();const card=mcq.closest(".card");if(card){card.querySelectorAll(`[data-mcq="${id}"]`).forEach(btn=>{const o=Number(btn.getAttribute("data-orig"));btn.classList.toggle("active",o===orig)})}return}

  const tf=tt.closest("[data-tf]");
  if(tf){const id=Number(tf.getAttribute("data-tf"));const k=Number(tf.getAttribute("data-k"));const v=(tf.getAttribute("data-v")==="1");const cur=Array.isArray(state.answers[id])?state.answers[id].slice(0,4):[null,null,null,null];while(cur.length<4)cur.push(null);cur[k]=v;state.answers[id]=cur;saveLocalProgress();updateStats();const card=tf.closest(".card");if(card){card.querySelectorAll(`[data-tf="${id}"][data-k="${k}"]`).forEach(btn=>{const bv=(btn.getAttribute("data-v")==="1");btn.classList.toggle("active",bv===v)})}return}

  const kp=tt.closest("[data-kpid][data-kpkey]");
  if(kp){const id=Number(kp.getAttribute("data-kpid"));const key=String(kp.getAttribute("data-kpkey")||"");const card=kp.closest(".card");if(!card)return;if(state.finalized)return;const raw=String(state.answers[id]||"");const arr=[raw[0]||"",raw[1]||"",raw[2]||"",raw[3]||""];let cursor=(SHORT4_FOCUS.id===id)?Number(SHORT4_FOCUS.k||0):arr.findIndex(x=>!x);if(cursor<0)cursor=3;const clamp=(n)=>Math.max(0,Math.min(3,n));const isMinus=(key==="−"||key==="-" );if(key==="CLR"){arr[0]=arr[1]=arr[2]=arr[3]="";cursor=0}else if(key==="⌫"||key==="<"||key==="BACK"||key==="DEL"){cursor=clamp(cursor);if(arr[cursor]){arr[cursor]=""}else{let j=cursor-1;while(j>=0&&!arr[j])j--;if(j>=0){arr[j]="";cursor=j}}}else{let pos=clamp(cursor);if(arr[pos]){let j=pos;while(j<4&&arr[j])j++;if(j>=4)j=-1;pos=j}if(pos>=0){let ch=key;if(isMinus)ch="−";if(ch==="−"&&pos!==0)ch="";if(ch===","&&pos===0)ch="";if(ch){if(ch==="−"&&arr[0])ch="";if(ch){arr[pos]=ch;let j=pos+1;while(j<4&&arr[j])j++;cursor=(j<4)?j:3}}}}state.answers[id]=arr.join("");saveLocalProgress();updateStats();const inputs=card.querySelectorAll(`.short4[data-id="${id}"]`);inputs.forEach(inp=>{const k=Number(inp.getAttribute("data-k"));inp.value=arr[k]||""});SHORT4_FOCUS.id=id;SHORT4_FOCUS.k=cursor;if(!SHORT4_CLICK_ONLY){const next=card.querySelector(`.short4[data-id="${id}"][data-k="${cursor}"]`);if(next){try{next.focus()}catch{}}}return}

  const b=tt.closest("[data-check]");
  if(!b)return;

  if(IS_MOBILE&&LAST_PD_CHECK.btn===b&&(Date.now()-LAST_PD_CHECK.ts)<700){
    return;
  }
  runEssayCheckButton(b);
});

content.addEventListener("input",(e)=>{const t=e.target;if(!t)return;if(t.classList&&t.classList.contains("ans")){const id=Number(t.dataset.id);const ck=state.checked[id];if(ck&&ck.locked){t.value=String(state.answers[id]||"");return}state.answers[id]=String(t.value||"");saveLocalProgress();updateStats();return}if(t.classList&&t.classList.contains("short4")){const id=Number(t.getAttribute("data-id"));const k=Number(t.getAttribute("data-k"));if(state.finalized)return;if(SHORT4_CLICK_ONLY){const raw=String(state.answers[id]||"");const arr=[raw[0]||"",raw[1]||"",raw[2]||"",raw[3]||""];t.value=arr[k]||"";return}SHORT4_FOCUS.id=id;SHORT4_FOCUS.k=k;let v=String(t.value||"");v=v.replace(/[^0-9\-,−]/g,"").slice(0,1);if(v==="-" )v="−";if(v==="−"&&k!==0)v="";if(v===","&&k===0)v="";if(t.value!==v)t.value=v;const raw=String(state.answers[id]||"");const arr=[raw[0]||"",raw[1]||"",raw[2]||"",raw[3]||""];arr[k]=v||"";state.answers[id]=arr.join("");saveLocalProgress();updateStats();if(v&&k<3){const card=t.closest(".card");const next=card&&card.querySelector(`.short4[data-id="${id}"][data-k="${k+1}"]`);if(next){try{next.focus()}catch{}SHORT4_FOCUS.k=k+1}}return}},{passive:true});
content.addEventListener("keydown",(e)=>{const t=e.target;if(!t||!t.classList||!t.classList.contains("short4"))return;if(SHORT4_CLICK_ONLY)return;const id=Number(t.getAttribute("data-id"));const k=Number(t.getAttribute("data-k"));if(e.key==="Backspace"){if(String(t.value||"")===""&&k>0){const card=t.closest(".card");const prev=card&&card.querySelector(`.short4[data-id="${id}"][data-k="${k-1}"]`);if(prev){try{prev.focus()}catch{}SHORT4_FOCUS.id=id;SHORT4_FOCUS.k=k-1}}}});

btnScrollTop.onclick=()=>{document.getElementById("shell").scrollTo({top:0,behavior:"smooth"})};btnHome.onclick=()=>goHome();
const resetBackdrop=document.getElementById("resetBackdrop");btnReset.onclick=()=>{resetBackdrop.classList.add("show");resetBackdrop.setAttribute("aria-hidden","false")};document.getElementById("btnCancelReset").onclick=()=>{resetBackdrop.classList.remove("show");resetBackdrop.setAttribute("aria-hidden","true")};resetBackdrop.addEventListener("click",(e)=>{if(e.target===resetBackdrop){resetBackdrop.classList.remove("show");resetBackdrop.setAttribute("aria-hidden","true")}});document.getElementById("btnConfirmReset").onclick=()=>{resetBackdrop.classList.remove("show");resetBackdrop.setAttribute("aria-hidden","true");resetForNewAttempt({reshuffle:true});toast("Đã làm lại");if(view.started)renderQuiz();else updateStats()};
const submitBackdrop=document.getElementById("submitBackdrop");const submitBody=document.getElementById("submitBody");document.getElementById("btnCancelSubmit").onclick=()=>closeSubmitConfirm(false);document.getElementById("btnConfirmSubmit").onclick=()=>closeSubmitConfirm(true);submitBackdrop.addEventListener("click",(e)=>{if(e.target===submitBackdrop)closeSubmitConfirm(false)});
let SUBMIT_PROMPT={open:false,resolve:null};
function openSubmitConfirm(htmlBody){return new Promise((resolve)=>{SUBMIT_PROMPT.open=true;SUBMIT_PROMPT.resolve=resolve;submitBody.innerHTML=htmlBody||`<p>Bạn có muốn nộp bài không?</p>`;submitBackdrop.classList.add("show");submitBackdrop.setAttribute("aria-hidden","false")})}
function closeSubmitConfirm(ans){if(!SUBMIT_PROMPT.open)return;submitBackdrop.classList.remove("show");submitBackdrop.setAttribute("aria-hidden","true");const r=SUBMIT_PROMPT.resolve;SUBMIT_PROMPT.open=false;SUBMIT_PROMPT.resolve=null;if(r)r(!!ans)}
function getMissingItems(){const items=getViewItems();const miss=[];items.forEach((q,idx)=>{if(!isAnswered(q))miss.push({idx:idx+1,id:q.id})});return miss}
function buildWrongList(items){const wrong=[];const push=(x)=>{if(!x)return;if(wrong.length>=200)return;wrong.push(x)};for(const q of items){const t=qTypeOf(q);if(t==="tf4"){const stmts=Array.isArray(q.meta?.statements)?q.meta.statements:["","","",""];const keys=Array.isArray(q.meta?.keys)?q.meta.keys:[true,false,false,false];const user=Array.isArray(state.answers[q.id])?state.answers[q.id]:[null,null,null,null];for(let i=0;i<4;i++){const u=user[i];const k=Boolean(keys[i]);const okPart=(u===true||u===false)&&(u===k);if(okPart)continue;const label="ABCD"[i];const stmt=String(stmts[i]||"").trim();const uText=(u===true)?"Đúng":(u===false)?"Sai":"(trống)";const kText=k?"Đúng":"Sai";push({id:q.id,word:`${label}. ${stmt||q.prompt||""}`,user_answer:uText,expected:kText})}continue}if(t==="mcq1"||t==="mcq"){const g=gradeOne(q);if(g.ok)continue;const userOrig=Number(state.answers[q.id]||0);const uLetter=(userOrig>=1&&userOrig<=4)?"ABCD"[userOrig-1]:"(trống)";push({id:q.id,word:q.prompt||"",user_answer:uLetter,expected:g.expected||""});continue}const g=gradeOne(q);if(g.ok)continue;const ua=String(state.answers[q.id]||"").trim();push({id:q.id,word:q.prompt||"",user_answer:ua?ua:"(trống)",expected:g.expected||""})}return wrong}
function computeFinal(){const items=getViewItems();let earned=0;let max=0;let fullCorrectCount=0;const per=[];for(const q of items){const g=gradeOne(q);max+=g.max;earned+=g.earned;if(g.ok)fullCorrectCount++;per.push({id:q.id,no:q.no,q_type:q.q_type,ok:!!g.ok,earned:g.earned,max:g.max})}const wrong=buildWrongList(items);const score10=max>0?Math.round((earned/max*10)*10)/10:0;return{score10,earned,max,fullCorrectCount,totalCount:items.length,per,wrong}}
async function submitToSupabase(result){if(!me||!me.user_id)throw new Error("need login");const attemptBody={quiz_id:quizId,user_id:me.user_id,score10:Number(result.score10||0),correct_count:Number(result.fullCorrectCount||0),total_count:Number(result.totalCount||0),details_json:{client:"q/index.html",ts:Date.now(),username:me.username||"",quiz_id:quizId,shuffle_mode:QUIZ.shuffle_mode||"none",order:state.order||[],earned:result.earned,max:result.max,per:result.per,wrong:result.wrong,answers:state.answers||{}}};const inserted=await sbPost(`attempts?select=attempt_id,created_at`,attemptBody,{preferReturn:true});const row=Array.isArray(inserted)?inserted[0]:inserted;const attemptId=row?.attempt_id;if(!attemptId)throw new Error("Không lấy được attempt_id");return attemptId}
async function doSubmitNow(){if(state.finalized)return;if(!view.started){toast("Chưa vào làm");return}if(QUIZ.require_login&&(!me||!me.user_id)){toast("Quiz này cần đăng nhập");renderGate();return}state.finalized=true;saveLocalProgress();renderLoading("Đang tính điểm…");const result=computeFinal();let attemptId="";

try{attemptId=await submitToSupabase(result);state.attempt_id=attemptId;saveLocalProgress()}catch(e){toast("Không lưu DB: "+(e?.message||"unknown"))}

try{await upsertOfficialScore(result.score10)}catch(e){toast("Không lưu điểm leaderboard: "+(e?.message||"unknown"))}

try{sessionStorage.setItem(`tk_last_result::${quizId}`,JSON.stringify({quiz_id:quizId,title:QUIZ.title,sub:QUIZ.sub,me:me?{username:me.username,role:me.role,user_id:me.user_id}:null,attempt_id:attemptId||"",result,ts:Date.now()}))}catch{}
resetForNewAttempt({reshuffle:true});clearLocalProgressOnly();const qs=new URLSearchParams();qs.set("quiz",quizId);if(attemptId)qs.set("attempt",attemptId);location.href=`/result.html?${qs.toString()}`}
btnSubmitBig.onclick=async()=>{if(state.finalized)return;if(!view.started){toast("Chưa vào làm");return}if(QUIZ.require_login&&(!me||!me.user_id)){toast("Quiz này cần đăng nhập");renderGate();return}const miss=getMissingItems();const missCount=miss.length;let body="";if(missCount===0){body=`<p><b>Bạn có muốn nộp bài không?</b></p>`}else if(missCount<5){const lis=miss.map(x=>`<li><b>Câu ${x.idx}</b></li>`).join("");body=`<p><b>Bạn chưa làm các câu sau:</b></p><ul class="missList">${lis}</ul><p>Không chọn là tính sai. Vẫn nộp chứ?</p>`}else{body=`<p><b>Bạn chưa làm ${missCount} câu.</b></p><p>Xác nhận nộp bài?</p>`}const ok=await openSubmitConfirm(body);if(!ok)return;await doSubmitNow()};
async function loadMeIfAny(){const token=getToken();if(!token)return null;try{const out=await sbRpc(RPC.me,{p_token:token});if(!out||out.ok!==true)throw new Error(out?.error||"me fail");const m=out.me||out.user||out.data||null;if(m&&m.id&&!m.user_id)m.user_id=m.id;return m}catch(_e){clearAuthLocal();return null}}
async function loadQuiz(){const token=getToken()||"";const out=await sbRpc(RPC.getQuiz,{p_quiz_id:quizId,p_token:token,p_access_code:""});if(!out||out.ok!==true)throw new Error(out?.error||"Không tải được quiz");const q=out.quiz||{};const items=Array.isArray(out.items)?out.items:[];return{quiz_id:q.quiz_id||quizId,title:q.title||"Quiz",sub:q.sub||"",require_login:(q.require_login!==false),shuffle_mode:q.shuffle_mode??"none",cover_image:q.cover_image||"",cover_data_url:q.cover_data_url||"",items:items.map(x=>{const meta=(x.meta&&typeof x.meta==="object")?x.meta:{};let answers=[];if(Array.isArray(x.answers)&&x.answers.length){answers=x.answers}else if(Array.isArray(meta.answers)){answers=meta.answers}return{id:Number(x.id),no:x.no,q_type:String(x.q_type||"essay"),prompt:String(x.prompt||""),answers,points:x.points??1,meta}})}}
async function enterAfterAuth(out){const token=out?.token||"";if(token)setToken(token);let m=out?.me||out?.user||out?.data||null;if(m&&m.id&&!m.user_id)m.user_id=m.id;if(!m||!m.user_id){const m2=await loadMeIfAny();if(m2)m=m2}if(m&&m.user_id){me=m;setMeCache(m);setNameCache(me.username||"");setUserCorner(me);try{QUIZ=await loadQuiz();quizTitleEl.textContent=QUIZ.title||"Quiz";quizSubEl.textContent=QUIZ.sub||"";applyShareMeta()}catch(e){renderQuizLoadError(e);return}if(state.finalized){resetForNewAttempt({reshuffle:true});clearLocalProgressOnly()}await refreshAttemptMeta();renderStart();updateStats()}else{toast("Không lấy được user");renderGate()}}
const profileBackdrop=document.getElementById("profileBackdrop");document.getElementById("btnCloseProfile").onclick=()=>closeProfileModal();profileBackdrop.addEventListener("click",(e)=>{if(e.target===profileBackdrop)closeProfileModal()});document.getElementById("btnProfileHome").onclick=()=>goHome();document.getElementById("btnLogout").addEventListener("click",()=>{clearAuthLocal();me=null;view.started=false;setUserCorner(null);closeProfileModal();toast("Đã đăng xuất");ATTEMPT_META={count:0,latestAttemptId:""};if(QUIZ.require_login)renderGate();else renderStart();updateStats()});
function openProfileModal(){if(!me||!me.username)return;document.getElementById("profileUsername").textContent=me.username;document.getElementById("profileRole").textContent=isAdminUser(me)?"ADMIN":"USER";profileBackdrop.classList.add("show");profileBackdrop.setAttribute("aria-hidden","false")}
function closeProfileModal(){profileBackdrop.classList.remove("show");profileBackdrop.setAttribute("aria-hidden","true")}
userCorner.addEventListener("click",()=>{if(me)openProfileModal()});
(async function boot(){if(!quizId||quizId.length!==5){renderLoading("Thiếu quiz_id. Mở đúng dạng: /q/index.html?quiz=abcde  (hoặc /q/abcde)");return}renderLoading("Đang tải quiz…");if(FLAG_RESTART){loadLocalProgress();resetForNewAttempt({reshuffle:true});clearLocalProgressOnly();dropFlagsFromUrl()}else{loadLocalProgress()}me=getMeCache();if(me&&me.id&&!me.user_id)me.user_id=me.id;if(getToken()&&(!me||!me.user_id)){const m2=await loadMeIfAny();if(m2){me=m2;setMeCache(me)}}try{QUIZ=await loadQuiz();quizTitleEl.textContent=QUIZ.title||"Quiz";quizSubEl.textContent=QUIZ.sub||"";applyShareMeta()}catch(e){renderQuizLoadError(e);return}if(state.finalized){resetForNewAttempt({reshuffle:true});clearLocalProgressOnly()}ensureShuffle({force:false});updateStats();if(!QUIZ.require_login){if(me&&me.user_id)setUserCorner(me);else setUserCorner(null);ATTEMPT_META={count:0,latestAttemptId:""};if(FLAG_START){dropFlagsFromUrl();view.started=true;renderQuiz();scrollToHashIfAny()}else{renderStart()}return}if(me&&me.user_id){setUserCorner(me);await refreshAttemptMeta();renderStart()}else{setUserCorner(null);renderGate()}})();
</script></body></html>
