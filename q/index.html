<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
  <title>Quiz</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg1: #ffecd2; --bg2: #fcb69f;
      --card: #fff; --text: #1f2937; --muted: #6b7280;
      --primary: #7c3aed; --ok: #16a34a; --bad: #dc2626;
      --border: #e5e7eb; --soft: #f8fafc;
      --shadow: 0 14px 40px rgba(0,0,0,.10);
      --radius: 18px;
      --gold: #f59e0b; --silver: #94a3b8; --bronze: #d97706;
      --admin: #2563eb;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html { -webkit-text-size-adjust: 100%; }
    body {
      margin: 0;
      font-family: "Montserrat", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
                  linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 100%);
      overflow: hidden;
      touch-action: pan-x pan-y;
    }
    .btn, .btn-x { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    #shell { height: 100vh; overflow: auto; -webkit-overflow-scrolling: touch; padding: 12px 0 110px; touch-action: pan-y; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 0 14px; }

    .userCorner {
      position: fixed;
      top: 10px;
      left: 12px;
      z-index: 10010;
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(229,231,235,.65);
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 22px rgba(0,0,0,.06);
      user-select: none;
      max-width: calc(100vw - 24px);
      cursor: pointer;
    }
    .userCorner .name {
      font-weight: 950;
      font-size: .88rem;
      color: rgba(31,41,55,.55);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 58vw;
    }
    .userCorner .adminBadge {
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 950;
      font-size: .78rem;
      background: rgba(37,99,235,.12);
      border: 1px solid rgba(37,99,235,.35);
      color: var(--admin);
      white-space: nowrap;
    }

    .actionbar {
      position: sticky; top: 10px; z-index: 9999;
      display: flex; justify-content: flex-end; gap: 10px; padding: 0 14px;
      flex-wrap: wrap;
    }
    .btn {
      border: 0; cursor: pointer;
      border-radius: 999px; padding: 10px 14px;
      font-weight: 900; font-size: .9rem;
      transition: transform .16s ease, filter .16s ease;
      display: inline-flex; align-items: center; gap: 8px;
      user-select: none; white-space: nowrap;
      box-shadow: 0 12px 24px rgba(0,0,0,.12);
      background: #fff; color: #111827; border: 1px solid #e5e7eb;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(.98); }
    .btn:active { transform: translateY(0px); }
    .btn-reset { background: #111827; color: #fff; border: 0; }
    .btn-primary {
      background: linear-gradient(135deg, #7c3aed, #fb7185);
      color: #fff; border: 0;
      box-shadow: 0 12px 24px rgba(124,58,237,.18);
    }
    .btn-check {
      border-radius: 12px;
      padding: 9px 10px;
      font-size: .86rem;
      font-weight: 950;
      box-shadow: 0 10px 20px rgba(124,58,237,.14);
      width: auto;
      min-width: 86px;
      justify-content: center;
    }
    .btn-check[disabled] { opacity: .65; cursor: not-allowed; }

    .topbar {
      margin-top: 10px;
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      padding: 14px;
      display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap;
    }
    .titlebox { display: flex; gap: 10px; align-items: center; flex: 1 1 360px; min-width: 240px; }
    .logo {
      width: 42px; height: 42px; border-radius: 16px;
      background: linear-gradient(135deg, #a78bfa, #fb7185);
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: 900;
      box-shadow: 0 10px 22px rgba(124,58,237,.18);
      user-select: none;
    }
    .titles h1 { font-size: 1.02rem; margin: 0; font-weight: 800; }
    .titles .tiny { margin-top: 3px; font-size: .86rem; color: var(--muted); font-weight: 650; }

    .stats { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pill {
      background: #f3f4f6; border: 1px solid #e5e7eb;
      border-radius: 999px; padding: 8px 12px;
      font-weight: 800; font-size: .9rem; color: #374151; white-space: nowrap;
    }
    .pill strong { color: var(--primary); }
    .progressline {
      height: 10px; border-radius: 999px; background: #f3f4f6; overflow: hidden;
      border: 1px solid #e5e7eb; width: 100%; max-width: 360px;
    }
    .progressfill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, #22c55e, #a78bfa);
      transition: width .25s ease;
    }

    .content { padding: 12px 0 0; }
    .card {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px; margin: 12px 0;
    }
    .row1 { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .vi { margin: 0; font-weight: 900; font-size: 1.04rem; line-height: 1.25; }
    .meta { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .idx {
      font-size: .78rem; font-weight: 900;
      padding: 6px 10px; border-radius: 999px;
      background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe;
      white-space: nowrap;
    }
    .muted { color: var(--muted); font-weight: 650; }

    .input {
      width: 100%;
      border-radius: 14px; border: 2px solid #e5e7eb;
      padding: 11px 12px; font-size: .95rem; font-weight: 700;
      outline: none; background: var(--soft);
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .input:focus {
      border-color: rgba(124,58,237,.55);
      box-shadow: 0 0 0 5px rgba(124,58,237,.10);
      background: #fff;
    }

    .qaRow{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .qaRow .input{ flex: 1 1 260px; }

    .resultRow{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:10px;
      align-items:center;
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px dashed #e5e7eb;
      background: #fff;
      font-weight: 800;
      line-height: 1.35;
    }
    .oktxt { color: var(--ok); font-weight: 1000; }
    .badtxt { color: var(--bad); font-weight: 1000; }

    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(17,24,39,.92); color: #fff;
      padding: 10px 12px; border-radius: 14px;
      font-weight: 800; font-size: .9rem;
      opacity: 0; pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      max-width: calc(100% - 28px);
      z-index: 20050;
      text-align: center;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(-4px); }

    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.35);
      display: none; align-items: center; justify-content: center;
      padding: 16px;
      z-index: 20000;
    }
    .modal-backdrop.show { display: flex; }
    .modal {
      width: 100%; max-width: 620px;
      background: #fff;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      padding: 14px;
      max-height: 82vh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal h3 { margin: 4px 0 6px; font-size: 1.02rem; }
    .modal p { margin: 0 0 12px; color: var(--muted); font-weight: 650; font-size: .92rem; line-height: 1.35; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
    .btn-ghost { background: #fff; color: #111827; border: 1px solid #e5e7eb; box-shadow: none; }
    .btn-danger { background: var(--bad); color: #fff; border: 0; }

    @media (max-width: 820px) {
      .progressline { max-width: 100%; }
      .btn { padding: 9px 12px; font-size: .85rem; }
      .resultRow{ grid-template-columns: 120px 1fr; }
      .userCorner .name { max-width: 66vw; }
      .btn-check{ min-width: 84px; }
    }
  </style>
</head>

<body>
  <div class="userCorner" id="userCorner" title="B·∫•m ƒë·ªÉ xem t√†i kho·∫£n">
    <span class="name" id="userCornerName">‚Äî</span>
    <span class="adminBadge" id="userCornerAdmin" style="display:none;">ADMIN</span>
  </div>

  <div id="shell">
    <div class="actionbar">
      <button class="btn" id="btnScrollTop">‚¨ÜÔ∏è L√™n ƒë·∫ßu</button>
      <button class="btn btn-primary" id="btnSubmit" disabled>üèÅ N·ªôp b√†i</button>
      <button class="btn btn-reset" id="btnReset">üîÅ L√†m l·∫°i</button>
    </div>

    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">Hi!</div>
          <div class="titles">
            <h1 id="quizTitle">Quiz</h1>
            <div class="tiny" id="quizSub"></div>
          </div>
        </div>

        <div class="stats">
          <div class="pill">ƒê√£ l√†m: <strong id="answeredCount">0</strong>/<span id="totalCount">0</span></div>
          <div class="progressline"><div class="progressfill" id="progressFill"></div></div>
        </div>
      </div>

      <div class="content" id="content"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal-backdrop" id="resetBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>L√†m l·∫°i b√†i?</h3>
      <p>X√≥a l·∫ßn l√†m hi·ªán t·∫°i (tr√™n m√°y) v√† shuffle l·∫°i.</p>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="btnCancelReset">H·ªßy</button>
        <button class="btn btn-danger" id="btnConfirmReset">X√≥a & L√†m l·∫°i</button>
      </div>
    </div>
  </div>

<script>
/** ====== SUPABASE CONFIG ====== */
const SUPABASE_URL = "https://aidvlydhbdtwunyreqak.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZHZseWRoYmR0d3VueXJlcWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzM5NzYsImV4cCI6MjA4NDIwOTk3Nn0.LMKGjKlUbC5qoY7hqDpaDFQrFWfwKemBTpxjTNp_L8o";

/** ====== RPC NAMES (n·∫øu b·∫°n d√πng t√™n kh√°c th√¨ s·ª≠a ·ªü ƒë√¢y) ====== */
const RPC = {
  getQuiz: "api_get_quiz",
  checkUsername: "api_check_username",
  login: "api_login",
  register: "api_register",
  me: "api_me"
};

/** ====== STORAGE ====== */
const TOKEN_KEY = "tk_token_v2";
const ME_KEY = "tk_me_v2";

/** ====== HELPERS ====== */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = String(msg||"");
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1400);
}
function escapeHtml(s) {
  return String(s ?? "")
    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;").replace(/'/g, "&#39;");
}
function normalizeForCompare(s) {
  let t = String(s||"").trim().toLowerCase();
  t = t.replace(/ƒë/g, "d");
  try { t = t.normalize("NFKD").replace(/[\u0300-\u036f]/g, ""); } catch {}
  t = t.replace(/[‚Äú‚Äù"']/g, " ");
  t = t.replace(/[^a-z0-9\s]/g, " ");
  t = t.replace(/\s+/g, " ").trim();
  return t;
}
function looseEq(user, expected){
  const u = normalizeForCompare(user);
  const a = normalizeForCompare(expected);
  if (!u || !a) return false;
  if (u === a) return true;
  // cho ph√©p sai r·∫•t nh·∫π: b·ªè kho·∫£ng tr·∫Øng
  if (u.replace(/\s/g,"") === a.replace(/\s/g,"")) return true;
  return false;
}
function parseQuizIdFromUrl(){
  const p = location.pathname;          // /q/abcde or /q/abcde.html
  const m = p.match(/^\/q\/([^\/]+)\/?$/);
  let id = m ? m[1] : "";
  id = id.replace(/\.html$/i,"").toLowerCase().replace(/[^a-z]/g,"").slice(0,5);
  return id;
}
function validateUsername(u){
  u = String(u||"").trim().toLowerCase();
  if(!u) return "Ch∆∞a nh·∫≠p username.";
  if(u.length>15) return "Username t·ªëi ƒëa 15 k√Ω t·ª±.";
  if(!/^[a-z0-9_]+$/.test(u)) return "Ch·ªâ d√πng a-z 0-9 v√† _ (kh√¥ng vi·∫øt hoa).";
  return null;
}
function getToken(){
  try { return (localStorage.getItem(TOKEN_KEY)||"").trim(); } catch { return ""; }
}
function setToken(t){
  try { localStorage.setItem(TOKEN_KEY, String(t||"").trim()); } catch {}
}
function clearToken(){
  try { localStorage.removeItem(TOKEN_KEY); } catch {}
  try { localStorage.removeItem(ME_KEY); } catch {}
}
function getMeCache(){
  try { return JSON.parse(localStorage.getItem(ME_KEY)||"null"); } catch { return null; }
}
function setMeCache(me){
  try { localStorage.setItem(ME_KEY, JSON.stringify(me||null)); } catch {}
}
function sbHeaders(){
  const key = String(SUPABASE_ANON_KEY||"").trim();
  return {
    "apikey": key,
    "Authorization": "Bearer " + key,
    "Content-Type": "application/json"
  };
}
async function sbRpc(fn, args){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{
    method:"POST",
    headers: sbHeaders(),
    body: JSON.stringify(args||{})
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "RPC error");
  }
  return data;
}
async function sbGet(path){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{ headers: sbHeaders() });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST GET error");
  }
  return data;
}
async function sbPost(path, body, { preferReturn=false } = {}){
  const headers = sbHeaders();
  if (preferReturn) headers["Prefer"] = "return=representation";
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{
    method:"POST",
    headers,
    body: JSON.stringify(body)
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST POST error");
  }
  return data;
}

/** ====== UI CORE ====== */
const content = document.getElementById("content");
const quizTitleEl = document.getElementById("quizTitle");
const quizSubEl   = document.getElementById("quizSub");
const userCorner  = document.getElementById("userCorner");
const userCornerName = document.getElementById("userCornerName");
const userCornerAdmin= document.getElementById("userCornerAdmin");

function setUserCorner(me){
  if(!me || !me.username){ userCorner.style.display="none"; return; }
  userCornerName.textContent = me.username;
  userCornerAdmin.style.display = (me.role === "admin") ? "inline-flex" : "none";
  userCorner.style.display = "inline-flex";
}

function updateStats(){
  const total = QUIZ.items.length;
  let answered = 0;
  for(const it of QUIZ.items){
    const v = String(state.answers[it.id]||"").trim();
    if (v) answered++;
  }
  document.getElementById("answeredCount").textContent = String(answered);
  document.getElementById("totalCount").textContent = String(total);
  document.getElementById("progressFill").style.width = total ? Math.round(answered*100/total)+"%" : "0%";

  const canSubmit = !!me && !!me.user_id && answered>0 && !state.finalized;
  document.getElementById("btnSubmit").disabled = !canSubmit;
}

/** ====== APP STATE ====== */
const quizId = parseQuizIdFromUrl();
const PROGRESS_KEY = `tk_progress::${quizId}`;

let me = null; // {user_id, username, role}
let QUIZ = { quiz_id: quizId, title:"Quiz", sub:"", items:[] };

let state = {
  quiz_id: quizId,
  answers: {},      // { vocab_id: "..." }
  checked: {},      // { vocab_id: {ok, expected, locked} }
  finalized: false,
  attempt_id: "",
  ts: 0
};

function loadLocalProgress(){
  try{
    const raw = localStorage.getItem(PROGRESS_KEY);
    if(!raw) return;
    const s = JSON.parse(raw);
    if(s && s.quiz_id === quizId){
      state = { ...state, ...s };
    }
  }catch{}
}
function saveLocalProgress(){
  state.ts = Date.now();
  try{ localStorage.setItem(PROGRESS_KEY, JSON.stringify(state)); }catch{}
}

function acceptedAnswers(item){
  // item.answers (text[]) ∆∞u ti√™n; n·∫øu r·ªóng th√¨ t√°ch meaning theo | ; / ,
  const out = [];
  if(Array.isArray(item.answers)) out.push(...item.answers);
  if(item.meaning){
    const t = String(item.meaning||"");
    t.split(/[|;/]/g).forEach(x=>{
      const p = x.trim();
      if(p) out.push(p);
      if(p.includes(",")){
        p.split(",").forEach(y=>{ const q=y.trim(); if(q) out.push(q); });
      }
    });
  }
  // unique (normalize compare)
  const seen = new Set();
  const uniq = [];
  for(const x of out){
    const k = normalizeForCompare(x);
    if(!k) continue;
    if(seen.has(k)) continue;
    seen.add(k);
    uniq.push(String(x).trim());
  }
  return uniq;
}

function gradeOne(item, userAns){
  const u = String(userAns||"").trim();
  const acc = acceptedAnswers(item);
  const expected = acc[0] || String(item.meaning||"");
  if(!u) return { ok:false, expected };
  for(const a of acc){
    if(looseEq(u,a)) return { ok:true, expected };
  }
  return { ok:false, expected };
}

/** ====== RENDER ====== */
function renderLoading(msg){
  content.innerHTML = `
    <div class="card">
      <div class="row1">
        <p class="vi">${escapeHtml(msg||"ƒêang t·∫£i...")}</p>
        <div class="meta"><span class="idx">LOADING</span></div>
      </div>
      <div class="muted" style="margin-top:8px">Vui l√≤ng ch·ªù...</div>
    </div>
  `;
}

function renderLogin(){
  content.innerHTML = `
    <div class="card">
      <div class="row1">
        <p class="vi">ƒêƒÉng nh·∫≠p</p>
        <div class="meta"><span class="idx">B·∫ÆT BU·ªòC</span></div>
      </div>
      <div class="muted" style="margin-top:8px; line-height:1.35">
        Username <b>kh√¥ng vi·∫øt hoa</b>, ch·ªâ <code>a-z 0-9 _</code>, t·ªëi ƒëa 15 k√Ω t·ª±.
      </div>

      <div style="margin-top:12px; display:grid; gap:10px;">
        <input id="u" class="input" placeholder="vd: tuankhoi" maxlength="15" autocomplete="off"/>
        <input id="p" class="input" placeholder="PIN (s·ªë)" inputmode="numeric" maxlength="12" autocomplete="off"/>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn btn-ghost" id="btnReg">ƒêƒÉng k√Ω</button>
          <button class="btn btn-primary" id="btnLogin">ƒêƒÉng nh·∫≠p</button>
        </div>
        <div class="muted" id="authMsg"></div>
      </div>
    </div>
  `;

  const uEl = document.getElementById("u");
  const pEl = document.getElementById("p");
  const msg = document.getElementById("authMsg");

  const doLogin = async (mode) => {
    const u = String(uEl.value||"").trim().toLowerCase();
    uEl.value = u;
    const err = validateUsername(u);
    if(err){ toast(err); return; }
    const pin = String(pEl.value||"").trim();
    if(!pin || !/^[0-9]+$/.test(pin)){ toast("PIN ch·ªâ g·ªìm s·ªë"); return; }

    msg.textContent = "ƒêang x·ª≠ l√Ω...";
    try{
      if(mode==="login"){
        const out = await sbRpc(RPC.login, { p_username: u, p_pin: pin });
        if(!out || out.ok!==true) throw new Error(out?.error || "Login fail");
        setToken(out.token || "");
        me = out.me || out.user || out.data || null;
        if(me && me.id && !me.user_id) me.user_id = me.id;
        setMeCache(me);
      }else{
        // check exists (n·∫øu function c√≥)
        try{
          const ck = await sbRpc(RPC.checkUsername, { p_username: u });
          if(ck && ck.exists===true) throw new Error("Username ƒë√£ t·ªìn t·∫°i");
        }catch(e){
          // n·∫øu rpc kh√¥ng c√≥ ho·∫∑c l·ªói schema cache, b·ªè qua check
        }
        const out = await sbRpc(RPC.register, { p_username: u, p_pin: pin });
        if(!out || out.ok!==true) throw new Error(out?.error || "Register fail");
        setToken(out.token || "");
        me = out.me || out.user || out.data || null;
        if(me && me.id && !me.user_id) me.user_id = me.id;
        setMeCache(me);
      }

      if(!me || !me.user_id) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c user");
      setUserCorner(me);
      toast("OK");
      renderQuiz();
    }catch(e){
      msg.textContent = "L·ªói: " + (e?.message || e);
      toast("Sai ho·∫∑c l·ªói server");
    }
  };

  document.getElementById("btnLogin").onclick = ()=>doLogin("login");
  document.getElementById("btnReg").onclick = ()=>doLogin("register");
}

function renderQuiz(){
  if(!QUIZ.items.length){
    content.innerHTML = `
      <div class="card">
        <div class="row1">
          <p class="vi">Quiz tr·ªëng</p>
          <div class="meta"><span class="idx">EMPTY</span></div>
        </div>
        <div class="muted" style="margin-top:8px">Ch∆∞a c√≥ c√¢u h·ªèi.</div>
      </div>
    `;
    updateStats();
    return;
  }

  let html = "";
  QUIZ.items.forEach((it, idx)=>{
    const typed = String(state.answers[it.id]||"");
    const ck = state.checked[it.id];
    const locked = ck && ck.locked;

    html += `
      <div class="card" data-card="${it.id}">
        <div class="row1">
          <p class="vi">C√¢u ${idx+1}. <b>${escapeHtml(it.word||"")}</b> <span class="muted">(${escapeHtml(it.pos||"")})</span></p>
          <div class="meta"><span class="idx">#${idx+1}</span></div>
        </div>

        <div style="margin-top:10px;">
          <div class="qaRow">
            <input class="input ans" data-id="${it.id}" placeholder="Nh·∫≠p nghƒ©a‚Ä¶" value="${escapeHtml(typed)}" ${locked ? "disabled":""}/>
            <button class="btn btn-primary btn-check" data-check="${it.id}" ${locked ? "disabled":""}>${locked?"ƒê√£ check":"Check"}</button>
          </div>
        </div>

        ${locked ? `
          <div class="resultRow">
            <div>${ck.ok ? `<span class="oktxt">ƒê√öNG ‚úÖ</span>` : `<span class="badtxt">SAI ‚ùå</span>`}</div>
            <div>${ck.ok ? `` : `<span class="muted">ƒê√°p √°n:</span> <b>${escapeHtml(ck.expected||"")}</b>`}</div>
          </div>
        `:""}
      </div>
    `;
  });

  content.innerHTML = html;
  updateStats();
}

/** ====== EVENTS ====== */
content.addEventListener("input", (e)=>{
  const t = e.target;
  if(!t || !t.classList.contains("ans")) return;
  const id = Number(t.dataset.id);
  state.answers[id] = String(t.value||"");
  // n·∫øu ƒë√£ lock th√¨ kh√¥ng cho s·ª≠a
  const ck = state.checked[id];
  if(ck && ck.locked){
    t.value = String(state.answers[id]||"");
    return;
  }
  saveLocalProgress();
  updateStats();
}, {passive:true});

content.addEventListener("keydown", (e)=>{
  const t = e.target;
  if(!t || !t.classList.contains("ans")) return;
  if(e.key==="Enter"){
    e.preventDefault();
    const id = Number(t.dataset.id);
    // auto check soft (kh√¥ng lock)
    const item = QUIZ.items.find(x=>Number(x.id)===id);
    if(!item) return;
    const g = gradeOne(item, state.answers[id]);
    state.checked[id] = { ok: !!g.ok, expected: String(g.expected||""), locked:false };
    saveLocalProgress();
    toast(g.ok ? "ƒê√öNG" : "SAI");
    updateStats();
  }
});

content.addEventListener("click", (e)=>{
  const b = e.target.closest("[data-check]");
  if(!b) return;
  const id = Number(b.dataset.check);
  const item = QUIZ.items.find(x=>Number(x.id)===id);
  if(!item) return;

  const ans = String(state.answers[id]||"").trim();
  if(!ans){ toast("Ch∆∞a nh·∫≠p"); return; }

  const g = gradeOne(item, ans);
  state.checked[id] = { ok: !!g.ok, expected: String(g.expected||""), locked:true };
  saveLocalProgress();
  toast(g.ok ? "ƒê√öNG" : "SAI");
  renderQuiz(); // ƒë·ªÉ hi·ªán resultRow + disable input
});

document.getElementById("btnScrollTop").onclick = ()=>{
  document.getElementById("shell").scrollTo({ top:0, behavior:"smooth" });
};

const resetBackdrop = document.getElementById("resetBackdrop");
document.getElementById("btnReset").onclick = ()=>{
  resetBackdrop.classList.add("show");
  resetBackdrop.setAttribute("aria-hidden","false");
};
document.getElementById("btnCancelReset").onclick = ()=>{
  resetBackdrop.classList.remove("show");
  resetBackdrop.setAttribute("aria-hidden","true");
};
resetBackdrop.addEventListener("click",(e)=>{
  if(e.target===resetBackdrop){
    resetBackdrop.classList.remove("show");
    resetBackdrop.setAttribute("aria-hidden","true");
  }
});
document.getElementById("btnConfirmReset").onclick = ()=>{
  resetBackdrop.classList.remove("show");
  resetBackdrop.setAttribute("aria-hidden","true");
  state.answers = {};
  state.checked = {};
  state.finalized = false;
  state.attempt_id = "";
  saveLocalProgress();
  toast("ƒê√£ l√†m l·∫°i");
  renderQuiz();
};

userCorner.addEventListener("click", ()=>{
  if(!me) return;
  const ok = confirm(`ƒêang login: ${me.username}\nOK = ƒëƒÉng xu·∫•t`);
  if(ok){
    clearToken();
    me = null;
    setUserCorner(null);
    toast("ƒê√£ ƒëƒÉng xu·∫•t");
    renderLogin();
    updateStats();
  }
});

/** ====== SUBMIT ====== */
function computeFinal(){
  let correct = 0;
  const wrong = [];
  for(const it of QUIZ.items){
    const ans = String(state.answers[it.id]||"").trim();
    const g = gradeOne(it, ans);
    if(g.ok) correct++;
    else wrong.push({ id: it.id, word: it.word, user: ans, expected: g.expected });
    // lock all
    state.checked[it.id] = { ok: !!g.ok, expected: String(g.expected||""), locked:true };
  }
  const total = QUIZ.items.length;
  const score10 = total ? Math.round((correct/total*10)*10)/10 : 0;
  return { score10, correctCount: correct, totalCount: total, wrong };
}

async function submitToSupabase(result){
  // 1) insert attempts
  const attemptBody = {
    quiz_id: quizId,
    user_id: me.user_id,
    score10: Number(result.score10||0),
    correct_count: Number(result.correctCount||0),
    total_count: Number(result.totalCount||0)
  };

  const inserted = await sbPost(`attempts?select=attempt_id,created_at`, attemptBody, { preferReturn:true });
  const row = Array.isArray(inserted) ? inserted[0] : inserted;
  const attemptId = row?.attempt_id;
  if(!attemptId) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c attempt_id");

  // 2) insert attempt_answers (batch)
  const ansRows = QUIZ.items.map(it=>{
    const userAnswer = String(state.answers[it.id]||"").trim();
    const g = gradeOne(it, userAnswer);
    return {
      attempt_id: attemptId,
      vocab_id: it.id,
      user_answer: userAnswer,
      ok: !!g.ok,
      expected: String(g.expected||"")
    };
  });
  try{
    await sbPost("attempt_answers", ansRows, { preferReturn:false });
  }catch(e){
    // n·∫øu table n√†y b·∫≠t RLS ho·∫∑c ch∆∞a mu·ªën l∆∞u chi ti·∫øt th√¨ b·ªè qua
  }

  return attemptId;
}

document.getElementById("btnSubmit").onclick = async ()=>{
  if(!me || !me.user_id){ toast("Ch∆∞a login"); renderLogin(); return; }
  if(state.finalized) return;

  state.finalized = true;

  renderLoading("ƒêang t√≠nh ƒëi·ªÉm‚Ä¶");
  const result = computeFinal();
  saveLocalProgress();

  // lu√¥n render quiz l·∫°i ƒë·ªÉ lock h·∫øt
  renderQuiz();

  // g·ª≠i supabase
  let attemptId = "";
  try{
    attemptId = await submitToSupabase(result);
    state.attempt_id = attemptId;
    saveLocalProgress();
  }catch(e){
    // v·∫´n cho xem k·∫øt qu·∫£ offline, nh∆∞ng b√°o
    toast("Kh√¥ng g·ª≠i ƒë∆∞·ª£c Supabase (xem k·∫øt qu·∫£ v·∫´n OK)");
  }

  // l∆∞u ƒë·ªÉ result.html ƒë·ªçc nhanh
  try{
    sessionStorage.setItem(`tk_last_result::${quizId}`, JSON.stringify({
      quiz_id: quizId,
      title: QUIZ.title,
      sub: QUIZ.sub,
      me: { username: me.username, role: me.role, user_id: me.user_id },
      attempt_id: attemptId || "",
      result,
      ts: Date.now()
    }));
  }catch{}

  // ƒëi sang result page
  const qs = new URLSearchParams();
  qs.set("quiz", quizId);
  if(attemptId) qs.set("attempt", attemptId);
  location.href = `/result.html?${qs.toString()}`;
};

/** ====== LOAD BOOTSTRAP ====== */
async function loadMeIfAny(){
  const token = getToken();
  if(!token) return null;
  try{
    const out = await sbRpc(RPC.me, { p_token: token });
    if(!out || out.ok!==true) throw new Error(out?.error || "me fail");
    const m = out.me || out.user || out.data || null;
    if(m && m.id && !m.user_id) m.user_id = m.id;
    return m;
  }catch(e){
    clearToken();
    return null;
  }
}

async function loadQuiz(){
  // ∆∞u ti√™n RPC (ƒë√∫ng flow b·∫°n ƒëang d√πng)
  try{
    const token = getToken();
    const out = await sbRpc(RPC.getQuiz, { p_quiz_id: quizId, p_token: token || "" });
    if(out && out.ok===true){
      const q = out.quiz || {};
      const items = out.items || [];
      return {
        quiz_id: q.quiz_id || quizId,
        title: q.title || "Quiz",
        sub: q.sub || "",
        items: items.map(x=>({
          id: Number(x.id),
          no: x.no,
          word: x.word,
          pos: x.pos,
          meaning: x.meaning,
          answers: x.answers || []
        }))
      };
    }
  }catch(e){
    // fallback REST
  }

  // REST fallback
  const qArr = await sbGet(`quizzes?quiz_id=eq.${quizId}&select=quiz_id,title,sub&limit=1`);
  const q = (Array.isArray(qArr) && qArr[0]) ? qArr[0] : { quiz_id: quizId, title:"Quiz", sub:"" };
  const items = await sbGet(`vocabs?quiz_id=eq.${quizId}&select=id,no,word,pos,meaning,answers&order=no.asc,id.asc`);
  return {
    quiz_id: q.quiz_id || quizId,
    title: q.title || "Quiz",
    sub: q.sub || "",
    items: (items||[]).map(x=>({
      id: Number(x.id),
      no: x.no,
      word: x.word,
      pos: x.pos,
      meaning: x.meaning,
      answers: x.answers || []
    }))
  };
}

(async function boot(){
  if(!quizId || quizId.length!==5){
    renderLoading("Sai link quiz. D·∫°ng ƒë√∫ng: /q/abcde");
    return;
  }

  renderLoading("ƒêang t·∫£i quiz‚Ä¶");

  loadLocalProgress();

  me = await loadMeIfAny();
  if(me) setMeCache(me);
  if(!me) me = getMeCache();

  if(me && me.user_id) setUserCorner(me);

  try{
    QUIZ = await loadQuiz();
    quizTitleEl.textContent = QUIZ.title || "Quiz";
    quizSubEl.textContent = QUIZ.sub || "";
  }catch(e){
    renderLoading("L·ªói t·∫£i ƒë·ªÅ: " + (e?.message || e));
    return;
  }

  updateStats();

  // quy·∫øt ƒë·ªãnh view
  if(!me || !me.user_id){
    renderLogin();
  }else{
    renderQuiz();
  }
})();
</script>
</body>
</html>
