<script>
/* ================== CONFIG ================== */
const HOME_URL = "/";

const SUPABASE_URL = "https://aidvlydhbdtwunyreqak.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmR0d3VueXJlcWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzM5NzYsImV4cCI6MjA4NDIwOTk3Nn0.LMKGjKlUbC5qoY7hqDpaDFQrFWfwKemBTpxjTNp_L8o";

const RPC = {
  getQuiz: "api_get_quiz3",
  checkUsername: "api_check_username",
  login: "api_login",
  register: "api_register",
  me: "api_me"
};

const TOKEN_KEY = "tk_token_v2";
const ME_KEY = "tk_me_v2";
const NAME_KEY = "tk_display_name_v1";

/* ================== HARD DEBUG (ƒë·ªÉ kh·ªèi ‚Äúm·∫•t h√∫t‚Äù) ================== */
function renderFatal(err){
  const msg = (err && (err.message || err)) ? (err.message || String(err)) : "Unknown error";
  renderLoading("L·ªói JS: " + msg);
}
window.addEventListener("error", (e)=>{ renderFatal(e?.error || e?.message); });
window.addEventListener("unhandledrejection", (e)=>{ renderFatal(e?.reason || e); });

/* ================== HELPERS ================== */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = String(msg||"");
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1300);
}
function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function normUsername(u){ return String(u||"").trim().toLowerCase(); }
function validateUsername(u){
  u = normUsername(u);
  if(!u) return "Ch∆∞a nh·∫≠p username.";
  if(u.length>15) return "Username t·ªëi ƒëa 15 k√Ω t·ª±.";
  if(!/^[a-z0-9_]+$/.test(u)) return "Ch·ªâ ƒë∆∞·ª£c d√πng a-z 0-9 v√† d·∫•u _ (kh√¥ng vi·∫øt hoa).";
  return null;
}
function isAdminUser(me){
  if(!me) return false;
  const u = String(me.username||"").toLowerCase();
  return me.role==="admin" || u==="tuankhoi";
}
function getToken(){ try{ return (localStorage.getItem(TOKEN_KEY)||"").trim(); }catch{ return ""; } }
function setToken(t){ try{ if(!t) localStorage.removeItem(TOKEN_KEY); else localStorage.setItem(TOKEN_KEY, String(t)); }catch{} }
function getMeCache(){ try{ return JSON.parse(localStorage.getItem(ME_KEY)||"null"); }catch{ return null; } }
function setMeCache(me){ try{ if(!me) localStorage.removeItem(ME_KEY); else localStorage.setItem(ME_KEY, JSON.stringify(me)); }catch{} }
function setNameCache(name){ try{ if(!name) localStorage.removeItem(NAME_KEY); else localStorage.setItem(NAME_KEY, String(name)); }catch{} }
function clearAuthLocal(){ setToken(""); setMeCache(null); }
function goHome(){ location.href = HOME_URL; }

/* quizId: ?quiz=abcde, #abcde, /q/abcde */
function parseQuizIdFromUrl(){
  try{
    const qs = new URLSearchParams(location.search);
    const q = (qs.get("quiz")||"").toLowerCase().replace(/[^a-z]/g,"").slice(0,5);
    if(q && q.length===5) return q;
  }catch{}
  const h = (location.hash||"").replace(/^#/,"").toLowerCase().replace(/[^a-z]/g,"").slice(0,5);
  if(h && h.length===5) return h;
  const p = location.pathname;
  const m = p.match(/\/q\/([a-z]{5})(?:\/|$)/i);
  if(m && m[1]) return String(m[1]).toLowerCase();
  return "";
}

/* ================== URL FLAGS ================== */
const URLP = new URLSearchParams(location.search);
const FLAG_START = (URLP.get("start")==="1");
const FLAG_RESTART = (URLP.get("restart")==="1");
function dropFlagsFromUrl(){
  if(!FLAG_START && !FLAG_RESTART) return;
  URLP.delete("start"); URLP.delete("restart");
  const qs = URLP.toString();
  const newUrl = location.pathname + (qs?("?"+qs):"") + (location.hash||"");
  try{ history.replaceState(null,"",newUrl); }catch{}
}

/* ================== SUPABASE CALLS ================== */
async function sbRpc(fn, args){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{
    method:"POST",
    headers:{
      "apikey": String(SUPABASE_ANON_KEY).trim(),
      "Authorization": "Bearer " + String(SUPABASE_ANON_KEY).trim(),
      "Content-Type":"application/json"
    },
    body: JSON.stringify(args||{})
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "RPC error");
  }
  return data;
}
async function sbPost(path, body, { preferReturn=false, upsert=false } = {}){
  const headers = {
    "apikey": String(SUPABASE_ANON_KEY).trim(),
    "Authorization": "Bearer " + String(SUPABASE_ANON_KEY).trim(),
    "Content-Type":"application/json"
  };
  if(preferReturn) headers["Prefer"] = "return=representation";
  if(upsert){
    headers["Prefer"] = (headers["Prefer"] ? headers["Prefer"] + "," : "") + "resolution=merge-duplicates";
  }

  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{
    method:"POST",
    headers,
    body: JSON.stringify(body)
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST POST error");
  }
  return data;
}

/* ================== UI refs ================== */
const actionbar = document.getElementById("actionbar");
const btnHome = document.getElementById("btnHome");
const btnScrollTop = document.getElementById("btnScrollTop");
const btnSubmit = document.getElementById("btnSubmit");
const btnReset = document.getElementById("btnReset");

const content = document.getElementById("content");
const quizTitleEl = document.getElementById("quizTitle");
const quizSubEl   = document.getElementById("quizSub");
const userCorner  = document.getElementById("userCorner");
const userCornerName = document.getElementById("userCornerName");
const userCornerAdmin= document.getElementById("userCornerAdmin");

function setUserCorner(me){
  if(!me || !me.username){ userCorner.style.display="none"; return; }
  userCornerName.textContent = me.username;
  userCornerAdmin.style.display = isAdminUser(me) ? "inline-flex" : "none";
  userCorner.style.display = "inline-flex";
}
function renderLoading(msg){
  content.innerHTML = `
    <div class="card">
      <div class="row1">
        <p class="vi">${escapeHtml(msg||"ƒêang t·∫£i...")}</p>
        <div class="meta"><span class="idx">LOADING</span></div>
      </div>
      <div class="muted" style="margin-top:8px">Vui l√≤ng ch·ªù...</div>
    </div>`;
}

/* ================== IMAGE VIEWER ================== */
const imgBackdrop = document.getElementById("imgBackdrop");
const imgViewer = document.getElementById("imgViewer");
const btnImgClose = document.getElementById("btnImgClose");
function openImg(url){
  if(!url) return;
  imgViewer.src = url;
  imgBackdrop.classList.add("show");
  imgBackdrop.setAttribute("aria-hidden","false");
}
function closeImg(){
  imgBackdrop.classList.remove("show");
  imgBackdrop.setAttribute("aria-hidden","true");
  imgViewer.src = "";
}
btnImgClose.onclick = closeImg;
imgBackdrop.addEventListener("click",(e)=>{ if(e.target===imgBackdrop) closeImg(); });

/* ================== APP STATE ================== */
const quizId = parseQuizIdFromUrl();
const PROGRESS_KEY = quizId ? `tk_progress::${quizId}` : `tk_progress::unknown`;

let me = null;
let QUIZ = { quiz_id: quizId, title:"Quiz", sub:"", require_login:true, items:[] };
let view = { started:false };

let state = {
  quiz_id: quizId,
  answers: {},
  checked: {},
  finalized: false,
  attempt_id: "",
  ts: 0
};

function syncActionbar(){
  const started = !!view.started;
  btnHome.classList.toggle("hidden", started);
  btnScrollTop.classList.toggle("hidden", !started);
  btnSubmit.classList.toggle("hidden", !started);
  btnReset.classList.toggle("hidden", !started);
}

/* ================== LOCAL PROGRESS ================== */
function hardResetProgressLocal(){
  state.answers = {};
  state.checked = {};
  state.finalized = false;
  state.attempt_id = "";
  try{ localStorage.removeItem(PROGRESS_KEY); }catch{}
  try{ sessionStorage.removeItem(`tk_last_result::${quizId}`); }catch{}
  saveLocalProgress();
}
function loadLocalProgress(){
  try{
    const raw = localStorage.getItem(PROGRESS_KEY);
    if(!raw) return;
    const s = JSON.parse(raw);
    if(s && s.quiz_id === quizId){
      state = { ...state, ...s };
    }
  }catch{}
}
function saveLocalProgress(){
  state.ts = Date.now();
  try{ localStorage.setItem(PROGRESS_KEY, JSON.stringify(state)); }catch{}
}

/* ================== Result helper ================== */
function bestAttemptIdForResult(){
  const a1 = String(state.attempt_id||"").trim();
  if(a1) return a1;
  try{
    const raw = sessionStorage.getItem(`tk_last_result::${quizId}`);
    if(raw){
      const x = JSON.parse(raw);
      if(x && x.quiz_id===quizId && x.attempt_id) return String(x.attempt_id);
    }
  }catch{}
  return "";
}
function goResult(){
  const qs = new URLSearchParams();
  qs.set("quiz", quizId);
  const a = bestAttemptIdForResult();
  if(a) qs.set("attempt", a);
  location.href = `/result.html?${qs.toString()}`;
}

/* ================== Grading helpers ================== */
function normalizeForCompare(s) {
  let t = String(s||"").trim().toLowerCase();
  t = t.replace(/ƒë/g, "d");
  try { t = t.normalize("NFKD").replace(/[\u0300-\u036f]/g, ""); } catch {}
  t = t.replace(/[‚Äú‚Äù"']/g, " ");
  t = t.replace(/[^a-z0-9\s\-,.]/g, " ");
  t = t.replace(/\s+/g, " ").trim();
  return t;
}
function looseEq(user, expected){
  const u = normalizeForCompare(user);
  const a = normalizeForCompare(expected);
  if (!u || !a) return false;
  if (u === a) return true;
  if (u.replace(/\s/g,"") === a.replace(/\s/g,"")) return true;
  return false;
}
function acceptedAnswersFromQuestion(q){
  const out = [];
  if(Array.isArray(q.answers)) out.push(...q.answers);
  const seen = new Set();
  const uniq = [];
  for(const x of out){
    const k = normalizeForCompare(x);
    if(!k) continue;
    if(seen.has(k)) continue;
    seen.add(k);
    uniq.push(String(x).trim());
  }
  return uniq;
}
function pointsOf(q){
  const p = Number(q.points ?? 0);
  return (isFinite(p) && p > 0) ? p : 1;
}
function qTypeOf(q){
  return String(q.q_type || "essay").toLowerCase();
}
function isAnswered(q){
  const t = qTypeOf(q);
  const v = state.answers[q.id];

  if(t === "mcq1" || t === "mcq"){
    const n = Number(v);
    return n>=1 && n<=4;
  }
  if(t === "tf4"){
    return Array.isArray(v) && v.length===4 && v.every(x => typeof x === "boolean");
  }
  // essay / short4
  return String(v||"").trim().length > 0;
}
function gradeOne(q){
  const t = qTypeOf(q);
  const max = pointsOf(q);

  if(t === "mcq1" || t === "mcq"){
    const user = Number(state.answers[q.id] || 0);
    const correct = Number(q.meta?.correct || 1) || 1;
    const ok = user === correct;
    const expected = `ƒê√°p √°n: ${"ABCD"[correct-1] || "A"}`;
    return { ok, expected, earned: ok ? max : 0, max };
  }

  if(t === "tf4"){
    const keys = Array.isArray(q.meta?.keys) ? q.meta.keys : [true,false,false,false];
    const user = Array.isArray(state.answers[q.id]) ? state.answers[q.id] : [false,false,false,false];

    let correctCount = 0;
    for(let i=0;i<4;i++){
      if(Boolean(user[i]) === Boolean(keys[i])) correctCount++;
    }

    const rule = q.meta?.rule?.byCorrectCount || { "0":0, "1":0.25, "2":0.5, "3":0.5, "4":1 };
    const mult = Number(rule[String(correctCount)] ?? 0) || 0;

    const earned = Math.round(max * mult * 100) / 100;
    const ok = (correctCount === 4);
    const expected = `ƒê√∫ng ${correctCount}/4 (ƒëi·ªÉm: ${earned}/${max})`;
    return { ok, expected, earned, max };
  }

  // essay / short4
  const user = String(state.answers[q.id] || "").trim();
  const acc = acceptedAnswersFromQuestion(q);
  const expected = acc[0] ? `ƒê√°p √°n: ${acc[0]}` : "ƒê√°p √°n: (ch∆∞a set)";
  if(!user) return { ok:false, expected, earned: 0, max };

  let ok = false;
  for(const a of acc){
    if(looseEq(user, a)){ ok = true; break; }
  }
  return { ok, expected, earned: ok ? max : 0, max };
}

/* ================== Stats ================== */
function updateStats(){
  const total = QUIZ.items.length;
  let answered = 0;
  for(const q of QUIZ.items){
    if(isAnswered(q)) answered++;
  }
  document.getElementById("answeredCount").textContent = String(answered);
  document.getElementById("totalCount").textContent = String(total);
  document.getElementById("progressFill").style.width = total ? Math.round(answered*100/total)+"%" : "0%";

  const canSubmit =
    !!view.started &&
    !state.finalized &&
    (QUIZ.require_login ? (!!me && !!me.user_id) : true);

  btnSubmit.disabled = !canSubmit;
  syncActionbar();
}

/* ================== Gate (login) ================== */
function renderGate(){
  view.started = false;
  syncActionbar();

  content.innerHTML = `
    <div class="card">
      <div class="row1">
        <p class="vi">Nh·∫≠p USERNAME</p>
        <div><span class="idx">B·∫ÆT BU·ªòC</span></div>
      </div>
      <div class="muted" style="margin-top:6px; line-height:1.35">
        T·ªëi ƒëa 15 k√Ω t·ª±, ch·ªâ <b>a-z 0-9 _</b>.
      </div>

      <div style="margin-top:10px; display:grid; gap:10px;">
        <input id="nameInput" class="input" placeholder="vd: tuankhoi123" maxlength="15" autocomplete="off"/>
        <button id="btnContinue" class="btn btn-primary" style="justify-content:center;">‚û°Ô∏è Ti·∫øp t·ª•c</button>
        <div class="muted" id="gateStatus">S·∫µn s√†ng.</div>
      </div>
    </div>
  `;

  const nameInput = document.getElementById("nameInput");
  const btnContinue = document.getElementById("btnContinue");
  const gateStatus = document.getElementById("gateStatus");

  nameInput.addEventListener("input",()=>{
    const v = normUsername(nameInput.value);
    if(nameInput.value!==v) nameInput.value=v;
  },{passive:true});
  try{ nameInput.focus(); }catch{}

  const doFlow = async ()=>{
    const u = normUsername(nameInput.value);
    const err = validateUsername(u);
    if(err){ toast(err); return; }

    btnContinue.disabled=true; btnContinue.textContent="‚è≥";
    gateStatus.textContent="ƒêang ki·ªÉm tra username‚Ä¶";
    try{
      const ck = await sbRpc(RPC.checkUsername, { p_username: u });
      if(!ck || ck.ok === false) throw new Error(ck?.error || "check fail");

      const exists = (typeof ck.exists === "boolean") ? ck.exists : null;
      const pinLen = (u==="tuankhoi") ? 6 : (Number(ck.pinLen||ck.pin_len||4)||4);

      if(exists === true){
        gateStatus.textContent="ƒêƒÉng nh·∫≠p‚Ä¶";
        await openPin({ username:u, mode:"login", pinLen });
        return;
      }

      if(exists === false){
        gateStatus.textContent=`Username "${u}" ch∆∞a ƒëƒÉng k√Ω.`;
        const ok = await openRegisterPrompt(u);
        if(!ok){ gateStatus.textContent="B·∫°n c√≥ th·ªÉ nh·∫≠p username kh√°c."; return; }

        const regPinLen = (u==="tuankhoi") ? 6 : 4;
        gateStatus.textContent="T·∫°o m·∫≠t kh·∫©u‚Ä¶";
        const pin = await openPin({ username:u, mode:"set", pinLen: regPinLen });

        gateStatus.textContent="ƒêang t·∫°o t√†i kho·∫£n‚Ä¶";
        const out = await sbRpc(RPC.register, { p_username: u, p_pin: String(pin||"") });
        if(!out || !out.ok || !out.token) throw new Error(out?.error || "register fail");

        toast("ƒê√£ ƒëƒÉng k√Ω & ƒëƒÉng nh·∫≠p");
        await enterAfterAuth(out);
        return;
      }

      gateStatus.textContent="Th·ª≠ ƒëƒÉng nh·∫≠p‚Ä¶";
      await openPin({ username:u, mode:"login", pinLen: (u==="tuankhoi")?6:4 });

    }catch(e){
      if(!(e && e.message==="cancel")) toast(e.message||"L·ªói");
      gateStatus.textContent="S·∫µn s√†ng.";
    }finally{
      btnContinue.disabled=false; btnContinue.textContent="‚û°Ô∏è Ti·∫øp t·ª•c";
    }
  };

  btnContinue.onclick = doFlow;
  nameInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); doFlow(); }});
}

/* ================== MODALS (register + pin) ================== */
/* register */
const registerBackdrop = document.getElementById("registerBackdrop");
const registerDesc = document.getElementById("registerDesc");
document.getElementById("btnRegisterNo").onclick = ()=>closeRegisterPrompt(false);
document.getElementById("btnRegisterYes").onclick = ()=>closeRegisterPrompt(true);
registerBackdrop.addEventListener("click",(e)=>{ if(e.target===registerBackdrop) closeRegisterPrompt(false); });

let REG_PROMPT = { open:false, resolve:null, username:"" };
function openRegisterPrompt(username){
  return new Promise((resolve)=>{
    REG_PROMPT.open=true;
    REG_PROMPT.resolve=resolve;
    REG_PROMPT.username=username;
    registerDesc.textContent = `Username "${username}" ch∆∞a ƒëƒÉng k√Ω, b·∫°n c√≥ mu·ªën ƒëƒÉng k√Ω kh√¥ng?`;
    registerBackdrop.classList.add("show");
    registerBackdrop.setAttribute("aria-hidden","false");
  });
}
function closeRegisterPrompt(ans){
  if(!REG_PROMPT.open) return;
  registerBackdrop.classList.remove("show");
  registerBackdrop.setAttribute("aria-hidden","true");
  const r = REG_PROMPT.resolve;
  REG_PROMPT.open=false;
  REG_PROMPT.resolve=null;
  REG_PROMPT.username="";
  if(r) r(!!ans);
}

/* PIN */
const pinBackdrop = document.getElementById("pinBackdrop");
const pinTitle = document.getElementById("pinTitle");
const pinDesc = document.getElementById("pinDesc");
const pinDots = document.getElementById("pinDots");
const pinKeypad = document.getElementById("pinKeypad");
const pinNote = document.getElementById("pinNote");
const pinWrap = document.getElementById("pinWrap");
document.getElementById("btnClosePin").onclick = ()=>closePin("cancel");
pinBackdrop.addEventListener("click",(e)=>{ if(e.target===pinBackdrop) closePin("cancel"); });

let PIN_KEYS_BUILT = false;
let PIN = {
  open:false, resolve:null, reject:null,
  username:"", mode:"login", step:"one",
  pinLen:4, value:"", first:"", submitting:false,
  dotEls:[], payload:null
};
function buildPinKeypadOnce(){
  if(PIN_KEYS_BUILT) return;
  PIN_KEYS_BUILT=true;
  pinKeypad.innerHTML="";
  const keys=["1","2","3","4","5","6","7","8","9","CLEAR","0","‚å´"];
  keys.forEach(k=>{
    const b=document.createElement("button");
    b.type="button";
    b.className="pinKey" + ((k==="CLEAR"||k==="‚å´")?" small":"");
    b.textContent=k;
    b.onclick=()=>onPinKey(k);
    pinKeypad.appendChild(b);
  });
}
function buildDots(n){
  pinDots.innerHTML="";
  PIN.dotEls=[];
  for(let i=0;i<n;i++){
    const d=document.createElement("div");
    d.className="dot";
    pinDots.appendChild(d);
    PIN.dotEls.push(d);
  }
}
function updateDots(){
  const len = PIN.value.length;
  for(let i=0;i<PIN.dotEls.length;i++){
    PIN.dotEls[i].classList.toggle("filled", i < len);
  }
}
function setPinNote(msg,type=""){
  if(type==="error") pinNote.classList.add("error");
  else pinNote.classList.remove("error");
  pinNote.textContent = String(msg||"");
}
function pinErrorPulse(msg){
  PIN.value="";
  updateDots();
  pinDots.classList.add("error");
  pinWrap.classList.remove("shake"); void pinWrap.offsetWidth; pinWrap.classList.add("shake");
  setPinNote(msg||"Sai m·∫≠t kh·∫©u","error");
  setTimeout(()=>{
    pinDots.classList.remove("error");
    pinWrap.classList.remove("shake");
    updatePinHeader();
  },520);
}
function updatePinHeader(){
  const note = (normUsername(PIN.username)==="tuankhoi") ? "T√†i kho·∫£n tuankhoi d√πng m·∫≠t kh·∫©u 6 s·ªë." : "M·∫≠t kh·∫©u ch·ªâ g·ªìm s·ªë.";
  if(PIN.mode==="login"){
    pinTitle.textContent="ƒêƒÉng nh·∫≠p";
    pinDesc.textContent=`Username: ${PIN.username}`;
  }else{
    if(PIN.step==="one"){ pinTitle.textContent="ƒêƒÉng k√Ω"; pinDesc.textContent=`T·∫°o m·∫≠t kh·∫©u ${PIN.pinLen} s·ªë`; }
    else { pinTitle.textContent="X√°c nh·∫≠n m·∫≠t kh·∫©u"; pinDesc.textContent=`Nh·∫≠p l·∫°i ${PIN.pinLen} s·ªë`; }
  }
  setPinNote(note);
}
function openPin({username, mode="login", pinLen=4}){
  return new Promise((resolve,reject)=>{
    PIN.open=true; PIN.resolve=resolve; PIN.reject=reject;
    PIN.username=String(username||"");
    PIN.mode=mode;
    PIN.pinLen=Math.max(4, Number(pinLen)||4);
    PIN.value=""; PIN.first=""; PIN.submitting=false; PIN.payload=null;
    PIN.step = "one";
    buildPinKeypadOnce();
    buildDots(PIN.pinLen);
    updatePinHeader();
    updateDots();
    pinBackdrop.classList.add("show");
    pinBackdrop.setAttribute("aria-hidden","false");
  });
}
function closePin(why){
  if(!PIN.open) return;
  pinBackdrop.classList.remove("show");
  pinBackdrop.setAttribute("aria-hidden","true");
  const rej = PIN.reject;
  const res = PIN.resolve;
  const payload = PIN.payload;
  PIN.open=false; PIN.resolve=null; PIN.reject=null; PIN.payload=null;
  if(why==="ok"){ if(res) res(payload); return; }
  if(rej) rej(new Error("cancel"));
}
async function onPinKey(k){
  if(!PIN.open || PIN.submitting) return;

  if(k==="CLEAR"){ PIN.value=""; updateDots(); return; }
  if(k==="‚å´"){ PIN.value=PIN.value.slice(0,-1); updateDots(); return; }

  if(PIN.value.length>=PIN.pinLen) return;
  PIN.value += String(k);
  updateDots();
  if(PIN.value.length!==PIN.pinLen) return;

  const val = PIN.value;
  if(!/^[0-9]+$/.test(val)){ pinErrorPulse("M·∫≠t kh·∫©u ch·ªâ g·ªìm s·ªë"); return; }

  if(PIN.mode==="login"){
    PIN.submitting=true;
    try{
      setPinNote("ƒêang ki·ªÉm tra‚Ä¶");
      const out = await sbRpc(RPC.login, { p_username: normUsername(PIN.username), p_pin: val });
      if(out && out.ok && out.token){
        PIN.payload = val;
        closePin("ok");
        toast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng");
        await enterAfterAuth(out);
        return;
      }
      pinErrorPulse(out?.error || "Sai m·∫≠t kh·∫©u");
    }catch(e){
      pinErrorPulse("Sai m·∫≠t kh·∫©u");
    }finally{
      PIN.submitting=false;
    }
    return;
  }

  if(PIN.mode==="set"){
    if(PIN.step==="one"){
      PIN.first = val;
      PIN.value = "";
      PIN.step="confirm";
      updatePinHeader();
      updateDots();
      return;
    }else{
      if(PIN.first !== val){
        pinErrorPulse("M·∫≠t kh·∫©u kh√¥ng kh·ªõp");
        PIN.first=""; PIN.step="one";
        updatePinHeader(); updateDots();
        return;
      }
      PIN.payload = val;
      closePin("ok");
      return;
    }
  }
}

/* ================== QUIZ RENDERING ================== */
function renderStart(){
  view.started = false;
  syncActionbar();
  setUserCorner(me);
  updateStats();

  const prevAttempt = bestAttemptIdForResult();
  const hasResult = !!prevAttempt || !!state.finalized;

  const loginNote = QUIZ.require_login
    ? `<div class="muted" style="margin-top:8px;line-height:1.35">B·∫°n ƒëang ƒëƒÉng nh·∫≠p: <b>${escapeHtml(me?.username||"")}</b></div>`
    : `<div class="muted" style="margin-top:8px;line-height:1.35">Quiz n√†y <b>kh√¥ng y√™u c·∫ßu ƒëƒÉng nh·∫≠p</b>. B·∫°n c√≥ th·ªÉ l√†m ngay.</div>`;

  content.innerHTML = `
    <div class="card">
      <div class="row1">
        <p class="vi">S·∫µn s√†ng l√†m b√†i</p>
        <div class="meta"><span class="idx">${escapeHtml(QUIZ.quiz_id||quizId)}</span></div>
      </div>

      ${loginNote}

      <div class="muted" style="margin-top:10px; line-height:1.35">
        T·ªïng s·ªë c√¢u: <b>${QUIZ.items.length}</b>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        ${hasResult ? `<button class="btn btn-ghost" id="btnViewResult" type="button">üìÑ Xem l·∫°i k·∫øt qu·∫£</button>` : ``}
        <button class="btn btn-primary" id="btnGo" type="button">üöÄ V√†o l√†m</button>
      </div>
    </div>
  `;

  document.getElementById("btnGo").onclick = ()=>{
    view.started = true;
    renderQuiz();
    scrollToHashIfAny();
  };
  if(hasResult){
    document.getElementById("btnViewResult").onclick = ()=>goResult();
  }
}

function renderQuiz(){
  view.started = true;
  syncActionbar();
  setUserCorner(me);

  if(!QUIZ.items.length){
    content.innerHTML = `
      <div class="card">
        <div class="row1">
          <p class="vi">Quiz tr·ªëng</p>
          <div class="meta"><span class="idx">EMPTY</span></div>
        </div>
        <div class="muted" style="margin-top:8px">Ch∆∞a c√≥ c√¢u h·ªèi (ho·∫∑c quiz y√™u c·∫ßu login).</div>
      </div>`;
    updateStats();
    return;
  }

  let html = "";
  QUIZ.items.forEach((q, idx)=>{
    const ck = state.checked[q.id];
    const locked = ck && ck.locked;
    const img = String(q.meta?.image_url || q.meta?.image || q.meta?.img || "").trim();
    const t = qTypeOf(q);

    html += `
      <div class="card" id="q${q.id}">
        <div class="row1">
          <p class="vi">C√¢u ${idx+1} <span class="muted">(${escapeHtml(t)})</span></p>
          <div class="meta"><span class="idx">#${idx+1}</span></div>
        </div>

        <div class="qPrompt">${escapeHtml(q.prompt||"")}</div>

        ${img ? `<img class="qImgThumb" data-img="${escapeHtml(img)}" src="${escapeHtml(img)}" alt="image">` : ``}

        ${t==="mcq1" || t==="mcq" ? renderMcq(q, locked) : ``}
        ${t==="essay" ? renderEssay(q, locked) : ``}
        ${t==="short4" ? renderShort4(q, locked) : ``}
        ${t==="tf4" ? renderTf4(q, locked) : ``}

        <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap">
          <button class="btn btn-primary btn-check" data-check="${q.id}" ${locked ? "disabled":""}>${locked?"ƒê√£ check":"Check"}</button>
        </div>

        ${locked ? `
          <div class="resultRow">
            <div>${ck.ok ? `<span class="oktxt">ƒê√öNG</span>` : `<span class="badtxt">SAI</span>`}</div>
            <div><span class="muted">${escapeHtml(ck.expected||"")}</span></div>
          </div>` : ``}
      </div>
    `;
  });

  content.innerHTML = html;
  updateStats();
}

function renderMcq(q, locked){
  const opts = Array.isArray(q.meta?.options) ? q.meta.options : ["","","",""];
  const user = Number(state.answers[q.id] || 0);

  return `
    <div class="optGrid" role="group" aria-label="options">
      ${[0,1,2,3].map(i=>{
        const letter = "ABCD"[i];
        const text = String(opts[i] ?? "");
        const active = (user === (i+1));
        return `
          <button class="optBtn ${active?"active":""}" data-mcq="${q.id}" data-v="${i+1}" ${locked?"disabled":""} type="button">
            <span class="optKey">${letter}</span>${escapeHtml(text)}
          </button>
        `;
      }).join("")}
    </div>
  `;
}
function renderEssay(q, locked){
  const v = String(state.answers[q.id] || "");
  return `
    <div style="margin-top:10px">
      <input class="input ans" data-id="${q.id}" placeholder="Nh·∫≠p ƒë√°p √°n" value="${escapeHtml(v)}" ${locked ? "disabled":""}/>
    </div>
  `;
}
function renderShort4(q, locked){
  const raw = String(state.answers[q.id] || "");
  const chars = [raw[0]||"", raw[1]||"", raw[2]||"", raw[3]||""];
  return `
    <div style="margin-top:10px">
      <div class="muted">Nh·∫≠p 4 √¥ (0-9, d·∫•u -, d·∫•u ,).</div>
      <div class="boxes4">
        ${chars.map((c,i)=>`
          <input class="input boxDigit short4" data-id="${q.id}" data-k="${i}" maxlength="1" inputmode="text"
            value="${escapeHtml(c)}" ${locked?"disabled":""}/>
        `).join("")}
      </div>
    </div>
  `;
}
function renderTf4(q, locked){
  const stmts = Array.isArray(q.meta?.statements) ? q.meta.statements : ["","","",""];
  const user = Array.isArray(state.answers[q.id]) ? state.answers[q.id] : [false,false,false,false];

  return `
    <div class="tfList">
      ${[0,1,2,3].map(i=>{
        const s = String(stmts[i]||"").trim();
        return `
          <div class="tfRow">
            <div class="tfTop">
              <div class="tfStmt"><b>${"ABCD"[i]}.</b> ${escapeHtml(s || "(tr·ªëng)")}</div>
              <div class="tfBtns">
                <button class="tfBtn ${user[i]===true?"active":""}" data-tf="${q.id}" data-k="${i}" data-v="1" ${locked?"disabled":""} type="button">ƒê√∫ng</button>
                <button class="tfBtn ${user[i]===false?"active":""}" data-tf="${q.id}" data-k="${i}" data-v="0" ${locked?"disabled":""} type="button">Sai</button>
              </div>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

function scrollToHashIfAny(){
  const h = (location.hash||"").trim();
  if(!h || h.length<2) return;
  const el = document.querySelector(h);
  if(!el) return;
  setTimeout(()=>{
    try{ el.scrollIntoView({ behavior:"smooth", block:"start" }); }catch{}
  }, 80);
}

/* ================== EVENTS ================== */
content.addEventListener("click", (e)=>{
  const img = e.target.closest("[data-img]");
  if(img){
    openImg(img.getAttribute("data-img"));
    return;
  }

  const mcq = e.target.closest("[data-mcq]");
  if(mcq){
    const id = Number(mcq.getAttribute("data-mcq"));
    const v = Number(mcq.getAttribute("data-v"));
    state.answers[id] = v;
    saveLocalProgress();
    renderQuiz();
    return;
  }

  const tf = e.target.closest("[data-tf]");
  if(tf){
    const id = Number(tf.getAttribute("data-tf"));
    const k = Number(tf.getAttribute("data-k"));
    const v = (tf.getAttribute("data-v")==="1");
    const cur = Array.isArray(state.answers[id]) ? state.answers[id].slice(0,4) : [false,false,false,false];
    cur[k] = v;
    state.answers[id] = cur;
    saveLocalProgress();
    renderQuiz();
    return;
  }

  const b = e.target.closest("[data-check]");
  if(!b) return;

  const id = Number(b.dataset.check);
  const q = QUIZ.items.find(x=>Number(x.id)===id);
  if(!q) return;

  if(!isAnswered(q)){
    toast("Ch∆∞a l√†m c√¢u n√†y");
    return;
  }

  const g = gradeOne(q);
  state.checked[id] = { ok: !!g.ok, expected: String(g.expected||""), locked:true };
  saveLocalProgress();
  toast(g.ok ? "ƒê√öNG" : "SAI");
  renderQuiz();
});

content.addEventListener("input", (e)=>{
  const t = e.target;
  if(!t) return;

  if(t.classList && t.classList.contains("ans")){
    const id = Number(t.dataset.id);
    const ck = state.checked[id];
    if(ck && ck.locked){
      t.value = String(state.answers[id]||"");
      return;
    }
    state.answers[id] = String(t.value||"");
    saveLocalProgress();
    updateStats();
    return;
  }

  if(t.classList && t.classList.contains("short4")){
    const id = Number(t.getAttribute("data-id"));
    const k = Number(t.getAttribute("data-k"));

    const ck = state.checked[id];
    if(ck && ck.locked){
      renderQuiz();
      return;
    }

    let v = String(t.value||"");
    v = v.replace(/[^0-9\-,]/g,"").slice(0,1);
    if(t.value !== v) t.value = v;

    const raw = String(state.answers[id] || "____");
    const arr = [raw[0]||"", raw[1]||"", raw[2]||"", raw[3]||""];
    arr[k] = v || "";
    state.answers[id] = arr.join("");
    saveLocalProgress();
    updateStats();
    return;
  }
}, {passive:true});

btnScrollTop.onclick = ()=>{ document.getElementById("shell").scrollTo({ top:0, behavior:"smooth" }); };
btnHome.onclick = ()=>goHome();

/* reset modal */
const resetBackdrop = document.getElementById("resetBackdrop");
btnReset.onclick = ()=>{ resetBackdrop.classList.add("show"); resetBackdrop.setAttribute("aria-hidden","false"); };
document.getElementById("btnCancelReset").onclick = ()=>{ resetBackdrop.classList.remove("show"); resetBackdrop.setAttribute("aria-hidden","true"); };
resetBackdrop.addEventListener("click",(e)=>{ if(e.target===resetBackdrop){ resetBackdrop.classList.remove("show"); resetBackdrop.setAttribute("aria-hidden","true"); }});
document.getElementById("btnConfirmReset").onclick = ()=>{
  resetBackdrop.classList.remove("show");
  resetBackdrop.setAttribute("aria-hidden","true");
  hardResetProgressLocal();
  toast("ƒê√£ l√†m l·∫°i");
  if(view.started) renderQuiz(); else updateStats();
};

/* ================== SUBMIT CONFIRM MODAL ================== */
const submitBackdrop = document.getElementById("submitBackdrop");
const submitBody = document.getElementById("submitBody");
document.getElementById("btnCancelSubmit").onclick = ()=>closeSubmitConfirm(false);
document.getElementById("btnConfirmSubmit").onclick = ()=>closeSubmitConfirm(true);
submitBackdrop.addEventListener("click",(e)=>{ if(e.target===submitBackdrop) closeSubmitConfirm(false); });

let SUBMIT_PROMPT = { open:false, resolve:null };
function openSubmitConfirm(htmlBody){
  return new Promise((resolve)=>{
    SUBMIT_PROMPT.open = true;
    SUBMIT_PROMPT.resolve = resolve;
    submitBody.innerHTML = htmlBody || `<p>B·∫°n c√≥ mu·ªën n·ªôp b√†i kh√¥ng?</p>`;
    submitBackdrop.classList.add("show");
    submitBackdrop.setAttribute("aria-hidden","false");
  });
}
function closeSubmitConfirm(ans){
  if(!SUBMIT_PROMPT.open) return;
  submitBackdrop.classList.remove("show");
  submitBackdrop.setAttribute("aria-hidden","true");
  const r = SUBMIT_PROMPT.resolve;
  SUBMIT_PROMPT.open=false;
  SUBMIT_PROMPT.resolve=null;
  if(r) r(!!ans);
}
function getMissingItems(){
  const miss = [];
  QUIZ.items.forEach((q, idx)=>{
    if(!isAnswered(q)) miss.push({ idx: idx+1, id: q.id });
  });
  return miss;
}

function computeFinal(){
  let earned = 0;
  let max = 0;
  let fullCorrectCount = 0;

  const per = [];
  for(const q of QUIZ.items){
    const g = gradeOne(q);
    max += g.max;
    earned += g.earned;
    if(g.ok) fullCorrectCount++;

    state.checked[q.id] = { ok: !!g.ok, expected: String(g.expected||""), locked:true };

    per.push({ id:q.id, no:q.no, q_type:q.q_type, ok:!!g.ok, earned:g.earned, max:g.max });
  }

  const score10 = max > 0 ? Math.round((earned/max*10)*10)/10 : 0;
  return { score10, earned, max, fullCorrectCount, totalCount: QUIZ.items.length, per };
}

/* attempts insert: n·∫øu b·ªã RLS ch·∫∑n th√¨ v·∫´n nh·∫£y result b·∫±ng sessionStorage */
async function submitToSupabase(result){
  if(!me || !me.user_id) throw new Error("need login");

  const attemptBody = {
    quiz_id: quizId,
    user_id: me.user_id,
    score10: Number(result.score10||0),
    correct_count: Number(result.fullCorrectCount||0),
    total_count: Number(result.totalCount||0),
    details_json: {
      client: "q/index.html",
      ts: Date.now(),
      mode: "questions",
      quiz_id: quizId,
      earned: result.earned,
      max: result.max,
      per: result.per,
      answers: state.answers || {},
      questions: QUIZ.items.map(q=>({ id:q.id, no:q.no, q_type:q.q_type, prompt:q.prompt, points:q.points, meta:q.meta }))
    }
  };

  const inserted = await sbPost(`attempts?select=attempt_id,created_at`, attemptBody, { preferReturn:true });
  const row = Array.isArray(inserted) ? inserted[0] : inserted;
  const attemptId = row?.attempt_id;
  if(!attemptId) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c attempt_id");
  return attemptId;
}

async function doSubmitNow(){
  if(state.finalized) return;
  if(!view.started){ toast("Ch∆∞a v√†o l√†m"); return; }

  if(QUIZ.require_login && (!me || !me.user_id)){
    toast("Quiz n√†y c·∫ßn ƒëƒÉng nh·∫≠p");
    renderGate();
    return;
  }

  state.finalized = true;

  renderLoading("ƒêang t√≠nh ƒëi·ªÉm‚Ä¶");
  const result = computeFinal();
  saveLocalProgress();

  // show locked UI
  renderQuiz();

  let attemptId = "";
  try{
    attemptId = await submitToSupabase(result);
    state.attempt_id = attemptId;
    saveLocalProgress();
  }catch(_e){
    toast("Kh√¥ng l∆∞u DB (xem k·∫øt qu·∫£ v·∫´n OK)");
  }

  try{
    sessionStorage.setItem(`tk_last_result::${quizId}`, JSON.stringify({
      quiz_id: quizId,
      title: QUIZ.title,
      sub: QUIZ.sub,
      me: me ? { username: me.username, role: me.role, user_id: me.user_id } : null,
      attempt_id: attemptId || "",
      result,
      ts: Date.now()
    }));
  }catch{}

  const qs = new URLSearchParams();
  qs.set("quiz", quizId);
  if(attemptId) qs.set("attempt", attemptId);
  location.href = `/result.html?${qs.toString()}`;
}

btnSubmit.onclick = async ()=>{
  if(state.finalized) return;
  if(!view.started){ toast("Ch∆∞a v√†o l√†m"); return; }

  if(QUIZ.require_login && (!me || !me.user_id)){
    toast("Quiz n√†y c·∫ßn ƒëƒÉng nh·∫≠p");
    renderGate();
    return;
  }

  const miss = getMissingItems();
  const missCount = miss.length;

  let body = "";
  if(missCount === 0){
    body = `<p><b>B·∫°n c√≥ mu·ªën n·ªôp b√†i kh√¥ng?</b></p>`;
  }else if(missCount < 5){
    const lis = miss.map(x=>`<li><b>C√¢u ${x.idx}</b></li>`).join("");
    body = `<p><b>B·∫°n ch∆∞a l√†m c√°c c√¢u sau:</b></p><ul class="missList">${lis}</ul><p>B·∫°n v·∫´n mu·ªën n·ªôp ch·ª©?</p>`;
  }else{
    body = `<p><b>B·∫°n ch∆∞a l√†m ${missCount} c√¢u.</b></p><p>X√°c nh·∫≠n n·ªôp b√†i?</p>`;
  }

  const ok = await openSubmitConfirm(body);
  if(!ok) return;
  await doSubmitNow();
};

/* ================== AUTH + LOAD QUIZ ================== */
async function loadMeIfAny(){
  const token = getToken();
  if(!token) return null;
  try{
    const out = await sbRpc(RPC.me, { p_token: token });
    if(!out || out.ok!==true) throw new Error(out?.error || "me fail");
    const m = out.me || out.user || out.data || null;
    if(m && m.id && !m.user_id) m.user_id = m.id;
    return m;
  }catch(_e){
    clearAuthLocal();
    return null;
  }
}

async function loadQuiz(){
  const token = getToken() || "";
  const out = await sbRpc(RPC.getQuiz, { p_quiz_id: quizId, p_token: token, p_access_code: "" });

  if(!out || out.ok !== true) throw new Error(out?.error || "Kh√¥ng t·∫£i ƒë∆∞·ª£c quiz");

  const q = out.quiz || {};
  const items = Array.isArray(out.items) ? out.items : [];

  return {
    quiz_id: q.quiz_id || quizId,
    title: q.title || "Quiz",
    sub: q.sub || "",
    require_login: (q.require_login !== false),
    require_access_code: !!q.require_access_code,
    login_required: !!out.login_required,
    access_code_required: !!out.access_code_required,
    items: items.map(x=>({
      id: Number(x.id),
      no: x.no,
      q_type: String(x.q_type || "essay"),
      prompt: String(x.prompt || ""),
      answers: Array.isArray(x.answers) ? x.answers : [],
      points: x.points ?? 1,
      meta: (x.meta && typeof x.meta === "object") ? x.meta : {}
    }))
  };
}

async function enterAfterAuth(out){
  const token = out?.token || "";
  if(token) setToken(token);

  let m = out?.me || out?.user || out?.data || null;
  if(m && m.id && !m.user_id) m.user_id = m.id;

  if(!m || !m.user_id){
    const m2 = await loadMeIfAny();
    if(m2) m = m2;
  }

  if(m && m.user_id){
    me = m;
    setMeCache(m);
    setNameCache(me.username || "");
    setUserCorner(me);

    // reload quiz ƒë·ªÉ l·∫•y items n·∫øu require_login
    try{
      QUIZ = await loadQuiz();
      quizTitleEl.textContent = QUIZ.title || "Quiz";
      quizSubEl.textContent = QUIZ.sub || "";
    }catch(e){
      renderLoading("L·ªói t·∫£i ƒë·ªÅ: " + (e?.message || e));
      return;
    }

    renderStart();
    updateStats();
  }else{
    toast("Kh√¥ng l·∫•y ƒë∆∞·ª£c user");
    renderGate();
  }
}

/* ================== Profile modal ================== */
const profileBackdrop = document.getElementById("profileBackdrop");
document.getElementById("btnCloseProfile").onclick = ()=>closeProfileModal();
profileBackdrop.addEventListener("click",(e)=>{ if(e.target===profileBackdrop) closeProfileModal(); });
document.getElementById("btnProfileHome").onclick = ()=>goHome();
document.getElementById("btnLogout").addEventListener("click", ()=>{
  clearAuthLocal();
  me = null;
  view.started = false;
  setUserCorner(null);
  closeProfileModal();
  toast("ƒê√£ ƒëƒÉng xu·∫•t");
  if(QUIZ.require_login) renderGate(); else renderStart();
  updateStats();
});
function openProfileModal(){
  if(!me || !me.username) return;
  document.getElementById("profileUsername").textContent = me.username;
  document.getElementById("profileRole").textContent = isAdminUser(me) ? "ADMIN" : "USER";
  profileBackdrop.classList.add("show");
  profileBackdrop.setAttribute("aria-hidden","false");
}
function closeProfileModal(){
  profileBackdrop.classList.remove("show");
  profileBackdrop.setAttribute("aria-hidden","true");
}
userCorner.addEventListener("click", ()=>{ if(me) openProfileModal(); });

/* ================== BOOT ================== */
(async function boot(){
  if(!quizId || quizId.length!==5){
    renderLoading("Thi·∫øu quiz_id. M·ªü ƒë√∫ng d·∫°ng: /q/index.html?quiz=abcde  (ho·∫∑c /q/abcde)");
    return;
  }

  renderLoading("ƒêang t·∫£i quiz‚Ä¶");

  if(FLAG_RESTART){
    hardResetProgressLocal();
    dropFlagsFromUrl();
  }else{
    loadLocalProgress();
  }

  // restore me/token
  me = getMeCache();
  if(me && me.id && !me.user_id) me.user_id = me.id;
  if(getToken() && (!me || !me.user_id)){
    const m2 = await loadMeIfAny();
    if(m2){ me = m2; setMeCache(me); }
  }

  // load quiz (d√πng token n·∫øu c√≥)
  try{
    QUIZ = await loadQuiz();
    quizTitleEl.textContent = QUIZ.title || "Quiz";
    quizSubEl.textContent = QUIZ.sub || "";
  }catch(e){
    renderLoading("L·ªói t·∫£i ƒë·ªÅ: " + (e?.message || e));
    return;
  }

  updateStats();

  // ‚úÖ y√™u c·∫ßu c·ªßa b·∫°n:
  // - quiz kh√¥ng require_login => KH√îNG hi·ªán m√†n login
  if(!QUIZ.require_login){
    if(me && me.user_id) setUserCorner(me); else setUserCorner(null);

    if(FLAG_START && !state.finalized){
      dropFlagsFromUrl();
      view.started = true;
      renderQuiz();
      scrollToHashIfAny();
    }else{
      renderStart();
    }
    return;
  }

  // quiz require_login
  if(me && me.user_id){
    setUserCorner(me);
    renderStart();
  }else{
    setUserCorner(null);
    renderGate();
  }
})();
</script>
