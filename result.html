<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>K·∫øt qu·∫£</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#ffecd2; --bg2:#fcb69f;
      --card:#fff; --text:#1f2937; --muted:#6b7280;
      --primary:#7c3aed; --ok:#16a34a; --bad:#dc2626; --warn:#f59e0b;
      --border:#e5e7eb; --soft:#f8fafc;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --radius:18px;

      --admin:#2563eb;
      --pin:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0;
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
                  linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 100%);
      overflow:hidden;
      touch-action:pan-x pan-y;
    }

    #shell{height:100vh;overflow:auto;-webkit-overflow-scrolling:touch;padding:12px 0 140px}
    .wrap{max-width:980px;margin:0 auto;padding:0 14px}

    .actionbar{
      position: sticky; top: 10px; z-index: 9999;
      display:flex; justify-content:flex-end; gap:10px; padding:0 14px;
      flex-wrap:wrap;
    }
    .btn{
      border:0; cursor:pointer;
      border-radius:999px; padding:10px 14px;
      font-weight:900; font-size:.9rem;
      transition:transform .16s ease, filter .16s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none; white-space:nowrap;
      box-shadow:0 12px 24px rgba(0,0,0,.12);
      background:#fff; color:#111827; border:1px solid #e5e7eb;
      text-decoration:none;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(.98)}
    .btn:active{transform:translateY(0)}
    .btn-reset{background:#111827;color:#fff;border:0}
    .btn-primary{
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      color:#fff;border:0;
      box-shadow:0 12px 24px rgba(124,58,237,.18);
    }

    .topbar{
      margin-top:10px;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(229,231,235,.9);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .titlebox{display:flex;gap:10px;align-items:center;flex:1 1 360px;min-width:240px}
    .logo{
      width:42px;height:42px;border-radius:16px;
      background:linear-gradient(135deg,#a78bfa,#fb7185);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;
      box-shadow:0 10px 22px rgba(124,58,237,.18);
      user-select:none;
    }
    .titles h1{font-size:1.02rem;margin:0;font-weight:800}
    .titles .tiny{margin-top:3px;font-size:.86rem;color:var(--muted);font-weight:650}

    .stats{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{
      background:#f3f4f6;border:1px solid #e5e7eb;
      border-radius:999px;padding:8px 12px;
      font-weight:800;font-size:.9rem;color:#374151;white-space:nowrap;
      display:inline-flex;gap:6px;align-items:center;
    }
    .pill strong{color:var(--primary)}
    .progressline{
      height:10px;border-radius:999px;background:#f3f4f6;overflow:hidden;
      border:1px solid #e5e7eb;width:100%;max-width:360px;
    }
    .progressfill{
      height:100%;width:0%;
      background:linear-gradient(90deg,#22c55e,#a78bfa);
      transition:width .25s ease;
    }

    .content{padding:12px 0 0}

    .card{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;margin:12px 0;
    }
    .row1{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .vi{margin:0;font-weight:900;font-size:1.04rem;line-height:1.25}
    .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .idx{
      font-size:.78rem;font-weight:900;
      padding:6px 10px;border-radius:999px;
      background:#eff6ff;color:#1d4ed8;border:1px solid #dbeafe;white-space:nowrap;
    }
    .muted{color:var(--muted);font-weight:650}
    .oktxt{color:var(--ok);font-weight:900}
    .badtxt{color:var(--bad);font-weight:900}

    .scoreHero{
      display:grid; gap:10px;
      align-items:center; justify-items:center;
      padding:10px 8px 6px; text-align:center;
    }
    .scoreBig{
      font-weight:1000;
      font-size:3.1rem;
      line-height:1;
      letter-spacing:-0.02em;
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-shadow:0 14px 40px rgba(124,58,237,.14);
    }
    .scoreSub{
      font-weight:900;
      font-size:1.05rem;
      color:#111827;
    }
    .scoreMeta{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    }

    .resultline{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px dashed #e5e7eb;
      background:#fff;
      font-weight:750;
      line-height:1.35;
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      border:1px solid #e5e7eb;
      background:#fff;
    }
    .table th,.table td{
      padding:10px 10px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
      font-weight:750;
      font-size:.92rem;
    }
    .table th{background:#f8fafc;font-weight:900}
    .table tr:last-child td{border-bottom:0}

    .rankpill{
      display:inline-flex; align-items:center; gap:8px;
      border-radius:999px; padding:6px 10px;
      font-weight:950; font-size:.86rem;
      border:1px solid #e5e7eb;
      background:#fff;
      white-space:nowrap;
    }
    .medal{
      width:22px;height:22px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:.9rem;color:#111827;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 10px 22px rgba(0,0,0,.10);
    }
    .m1{background:linear-gradient(135deg,#fde68a,#f59e0b)}
    .m2{background:linear-gradient(135deg,#e2e8f0,#94a3b8)}
    .m3{background:linear-gradient(135deg,#fdba74,#d97706)}
    .toprow1 td{background:rgba(245,158,11,.10)}
    .toprow2 td{background:rgba(148,163,184,.12)}
    .toprow3 td{background:rgba(217,119,6,.10)}

    .meRow td{
      background:rgba(124,58,237,.12)!important;
      border-top:1px solid rgba(124,58,237,.25);
      border-bottom:1px solid rgba(124,58,237,.25);
    }
    .meRow td:first-child{border-left:6px solid rgba(124,58,237,.55)}
    .meName{font-weight:1000;letter-spacing:.01em}
    .meBadge{
      margin-left:8px;
      padding:4px 8px;border-radius:999px;
      font-weight:900;font-size:.78rem;
      background:rgba(124,58,237,.14);
      border:1px solid rgba(124,58,237,.35);
      color:#4c1d95;
      white-space:nowrap;
    }

    .toast{
      position:fixed; left:50%; bottom:88px; transform:translateX(-50%);
      background:rgba(17,24,39,.92); color:#fff;
      padding:10px 12px; border-radius:14px;
      font-weight:800; font-size:.9rem;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width:calc(100% - 28px);
      z-index:10003;
      text-align:center;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}

    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:10001;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      width:100%; max-width:520px;
      background:#fff;
      border-radius:18px;
      border:1px solid #e5e7eb;
      box-shadow:0 20px 60px rgba(0,0,0,.18);
      padding:14px;
      max-height:82vh;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .modal h3{margin:4px 0 6px;font-size:1.02rem}
    .modal p{margin:0 0 12px;color:var(--muted);font-weight:650;font-size:.92rem;line-height:1.35}

    .xclose{
      position:sticky; top:0;
      display:flex; justify-content:flex-end;
      z-index:2; margin-bottom:4px;
    }
    .btn-x{
      width:56px;height:56px;
      border-radius:16px;
      border:1px solid #e5e7eb;
      background:#fff;
      cursor:pointer;
      font-weight:1000;
      font-size:1.8rem;
      line-height:1;
      box-shadow:0 12px 24px rgba(0,0,0,.10);
    }
    .btn-x:hover{filter:brightness(.98);transform:translateY(-1px)}
    .btn-x:active{transform:translateY(0)}

    .input{
      width:100%;
      border-radius:14px;border:2px solid #e5e7eb;
      padding:11px 12px;font-size:.95rem;font-weight:700;
      outline:none;background:var(--soft);
      transition:border-color .15s ease, box-shadow .15s ease;
      font-family:inherit;
      color:#111827;
    }
    .input:focus{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 0 0 5px rgba(124,58,237,.10);
      background:#fff;
    }

    .cmtBox{display:grid;gap:12px;margin-top:10px}
    .cmtItem{border:1px solid #e5e7eb;border-radius:16px;padding:12px;background:#fff}
    .cmtHead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .cmtAuthor{font-weight:950;color:#6b7280;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .adminBadgeInline{
      padding:4px 8px;border-radius:999px;font-weight:950;font-size:.78rem;
      background:rgba(37,99,235,.12);border:1px solid rgba(37,99,235,.35);color:var(--admin);white-space:nowrap;
    }
    .pinBadgeInline{
      padding:4px 8px;border-radius:999px;font-weight:950;font-size:.78rem;
      background:rgba(245,158,11,.14);border:1px solid rgba(245,158,11,.35);color:#92400e;white-space:nowrap;
    }
    .cmtText{color:#111827;font-weight:750;line-height:1.35;white-space:pre-wrap;word-break:break-word}
    .cmtActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;justify-content:flex-end}
    .cmtBtn{
      border-radius:999px;padding:7px 10px;font-weight:900;
      border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-size:.82rem;
    }
    .cmtBtnDanger{background:rgba(220,38,38,.1);border-color:rgba(220,38,38,.25);color:#991b1b}
    .cmtBtnPin{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35);color:#92400e}
    .cmtTime{margin-top:6px;text-align:right;color:#6b7280;font-weight:800;font-size:.82rem}
    .replyWrap{margin-top:10px;margin-left:14px;padding-left:12px;border-left:6px solid #e5e7eb;display:grid;gap:10px}
    .replyForm{margin-left:14px;padding-left:12px;border-left:6px solid #e5e7eb;margin-top:10px;display:grid;gap:10px}
    .charRow{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:#6b7280;font-weight:800;font-size:.85rem}

    .miniLink{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#fff;
      font-weight:900;
      font-size:.82rem;
      color:#111827;
      text-decoration:none;
      box-shadow:0 10px 22px rgba(0,0,0,.08);
    }
    .miniLink:hover{filter:brightness(.98);transform:translateY(-1px)}
    .miniLink:active{transform:translateY(0)}

    @media (max-width:820px){
      .progressline{max-width:100%}
      .btn{padding:9px 12px;font-size:.85rem}
      .scoreBig{font-size:2.8rem}
    }
  </style>
</head>

<body>
  <div id="shell">
    <div class="actionbar">
      <a class="btn" id="btnHome" href="https://www.tuankhoi.site" rel="noopener">Trang ch·ªß</a>
      <button class="btn" id="btnScrollTop" type="button">‚¨ÜÔ∏è L√™n ƒë·∫ßu</button>
      <button class="btn btn-reset" id="btnRestart" type="button">üîÅ L√†m l·∫°i</button>
      <button class="btn btn-primary" id="btnDiscuss" type="button">üí¨ Th·∫£o lu·∫≠n</button>
    </div>

    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">RS</div>
          <div class="titles">
            <h1 id="quizTitle">K·∫øt qu·∫£</h1>
            <div class="tiny" id="quizSub"></div>
          </div>
        </div>

        <div class="stats">
          <div class="pill">Ng∆∞·ªùi l√†m: <strong id="whoName">‚Äî</strong></div>
          <div class="pill">ƒê√∫ng: <strong id="answeredCount">0</strong>/<span id="totalCount">0</span></div>
          <div class="progressline"><div class="progressfill" id="progressFill"></div></div>
        </div>
      </div>

      <div class="content" id="content">
        <div id="summary" class="card"></div>
        <div id="wrongCard" class="card" style="display:none; cursor:pointer;"></div>
        <div id="lb" class="card"></div>
        <div id="discussionAnchor" style="height:1px;"></div>
        <div id="discussion" class="card"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal-backdrop" id="wrongBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wrongTitle">
      <div class="xclose">
        <button class="btn-x" id="btnCloseWrong" aria-label="ƒê√≥ng">‚úï</button>
      </div>
      <h3 id="wrongTitle">Nh·ªØng c√¢u sai</h3>
      <p>Li·ªát k√™ c√¢u b·∫°n l√†m sai ho·∫∑c ch∆∞a ch·ªçn.</p>
      <div id="wrongBody" style="display:grid; gap:12px;"></div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
const SUPABASE_URL = "https://aidvlydhbdtwunyreqak.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZHZseWRoYmR0d3VueXJlcWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzM5NzYsImV4cCI6MjA4NDIwOTk3Nn0.LMKGjKlUbC5qoY7hqDpaDFQrFWfwKemBTpxjTNp_L8o";

const RPC = {
  me: "api_me",
  quizMeta: "api_get_quiz_meta",
  attemptPublic: "api_get_attempt_public",
  leaderboard: "api_get_leaderboard",
  pinComment: "api_toggle_comment_pin",
  questionsPublic: "api_get_questions_public"
};

const TOKEN_KEY = "tk_token_v2";
const NAME_KEY  = "tk_display_name_v1";

/* ===== helpers ===== */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = String(msg||"");
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1400);
}
function escapeHtml(s) {
  return String(s ?? "")
    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;").replace(/'/g, "&#39;");
}
function loadName(){ try { return (localStorage.getItem(NAME_KEY)||"").trim(); } catch { return ""; } }
function getToken(){ try { return (localStorage.getItem(TOKEN_KEY)||"").trim(); } catch { return ""; } }

function sbHeaders(){
  const anon = String(SUPABASE_ANON_KEY||"").trim();
  return {
    "apikey": anon,
    "Authorization": "Bearer " + anon,
    "Content-Type": "application/json"
  };
}
async function sbRpc(fn, args){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{
    method:"POST",
    headers: sbHeaders(),
    body: JSON.stringify(args||{})
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "RPC error");
  }
  return data;
}
async function sbGet(path){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{ headers: sbHeaders() });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST GET error");
  }
  return data;
}
async function sbPost(path, body, { preferReturn=true } = {}){
  const h = sbHeaders();
  if(preferReturn) h["Prefer"]="return=representation";
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{
    method:"POST",
    headers: h,
    body: JSON.stringify(body||{})
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST POST error");
  }
  return data;
}
async function sbDelete(path){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{
    method:"DELETE",
    headers: sbHeaders()
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST DELETE error");
  }
  return data;
}

function toMs(ts){
  const d = new Date(ts);
  const t = d.getTime();
  return isFinite(t) ? t : 0;
}
function fmtTs(ts){
  try{
    const d = ts ? new Date(ts) : new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}, ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)}`;
  }catch{ return ""; }
}

/* ================== URL / STATE ================== */
const qs = new URLSearchParams(location.search);
const quizId = String(qs.get("quiz")||"").toLowerCase().replace(/[^a-z]/g,"").slice(0,5);
const attemptId = String(qs.get("attempt")||"").trim();

const PROGRESS_KEY = `tk_progress::${quizId}`;
function clearForRestart(){
  try{ localStorage.removeItem(PROGRESS_KEY); }catch{}
  try{ sessionStorage.removeItem(`tk_last_result::${quizId}`); }catch{}
}

/* ================== ACTION BUTTONS ================== */
const shell = document.getElementById("shell");
document.getElementById("btnScrollTop").addEventListener("click", ()=> shell.scrollTo({ top:0, behavior:"smooth" }));
document.getElementById("btnDiscuss").addEventListener("click", ()=>{
  const a = document.getElementById("discussionAnchor");
  if(a) a.scrollIntoView({ behavior:"smooth", block:"start" });
});
document.getElementById("btnRestart").addEventListener("click", ()=>{
  if(!quizId){ location.href = "/"; return; }
  clearForRestart();
  location.href = `/q/index.html?quiz=${quizId}&restart=1&start=1`;
});

/* ================== WRONG MODAL ================== */
let CURRENT_WRONG_LIST = [];

const wrongBackdrop = document.getElementById("wrongBackdrop");
const wrongBody = document.getElementById("wrongBody");
const btnCloseWrong = document.getElementById("btnCloseWrong");

function openWrongPopup(){
  renderWrongPopupContent(CURRENT_WRONG_LIST);
  wrongBackdrop.classList.add("show");
  wrongBackdrop.setAttribute("aria-hidden","false");
}
function closeWrongPopup(){
  wrongBackdrop.classList.remove("show");
  wrongBackdrop.setAttribute("aria-hidden","true");
}
btnCloseWrong.addEventListener("click", closeWrongPopup);
wrongBackdrop.addEventListener("click", (e)=>{ if(e.target === wrongBackdrop) closeWrongPopup(); });
document.addEventListener("keydown",(e)=>{ if(e.key === "Escape") closeWrongPopup(); });

function renderWrongPopupContent(list){
  const arr = Array.isArray(list) ? list : [];
  CURRENT_WRONG_LIST = arr;
  wrongBody.innerHTML = "";

  if(!arr.length){
    wrongBody.innerHTML = `<div class="resultline"><span class="oktxt">B·∫°n kh√¥ng sai c√¢u n√†o ‚úÖ</span></div>`;
    return;
  }

  arr.forEach((w,i)=>{
    const word = w.word || "(?)";
    const u = (w.user_answer ?? w.user ?? "").toString().trim();
    const ex = (w.expected ?? "").toString().trim();
    const jump = (quizId && w.id) ? `/q/index.html?quiz=${quizId}&start=1#q${encodeURIComponent(String(w.id))}` : "";

    const box = document.createElement("div");
    box.className = "resultline";
    box.innerHTML = `
      <div><b>C√¢u ${i+1}.</b> ${escapeHtml(word)}</div>
      <div style="margin-top:6px"><span class="badtxt">SAI ‚ùå</span></div>
      <div style="margin-top:6px"><span class="muted">B·∫°n tr·∫£ l·ªùi:</span> <b>${escapeHtml(u||"(tr·ªëng)")}</b></div>
      <div style="margin-top:4px"><span class="muted">ƒê√°p √°n/ghi ch√∫:</span> <b>${escapeHtml(ex||"(?)")}</b></div>
      ${jump ? `<div style="margin-top:10px; display:flex; justify-content:flex-end;">
        <a class="miniLink" href="${jump}">M·ªü ƒë√∫ng c√¢u n√†y</a>
      </div>` : ``}
    `;
    wrongBody.appendChild(box);
  });
}

/* ================== UI RENDER ================== */
function setTopbar({title, sub, username, correctCount, totalCount, progressPercent}){
  document.getElementById("quizTitle").textContent = title || "K·∫øt qu·∫£";
  document.getElementById("quizSub").textContent = sub || "";
  document.getElementById("whoName").textContent = username || "‚Äî";
  document.getElementById("answeredCount").textContent = String(Number(correctCount||0));
  document.getElementById("totalCount").textContent = String(Number(totalCount||0));
  document.getElementById("progressFill").style.width = `${Math.max(0, Math.min(100, Number(progressPercent||0)))}%`;
}

function renderSummaryCard({ score10, correctCount, totalCount, wrongCount, recomputeNote }){
  const sum = document.getElementById("summary");
  const pct = totalCount ? (Number(correctCount||0)/Number(totalCount||0))*100 : (Number(score10||0)*10);
  const pctInt = isFinite(pct) ? Math.round(pct) : 0;

  sum.innerHTML = `
    <div class="row1">
      <p class="vi">K·∫øt qu·∫£</p>
      <div class="meta"><span class="idx">ƒê√É SUBMIT</span></div>
    </div>

    <div class="scoreHero">
      <div class="scoreBig">${pctInt}%</div>
      <div class="scoreSub">= ${Number(score10||0).toFixed(1)} ƒëi·ªÉm (thang 10)</div>

      <div class="scoreMeta">
        <div class="pill">ƒê√∫ng: <strong>${Number(correctCount||0)}</strong>/${Number(totalCount||0)}</div>
        <div class="pill">Sai: <strong>${Number(wrongCount||0)}</strong></div>
      </div>

      ${recomputeNote ? `<div class="resultline" style="margin-top:0">${recomputeNote}</div>` : ``}
    </div>
  `;
}

function renderWrongCard(wrongCount){
  const wc = Number(wrongCount||0);
  const card = document.getElementById("wrongCard");
  if(wc <= 0){
    card.style.display = "none";
    return;
  }
  card.style.display = "";
  card.innerHTML = `
    <div class="row1">
      <p class="vi">Nh·ªØng c√¢u sai</p>
      <div class="meta"><span class="idx">${wc} c√¢u</span></div>
    </div>
    <div class="muted" style="margin-top:6px">B·∫•m v√†o ƒë√¢y ƒë·ªÉ xem chi ti·∫øt c√¢u sai.</div>
  `;
  card.onclick = ()=> openWrongPopup();
}

function renderLeaderboard(rows, myUserId){
  const lb = document.getElementById("lb");
  const arr = Array.isArray(rows) ? rows : [];

  if(!arr.length){
    lb.innerHTML = `
      <div class="row1">
        <p class="vi">B·∫£ng x·∫øp h·∫°ng</p>
        <div class="meta"><span class="idx">TOP</span></div>
      </div>
      <div class="muted" style="margin-top:6px">
        Ch∆∞a c√≥ d·ªØ li·ªáu. (N·∫øu b·∫°n ƒë√£ l√†m m√† v·∫´n tr·ªëng: ki·ªÉm tra l·∫°i RPC <b>api_get_leaderboard</b> v√† RLS.)
      </div>
    `;
    return;
  }

  const maxRows = 30;
  const top = arr.slice(0, maxRows);

  const myIndex = myUserId ? top.findIndex(r => String(r.user_id) === String(myUserId)) : -1;
  const myRankLine = (myIndex >= 0)
    ? `<div class="resultline" style="margin-top:0"><b>V·ªã tr√≠ c·ªßa b·∫°n:</b> B·∫°n ƒëang ·ªü h·∫°ng <b>#${myIndex+1}</b> trong b·∫£ng ƒëang hi·ªÉn th·ªã.</div>`
    : `<div class="resultline" style="margin-top:0">B·∫°n ch∆∞a n·∫±m trong top ƒëang hi·ªÉn th·ªã.</div>`;

  const body = top.map((r, index)=>{
    const rk = index + 1;
    const medal = rk === 1 ? `<span class="medal m1">ü•á</span>` :
                  rk === 2 ? `<span class="medal m2">ü•à</span>` :
                  rk === 3 ? `<span class="medal m3">ü•â</span>` : "";
    const trClass = rk === 1 ? "toprow1" : rk === 2 ? "toprow2" : rk === 3 ? "toprow3" : "";
    const isMe = myUserId && String(r.user_id) === String(myUserId);
    const rowClass = `${trClass} ${isMe ? "meRow" : ""}`.trim();

    const nameCell = isMe
      ? `<span class="meName">${escapeHtml(r.username||"(user)")}</span><span class="meBadge">B·∫°n</span>`
      : `${escapeHtml(r.username||"(user)")}`;

    const score10 = Number(r.score10||0);
    const pct = Math.round(score10 * 10);

    return `
      <tr class="${rowClass}">
        <td><span class="rankpill">${medal}<span>${rk}</span></span></td>
        <td>${nameCell}${String(r.role||"").toLowerCase()==="admin" ? ` <span style="color:#2563eb;font-weight:900">(ADMIN)</span>` : ``}</td>
        <td><b>${score10.toFixed(1)}</b>/10</td>
        <td>${pct}%</td>
      </tr>
    `;
  }).join("");

  lb.innerHTML = `
    <div class="row1">
      <p class="vi">B·∫£ng x·∫øp h·∫°ng</p>
      <div class="meta"><span class="idx">TOP</span></div>
    </div>
    <div class="muted" style="margin-top:6px">
      X·∫øp theo <b>ƒëi·ªÉm cao nh·∫•t</b> c·ªßa m·ªói <b>ng∆∞·ªùi</b>. D√≤ng c·ªßa <b>b·∫°n</b> s·∫Ω ƒë∆∞·ª£c t√¥ n·ªïi b·∫≠t. (0 ƒëi·ªÉm v·∫´n hi·ªÉn th·ªã)
    </div>
    <div style="margin-top:10px">${myRankLine}</div>
    <div style="overflow:auto; margin-top:10px;">
      <table class="table">
        <thead><tr><th>#</th><th>T√™n</th><th>ƒêi·ªÉm</th><th>%</th></tr></thead>
        <tbody>${body}</tbody>
      </table>
    </div>
  `;
}

/* ================== GRADING (match q/index) ================== */
function normalizeForCompare(s) {
  let t = String(s||"").trim().toLowerCase();
  t = t.replace(/ƒë/g, "d");
  try { t = t.normalize("NFKD").replace(/[\u0300-\u036f]/g, ""); } catch {}
  t = t.replace(/[‚Äú‚Äù"']/g, " ");
  t = t.replace(/[^a-z0-9\s\-,.]/g, " ");
  t = t.replace(/\s+/g, " ").trim();
  return t;
}
function looseEq(user, expected){
  const u = normalizeForCompare(user);
  const a = normalizeForCompare(expected);
  if (!u || !a) return false;
  if (u === a) return true;
  if (u.replace(/\s/g,"") === a.replace(/\s/g,"")) return true;
  return false;
}
function pointsOf(q){
  const p = Number(q.points ?? 0);
  return (isFinite(p) && p > 0) ? p : 1;
}
function qTypeOf(q){
  return String(q.q_type || "essay").toLowerCase();
}
function acceptedAnswersFromQuestion(q){
  const out = [];
  if(Array.isArray(q.answers)) out.push(...q.answers);
  const seen = new Set();
  const uniq = [];
  for(const x of out){
    const k = normalizeForCompare(x);
    if(!k) continue;
    if(seen.has(k)) continue;
    seen.add(k);
    uniq.push(String(x).trim());
  }
  return uniq;
}
function toMcqNumber(v){
  if(v==null) return 0;
  if(typeof v === "number"){
    const n = Math.floor(v);
    return (n>=1 && n<=4) ? n : 0;
  }
  const s = String(v).trim();
  if(/^[1-4]$/.test(s)) return Number(s);
  const u = s.toUpperCase();
  if(u==="A") return 1;
  if(u==="B") return 2;
  if(u==="C") return 3;
  if(u==="D") return 4;
  return 0;
}
function mcqCorrectOf(q){
  const m = q.meta || {};
  if(Number(m.correct)>=1 && Number(m.correct)<=4) return Number(m.correct);

  const ans = String(m.answer || "").trim();
  if(ans){
    const n = toMcqNumber(ans);
    if(n) return n;
  }
  return 0;
}
function mcqOptionsOf(q){
  const m = q.meta || {};
  if(Array.isArray(m.options)) return m.options;
  return ["","","",""];
}
function fmtMcqChoice(n, opts){
  const L = "ABCD";
  const idx = (Number(n||0)-1);
  const t = (idx>=0 && idx<4) ? String(opts[idx]||"") : "";
  return idx>=0 ? `${L[idx]}${t ? `. ${t}` : ""}` : "(tr·ªëng)";
}
function gradeOne(q, userAnswer){
  const t = qTypeOf(q);
  const max = pointsOf(q);

  if(t === "mcq1" || t === "mcq"){
    const user = toMcqNumber(userAnswer);
    const correct = mcqCorrectOf(q);
    const ok = (user>0 && correct>0 && user === correct);
    const opts = mcqOptionsOf(q);
    const expected = correct ? `ƒê√°p √°n: ${fmtMcqChoice(correct, opts)}` : "ƒê√°p √°n: (ch∆∞a set)";
    return { ok, expected, earned: ok ? max : 0, max, user_fmt: fmtMcqChoice(user, opts) };
  }

  if(t === "tf4"){
    const keys = Array.isArray(q.meta?.keys) ? q.meta.keys : [true,false,false,false];
    const user = Array.isArray(userAnswer) ? userAnswer : [null,null,null,null];

    let correctCount = 0;
    for(let i=0;i<4;i++){
      if((user[i] === true || user[i] === false) && user[i] === Boolean(keys[i])) correctCount++;
    }

    const rule = q.meta?.rule?.byCorrectCount || { "0":0, "1":0.25, "2":0.5, "3":0.5, "4":1 };
    const mult = Number(rule[String(correctCount)] ?? 0) || 0;

    const earned = Math.round(max * mult * 100) / 100;
    const ok = (correctCount === 4);

    const expected = `ƒê√∫ng ${correctCount}/4 (ƒëi·ªÉm: ${earned}/${max})`;
    const ufmt = Array.isArray(user)
      ? user.map(x => x===true ? "ƒê√∫ng" : x===false ? "Sai" : "‚Äî").join(" | ")
      : "(tr·ªëng)";
    const kfmt = keys.map(x => x ? "ƒê√∫ng" : "Sai").join(" | ");
    return { ok, expected: expected + ` ‚Ä¢ Key: ${kfmt}`, earned, max, user_fmt: ufmt };
  }

  // essay / short4
  const user = String(userAnswer || "").trim();
  const acc = acceptedAnswersFromQuestion(q);
  const expected = acc[0] ? `ƒê√°p √°n: ${acc[0]}` : "ƒê√°p √°n: (ch∆∞a set)";
  if(!user) return { ok:false, expected, earned: 0, max, user_fmt: "(tr·ªëng)" };

  let ok = false;
  for(const a of acc){
    if(looseEq(user, a)){ ok = true; break; }
  }
  return { ok, expected, earned: ok ? max : 0, max, user_fmt: user };
}

/* ================== COMMENTS ================== */
const DISCUSS_MAX = 120;
let DISC = { tree:[], openReply:"" };

function discussionHtml(username){
  return `
    <div class="row1">
      <p class="vi">Th·∫£o lu·∫≠n</p>
      <div class="meta"><span class="idx">üí¨</span></div>
    </div>

    <div style="margin-top:10px; display:grid; gap:10px;">
      <div class="charRow">
        <div><b>Vi·∫øt b√¨nh lu·∫≠n</b> <span class="muted">(T√™n: <b>${escapeHtml(username||"‚Äî")}</b>)</span></div>
        <div><span id="rootCount">0</span>/${DISCUSS_MAX}</div>
      </div>
      <textarea id="rootInput" class="input" rows="3" maxlength="${DISCUSS_MAX}" placeholder="Nh·∫≠p b√¨nh lu·∫≠n..."></textarea>
      <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-primary" id="btnPostRoot" style="justify-content:center;">G·ª≠i</button>
      </div>
      <div id="discussList" class="cmtBox"></div>
    </div>
  `;
}
function isAdmin(me){
  return !!me && (String(me.role||"").toLowerCase()==="admin" || String(me.username||"").toLowerCase()==="tuankhoi");
}
function buildTree(rows){
  const byId = new Map();
  rows.forEach(r=>{
    byId.set(String(r.id), {
      id: String(r.id),
      parent_id: (r.parent_id==null ? "" : String(r.parent_id)),
      author: String(r.author||""),
      created_at: r.created_at,
      createdAtMs: toMs(r.created_at),
      text: String(r.text||""),
      pinned: !!r.pinned,
      pinnedAtMs: r.pinned_at ? toMs(r.pinned_at) : 0,
      replies: []
    });
  });

  const roots = [];
  for(const node of byId.values()){
    if(node.parent_id && byId.has(node.parent_id)){
      byId.get(node.parent_id).replies.push(node);
    }else{
      roots.push(node);
    }
  }

  // roots: pinned first, then pinned_at desc, then created_at asc
  roots.sort((a,b)=>{
    if(a.pinned !== b.pinned) return a.pinned ? -1 : 1;
    if(a.pinned && b.pinned && a.pinnedAtMs !== b.pinnedAtMs) return b.pinnedAtMs - a.pinnedAtMs;
    return a.createdAtMs - b.createdAtMs;
  });

  // replies: pinned first too
  roots.forEach(r=>r.replies.sort((a,b)=>{
    if(a.pinned !== b.pinned) return a.pinned ? -1 : 1;
    if(a.pinned && b.pinned && a.pinnedAtMs !== b.pinnedAtMs) return b.pinnedAtMs - a.pinnedAtMs;
    return a.createdAtMs - b.createdAtMs;
  }));

  return roots;
}
function canDeleteComment(c, me){
  if(isAdmin(me)) return true;
  const a = String(c.author||"").trim().toLowerCase();
  const m = String(me?.username||"").trim().toLowerCase();
  return !!m && a === m;
}
async function loadComments(){
  const rows = await sbGet(
    `comments?quiz_id=eq.${quizId}` +
    `&select=id,parent_id,author,text,created_at,pinned,pinned_at` +
    `&order=pinned.desc,pinned_at.desc,created_at.asc&limit=400`
  );
  DISC.tree = buildTree(Array.isArray(rows)?rows:[]);
}
async function addComment({ text, parent_id, author }){
  const payload = {
    quiz_id: quizId,
    parent_id: (parent_id==null ? null : Number(parent_id)),
    author: author || "",
    text: text || ""
  };
  const res = await sbPost("comments", payload, {preferReturn:true});
  return Array.isArray(res) ? res[0] : res;
}
async function deleteComment(id){
  await sbDelete(`comments?id=eq.${encodeURIComponent(id)}`);
}
async function togglePinComment({ me, commentId, pin }){
  const token = getToken();
  if(!token) { toast("Admin c·∫ßn ƒëƒÉng nh·∫≠p"); return; }
  try{
    const out = await sbRpc(RPC.pinComment, { p_token: token, p_comment_id: Number(commentId), p_pin: !!pin });
    if(!out || out.ok!==true) throw new Error(out?.error || "Pin l·ªói");
    toast(pin ? "ƒê√£ pin" : "ƒê√£ b·ªè pin");
    await loadComments();
    renderDiscussion(me);
  }catch(e){
    toast(e?.message || "Pin l·ªói");
  }
}
function renderDiscussion(me){
  const discussionEl = document.getElementById("discussion");
  const list = document.getElementById("discussList");
  if(!list) return;

  const tree = DISC.tree || [];
  if(!tree.length){
    list.innerHTML = `<div class="muted">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</div>`;
    return;
  }

  list.innerHTML = "";
  tree.forEach(root=>{
    const wrap = document.createElement("div");
    wrap.className = "cmtItem";

    const showAdminBadge = (String(root.author||"").trim().toLowerCase() === "tuankhoi");
    const adminTag = showAdminBadge ? `<span class="adminBadgeInline">ADMIN</span>` : ``;
    const pinTag = root.pinned ? `<span class="pinBadgeInline">üìå PIN</span>` : ``;

    const delBtn = canDeleteComment(root, me)
      ? `<button class="cmtBtn cmtBtnDanger" data-del="${escapeHtml(root.id)}">X√≥a</button>` : ``;

    const pinBtn = isAdmin(me)
      ? `<button class="cmtBtn cmtBtnPin" data-pin="${escapeHtml(root.id)}" data-pv="${root.pinned?0:1}">
          ${root.pinned ? "B·ªè pin" : "üìå Pin"}
        </button>` : ``;

    wrap.innerHTML = `
      <div class="cmtHead">
        <div class="cmtAuthor">
          <span>${escapeHtml(root.author||"‚Äî")}</span>
          ${adminTag}
          ${pinTag}
        </div>
      </div>
      <div class="cmtText">${escapeHtml(root.text||"")}</div>

      <div class="cmtActions">
        <button class="cmtBtn" data-reply="${escapeHtml(root.id)}">Tr·∫£ l·ªùi</button>
        ${pinBtn}
        ${delBtn}
      </div>
      <div class="cmtTime">${escapeHtml(fmtTs(root.created_at))}</div>

      <div class="replySlot" data-slot="${escapeHtml(root.id)}"></div>
      <div class="replyWrap" data-replies="${escapeHtml(root.id)}"></div>
    `;
    list.appendChild(wrap);

    const slot = wrap.querySelector(`[data-slot="${CSS.escape(String(root.id))}"]`);
    if(slot && DISC.openReply === String(root.id)){
      slot.innerHTML = `
        <div class="replyForm">
          <div class="charRow">
            <div><b>Tr·∫£ l·ªùi</b></div>
            <div><span data-ct>0</span>/${DISCUSS_MAX}</div>
          </div>
          <textarea class="input" rows="2" maxlength="${DISCUSS_MAX}" placeholder="Nh·∫≠p tr·∫£ l·ªùi..."></textarea>
          <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-primary" data-sendreply="${escapeHtml(root.id)}" style="justify-content:center;">G·ª≠i</button>
            <button class="btn" data-cancelreply style="justify-content:center;">H·ªßy</button>
          </div>
        </div>
      `;
    }

    const rWrap = wrap.querySelector(`[data-replies="${CSS.escape(String(root.id))}"]`);
    if(rWrap){
      rWrap.innerHTML = "";
      (root.replies||[]).forEach(r=>{
        const item = document.createElement("div");
        item.className = "cmtItem";
        item.style.margin = "0";

        const rPinTag = r.pinned ? `<span class="pinBadgeInline">üìå PIN</span>` : ``;

        const rPinBtn = isAdmin(me)
          ? `<button class="cmtBtn cmtBtnPin" data-pin="${escapeHtml(r.id)}" data-pv="${r.pinned?0:1}">
              ${r.pinned ? "B·ªè pin" : "üìå Pin"}
            </button>` : ``;

        const rDelBtn = canDeleteComment(r, me)
          ? `<button class="cmtBtn cmtBtnDanger" data-del="${escapeHtml(r.id)}">X√≥a</button>` : ``;

        item.innerHTML = `
          <div class="cmtHead">
            <div class="cmtAuthor">
              <span>${escapeHtml(r.author||"‚Äî")}</span>
              ${rPinTag}
            </div>
          </div>
          <div class="cmtText">${escapeHtml(r.text||"")}</div>
          <div class="cmtActions">
            ${rPinBtn}
            ${rDelBtn}
          </div>
          <div class="cmtTime">${escapeHtml(fmtTs(r.created_at))}</div>
        `;
        rWrap.appendChild(item);
      });
    }
  });

  // bind events once at container level
  discussionEl.onclick = async (e)=>{
    const pinBtn = e.target.closest("[data-pin]");
    if(pinBtn){
      const id = pinBtn.getAttribute("data-pin");
      const pv = pinBtn.getAttribute("data-pv");
      await togglePinComment({ me, commentId: id, pin: pv==="1" });
      return;
    }

    const delBtn = e.target.closest("[data-del]");
    if(delBtn){
      const id = String(delBtn.getAttribute("data-del")||"");
      if(!id) return;
      if(!confirm("X√≥a b√¨nh lu·∫≠n n√†y?")) return;
      try{
        await deleteComment(id);
        await loadComments();
        renderDiscussion(me);
        toast("ƒê√£ x√≥a");
      }catch(_err){
        toast("X√≥a l·ªói (c√≥ th·ªÉ do RLS)");
      }
      return;
    }

    const replyBtn = e.target.closest("[data-reply]");
    if(replyBtn){
      const rootId = String(replyBtn.getAttribute("data-reply")||"");
      DISC.openReply = (DISC.openReply === rootId) ? "" : rootId;
      renderDiscussion(me);
      const slot = discussionEl.querySelector(`[data-slot="${CSS.escape(rootId)}"]`);
      const ta = slot ? slot.querySelector("textarea") : null;
      if(ta) ta.focus();
      return;
    }

    const cancelBtn = e.target.closest("[data-cancelreply]");
    if(cancelBtn){
      DISC.openReply = "";
      renderDiscussion(me);
      return;
    }

    const sendBtn = e.target.closest("[data-sendreply]");
    if(sendBtn){
      const rootId = String(sendBtn.getAttribute("data-sendreply")||"");
      const slot = discussionEl.querySelector(`[data-slot="${CSS.escape(rootId)}"]`);
      const ta = slot ? slot.querySelector("textarea") : null;
      const text = ta ? String(ta.value||"").trim() : "";
      if(!text || text.length > DISCUSS_MAX){ toast("T·ªëi ƒëa 120 k√Ω t·ª±"); return; }

      const author = String(me?.username || "").trim();
      if(!author){ toast("Thi·∫øu t√™n"); return; }

      DISC.openReply = "";
      renderDiscussion(me);

      try{
        await addComment({ text, parent_id: rootId, author });
        await loadComments();
        renderDiscussion(me);
        toast("ƒê√£ g·ª≠i");
      }catch(_err){
        toast("G·ª≠i l·ªói (c√≥ th·ªÉ do RLS)");
      }
      return;
    }
  };

  discussionEl.oninput = (e)=>{
    const ta = e.target;
    if(!(ta && ta.tagName === "TEXTAREA")) return;
    const form = ta.closest(".replyForm");
    if(!form) return;
    const ct = form.querySelector("[data-ct]");
    if(ct) ct.textContent = String((ta.value||"").length);
  };
}

/* ================== DATA LOADERS ================== */
async function loadMeIfAny(){
  const token = getToken();
  if(!token) return null;
  try{
    const out = await sbRpc(RPC.me, { p_token: token });
    if(!out || out.ok!==true) return null;
    const m = out.me || out.user || out.data || null;
    if(m && m.id && !m.user_id) m.user_id = m.id;
    return m;
  }catch(_e){
    return null;
  }
}
async function loadQuizMeta(){
  const out = await sbRpc(RPC.quizMeta, { p_quiz_id: quizId });
  if(!out || out.ok!==true) throw new Error(out?.error || "Kh√¥ng load quiz meta");
  const q = out.quiz || {};
  return { title: q.title || "", sub: q.sub || "" };
}
async function loadAttemptPublic(attemptId, token){
  const out = await sbRpc(RPC.attemptPublic, { p_attempt_id: attemptId, p_token: token || "" });
  if(!out || out.ok!==true) throw new Error(out?.error || "Kh√¥ng load attempt");
  return out;
}
async function loadLeaderboard(){
  const out = await sbRpc(RPC.leaderboard, { p_quiz_id: quizId, p_limit: 50 });
  if(Array.isArray(out)) return out;
  // fallback n·∫øu RPC tr·∫£ object {items:[]}
  if(out && Array.isArray(out.items)) return out.items;
  return [];
}
async function loadQuestionsPublic(){
  const out = await sbRpc(RPC.questionsPublic, { p_quiz_id: quizId });
  if(!out || out.ok!==true) return [];
  return Array.isArray(out.items) ? out.items : [];
}

/* ================== BUILD WRONG LIST + RECOMPUTE ================== */
function buildWrongFrom({ questions, answersMap }){
  const byId = new Map();
  questions.forEach(q=>byId.set(String(q.id), q));

  const wrong = [];
  let earned = 0;
  let max = 0;
  let correctCount = 0;
  let totalCount = questions.length;

  for(const q of questions){
    const id = String(q.id);
    const ua = (answersMap && Object.prototype.hasOwnProperty.call(answersMap, id)) ? answersMap[id] : answersMap?.[q.id];
    const g = gradeOne(q, ua);
    max += g.max;
    earned += g.earned;
    if(g.ok) correctCount++;

    if(!g.ok){
      const word = String(q.prompt || "").trim() || `#${q.id}`;
      wrong.push({
        id: q.id,
        word,
        user_answer: g.user_fmt || (ua==null ? "" : String(ua)),
        expected: g.expected || ""
      });
    }
  }

  const score10 = max>0 ? Math.round((earned/max*10)*10)/10 : 0;
  return { wrong, recompute: { score10, correctCount, totalCount, earned, max } };
}

/* ================== BOOT ================== */
(async function boot(){
  if(!quizId){
    setTopbar({ title:"K·∫øt qu·∫£", sub:"Sai link (thi·∫øu ?quiz=abcde)", username:"‚Äî", correctCount:0, totalCount:0, progressPercent:0 });
    document.getElementById("summary").innerHTML = `<div class="muted">Sai link.</div>`;
    document.getElementById("wrongCard").style.display="none";
    document.getElementById("lb").innerHTML = `<div class="muted">Sai link.</div>`;
    document.getElementById("discussion").innerHTML = `<div class="muted">Sai link.</div>`;
    return;
  }

  let cached = null;
  try{ cached = JSON.parse(sessionStorage.getItem(`tk_last_result::${quizId}`)||"null"); }catch{}
  const fallbackName = loadName();

  const token = getToken();
  let me = await loadMeIfAny();

  let username = me?.username || (cached?.me?.username || fallbackName || "");
  let myUserId = me?.user_id || (cached?.me?.user_id || "");

  let score10 = Number(cached?.result?.score10 || 0);
  let correctCount = Number(cached?.result?.fullCorrectCount || cached?.result?.correctCount || 0);
  let totalCount = Number(cached?.result?.totalCount || 0);
  let wrongList = Array.isArray(cached?.result?.wrong) ? cached.result.wrong : [];

  let djAnswers = cached?.result?.answers || cached?.answers || null;

  // quiz meta
  let qTitle="", qSub="";
  try{
    const qm = await loadQuizMeta();
    qTitle = qm.title || "";
    qSub = qm.sub || "";
  }catch{}

  // attempt th·∫≠t (RPC)
  let attemptDetails = null;
  if(attemptId){
    try{
      const out = await loadAttemptPublic(attemptId, token);
      const a = out.attempt || {};
      const u = out.user || {};

      score10 = Number(a.score10||0);
      correctCount = Number(a.correct_count||0);
      totalCount = Number(a.total_count||0);

      if(!username && u.username) username = u.username;
      if(!myUserId && me?.user_id) myUserId = me.user_id;

      attemptDetails = a.details_json || {};
      djAnswers = attemptDetails.answers || djAnswers;

      if(Array.isArray(attemptDetails.wrong)) wrongList = attemptDetails.wrong;
    }catch(_e){}
  }

  // N·∫øu thi·∫øu wrongList (ƒëa ph·∫ßn do submit kh√¥ng l∆∞u wrong) -> t·ª± t√≠nh t·ª´ questions + answers
  let recomputeNote = "";
  try{
    const questions = await loadQuestionsPublic();
    const answersMap = (attemptDetails && attemptDetails.answers) ? attemptDetails.answers : (djAnswers || {});
    if(questions.length){
      const out2 = buildWrongFrom({ questions, answersMap });
      if(!wrongList || !wrongList.length) wrongList = out2.wrong;

      // Recompute score to sanity-check (n·∫øu mu·ªën ‚Äúƒë√∫ng ho√†n to√†n‚Äù th√¨ √≠t nh·∫•t detect mismatch)
      const rs = out2.recompute;
      const dbScore = Number(score10||0);
      const reScore = Number(rs.score10||0);

      // ch·ªâ show note n·∫øu l·ªách r√µ r√†ng
      if(isFinite(dbScore) && isFinite(reScore) && Math.abs(dbScore - reScore) >= 0.2){
        recomputeNote = `‚ö†Ô∏è <b>C·∫£nh b√°o:</b> ƒêi·ªÉm trong DB = <b>${dbScore.toFixed(1)}</b> nh∆∞ng t√≠nh l·∫°i theo ƒë√°p √°n = <b>${reScore.toFixed(1)}</b>. 
        H√£y ki·ªÉm tra logic ch·∫•m ·ªü trang l√†m b√†i / server.`;
      }
      // update counts theo recompute n·∫øu DB ƒëang 0/thi·∫øu
      if(!totalCount || totalCount<=0) totalCount = rs.totalCount;
      if(!correctCount && rs.correctCount>=0) correctCount = rs.correctCount;
    }
  }catch(_e){}

  CURRENT_WRONG_LIST = Array.isArray(wrongList) ? wrongList : [];

  // topbar
  const prog = totalCount ? (Number(correctCount||0)/Number(totalCount||0))*100 : (Number(score10||0)*10);
  setTopbar({
    title: qTitle || cached?.title || "K·∫øt qu·∫£",
    sub: qSub || cached?.sub || "",
    username: username || "‚Äî",
    correctCount: Number(correctCount||0),
    totalCount: Number(totalCount||0),
    progressPercent: prog
  });

  // summary + wrong card
  renderSummaryCard({ score10, correctCount, totalCount, wrongCount: CURRENT_WRONG_LIST.length, recomputeNote });
  renderWrongCard(CURRENT_WRONG_LIST.length);

  // leaderboard
  try{
    const lb = await loadLeaderboard();
    renderLeaderboard(lb, myUserId);
  }catch(_e){
    renderLeaderboard([], "");
  }

  // discussion
  const discussionEl = document.getElementById("discussion");
  discussionEl.innerHTML = discussionHtml(username || fallbackName || "‚Äî");

  const rootInput = document.getElementById("rootInput");
  const rootCount = document.getElementById("rootCount");
  const btnPostRoot = document.getElementById("btnPostRoot");

  rootInput.addEventListener("input", ()=>{ rootCount.textContent = String((rootInput.value||"").length); }, {passive:true});

  const meForUI = me || { username: username || fallbackName || "", role:"user" };

  try{
    await loadComments();
    renderDiscussion(meForUI);
  }catch(e){
    discussionEl.innerHTML += `<div class="muted" style="margin-top:10px">
      Kh√¥ng load ƒë∆∞·ª£c comments: <b>${escapeHtml(e?.message || String(e))}</b>
    </div>`;
  }

  btnPostRoot.addEventListener("click", async ()=>{
    const text = String(rootInput.value||"").trim();
    if(!text || text.length > DISCUSS_MAX){ toast("T·ªëi ƒëa 120 k√Ω t·ª±"); return; }
    const author = String(meForUI.username || "").trim();
    if(!author){ toast("Thi·∫øu t√™n"); return; }

    rootInput.value = ""; rootCount.textContent = "0";
    try{
      await addComment({ text, parent_id:null, author });
      await loadComments();
      renderDiscussion(meForUI);
      toast("ƒê√£ g·ª≠i");
    }catch(_e){
      toast("G·ª≠i l·ªói (c√≥ th·ªÉ do RLS)");
    }
  });
})();
</script>
</body>
</html>
