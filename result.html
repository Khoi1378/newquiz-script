<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>K·∫øt qu·∫£</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <!-- ‚úÖ KaTeX (LaTeX render) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

  <style>
    :root{
      --bg1:#ffecd2; --bg2:#fcb69f;
      --card:#fff; --text:#1f2937; --muted:#6b7280;
      --primary:#7c3aed; --ok:#16a34a; --bad:#dc2626; --warn:#f59e0b;
      --border:#e5e7eb; --soft:#f8fafc;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --radius:18px;
      --admin:#2563eb;
      --pin:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0;
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
                  linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 100%);
      overflow:hidden;
      touch-action:pan-x pan-y;
    }

    #shell{height:100vh;overflow:auto;-webkit-overflow-scrolling:touch;padding:12px 0 140px}
    .wrap{max-width:980px;margin:0 auto;padding:0 14px}

    .actionbar{
      position: sticky; top: 10px; z-index: 9999;
      display:flex; justify-content:flex-end; gap:10px; padding:0 14px;
      flex-wrap:wrap;
    }
    .btn{
      border:0; cursor:pointer;
      border-radius:999px; padding:10px 14px;
      font-weight:900; font-size:.9rem;
      transition:transform .16s ease, filter .16s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none; white-space:nowrap;
      box-shadow:0 12px 24px rgba(0,0,0,.12);
      background:#fff; color:#111827; border:1px solid #e5e7eb;
      text-decoration:none;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(.98)}
    .btn:active{transform:translateY(0)}
    .btn-reset{background:#111827;color:#fff;border:0}
    .btn-primary{
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      color:#fff;border:0;
      box-shadow:0 12px 24px rgba(124,58,237,.18);
    }
    .btn[disabled]{opacity:.65;cursor:not-allowed;transform:none !important;filter:none !important}

    .topbar{
      margin-top:10px;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(229,231,235,.9);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .titlebox{display:flex;gap:10px;align-items:center;flex:1 1 360px;min-width:240px}
    .logo{
      width:42px;height:42px;border-radius:16px;
      background:linear-gradient(135deg,#a78bfa,#fb7185);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;
      box-shadow:0 10px 22px rgba(124,58,237,.18);
      user-select:none;
    }
    .titles h1{font-size:1.02rem;margin:0;font-weight:800}
    .titles .tiny{margin-top:3px;font-size:.86rem;color:var(--muted);font-weight:650}

    .stats{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{
      background:#f3f4f6;border:1px solid #e5e7eb;
      border-radius:999px;padding:8px 12px;
      font-weight:800;font-size:.9rem;color:#374151;white-space:nowrap;
      display:inline-flex;gap:6px;align-items:center;
    }
    .pill strong{color:var(--primary)}
    .progressline{
      height:10px;border-radius:999px;background:#f3f4f6;overflow:hidden;
      border:1px solid #e5e7eb;width:100%;max-width:360px;
    }
    .progressfill{
      height:100%;width:0%;
      background:linear-gradient(90deg,#22c55e,#a78bfa);
      transition:width .25s ease;
    }

    .content{padding:12px 0 0}

    .card{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;margin:12px 0;
    }
    .row1{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .vi{margin:0;font-weight:900;font-size:1.04rem;line-height:1.25}
    .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .idx{
      font-size:.78rem;font-weight:900;
      padding:6px 10px;border-radius:999px;
      background:#eff6ff;color:#1d4ed8;border:1px solid #dbeafe;white-space:nowrap;
    }
    .muted{color:var(--muted);font-weight:650}
    .oktxt{color:var(--ok);font-weight:900}
    .badtxt{color:var(--bad);font-weight:900}

    .scoreHero{
      display:grid; gap:10px;
      align-items:center; justify-items:center;
      padding:10px 8px 6px; text-align:center;
    }
    .scoreBig{
      font-weight:1000;
      font-size:3.1rem;
      line-height:1;
      letter-spacing:-0.02em;
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-shadow:0 14px 40px rgba(124,58,237,.14);
    }
    .scoreSub{
      font-weight:900;
      font-size:1.05rem;
      color:#111827;
    }
    .scoreMeta{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    }

    .resultline{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px dashed #e5e7eb;
      background:#fff;
      font-weight:750;
      line-height:1.35;
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      border:1px solid #e5e7eb;
      background:#fff;
    }
    .table th,.table td{
      padding:10px 10px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
      font-weight:750;
      font-size:.92rem;
    }
    .table th{background:#f8fafc;font-weight:900}
    .table tr:last-child td{border-bottom:0}

    .rankpill{
      display:inline-flex; align-items:center; gap:8px;
      border-radius:999px; padding:6px 10px;
      font-weight:950; font-size:.86rem;
      border:1px solid #e5e7eb;
      background:#fff;
      white-space:nowrap;
    }
    .medal{
      width:22px;height:22px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:.9rem;color:#111827;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 10px 22px rgba(0,0,0,.10);
    }
    .m1{background:linear-gradient(135deg,#fde68a,#f59e0b)}
    .m2{background:linear-gradient(135deg,#e2e8f0,#94a3b8)}
    .m3{background:linear-gradient(135deg,#fdba74,#d97706)}
    .toprow1 td{background:rgba(245,158,11,.10)}
    .toprow2 td{background:rgba(148,163,184,.12)}
    .toprow3 td{background:rgba(217,119,6,.10)}

    .meRow td{
      background:rgba(124,58,237,.12)!important;
      border-top:1px solid rgba(124,58,237,.25);
      border-bottom:1px solid rgba(124,58,237,.25);
    }
    .meRow td:first-child{border-left:6px solid rgba(124,58,237,.55)}
    .meName{font-weight:1000;letter-spacing:.01em}
    .meBadge{
      margin-left:8px;
      padding:4px 8px;border-radius:999px;
      font-weight:900;font-size:.78rem;
      background:rgba(124,58,237,.14);
      border:1px solid rgba(124,58,237,.35);
      color:#4c1d95;
      white-space:nowrap;
    }

    .toast{
      position:fixed; left:50%; bottom:88px; transform:translateX(-50%);
      background:rgba(17,24,39,.92); color:#fff;
      padding:10px 12px; border-radius:14px;
      font-weight:800; font-size:.9rem;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width:calc(100% - 28px);
      z-index:10003;
      text-align:center;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}

    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:10001;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      width:100%; max-width:720px;
      background:#fff;
      border-radius:18px;
      border:1px solid #e5e7eb;
      box-shadow:0 20px 60px rgba(0,0,0,.18);
      padding:14px;
      max-height:82vh;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .modal h3{margin:4px 0 6px;font-size:1.02rem}
    .modal p{margin:0 0 12px;color:var(--muted);font-weight:650;font-size:.92rem;line-height:1.35}

    .xclose{
      position:sticky; top:0;
      display:flex; justify-content:flex-end;
      z-index:2; margin-bottom:4px;
    }
    .btn-x{
      width:56px;height:56px;
      border-radius:16px;
      border:1px solid #e5e7eb;
      background:#fff;
      cursor:pointer;
      font-weight:1000;
      font-size:1.8rem;
      line-height:1;
      box-shadow:0 12px 24px rgba(0,0,0,.10);
    }
    .btn-x:hover{filter:brightness(.98);transform:translateY(-1px)}
    .btn-x:active{transform:translateY(0)}

    .miniBtn{
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      border:1px solid #e5e7eb;
      background:#fff;
      cursor:pointer;
      font-size:.84rem;
      box-shadow:0 10px 22px rgba(0,0,0,.08);
    }
    .miniBtn:hover{filter:brightness(.98);transform:translateY(-1px)}
    .miniBtn:active{transform:translateY(0)}

    .qBox{
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:12px;
      background:#fff;
      line-height:1.35;
    }
    .qPrompt{font-weight:900;white-space:pre-wrap}
    .qImg{
      margin-top:10px;
      width:100%;
      max-width:420px;
      border-radius:16px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 24px rgba(0,0,0,.08);
      display:block;
    }
    .kv{
      margin-top:10px;
      display:grid;
      gap:10px;
    }
    .kvRow{
      border:1px dashed #e5e7eb;
      border-radius:16px;
      padding:10px 12px;
      background:#fff;
      display:grid;
      gap:6px;
    }
    .kvKey{font-weight:900;color:#374151}
    .kvVal{font-weight:800}
    .optList{margin-top:8px;display:grid;gap:8px}
    .optItem{
      border-radius:14px;
      border:1px solid #e5e7eb;
      padding:10px 12px;
      background:#fff;
      font-weight:850;
      line-height:1.35;
    }
    .optItem.good{border-color:rgba(22,163,74,.45);background:rgba(22,163,74,.06)}
    .optItem.bad{border-color:rgba(220,38,38,.45);background:rgba(220,38,38,.06)}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      font-weight:950;font-size:.82rem;
      border:1px solid #e5e7eb;background:#fff;
      white-space:nowrap;
    }
    .badge.bad{border-color:rgba(220,38,38,.35);background:rgba(220,38,38,.06);color:#991b1b}
    .badge.ok{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.06);color:#065f46}

    .wrongRow{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      border:1px solid #e5e7eb;border-radius:16px;padding:12px;background:#fff;
    }
    .wrongLeft{min-width:220px;flex:1 1 520px}
    .wrongTitle{font-weight:1000;line-height:1.25}
    .wrongSub{margin-top:6px;color:#6b7280;font-weight:800;font-size:.9rem;line-height:1.35;white-space:pre-wrap}
    .wrongRight{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}

    .mutedSmall{color:#6b7280;font-weight:800;font-size:.85rem}

    @media (max-width:820px){
      .progressline{max-width:100%}
      .btn{padding:9px 12px;font-size:.85rem}
      .scoreBig{font-size:2.8rem}
    }
  </style>
</head>

<body>
  <div id="shell">
    <div class="actionbar">
      <a class="btn" id="btnHome" href="https://www.tuankhoi.site" rel="noopener">Trang ch·ªß</a>
      <button class="btn" id="btnScrollTop" type="button">‚¨ÜÔ∏è L√™n ƒë·∫ßu</button>
      <button class="btn btn-reset" id="btnRestart" type="button">üîÅ L√†m l·∫°i</button>
      <button class="btn btn-primary" id="btnDiscuss" type="button">üí¨ Th·∫£o lu·∫≠n</button>
    </div>

    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">RS</div>
          <div class="titles">
            <h1 id="quizTitle">K·∫øt qu·∫£</h1>
            <div class="tiny" id="quizSub"></div>
          </div>
        </div>

        <div class="stats">
          <div class="pill">Ng∆∞·ªùi l√†m: <strong id="whoName">‚Äî</strong></div>
          <div class="pill">ƒê√∫ng: <strong id="answeredCount">0</strong>/<span id="totalCount">0</span></div>
          <div class="progressline"><div class="progressfill" id="progressFill"></div></div>
        </div>
      </div>

      <div class="content" id="content">
        <div id="summary" class="card"></div>
        <div id="wrongCard" class="card" style="display:none; cursor:pointer;"></div>
        <div id="lb" class="card"></div>
        <div id="discussionAnchor" style="height:1px;"></div>
        <div id="discussion" class="card"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- WRONG LIST MODAL -->
  <div class="modal-backdrop" id="wrongBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wrongTitle">
      <div class="xclose">
        <button class="btn-x" id="btnCloseWrong" aria-label="ƒê√≥ng">‚úï</button>
      </div>
      <h3 id="wrongTitle">Chi ti·∫øt ƒë√∫ng / sai</h3>
      <p>Ch·ªâ li·ªát k√™ nh·ªØng c√¢u <b>sai</b> ho·∫∑c <b>b·ªè tr·ªëng</b>. B·∫•m <b>Chi ti·∫øt</b> ƒë·ªÉ xem full c√¢u h·ªèi + ƒë√°p √°n.</p>
      <div id="wrongBody" style="display:grid; gap:12px;"></div>
    </div>
  </div>

  <!-- QUESTION DETAIL MODAL -->
  <div class="modal-backdrop" id="detailBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
      <div class="xclose">
        <button class="btn-x" id="btnCloseDetail" aria-label="ƒê√≥ng">‚úï</button>
      </div>
      <h3 id="detailTitle">Chi ti·∫øt c√¢u h·ªèi</h3>
      <div id="detailBody"></div>
    </div>
  </div>

  <!-- ‚úÖ KaTeX JS -->
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<script>
/* ================== CONFIG ================== */
const SUPABASE_URL = "https://aidvlydhbdtwunyreqak.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZHZseWRoYmR0d3VueXJlcWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzM5NzYsImV4cCI6MjA4NDIwOTk3Nn0.LMKGjKlUbC5qoY7hqDpaDFQrFWfwKemBTpxjTNp_L8o";

const RPC = {
  me: "api_me",
  quizMeta: "api_get_quiz_meta",
  attemptPublic: "api_get_attempt_public",
  leaderboard: "api_get_leaderboard",
  pinComment: "api_toggle_comment_pin",
  questionsPublic: "api_get_questions_public"
};

const TOKEN_KEY = "tk_token_v2";
const NAME_KEY  = "tk_display_name_v1";

/* ================== HARD DEBUG ================== */
function renderFatal(err){
  const msg = (err && (err.message || err)) ? (err.message || String(err)) : "Unknown error";
  toast("L·ªói: " + msg);
}
window.addEventListener("error", (e)=>{ renderFatal(e?.error || e?.message); });
window.addEventListener("unhandledrejection", (e)=>{ renderFatal(e?.reason || e); });

/* ===== helpers ===== */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = String(msg||"");
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1400);
}
function escapeHtml(s) {
  return String(s ?? "")
    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;").replace(/'/g, "&#39;");
}
function loadName(){ try { return (localStorage.getItem(NAME_KEY)||"").trim(); } catch { return ""; } }
function getToken(){ try { return (localStorage.getItem(TOKEN_KEY)||"").trim(); } catch { return ""; } }

function sbHeaders(){
  const anon = String(SUPABASE_ANON_KEY||"").trim();
  return {
    "apikey": anon,
    "Authorization": "Bearer " + anon,
    "Content-Type": "application/json"
  };
}
async function sbRpc(fn, args){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{
    method:"POST",
    headers: sbHeaders(),
    body: JSON.stringify(args||{})
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "RPC error");
  }
  return data;
}
async function sbGet(path){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{ headers: sbHeaders() });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST GET error");
  }
  return data;
}
async function sbPost(path, body, { preferReturn=true } = {}){
  const h = sbHeaders();
  if(preferReturn) h["Prefer"]="return=representation";
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{
    method:"POST",
    headers: h,
    body: JSON.stringify(body||{})
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST POST error");
  }
  return data;
}
async function sbDelete(path){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{
    method:"DELETE",
    headers: sbHeaders()
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST DELETE error");
  }
  return data;
}

function applyMath(rootEl){
  if(!rootEl) return;
  if(typeof window.renderMathInElement !== "function") return;
  try{
    window.renderMathInElement(rootEl, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false }
      ],
      throwOnError: false
    });
  }catch{}
}

function toMs(ts){
  const d = new Date(ts);
  const t = d.getTime();
  return isFinite(t) ? t : 0;
}
function fmtTs(ts){
  try{
    const d = ts ? new Date(ts) : new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}, ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)}`;
  }catch{ return ""; }
}

/* ================== URL / STATE ================== */
const qs = new URLSearchParams(location.search);
const quizId = String(qs.get("quiz")||"").toLowerCase().replace(/[^a-z]/g,"").slice(0,5);
const attemptId = String(qs.get("attempt")||"").trim();

const PROGRESS_KEY = `tk_progress::${quizId}`;
function clearForRestart(){
  try{ localStorage.removeItem(PROGRESS_KEY); }catch{}
  try{ sessionStorage.removeItem(`tk_last_result::${quizId}`); }catch{}
}

/* ================== ACTION BUTTONS ================== */
const shell = document.getElementById("shell");
document.getElementById("btnScrollTop").addEventListener("click", ()=> shell.scrollTo({ top:0, behavior:"smooth" }));
document.getElementById("btnDiscuss").addEventListener("click", ()=>{
  const a = document.getElementById("discussionAnchor");
  if(a) a.scrollIntoView({ behavior:"smooth", block:"start" });
});
document.getElementById("btnRestart").addEventListener("click", ()=>{
  if(!quizId){ location.href = "/"; return; }
  clearForRestart();
  location.href = `/q/index.html?quiz=${quizId}&restart=1&start=1`;
});

/* ================== MODALS ================== */
const wrongBackdrop = document.getElementById("wrongBackdrop");
const wrongBody = document.getElementById("wrongBody");
document.getElementById("btnCloseWrong").addEventListener("click", ()=>closeWrongPopup());
wrongBackdrop.addEventListener("click",(e)=>{ if(e.target===wrongBackdrop) closeWrongPopup(); });

const detailBackdrop = document.getElementById("detailBackdrop");
const detailBody = document.getElementById("detailBody");
document.getElementById("btnCloseDetail").addEventListener("click", ()=>closeDetail());
detailBackdrop.addEventListener("click",(e)=>{ if(e.target===detailBackdrop) closeDetail(); });

document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    if(detailBackdrop.classList.contains("show")) closeDetail();
    else if(wrongBackdrop.classList.contains("show")) closeWrongPopup();
  }
});

function openWrongPopup(){
  wrongBackdrop.classList.add("show");
  wrongBackdrop.setAttribute("aria-hidden","false");
  applyMath(wrongBody);
}
function closeWrongPopup(){
  wrongBackdrop.classList.remove("show");
  wrongBackdrop.setAttribute("aria-hidden","true");
}
function openDetail(html){
  detailBody.innerHTML = html || "";
  detailBackdrop.classList.add("show");
  detailBackdrop.setAttribute("aria-hidden","false");
  applyMath(detailBody);
}
function closeDetail(){
  detailBackdrop.classList.remove("show");
  detailBackdrop.setAttribute("aria-hidden","true");
  detailBody.innerHTML = "";
}

/* ================== UI RENDER ================== */
function setTopbar({title, sub, username, correctCount, totalCount, progressPercent}){
  document.getElementById("quizTitle").textContent = title || "K·∫øt qu·∫£";
  document.getElementById("quizSub").textContent = sub || "";
  document.getElementById("whoName").textContent = username || "‚Äî";
  document.getElementById("answeredCount").textContent = String(Number(correctCount||0));
  document.getElementById("totalCount").textContent = String(Number(totalCount||0));
  document.getElementById("progressFill").style.width = `${Math.max(0, Math.min(100, Number(progressPercent||0)))}%`;
}

function renderSummaryCard({ score10, correctCount, totalCount, wrongCount, createdAt, canViewDetails }){
  const sum = document.getElementById("summary");
  const pct = Math.round(Math.max(0, Math.min(100, Number(score10||0)*10)));
  const createdLine = createdAt ? `<div class="mutedSmall">N·ªôp l√∫c: <b>${escapeHtml(fmtTs(createdAt))}</b></div>` : "";

  sum.innerHTML = `
    <div class="row1">
      <p class="vi">K·∫øt qu·∫£</p>
      <div class="meta"><span class="idx">DB</span></div>
    </div>

    <div class="scoreHero">
      <div class="scoreBig">${pct}%</div>
      <div class="scoreSub">= ${Number(score10||0).toFixed(1)} ƒëi·ªÉm (thang 10)</div>

      <div class="scoreMeta">
        <div class="pill">ƒê√∫ng: <strong>${Number(correctCount||0)}</strong>/${Number(totalCount||0)}</div>
        <div class="pill">Sai/Tr·ªëng: <strong>${Number(wrongCount||0)}</strong></div>
      </div>

      ${createdLine}

      ${canViewDetails ? `
        <div class="resultline" style="margin-top:0">
          <b>Chi ti·∫øt:</b> B·∫•m v√†o ƒë·ªÉ xem c√¢u h·ªèi v√† ƒë√°p √°n.
        </div>
      ` : `
        <div class="resultline" style="margin-top:0">
          <b>L∆∞u √Ω:</b> Link n√†y ƒëang hi·ªÉn th·ªã theo DB. N·∫øu mu·ªën xem <b>chi ti·∫øt ƒë√°p √°n</b>, h√£y m·ªü b·∫±ng t√†i kho·∫£n ƒë√£ l√†m b√†i (c√≥ token).
        </div>
      `}
    </div>
  `;
  applyMath(sum);
}

function renderWrongCard(wrongCount, canViewDetails){
  const wc = Number(wrongCount||0);
  const card = document.getElementById("wrongCard");

  if(!canViewDetails){
    card.style.display = "none";
    return;
  }

  if(wc <= 0){
    card.style.display = "";
    card.innerHTML = `
      <div class="row1">
        <p class="vi">Nh·ªØng c√¢u sai ‚ùå</p>
        <div class="meta"><span class="idx">0 c√¢u</span></div>
      </div>
      <div class="muted" style="margin-top:6px">B·∫°n kh√¥ng sai c√¢u n√†o ‚úÖ</div>
    `;
    card.onclick = ()=>{};
    return;
  }

  card.style.display = "";
  card.innerHTML = `
    <div class="row1">
      <p class="vi">Nh·ªØng c√¢u sai ‚ùå</p>
      <div class="meta"><span class="idx">${wc} c√¢u</span></div>
    </div>
    <div class="muted" style="margin-top:6px">B·∫•m v√†o ƒë√¢y ƒë·ªÉ xem chi ti·∫øt (full c√¢u h·ªèi + h√¨nh + ƒë√°p √°n).</div>
  `;
  card.onclick = ()=> openWrongPopup();
}

function renderLeaderboard(rows, myUserId, errMsg){
  const lb = document.getElementById("lb");
  const arr = Array.isArray(rows) ? rows : [];

  if(errMsg){
    lb.innerHTML = `
      <div class="row1">
        <p class="vi">B·∫£ng x·∫øp h·∫°ng</p>
        <div class="meta"><span class="idx">RPC</span></div>
      </div>
      <div class="muted" style="margin-top:6px;line-height:1.35">
        L·ªói load leaderboard: <b>${escapeHtml(errMsg)}</b><br/>
        (H√£y ch·∫°y l·∫°i SQL ph·∫ßn <b>api_get_leaderboard</b> v√† ƒë·∫£m b·∫£o ƒë√£ <b>GRANT</b> cho anon/authenticated.)
      </div>
    `;
    return;
  }

  if(!arr.length){
    lb.innerHTML = `
      <div class="row1">
        <p class="vi">B·∫£ng x·∫øp h·∫°ng</p>
        <div class="meta"><span class="idx">TOP</span></div>
      </div>
      <div class="muted" style="margin-top:6px">
        Ch∆∞a c√≥ d·ªØ li·ªáu. (N·∫øu b·∫°n ƒë√£ l√†m m√† v·∫´n tr·ªëng: ki·ªÉm tra l·∫°i RPC <b>api_get_leaderboard</b> v√† RLS.)
      </div>
    `;
    return;
  }

  const maxRows = 30;
  const top = arr.slice(0, maxRows);

  const myIndex = myUserId ? top.findIndex(r => String(r.user_id) === String(myUserId)) : -1;
  const myRankLine = (myIndex >= 0)
    ? `<div class="resultline" style="margin-top:0"><b>V·ªã tr√≠ c·ªßa b·∫°n:</b> B·∫°n ƒëang ·ªü h·∫°ng <b>#${myIndex+1}</b> trong b·∫£ng ƒëang hi·ªÉn th·ªã.</div>`
    : `<div class="resultline" style="margin-top:0">B·∫°n ch∆∞a n·∫±m trong top ƒëang hi·ªÉn th·ªã.</div>`;

  const body = top.map((r, index)=>{
    const rk = index + 1;
    const medal = rk === 1 ? `<span class="medal m1">ü•á</span>` :
                  rk === 2 ? `<span class="medal m2">ü•à</span>` :
                  rk === 3 ? `<span class="medal m3">ü•â</span>` : "";
    const trClass = rk === 1 ? "toprow1" : rk === 2 ? "toprow2" : rk === 3 ? "toprow3" : "";
    const isMe = myUserId && String(r.user_id) === String(myUserId);
    const rowClass = `${trClass} ${isMe ? "meRow" : ""}`.trim();

    const nameCell = isMe
      ? `<span class="meName">${escapeHtml(r.username||"(user)")}</span><span class="meBadge">B·∫°n</span>`
      : `${escapeHtml(r.username||"(user)")}`;

    const score10 = Number(r.score10||0);
    const pct = Math.round(score10 * 10);

    return `
      <tr class="${rowClass}">
        <td><span class="rankpill">${medal}<span>${rk}</span></span></td>
        <td>${nameCell}${String(r.role||"").toLowerCase()==="admin" ? ` <span style="color:#2563eb;font-weight:900">admin</span>` : ``}</td>
        <td><b>${score10.toFixed(1)}</b>/10</td>
        <td>${pct}%</td>
      </tr>
    `;
  }).join("");

  lb.innerHTML = `
    <div class="row1">
      <p class="vi">B·∫£ng x·∫øp h·∫°ng</p>
      <div class="meta"><span class="idx">TOP</span></div>
    </div>
    <div class="muted" style="margin-top:6px">
      X·∫øp theo <b>ƒëi·ªÉm cao nh·∫•t</b> c·ªßa m·ªói <b>ng∆∞·ªùi</b>. (T√≠nh theo DB)
    </div>
    <div style="margin-top:10px">${myRankLine}</div>
    <div style="overflow:auto; margin-top:10px;">
      <table class="table">
        <thead><tr><th>#</th><th>T√™n</th><th>ƒêi·ªÉm</th><th>%</th></tr></thead>
        <tbody>${body}</tbody>
      </table>
    </div>
  `;
}

/* ================== GRADING (for wrong-details only) ================== */
function normalizeForCompare(s) {
  let t = String(s||"").trim().toLowerCase();
  t = t.replace(/ƒë/g, "d");
  try { t = t.normalize("NFKD").replace(/[\u0300-\u036f]/g, ""); } catch {}
  t = t.replace(/[‚Äú‚Äù"']/g, " ");
  t = t.replace(/[^a-z0-9\s\-,.]/g, " ");
  t = t.replace(/\s+/g, " ").trim();
  return t;
}
function looseEq(user, expected){
  const u = normalizeForCompare(user);
  const a = normalizeForCompare(expected);
  if (!u || !a) return false;
  if (u === a) return true;
  if (u.replace(/\s/g,"") === a.replace(/\s/g,"")) return true;
  return false;
}
function pointsOf(q){
  const p = Number(q.points ?? 0);
  return (isFinite(p) && p > 0) ? p : 1;
}
function qTypeOf(q){
  return String(q.q_type || "essay").toLowerCase();
}
function acceptedAnswersFromQuestion(q){
  const out = [];
  if(Array.isArray(q.answers)) out.push(...q.answers);
  const seen = new Set();
  const uniq = [];
  for(const x of out){
    const k = normalizeForCompare(x);
    if(!k) continue;
    if(seen.has(k)) continue;
    seen.add(k);
    uniq.push(String(x).trim());
  }
  return uniq;
}
function toMcqNumber(v){
  if(v==null) return 0;
  if(typeof v === "number"){
    const n = Math.floor(v);
    return (n>=1 && n<=4) ? n : 0;
  }
  const s = String(v).trim();
  if(/^[1-4]$/.test(s)) return Number(s);
  const u = s.toUpperCase();
  if(u==="A") return 1;
  if(u==="B") return 2;
  if(u==="C") return 3;
  if(u==="D") return 4;
  return 0;
}
function mcqCorrectOf(q){
  const m = q.meta || {};
  if(Number(m.correct)>=1 && Number(m.correct)<=4) return Number(m.correct);
  const ans = String(m.answer || "").trim();
  if(ans){
    const n = toMcqNumber(ans);
    if(n) return n;
  }
  return 0;
}
function mcqOptionsOf(q){
  const m = q.meta || {};
  if(Array.isArray(m.options)) return m.options;
  return ["","","",""];
}
function fmtMcqChoice(n, opts){
  const L = "ABCD";
  const idx = (Number(n||0)-1);
  const t = (idx>=0 && idx<4) ? String(opts[idx]||"") : "";
  return idx>=0 ? `${L[idx]}${t ? `. ${t}` : ""}` : "(tr·ªëng)";
}
function gradeOne(q, userAnswer){
  const t = qTypeOf(q);
  const max = pointsOf(q);

  if(t === "mcq1" || t === "mcq"){
    const user = toMcqNumber(userAnswer);
    const correct = mcqCorrectOf(q);
    const ok = (user>0 && correct>0 && user === correct);
    const opts = mcqOptionsOf(q);
    const expected = correct ? `ƒê√°p √°n ƒë√∫ng: ${fmtMcqChoice(correct, opts)}` : "ƒê√°p √°n ƒë√∫ng: (ch∆∞a set)";
    const userFmt = user ? `B·∫°n ch·ªçn: ${fmtMcqChoice(user, opts)}` : "B·∫°n ch·ªçn: (tr·ªëng)";
    return { ok, expected, userFmt, earned: ok ? max : 0, max };
  }

  if(t === "tf4"){
    const keys = Array.isArray(q.meta?.keys) ? q.meta.keys : [true,false,false,false];
    const stmts = Array.isArray(q.meta?.statements) ? q.meta.statements : ["","","",""];
    const user = Array.isArray(userAnswer) ? userAnswer : [null,null,null,null];

    let correctCount = 0;
    for(let i=0;i<4;i++){
      if((user[i] === true || user[i] === false) && user[i] === Boolean(keys[i])) correctCount++;
    }
    const rule = q.meta?.rule?.byCorrectCount || { "0":0, "1":0.25, "2":0.5, "3":0.5, "4":1 };
    const mult = Number(rule[String(correctCount)] ?? 0) || 0;

    const earned = Math.round(max * mult * 100) / 100;
    const ok = (correctCount === 4);

    const ufmt = Array.isArray(user)
      ? user.map(x => x===true ? "ƒê√∫ng" : x===false ? "Sai" : "‚Äî").join(" | ")
      : "(tr·ªëng)";
    const kfmt = keys.map(x => x ? "ƒê√∫ng" : "Sai").join(" | ");
    const expected = `Key: ${kfmt} ‚Ä¢ ƒê√∫ng ${correctCount}/4 (ƒëi·ªÉm: ${earned}/${max})`;

    return { ok, expected, userFmt: `B·∫°n ch·ªçn: ${ufmt}`, earned, max, stmts, keys, user };
  }

  // essay / short4
  const user = String(userAnswer || "").trim();
  const acc = acceptedAnswersFromQuestion(q);
  const expected = acc[0] ? `ƒê√°p √°n ƒë√∫ng: ${acc[0]}` : "ƒê√°p √°n ƒë√∫ng: (ch∆∞a set)";
  if(!user) return { ok:false, expected, userFmt:"B·∫°n tr·∫£ l·ªùi: (tr·ªëng)", earned: 0, max };

  let ok = false;
  for(const a of acc){
    if(looseEq(user, a)){ ok = true; break; }
  }
  return { ok, expected, userFmt:`B·∫°n tr·∫£ l·ªùi: ${user}`, earned: ok ? max : 0, max };
}

/* ================== COMMENTS (gi·ªØ nguy√™n logic c≈©) ================== */
const DISCUSS_MAX = 120;
let DISC = { tree:[], openReply:"" };

function discussionHtml(username){
  return `
    <div class="row1">
      <p class="vi">Th·∫£o lu·∫≠n</p>
      <div class="meta"><span class="idx">üí¨</span></div>
    </div>

    <div style="margin-top:10px; display:grid; gap:10px;">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:#6b7280;font-weight:800;font-size:.85rem">
        <div><b>Vi·∫øt b√¨nh lu·∫≠n</b> <span class="muted">(T√™n: <b>${escapeHtml(username||"‚Äî")}</b>)</span></div>
        <div><span id="rootCount">0</span>/${DISCUSS_MAX}</div>
      </div>
      <textarea id="rootInput" class="qBox" style="min-height:86px;border-style:solid;border-width:2px;background:var(--soft)" maxlength="${DISCUSS_MAX}" placeholder="Nh·∫≠p b√¨nh lu·∫≠n..."></textarea>
      <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-primary" id="btnPostRoot" style="justify-content:center;">G·ª≠i</button>
      </div>
      <div id="discussList" style="display:grid;gap:12px"></div>
    </div>
  `;
}
function isAdmin(me){
  return !!me && (String(me.role||"").toLowerCase()==="admin" || String(me.username||"").toLowerCase()==="tuankhoi");
}
function buildTree(rows){
  const byId = new Map();
  rows.forEach(r=>{
    byId.set(String(r.id), {
      id: String(r.id),
      parent_id: (r.parent_id==null ? "" : String(r.parent_id)),
      author: String(r.author||""),
      created_at: r.created_at,
      createdAtMs: toMs(r.created_at),
      text: String(r.text||""),
      pinned: !!r.pinned,
      pinnedAtMs: r.pinned_at ? toMs(r.pinned_at) : 0,
      replies: []
    });
  });

  const roots = [];
  for(const node of byId.values()){
    if(node.parent_id && byId.has(node.parent_id)){
      byId.get(node.parent_id).replies.push(node);
    }else{
      roots.push(node);
    }
  }

  roots.sort((a,b)=>{
    if(a.pinned !== b.pinned) return a.pinned ? -1 : 1;
    if(a.pinned && b.pinned && a.pinnedAtMs !== b.pinnedAtMs) return b.pinnedAtMs - a.pinnedAtMs;
    return a.createdAtMs - b.createdAtMs;
  });

  roots.forEach(r=>r.replies.sort((a,b)=>{
    if(a.pinned !== b.pinned) return a.pinned ? -1 : 1;
    if(a.pinned && b.pinned && a.pinnedAtMs !== b.pinnedAtMs) return b.pinnedAtMs - a.pinnedAtMs;
    return a.createdAtMs - b.createdAtMs;
  }));

  return roots;
}
function canDeleteComment(c, me){
  if(isAdmin(me)) return true;
  const a = String(c.author||"").trim().toLowerCase();
  const m = String(me?.username||"").trim().toLowerCase();
  return !!m && a === m;
}
async function loadComments(){
  const rows = await sbGet(
    `comments?quiz_id=eq.${quizId}` +
    `&select=id,parent_id,author,text,created_at,pinned,pinned_at` +
    `&order=pinned.desc,pinned_at.desc,created_at.asc&limit=400`
  );
  DISC.tree = buildTree(Array.isArray(rows)?rows:[]);
}
async function addComment({ text, parent_id, author }){
  const payload = {
    quiz_id: quizId,
    parent_id: (parent_id==null ? null : Number(parent_id)),
    author: author || "",
    text: text || ""
  };
  const res = await sbPost("comments", payload, {preferReturn:true});
  return Array.isArray(res) ? res[0] : res;
}
async function deleteComment(id){
  await sbDelete(`comments?id=eq.${encodeURIComponent(id)}`);
}
async function togglePinComment({ me, commentId, pin }){
  const token = getToken();
  if(!token) { toast("Admin c·∫ßn ƒëƒÉng nh·∫≠p"); return; }
  try{
    const out = await sbRpc(RPC.pinComment, { p_token: token, p_comment_id: Number(commentId), p_pin: !!pin });
    if(!out || out.ok!==true) throw new Error(out?.error || "Pin l·ªói");
    toast(pin ? "ƒê√£ pin" : "ƒê√£ b·ªè pin");
    await loadComments();
    renderDiscussion(me);
  }catch(e){
    toast(e?.message || "Pin l·ªói");
  }
}
function renderDiscussion(me){
  const discussionEl = document.getElementById("discussion");
  const list = document.getElementById("discussList");
  if(!list) return;

  const tree = DISC.tree || [];
  if(!tree.length){
    list.innerHTML = `<div class="muted">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</div>`;
    return;
  }

  list.innerHTML = "";
  tree.forEach(root=>{
    const wrap = document.createElement("div");
    wrap.className = "qBox";
    wrap.style.boxShadow = "none";

    const showAdminBadge = (String(root.author||"").trim().toLowerCase() === "tuankhoi");
    const adminTag = showAdminBadge ? `<span style="padding:4px 8px;border-radius:999px;font-weight:950;font-size:.78rem;background:rgba(37,99,235,.12);border:1px solid rgba(37,99,235,.35);color:var(--admin)">ADMIN</span>` : ``;
    const pinTag = root.pinned ? `<span style="padding:4px 8px;border-radius:999px;font-weight:950;font-size:.78rem;background:rgba(245,158,11,.14);border:1px solid rgba(245,158,11,.35);color:#92400e">üìå PIN</span>` : ``;

    const delBtn = canDeleteComment(root, me)
      ? `<button class="miniBtn" style="background:rgba(220,38,38,.08);border-color:rgba(220,38,38,.25);color:#991b1b" data-del="${escapeHtml(root.id)}">X√≥a</button>` : ``;

    const pinBtn = isAdmin(me)
      ? `<button class="miniBtn" style="background:rgba(245,158,11,.10);border-color:rgba(245,158,11,.30);color:#92400e" data-pin="${escapeHtml(root.id)}" data-pv="${root.pinned?0:1}">
          ${root.pinned ? "B·ªè pin" : "üìå Pin"}
        </button>` : ``;

    wrap.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
        <div style="font-weight:950;color:#6b7280;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span>${escapeHtml(root.author||"‚Äî")}</span>
          ${adminTag}
          ${pinTag}
        </div>
      </div>
      <div style="color:#111827;font-weight:750;line-height:1.35;white-space:pre-wrap;word-break:break-word">${escapeHtml(root.text||"")}</div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;justify-content:flex-end">
        <button class="miniBtn" data-reply="${escapeHtml(root.id)}">Tr·∫£ l·ªùi</button>
        ${pinBtn}
        ${delBtn}
      </div>
      <div style="margin-top:6px;text-align:right;color:#6b7280;font-weight:800;font-size:.82rem">${escapeHtml(fmtTs(root.created_at))}</div>

      <div class="replySlot" data-slot="${escapeHtml(root.id)}"></div>
      <div class="replyWrap" data-replies="${escapeHtml(root.id)}" style="margin-top:10px;margin-left:14px;padding-left:12px;border-left:6px solid #e5e7eb;display:grid;gap:10px"></div>
    `;
    list.appendChild(wrap);

    const slot = wrap.querySelector(`[data-slot="${CSS.escape(String(root.id))}"]`);
    if(slot && DISC.openReply === String(root.id)){
      slot.innerHTML = `
        <div style="margin-top:10px;display:grid;gap:10px">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:#6b7280;font-weight:800;font-size:.85rem">
            <div><b>Tr·∫£ l·ªùi</b></div>
            <div><span data-ct>0</span>/${DISCUSS_MAX}</div>
          </div>
          <textarea class="qBox" style="min-height:72px;border-style:solid;border-width:2px;background:var(--soft)" maxlength="${DISCUSS_MAX}" placeholder="Nh·∫≠p tr·∫£ l·ªùi..."></textarea>
          <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-primary" data-sendreply="${escapeHtml(root.id)}" style="justify-content:center;">G·ª≠i</button>
            <button class="btn" data-cancelreply style="justify-content:center;">H·ªßy</button>
          </div>
        </div>
      `;
    }

    const rWrap = wrap.querySelector(`[data-replies="${CSS.escape(String(root.id))}"]`);
    if(rWrap){
      rWrap.innerHTML = "";
      (root.replies||[]).forEach(r=>{
        const item = document.createElement("div");
        item.className = "qBox";
        item.style.margin = "0";
        item.style.boxShadow = "none";

        const rPinTag = r.pinned ? `<span style="padding:4px 8px;border-radius:999px;font-weight:950;font-size:.78rem;background:rgba(245,158,11,.14);border:1px solid rgba(245,158,11,.35);color:#92400e">üìå PIN</span>` : ``;

        const rPinBtn = isAdmin(me)
          ? `<button class="miniBtn" style="background:rgba(245,158,11,.10);border-color:rgba(245,158,11,.30);color:#92400e" data-pin="${escapeHtml(r.id)}" data-pv="${r.pinned?0:1}">
              ${r.pinned ? "B·ªè pin" : "üìå Pin"}
            </button>` : ``;

        const rDelBtn = canDeleteComment(r, me)
          ? `<button class="miniBtn" style="background:rgba(220,38,38,.08);border-color:rgba(220,38,38,.25);color:#991b1b" data-del="${escapeHtml(r.id)}">X√≥a</button>` : ``;

        item.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
            <div style="font-weight:950;color:#6b7280;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span>${escapeHtml(r.author||"‚Äî")}</span>
              ${rPinTag}
            </div>
          </div>
          <div style="color:#111827;font-weight:750;line-height:1.35;white-space:pre-wrap;word-break:break-word">${escapeHtml(r.text||"")}</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;justify-content:flex-end">
            ${rPinBtn}
            ${rDelBtn}
          </div>
          <div style="margin-top:6px;text-align:right;color:#6b7280;font-weight:800;font-size:.82rem">${escapeHtml(fmtTs(r.created_at))}</div>
        `;
        rWrap.appendChild(item);
      });
    }
  });

  discussionEl.onclick = async (e)=>{
    const pinBtn = e.target.closest("[data-pin]");
    if(pinBtn){
      const id = pinBtn.getAttribute("data-pin");
      const pv = pinBtn.getAttribute("data-pv");
      await togglePinComment({ me, commentId: id, pin: pv==="1" });
      return;
    }

    const delBtn = e.target.closest("[data-del]");
    if(delBtn){
      const id = String(delBtn.getAttribute("data-del")||"");
      if(!id) return;
      if(!confirm("X√≥a b√¨nh lu·∫≠n n√†y?")) return;
      try{
        await deleteComment(id);
        await loadComments();
        renderDiscussion(me);
        toast("ƒê√£ x√≥a");
      }catch(_err){
        toast("X√≥a l·ªói (c√≥ th·ªÉ do RLS)");
      }
      return;
    }

    const replyBtn = e.target.closest("[data-reply]");
    if(replyBtn){
      const rootId = String(replyBtn.getAttribute("data-reply")||"");
      DISC.openReply = (DISC.openReply === rootId) ? "" : rootId;
      renderDiscussion(me);
      const slot = discussionEl.querySelector(`[data-slot="${CSS.escape(rootId)}"]`);
      const ta = slot ? slot.querySelector("textarea") : null;
      if(ta) ta.focus();
      return;
    }

    const cancelBtn = e.target.closest("[data-cancelreply]");
    if(cancelBtn){
      DISC.openReply = "";
      renderDiscussion(me);
      return;
    }

    const sendBtn = e.target.closest("[data-sendreply]");
    if(sendBtn){
      const rootId = String(sendBtn.getAttribute("data-sendreply")||"");
      const slot = discussionEl.querySelector(`[data-slot="${CSS.escape(rootId)}"]`);
      const ta = slot ? slot.querySelector("textarea") : null;
      const text = ta ? String(ta.value||"").trim() : "";
      if(!text || text.length > DISCUSS_MAX){ toast("T·ªëi ƒëa 120 k√Ω t·ª±"); return; }

      const author = String(me?.username || "").trim();
      if(!author){ toast("Thi·∫øu t√™n"); return; }

      DISC.openReply = "";
      renderDiscussion(me);

      try{
        await addComment({ text, parent_id: rootId, author });
        await loadComments();
        renderDiscussion(me);
        toast("ƒê√£ g·ª≠i");
      }catch(_err){
        toast("G·ª≠i l·ªói (c√≥ th·ªÉ do RLS)");
      }
      return;
    }
  };

  discussionEl.oninput = (e)=>{
    const ta = e.target;
    if(!(ta && ta.tagName === "TEXTAREA")) return;
    const form = ta.closest("div");
    if(!form) return;
    const ct = form.querySelector("[data-ct]");
    if(ct) ct.textContent = String((ta.value||"").length);
  };
}

/* ================== DATA LOADERS ================== */
async function loadMeIfAny(){
  const token = getToken();
  if(!token) return null;
  try{
    const out = await sbRpc(RPC.me, { p_token: token });
    if(!out || out.ok!==true) return null;
    const m = out.me || out.user || out.data || null;
    if(m && m.id && !m.user_id) m.user_id = m.id;
    return m;
  }catch(_e){
    return null;
  }
}
async function loadQuizMeta(){
  const out = await sbRpc(RPC.quizMeta, { p_quiz_id: quizId });
  if(!out || out.ok!==true) throw new Error(out?.error || "Kh√¥ng load quiz meta");
  const q = out.quiz || {};
  return { title: q.title || "", sub: q.sub || "" };
}
async function loadAttemptPublic(attemptId, token){
  const out = await sbRpc(RPC.attemptPublic, { p_attempt_id: attemptId, p_token: token || "" });
  if(!out || out.ok!==true) throw new Error(out?.error || "Kh√¥ng load attempt");
  return out;
}
async function loadLeaderboard(){
  const out = await sbRpc(RPC.leaderboard, { p_quiz_id: quizId, p_limit: 50 });
  if(Array.isArray(out)) return out;
  if(out && Array.isArray(out.items)) return out.items;
  return [];
}
async function loadQuestionsPublic(){
  const out = await sbRpc(RPC.questionsPublic, { p_quiz_id: quizId });
  if(!out || out.ok!==true) return [];
  return Array.isArray(out.items) ? out.items : [];
}

/* ================== WRONG LIST BUILD + DETAIL UI ================== */
let QUESTIONS = [];
let QBYID = new Map();
let WRONG_ITEMS = []; // [{id, idx, prompt, q, g, userAnswerRaw}]
let CAN_VIEW_DETAILS = false;

function pickAnswer(answersMap, qid){
  if(!answersMap) return undefined;
  const k1 = String(qid);
  if(Object.prototype.hasOwnProperty.call(answersMap, k1)) return answersMap[k1];
  if(Object.prototype.hasOwnProperty.call(answersMap, qid)) return answersMap[qid];
  return answersMap[k1];
}
function imgOf(q){
  const m = q.meta || {};
  return String(m.image_url || m.image || m.img || "").trim();
}
function buildWrongFromAttempt({ perList, answersMap }){
  WRONG_ITEMS = [];
  const perById = new Map();
  if(Array.isArray(perList)){
    for(const p of perList){
      if(p && p.id!=null) perById.set(String(p.id), p);
    }
  }

  QUESTIONS.forEach((q, idx0)=>{
    const id = String(q.id);
    const per = perById.get(id);
    const okFromPer = (per && typeof per.ok === "boolean") ? per.ok : null;

    const ua = pickAnswer(answersMap, q.id);
    const g = gradeOne(q, ua);

    const ok = (okFromPer === null) ? !!g.ok : !!okFromPer;

    if(!ok){
      const prompt = String(q.prompt || "").trim() || `#${q.id}`;
      WRONG_ITEMS.push({
        id: q.id,
        idx: idx0 + 1,
        prompt,
        q,
        g,
        userAnswerRaw: ua
      });
    }
  });
}

function renderWrongList(){
  wrongBody.innerHTML = "";

  if(!CAN_VIEW_DETAILS){
    wrongBody.innerHTML = `<div class="resultline">Kh√¥ng c√≥ quy·ªÅn xem chi ti·∫øt ƒë√°p √°n cho attempt n√†y.</div>`;
    return;
  }

  if(!WRONG_ITEMS.length){
    wrongBody.innerHTML = `<div class="resultline"><span class="oktxt">B·∫°n kh√¥ng sai c√¢u n√†o ‚úÖ</span></div>`;
    return;
  }

  WRONG_ITEMS.forEach((w)=>{
    const wrap = document.createElement("div");
    wrap.className = "wrongRow";

    const t = qTypeOf(w.q);
    const typeLabel = (t==="mcq1"||t==="mcq") ? "Tr·∫Øc nghi·ªám" : (t==="tf4") ? "ƒê√∫ng/Sai" : (t==="short4") ? "4 √¥" : "T·ª± lu·∫≠n";

    const uline = (w.g && w.g.userFmt) ? w.g.userFmt : "B·∫°n tr·∫£ l·ªùi: (tr·ªëng)";
    const eline = (w.g && w.g.expected) ? w.g.expected : "ƒê√°p √°n ƒë√∫ng: (?)";

    wrap.innerHTML = `
      <div class="wrongLeft">
        <div class="wrongTitle">
          <span class="badge bad">SAI</span>
          <span class="badge" style="margin-left:8px">${escapeHtml(typeLabel)}</span>
          <span class="badge" style="margin-left:8px">C√¢u ${Number(w.idx||0)}</span>
        </div>
        <div class="wrongSub" style="margin-top:8px">${escapeHtml(w.prompt)}</div>
        <div class="wrongSub" style="margin-top:8px">${escapeHtml(uline)}</div>
        <div class="wrongSub" style="margin-top:4px">${escapeHtml(eline)}</div>
      </div>
      <div class="wrongRight">
        <button class="miniBtn" data-detail="${escapeHtml(String(w.id))}">Chi ti·∫øt</button>
      </div>
    `;
    wrongBody.appendChild(wrap);

    wrap.querySelector(`[data-detail="${CSS.escape(String(w.id))}"]`).onclick = ()=>{
      openDetail(renderQuestionDetailHtml(w.q, w.g, w.userAnswerRaw));
    };

    applyMath(wrap);
  });

  applyMath(wrongBody);
}

function renderQuestionDetailHtml(q, g, userAnswerRaw){
  const t = qTypeOf(q);
  const img = imgOf(q);
  const prompt = String(q.prompt||"").trim();

  let body = `
    <div class="qBox">
      <div class="qPrompt">${escapeHtml(prompt || "(tr·ªëng)")}</div>
      ${img ? `<img class="qImg" src="${escapeHtml(img)}" alt="image">` : ``}
    </div>

    <div class="kv">
      <div class="kvRow">
        <div class="kvKey">K·∫øt qu·∫£</div>
        <div class="kvVal">${g.ok ? `<span class="badge ok">ƒê√öNG</span>` : `<span class="badge bad">SAI</span>`}</div>
      </div>
      <div class="kvRow">
        <div class="kvKey">B·∫°n l√†m</div>
        <div class="kvVal">${escapeHtml(g.userFmt || "‚Äî")}</div>
      </div>
      <div class="kvRow">
        <div class="kvKey">ƒê√°p √°n ƒë√∫ng</div>
        <div class="kvVal">${escapeHtml(g.expected || "‚Äî")}</div>
      </div>
    </div>
  `;

  if(t==="mcq1" || t==="mcq"){
    const opts = mcqOptionsOf(q);
    const userN = toMcqNumber(userAnswerRaw);
    const corN = mcqCorrectOf(q);
    const L = "ABCD";
    body += `
      <div class="qBox" style="margin-top:12px">
        <div style="font-weight:1000">C√°c l·ª±a ch·ªçn</div>
        <div class="optList">
          ${[1,2,3,4].map(n=>{
            const text = String(opts[n-1]||"");
            const isCor = (corN===n);
            const isUser = (userN===n);
            const cls = isCor ? "good" : (isUser && !isCor) ? "bad" : "";
            const tag = isCor ? `<span class="badge ok">ƒê√∫ng</span>` : isUser ? `<span class="badge bad">B·∫°n ch·ªçn</span>` : ``;
            return `
              <div class="optItem ${cls}">
                <b>${L[n-1]}.</b> ${escapeHtml(text || "(tr·ªëng)")}
                ${tag ? `<div style="margin-top:6px">${tag}</div>` : ``}
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `;
  }

  if(t==="tf4"){
    const stmts = Array.isArray(q.meta?.statements) ? q.meta.statements : ["","","",""];
    const keys = Array.isArray(q.meta?.keys) ? q.meta.keys : [true,false,false,false];
    const user = Array.isArray(userAnswerRaw) ? userAnswerRaw : [null,null,null,null];

    body += `
      <div class="qBox" style="margin-top:12px">
        <div style="font-weight:1000">ƒê√∫ng/Sai (4 √Ω)</div>
        <div class="optList">
          ${[0,1,2,3].map(i=>{
            const st = String(stmts[i]||"").trim();
            const k = !!keys[i];
            const u = user[i];
            const uTxt = (u===true) ? "ƒê√∫ng" : (u===false) ? "Sai" : "‚Äî";
            const kTxt = k ? "ƒê√∫ng" : "Sai";
            const ok = (u===true || u===false) ? (u===k) : false;
            const cls = ok ? "good" : "bad";
            return `
              <div class="optItem ${cls}">
                <b>${"ABCD"[i]}.</b> ${escapeHtml(st || "(tr·ªëng)")}
                <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                  <span class="badge">${escapeHtml("B·∫°n: " + uTxt)}</span>
                  <span class="badge ok">${escapeHtml("Key: " + kTxt)}</span>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `;
  }

  if(t==="essay" || t==="short4"){
    const acc = acceptedAnswersFromQuestion(q);
    const ua = String(userAnswerRaw ?? "").trim();
    body += `
      <div class="qBox" style="margin-top:12px">
        <div style="font-weight:1000">ƒê√°p √°n</div>
        <div class="muted" style="margin-top:6px">C√°c ƒë√°p √°n ch·∫•p nh·∫≠n:</div>
        <div class="optList">
          ${(acc.length?acc:["(ch∆∞a set)"]).map(a=>`<div class="optItem good">${escapeHtml(a)}</div>`).join("")}
        </div>
        <div class="resultline">
          <b>B·∫°n tr·∫£ l·ªùi:</b> ${escapeHtml(ua || "(tr·ªëng)")}
        </div>
      </div>
    `;
  }

  return body;
}

/* ================== BOOT ================== */
(async function boot(){
  if(!quizId){
    setTopbar({ title:"K·∫øt qu·∫£", sub:"Sai link (thi·∫øu ?quiz=abcde)", username:"‚Äî", correctCount:0, totalCount:0, progressPercent:0 });
    document.getElementById("summary").innerHTML = `<div class="muted">Sai link.</div>`;
    document.getElementById("wrongCard").style.display="none";
    document.getElementById("lb").innerHTML = `<div class="muted">Sai link.</div>`;
    document.getElementById("discussion").innerHTML = `<div class="muted">Sai link.</div>`;
    return;
  }

  const token = getToken();
  const fallbackName = loadName();

  let me = await loadMeIfAny();
  let username = me?.username || fallbackName || "‚Äî";
  let myUserId = me?.user_id || "";

  let qTitle="", qSub="";
  try{
    const qm = await loadQuizMeta();
    qTitle = qm.title || "";
    qSub = qm.sub || "";
  }catch{}

  // 1) ∆∞u ti√™n load theo attemptId t·ª´ DB (ƒë√∫ng y√™u c·∫ßu: ƒëi·ªÉm l·∫•y theo DB)
  let aScore10 = 0, aCorrect = 0, aTotal = 0, aCreatedAt = "";
  let detailsJson = {};
  CAN_VIEW_DETAILS = false;

  if(attemptId){
    try{
      const out = await loadAttemptPublic(attemptId, token);
      const a = out.attempt || {};
      const u = out.user || {};
      const q = out.quiz || {};

      // topbar meta ∆∞u ti√™n t·ª´ DB
      qTitle = q.title || qTitle || "K·∫øt qu·∫£";
      qSub = q.sub || qSub || "";

      username = u.username || username || "‚Äî";
      // myUserId ch·ªâ d√πng highlight leaderboard, v·∫´n l·∫•y t·ª´ me
      if(me?.user_id) myUserId = me.user_id;

      aScore10 = Number(a.score10||0);
      aCorrect = Number(a.correct_count||0);
      aTotal = Number(a.total_count||0);
      aCreatedAt = a.created_at || "";

      CAN_VIEW_DETAILS = !!out.can_view_details;
      detailsJson = (a.details_json && typeof a.details_json === "object") ? a.details_json : {};
    }catch(e){
      toast("Kh√¥ng load ƒë∆∞·ª£c attempt: " + (e?.message || "error"));
    }
  }else{
    // fallback: n·∫øu kh√¥ng c√≥ attempt param, d√πng cache sessionStorage (n·∫øu c√≥)
    try{
      const cached = JSON.parse(sessionStorage.getItem(`tk_last_result::${quizId}`)||"null");
      if(cached && cached.result){
        aScore10 = Number(cached.result.score10||0);
        aCorrect = Number(cached.result.fullCorrectCount||cached.result.correctCount||0);
        aTotal = Number(cached.result.totalCount||0);
        detailsJson = (cached.result && typeof cached.result === "object") ? cached.result : {};
        username = cached?.me?.username || username;
        CAN_VIEW_DETAILS = true;
      }
    }catch{}
  }

  // counts/percent theo DB
  const prog = aTotal ? (aCorrect/aTotal)*100 : (aScore10*10);
  setTopbar({
    title: qTitle || "K·∫øt qu·∫£",
    sub: qSub || "",
    username: username || "‚Äî",
    correctCount: aCorrect,
    totalCount: aTotal,
    progressPercent: prog
  });

  // n·∫øu xem ƒë∆∞·ª£c chi ti·∫øt: build wrong list t·ª´ questions + (per/answers) trong details_json
  let wrongCountForUI = Math.max(0, (aTotal||0) - (aCorrect||0));

  if(CAN_VIEW_DETAILS){
    try{
      QUESTIONS = await loadQuestionsPublic();
      QBYID = new Map(QUESTIONS.map(q=>[String(q.id), q]));
      const perList = Array.isArray(detailsJson?.per) ? detailsJson.per : [];
      const answersMap = (detailsJson && detailsJson.answers && typeof detailsJson.answers==="object") ? detailsJson.answers : null;

      // N·∫øu kh√¥ng c√≥ answers/per => kh√¥ng build ƒë·ªÉ tr√°nh ‚Äúg√°n tr·ªëng‚Äù
      if(QUESTIONS.length && (perList.length || answersMap)){
        buildWrongFromAttempt({ perList, answersMap });
        wrongCountForUI = WRONG_ITEMS.length;
        renderWrongList();
      }else{
        WRONG_ITEMS = [];
        wrongBody.innerHTML = `<div class="resultline">
          Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt (answers/per) trong attempt ƒë·ªÉ hi·ªÉn th·ªã c√¢u sai.
        </div>`;
      }
    }catch(e){
      WRONG_ITEMS = [];
      wrongBody.innerHTML = `<div class="resultline">L·ªói load c√¢u h·ªèi: ${escapeHtml(e?.message||"")}</div>`;
    }
  }

  // summary + wrong card
  renderSummaryCard({
    score10: aScore10,
    correctCount: aCorrect,
    totalCount: aTotal,
    wrongCount: wrongCountForUI,
    createdAt: aCreatedAt,
    canViewDetails: CAN_VIEW_DETAILS
  });
  renderWrongCard(wrongCountForUI, CAN_VIEW_DETAILS);

  // leaderboard
  try{
    const lbRows = await loadLeaderboard();
    renderLeaderboard(lbRows, myUserId, "");
  }catch(e){
    renderLeaderboard([], "", e?.message || "RPC error");
  }

  // discussion
  const discussionEl = document.getElementById("discussion");
  discussionEl.innerHTML = discussionHtml(username || fallbackName || "‚Äî");

  const rootInput = document.getElementById("rootInput");
  const rootCount = document.getElementById("rootCount");
  const btnPostRoot = document.getElementById("btnPostRoot");

  rootInput.addEventListener("input", ()=>{ rootCount.textContent = String((rootInput.value||"").length); }, {passive:true});

  const meForUI = me || { username: username || fallbackName || "", role:"user" };

  try{
    await loadComments();
    renderDiscussion(meForUI);
  }catch(e){
    discussionEl.innerHTML += `<div class="muted" style="margin-top:10px">
      Kh√¥ng load ƒë∆∞·ª£c comments: <b>${escapeHtml(e?.message || String(e))}</b>
    </div>`;
  }

  btnPostRoot.addEventListener("click", async ()=>{
    const text = String(rootInput.value||"").trim();
    if(!text || text.length > DISCUSS_MAX){ toast("T·ªëi ƒëa 120 k√Ω t·ª±"); return; }
    const author = String(meForUI.username || "").trim();
    if(!author){ toast("Thi·∫øu t√™n"); return; }

    rootInput.value = ""; rootCount.textContent = "0";
    try{
      await addComment({ text, parent_id:null, author });
      await loadComments();
      renderDiscussion(meForUI);
      toast("ƒê√£ g·ª≠i");
    }catch(_e){
      toast("G·ª≠i l·ªói (c√≥ th·ªÉ do RLS)");
    }
  });

  // bind wrongCard click
  const wrongCard = document.getElementById("wrongCard");
  if(wrongCard && CAN_VIEW_DETAILS){
    wrongCard.addEventListener("click", ()=> openWrongPopup());
  }
})();
</script>
</body>
</html>
