<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>K·∫øt qu·∫£</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg1:#ffecd2; --bg2:#fcb69f;
      --card:#fff; --text:#1f2937; --muted:#6b7280;
      --primary:#7c3aed; --ok:#16a34a; --bad:#dc2626;
      --border:#e5e7eb;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --radius:18px;
      --admin:#2563eb;
      --pin:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0;
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
                  linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 100%);
      overflow:hidden;
      touch-action:pan-x pan-y;
    }
    #shell{height:100vh;overflow:auto;-webkit-overflow-scrolling:touch;padding:12px 0 110px}
    .wrap{max-width:980px;margin:0 auto;padding:0 14px}

    .topbar{
      margin-top:10px;background:rgba(255,255,255,.86);
      border:1px solid rgba(229,231,235,.9);border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:14px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .titlebox{display:flex;gap:10px;align-items:center;flex:1 1 360px;min-width:240px}
    .logo{
      width:42px;height:42px;border-radius:16px;
      background:linear-gradient(135deg,#a78bfa,#fb7185);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;box-shadow:0 10px 22px rgba(124,58,237,.18);
      user-select:none;
    }
    .titles h1{font-size:1.02rem;margin:0;font-weight:800}
    .titles .tiny{margin-top:3px;font-size:.86rem;color:var(--muted);font-weight:650}

    .card{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;margin:12px 0;
    }
    .row1{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .vi{margin:0;font-weight:900;font-size:1.04rem;line-height:1.25}
    .idx{
      font-size:.78rem;font-weight:900;padding:6px 10px;border-radius:999px;
      background:#eff6ff;color:#1d4ed8;border:1px solid #dbeafe;white-space:nowrap;
    }
    .muted{color:var(--muted);font-weight:650}
    .pill{
      background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:8px 12px;
      font-weight:800;font-size:.9rem;color:#374151;white-space:nowrap;
      display:inline-flex;gap:6px;align-items:center;
    }
    .pill strong{color:var(--primary)}
    .oktxt{color:var(--ok);font-weight:1000}
    .badtxt{color:var(--bad);font-weight:1000}

    .btn{
      border:0;cursor:pointer;border-radius:999px;padding:10px 14px;
      font-weight:900;font-size:.9rem;
      display:inline-flex;align-items:center;gap:8px;
      box-shadow:0 12px 24px rgba(0,0,0,.12);
      background:#fff;color:#111827;border:1px solid #e5e7eb;
      text-decoration:none;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#7c3aed,#fb7185);
      color:#fff;border:0;box-shadow:0 12px 24px rgba(124,58,237,.18);
    }
    .btn[disabled]{opacity:.65;cursor:not-allowed}

    .table{
      width:100%;border-collapse:separate;border-spacing:0;
      overflow:hidden;border-radius:16px;border:1px solid #e5e7eb;background:#fff;
      table-layout:fixed;
    }
    .table th,.table td{
      padding:10px 10px;border-bottom:1px solid #e5e7eb;text-align:left;
      font-weight:750;font-size:.92rem;overflow:hidden;text-overflow:ellipsis;
    }
    .table th{background:#f8fafc;font-weight:900}
    .table tr:last-child td{border-bottom:0}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(17,24,39,.92);color:#fff;padding:10px 12px;border-radius:14px;
      font-weight:800;font-size:.9rem;opacity:0;pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width:calc(100% - 28px);z-index:20050;text-align:center;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}

    /* Wrong list (modal) */
    .wList{display:grid;gap:10px;margin-top:10px}
    .wItem{
      border:1px solid #e5e7eb;border-radius:16px;padding:12px;background:#fff;
      cursor:pointer; user-select:none;
      transition:transform .12s ease, filter .12s ease;
    }
    .wItem:hover{transform:translateY(-1px);filter:brightness(.99)}
    .wHead{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .wLeft{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .wNo{
      font-weight:1000;font-size:.82rem;
      padding:6px 10px;border-radius:999px;
      background:rgba(220,38,38,.10);
      border:1px solid rgba(220,38,38,.25);
      color:#991b1b;
      white-space:nowrap;
    }
    .wWord{font-weight:950}
    .wDetail{display:none;margin-top:10px;line-height:1.35}
    .wItem.open .wDetail{display:block}
    .wDetailRow{margin-top:8px}
    .wLinkRow{margin-top:10px;display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}
    .wSmallBtn{
      border-radius:999px;padding:7px 10px;font-weight:900;
      border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-size:.82rem;
      text-decoration:none;color:#111827;
    }

    /* comments UI */
    .input{
      width:100%;
      border-radius:14px;border:2px solid #e5e7eb;
      padding:11px 12px;font-size:.95rem;font-weight:700;
      outline:none;background:#f8fafc;
      transition:border-color .15s ease, box-shadow .15s ease;
      font-family:inherit;
    }
    .input:focus{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 0 0 5px rgba(124,58,237,.10);
      background:#fff;
    }
    .cmtBox{display:grid;gap:12px;margin-top:10px}
    .cmtItem{border:1px solid #e5e7eb;border-radius:16px;padding:12px;background:#fff}
    .cmtHead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .cmtAuthor{font-weight:950;color:#6b7280;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .adminBadgeInline{
      padding:4px 8px;border-radius:999px;font-weight:950;font-size:.78rem;
      background:rgba(37,99,235,.12);border:1px solid rgba(37,99,235,.35);color:var(--admin);white-space:nowrap;
    }
    .pinBadgeInline{
      padding:4px 8px;border-radius:999px;font-weight:950;font-size:.78rem;
      background:rgba(245,158,11,.14);border:1px solid rgba(245,158,11,.35);color:#92400e;white-space:nowrap;
    }
    .cmtText{color:#111827;font-weight:750;line-height:1.35;white-space:pre-wrap;word-break:break-word}
    .cmtActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;justify-content:flex-end}
    .cmtBtn{
      border-radius:999px;padding:7px 10px;font-weight:900;
      border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-size:.82rem;
    }
    .cmtBtnDanger{background:rgba(220,38,38,.1);border-color:rgba(220,38,38,.25);color:#991b1b}
    .cmtBtnPin{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35);color:#92400e}
    .cmtTime{margin-top:6px;text-align:right;color:#6b7280;font-weight:800;font-size:.82rem}
    .replyWrap{margin-top:10px;margin-left:14px;padding-left:12px;border-left:6px solid #e5e7eb;display:grid;gap:10px}
    .replyForm{margin-left:14px;padding-left:12px;border-left:6px solid #e5e7eb;margin-top:10px;display:grid;gap:10px}
    .charRow{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:#6b7280;font-weight:800;font-size:.85rem}

    /* Modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:30000;
    }
    .modal.show{display:flex}
    .modalBack{
      position:absolute; inset:0;
      background:rgba(17,24,39,.58);
      backdrop-filter: blur(4px);
    }
    .modalCard{
      position:relative;
      width:100%;
      max-width:760px;
      max-height:78vh;
      overflow:auto;
      background:#fff;
      border-radius:18px;
      border:1px solid #e5e7eb;
      box-shadow:0 18px 60px rgba(0,0,0,.22);
      padding:14px;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:10px; border-bottom:1px solid #e5e7eb; margin-bottom:10px;
    }
    .modalTitle{font-weight:950;font-size:1.02rem}
    .modalClose{
      border-radius:999px;
      padding:8px 12px;
      font-weight:950;
      border:1px solid #e5e7eb;
      background:#fff;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <div id="shell">
    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">‚úÖ</div>
          <div class="titles">
            <h1 id="title">K·∫øt qu·∫£</h1>
            <div class="tiny" id="sub"></div>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <a class="btn" id="btnBackStore" href="/">‚Üê Store</a>
          <a class="btn btn-primary" id="btnRestart" href="/q/index.html">‚Ü©Ô∏è L√†m l·∫°i</a>
        </div>
      </div>

      <div id="summary" class="card"></div>
      <div id="lb" class="card"></div>
      <div id="discussion" class="card"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Wrong modal -->
  <div id="wrongModal" class="modal" aria-hidden="true">
    <div class="modalBack" id="wrongModalBack"></div>
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="wrongModalTitle">
      <div class="modalHead">
        <div class="modalTitle" id="wrongModalTitle">C√¢u sai</div>
        <button class="modalClose" id="btnCloseWrong" type="button">‚úï</button>
      </div>
      <div id="wrongModalBody"></div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
const SUPABASE_URL = "https://aidvlydhbdtwunyreqak.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE"; // <-- gi·ªØ key c·ªßa b·∫°n (ƒë·ª´ng ƒë·ªïi n·∫øu ƒëang ch·∫°y OK)

const RPC = {
  me: "api_me",
  quizMeta: "api_get_quiz_meta",
  attemptPublic: "api_get_attempt_public",
  leaderboard: "api_get_leaderboard",
  pinComment: "api_toggle_comment_pin"
};

const TOKEN_KEY = "tk_token_v2";
const NAME_KEY  = "tk_display_name_v1";

/* ===== helpers ===== */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = String(msg||"");
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1400);
}
function escapeHtml(s) {
  return String(s ?? "")
    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;").replace(/'/g, "&#39;");
}
function loadName(){ try { return (localStorage.getItem(NAME_KEY)||"").trim(); } catch { return ""; } }
function getToken(){ try { return (localStorage.getItem(TOKEN_KEY)||"").trim(); } catch { return ""; } }

function sbHeaders(){
  const anon = String(SUPABASE_ANON_KEY||"").trim();
  return {
    "apikey": anon,
    "Authorization": "Bearer " + anon,
    "Content-Type": "application/json"
  };
}
async function sbRpc(fn, args){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{
    method:"POST",
    headers: sbHeaders(),
    body: JSON.stringify(args||{})
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "RPC error");
  }
  return data;
}
async function sbGet(path){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{ headers: sbHeaders() });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST GET error");
  }
  return data;
}
async function sbPost(path, body, { preferReturn=true } = {}){
  const h = sbHeaders();
  if(preferReturn) h["Prefer"]="return=representation";
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{
    method:"POST",
    headers: h,
    body: JSON.stringify(body||{})
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST POST error");
  }
  return data;
}
async function sbDelete(path){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{
    method:"DELETE",
    headers: sbHeaders()
  });
  const txt = await res.text();
  let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint||data.details))
      ? (data.message||data.error||data.hint||data.details)
      : txt;
    throw new Error(msg || "REST DELETE error");
  }
  return data;
}

function toMs(ts){
  const d = new Date(ts);
  const t = d.getTime();
  return isFinite(t) ? t : 0;
}
function fmtTs(ts){
  try{
    const d = ts ? new Date(ts) : new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}, ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)}`;
  }catch{ return ""; }
}

/* ================== URL / STATE ================== */
const qs = new URLSearchParams(location.search);
const quizId = String(qs.get("quiz")||"").toLowerCase().replace(/[^a-z]/g,"").slice(0,5);
const attemptId = String(qs.get("attempt")||"").trim();

const PROGRESS_KEY = `tk_progress::${quizId}`;
function clearForRestart(){
  try{ localStorage.removeItem(PROGRESS_KEY); }catch{}
  try{ sessionStorage.removeItem(`tk_last_result::${quizId}`); }catch{}
}

/* restart */
const btnRestart = document.getElementById("btnRestart");
btnRestart.href = quizId ? `/q/index.html?quiz=${quizId}&restart=1&start=1` : "/";
btnRestart.addEventListener("click",(e)=>{
  if(!quizId) return;
  e.preventDefault();
  clearForRestart();
  location.href = `/q/index.html?quiz=${quizId}&restart=1&start=1`;
});

/* ================== WRONG MODAL ================== */
let CURRENT_WRONG_LIST = [];

function renderWrongModal(list){
  const body = document.getElementById("wrongModalBody");
  const title = document.getElementById("wrongModalTitle");
  if(!body || !title) return;

  const arr = Array.isArray(list) ? list : [];
  CURRENT_WRONG_LIST = arr;

  if(!arr.length){
    title.textContent = "C√¢u sai";
    body.innerHTML = `<div class="muted"><span class="oktxt">Kh√¥ng c√≥ c√¢u sai ‚úÖ</span></div>`;
    return;
  }

  title.textContent = `C√¢u sai (${arr.length})`;
  const items = arr.map((w,i)=>{
    const word = w.word || "(?)";
    const u = (w.user_answer ?? w.user ?? "").toString().trim();
    const ex = (w.expected ?? "").toString().trim();
    const jump = quizId && w.id ? `/q/index.html?quiz=${quizId}&start=1#q${encodeURIComponent(String(w.id))}` : "";
    return `
      <div class="wItem" data-w="${escapeHtml(String(w.id ?? i))}">
        <div class="wHead">
          <div class="wLeft">
            <span class="wNo">SAI ‚Ä¢ C√¢u ${i+1}</span>
            <span class="wWord">${escapeHtml(word)}</span>
          </div>
          <div class="muted">Xem</div>
        </div>
        <div class="wDetail">
          <div class="wDetailRow"><span class="muted">B·∫°n tr·∫£ l·ªùi:</span> <b>${escapeHtml(u||"(tr·ªëng)")}</b></div>
          <div class="wDetailRow"><span class="muted">ƒê√°p √°n/ghi ch√∫:</span> <b>${escapeHtml(ex||"(?)")}</b></div>
          ${jump ? `
            <div class="wLinkRow">
              <a class="wSmallBtn" href="${jump}">M·ªü ƒë√∫ng c√¢u n√†y</a>
            </div>` : ``}
        </div>
      </div>
    `;
  }).join("");

  body.innerHTML = `
    <div class="muted" style="margin-top:2px">B·∫•m v√†o t·ª´ng c√¢u ƒë·ªÉ xem chi ti·∫øt.</div>
    <div class="wList">${items}</div>
  `;
}
function openWrongModal(){
  if(!Array.isArray(CURRENT_WRONG_LIST) || !CURRENT_WRONG_LIST.length) return;
  renderWrongModal(CURRENT_WRONG_LIST);
  const m = document.getElementById("wrongModal");
  if(!m) return;
  m.classList.add("show");
  m.setAttribute("aria-hidden","false");
  document.body.style.overflow = "hidden";
}
function closeWrongModal(){
  const m = document.getElementById("wrongModal");
  if(!m) return;
  m.classList.remove("show");
  m.setAttribute("aria-hidden","true");
  document.body.style.overflow = "";
}
(function bindWrongModal(){
  const back = document.getElementById("wrongModalBack");
  const closeBtn = document.getElementById("btnCloseWrong");
  const body = document.getElementById("wrongModalBody");

  if(back) back.addEventListener("click", closeWrongModal, {passive:true});
  if(closeBtn) closeBtn.addEventListener("click", closeWrongModal, {passive:true});
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeWrongModal(); });

  if(body){
    body.addEventListener("click",(e)=>{
      if(e.target.closest("a")) return;
      const item = e.target.closest(".wItem");
      if(!item) return;
      item.classList.toggle("open");
      const label = item.querySelector(".wHead .muted");
      if(label) label.textContent = item.classList.contains("open") ? "·∫®n" : "Xem";
    }, {passive:true});
  }
})();

/* ================== RENDER SUMMARY/LB ================== */
function renderSummary({ title, sub, score10, correctCount, totalCount, wrongCount }){
  document.getElementById("title").textContent = title || "K·∫øt qu·∫£";
  document.getElementById("sub").textContent = sub || "";

  const wc = Number(wrongCount||0);

  document.getElementById("summary").innerHTML = `
    <div class="row1">
      <p class="vi">T·ªïng k·∫øt</p>
      <div class="idx">DONE</div>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
        <span class="pill">ƒêi·ªÉm: <strong>${Number(score10||0).toFixed(1)}/10</strong></span>
        <span class="pill">ƒê√∫ng: <strong>${Number(correctCount||0)}</strong>/${Number(totalCount||0)}</span>
      </div>

      ${wc > 0 ? `<button class="btn" id="btnWrong" type="button">‚ùå C√¢u sai (${wc})</button>` : ``}
    </div>
  `;

  const btnWrong = document.getElementById("btnWrong");
  if(btnWrong){
    btnWrong.addEventListener("click", openWrongModal, {passive:true});
  }
}

function renderLeaderboard(rows, myUserId){
  const lb = document.getElementById("lb");
  if(!Array.isArray(rows) || !rows.length){
    lb.innerHTML = `
      <div class="row1"><p class="vi">B·∫£ng x·∫øp h·∫°ng</p><div class="idx">TOP</div></div>
      <div class="muted" style="margin-top:10px">Ch∆∞a c√≥ d·ªØ li·ªáu (ch∆∞a ai n·ªôp / ho·∫∑c DB ch∆∞a c√≥ attempt).</div>
    `;
    return;
  }

  const body = rows.slice(0,50).map((r,i)=>{
    const isMe = myUserId && String(r.user_id) === String(myUserId);
    return `
      <tr ${isMe ? `style="background: rgba(124,58,237,.10)"` : ``}>
        <td style="width:70px"><b>${i+1}</b></td>
        <td>
          ${escapeHtml(r.username||"(user)")}
          ${String(r.role||"").toLowerCase()==="admin" ? ` <span style="color:#2563eb; font-weight:900">(ADMIN)</span>`:''}
          ${isMe?` <span style="color:#4c1d95; font-weight:900">(B·∫°n)</span>`:''}
        </td>
        <td style="width:110px"><b>${Number(r.score10||0).toFixed(1)}</b>/10</td>
      </tr>
    `;
  }).join("");

  lb.innerHTML = `
    <div class="row1"><p class="vi">B·∫£ng x·∫øp h·∫°ng</p><div class="idx">TOP</div></div>
    <div class="muted" style="margin-top:8px">Top theo <b>ƒëi·ªÉm cao nh·∫•t c·ªßa m·ªói user</b> (tie-break: n·ªôp g·∫ßn nh·∫•t).</div>
    <div style="margin-top:10px; overflow:auto">
      <table class="table">
        <thead><tr><th>#</th><th>T√™n</th><th>ƒêi·ªÉm</th></tr></thead>
        <tbody>${body}</tbody>
      </table>
    </div>
  `;
}

/* ================== COMMENTS ================== */
const DISCUSS_MAX = 120;
let DISC = { tree:[], openReply:"" };

function discussionHtml(username){
  return `
    <div class="row1"><p class="vi">Th·∫£o lu·∫≠n</p><div class="idx">üí¨</div></div>

    <div style="margin-top:10px; display:grid; gap:10px;">
      <div class="charRow">
        <div><b>Vi·∫øt b√¨nh lu·∫≠n</b> <span class="muted">(T√™n: <b>${escapeHtml(username||"‚Äî")}</b>)</span></div>
        <div><span id="rootCount">0</span>/${DISCUSS_MAX}</div>
      </div>
      <textarea id="rootInput" class="input" rows="3" maxlength="${DISCUSS_MAX}" placeholder="Nh·∫≠p b√¨nh lu·∫≠n..."></textarea>
      <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-primary" id="btnPostRoot" style="justify-content:center;">‚ûï G·ª≠i</button>
      </div>
      <div id="discussList" class="cmtBox"></div>
    </div>
  `;
}

function isAdmin(me){
  return !!me && (String(me.role||"").toLowerCase()==="admin" || String(me.username||"").toLowerCase()==="tuankhoi");
}

function buildTree(rows){
  const byId = new Map();
  rows.forEach(r=>{
    byId.set(String(r.id), {
      id: String(r.id),
      parent_id: (r.parent_id==null ? "" : String(r.parent_id)),
      author: String(r.author||""),
      created_at: r.created_at,
      createdAtMs: toMs(r.created_at),
      text: String(r.text||""),
      pinned: !!r.pinned,
      pinnedAtMs: r.pinned_at ? toMs(r.pinned_at) : 0,
      replies: []
    });
  });

  const roots = [];
  for(const node of byId.values()){
    if(node.parent_id && byId.has(node.parent_id)){
      byId.get(node.parent_id).replies.push(node);
    }else{
      roots.push(node);
    }
  }

  // Sort: pinned first, then pinned_at desc, then created_at asc
  roots.sort((a,b)=>{
    if(a.pinned !== b.pinned) return a.pinned ? -1 : 1;
    if(a.pinned && b.pinned && a.pinnedAtMs !== b.pinnedAtMs) return b.pinnedAtMs - a.pinnedAtMs;
    return a.createdAtMs - b.createdAtMs;
  });
  roots.forEach(r=>r.replies.sort((a,b)=>a.createdAtMs-b.createdAtMs));
  return roots;
}

function canDeleteComment(c, me){
  if(isAdmin(me)) return true;
  const a = String(c.author||"").trim().toLowerCase();
  const m = String(me?.username||"").trim().toLowerCase();
  return !!m && a === m;
}

async function loadComments(){
  // l·∫•y pinned + pinned_at ƒë·ªÉ sort & render
  const rows = await sbGet(
    `comments?quiz_id=eq.${quizId}` +
    `&select=id,parent_id,author,text,created_at,pinned,pinned_at` +
    `&order=pinned.desc,pinned_at.desc,created_at.asc&limit=400`
  );
  DISC.tree = buildTree(Array.isArray(rows)?rows:[]);
}

async function addComment({ text, parent_id, author }){
  const payload = {
    quiz_id: quizId,
    parent_id: (parent_id==null ? null : Number(parent_id)),
    author: author || "",
    text: text || ""
  };
  const res = await sbPost("comments", payload, {preferReturn:true});
  return Array.isArray(res) ? res[0] : res;
}
async function deleteComment(id){
  await sbDelete(`comments?id=eq.${encodeURIComponent(id)}`);
}

async function togglePinComment({ me, commentId, pin }){
  const token = getToken();
  if(!token) { toast("Admin c·∫ßn ƒëƒÉng nh·∫≠p"); return; }
  try{
    const out = await sbRpc(RPC.pinComment, { p_token: token, p_comment_id: Number(commentId), p_pin: !!pin });
    if(!out || out.ok!==true) throw new Error(out?.error || "Pin l·ªói");
    toast(pin ? "ƒê√£ pin" : "ƒê√£ b·ªè pin");
    await loadComments();
    renderDiscussion(me);
  }catch(e){
    toast(e?.message || "Pin l·ªói");
  }
}

function renderDiscussion(me){
  const myName = me?.username || "";
  const list = document.getElementById("discussList");
  if(!list) return;

  const tree = DISC.tree || [];
  if(!tree.length){
    list.innerHTML = `<div class="muted">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</div>`;
    return;
  }

  list.innerHTML = "";
  tree.forEach(root=>{
    const wrap = document.createElement("div");
    wrap.className = "cmtItem";

    const showAdminBadge = (String(root.author||"").trim().toLowerCase() === "tuankhoi");
    const adminTag = showAdminBadge ? `<span class="adminBadgeInline">ADMIN</span>` : ``;

    const pinTag = root.pinned ? `<span class="pinBadgeInline">üìå PIN</span>` : ``;

    const delBtn = canDeleteComment(root, me)
      ? `<button class="cmtBtn cmtBtnDanger" data-del="${escapeHtml(root.id)}">X√≥a</button>` : ``;

    // ‚úÖ Admin pin button:
    // - ch·ªâ root comment
    // - KH√îNG pin n·∫øu ƒë√£ c√≥ reply (root.replies.length>0)
    // - n·∫øu ƒëang pinned => cho b·ªè pin (unpin) (OK)
    const canPin = isAdmin(me) && (root.replies||[]).length===0;
    const pinBtn = isAdmin(me)
      ? (canPin
          ? `<button class="cmtBtn cmtBtnPin" data-pin="${escapeHtml(root.id)}" data-pv="${root.pinned?0:1}">${root.pinned ? "B·ªè pin" : "üìå Pin"}</button>`
          : `<span class="muted" style="font-weight:900;font-size:.82rem">Kh√¥ng pin ƒë∆∞·ª£c (ƒë√£ c√≥ tr·∫£ l·ªùi)</span>`
        )
      : ``;

    wrap.innerHTML = `
      <div class="cmtHead">
        <div class="cmtAuthor">
          <span>${escapeHtml(root.author||"‚Äî")}</span>
          ${adminTag}
          ${pinTag}
        </div>
      </div>
      <div class="cmtText">${escapeHtml(root.text||"")}</div>

      <div class="cmtActions">
        <button class="cmtBtn" data-reply="${escapeHtml(root.id)}">Tr·∫£ l·ªùi</button>
        ${pinBtn}
        ${delBtn}
      </div>
      <div class="cmtTime">${escapeHtml(fmtTs(root.created_at))}</div>

      <div class="replySlot" data-slot="${escapeHtml(root.id)}"></div>
      <div class="replyWrap" data-replies="${escapeHtml(root.id)}"></div>
    `;
    list.appendChild(wrap);

    const slot = wrap.querySelector(`[data-slot="${CSS.escape(String(root.id))}"]`);
    if(slot && DISC.openReply === String(root.id)){
      slot.innerHTML = `
        <div class="replyForm">
          <div class="charRow">
            <div><b>Tr·∫£ l·ªùi</b></div>
            <div><span data-ct>0</span>/${DISCUSS_MAX}</div>
          </div>
          <textarea class="input" rows="2" maxlength="${DISCUSS_MAX}" placeholder="Nh·∫≠p tr·∫£ l·ªùi..."></textarea>
          <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-primary" data-sendreply="${escapeHtml(root.id)}" style="justify-content:center;">G·ª≠i</button>
            <button class="btn" data-cancelreply style="justify-content:center;">H·ªßy</button>
          </div>
        </div>
      `;
    }

    const rWrap = wrap.querySelector(`[data-replies="${CSS.escape(String(root.id))}"]`);
    if(rWrap){
      rWrap.innerHTML = "";
      (root.replies||[]).forEach(r=>{
        const item = document.createElement("div");
        item.className = "cmtItem";
        item.style.margin = "0";

        const rDelBtn = canDeleteComment(r, me)
          ? `<button class="cmtBtn cmtBtnDanger" data-del="${escapeHtml(r.id)}">X√≥a</button>` : ``;

        item.innerHTML = `
          <div class="cmtHead">
            <div class="cmtAuthor">
              <span>${escapeHtml(r.author||"‚Äî")}</span>
            </div>
          </div>
          <div class="cmtText">${escapeHtml(r.text||"")}</div>
          <div class="cmtActions">${rDelBtn}</div>
          <div class="cmtTime">${escapeHtml(fmtTs(r.created_at))}</div>
        `;
        rWrap.appendChild(item);
      });
    }
  });
}

/* ================== DATA LOADERS ================== */
async function loadMeIfAny(){
  const token = getToken();
  if(!token) return null;
  try{
    const out = await sbRpc(RPC.me, { p_token: token });
    if(!out || out.ok!==true) return null;
    const m = out.me || out.user || out.data || null;
    if(m && m.id && !m.user_id) m.user_id = m.id;
    return m;
  }catch(_e){
    return null;
  }
}

async function loadQuizMeta(){
  const out = await sbRpc(RPC.quizMeta, { p_quiz_id: quizId });
  if(!out || out.ok!==true) throw new Error(out?.error || "Kh√¥ng load quiz meta");
  const q = out.quiz || {};
  return { title: q.title || "", sub: q.sub || "" };
}

async function loadAttemptPublic(attemptId, token){
  const out = await sbRpc(RPC.attemptPublic, { p_attempt_id: attemptId, p_token: token || "" });
  if(!out || out.ok!==true) throw new Error(out?.error || "Kh√¥ng load attempt");
  return out;
}

async function loadLeaderboard(){
  const rows = await sbRpc(RPC.leaderboard, { p_quiz_id: quizId, p_limit: 50 });
  // PostgREST RPC table-return => array
  return Array.isArray(rows) ? rows : [];
}

/* ================== BOOT ================== */
(async function boot(){
  if(!quizId){
    renderSummary({ title:"K·∫øt qu·∫£", sub:"Sai link (thi·∫øu ?quiz=abcde)", score10:0, correctCount:0, totalCount:0, wrongCount:0 });
    document.getElementById("lb").innerHTML = `<div class="muted">Sai link.</div>`;
    document.getElementById("discussion").innerHTML = `<div class="muted">Sai link.</div>`;
    return;
  }

  // cache nhanh
  let cached = null;
  try{ cached = JSON.parse(sessionStorage.getItem(`tk_last_result::${quizId}`)||"null"); }catch{}
  const fallbackName = loadName();

  const token = getToken();
  let me = await loadMeIfAny(); // c√≥ th·ªÉ null

  let username = me?.username || (cached?.me?.username || fallbackName || "");
  let myUserId = me?.user_id || (cached?.me?.user_id || "");

  let score10 = cached?.result?.score10 || 0;
  let correctCount = cached?.result?.fullCorrectCount || cached?.result?.correctCount || 0;
  let totalCount = cached?.result?.totalCount || 0;
  let wrongList = cached?.result?.wrong || [];

  CURRENT_WRONG_LIST = Array.isArray(wrongList) ? wrongList : [];
  renderWrongModal(CURRENT_WRONG_LIST);

  renderSummary({
    title: cached?.title || "K·∫øt qu·∫£",
    sub: cached?.sub || "",
    score10, correctCount, totalCount,
    wrongCount: CURRENT_WRONG_LIST.length
  });

  // quiz meta (RPC, kh√¥ng b·ªã permission denied)
  let qTitle="", qSub="";
  try{
    const qm = await loadQuizMeta();
    qTitle = qm.title || "";
    qSub = qm.sub || "";
  }catch{}

  // attempt th·∫≠t (RPC)
  if(attemptId){
    try{
      const out = await loadAttemptPublic(attemptId, token);
      const a = out.attempt || {};
      const u = out.user || {};

      score10 = Number(a.score10||0);
      correctCount = Number(a.correct_count||0);
      totalCount = Number(a.total_count||0);

      if(!username && u.username) username = u.username;
      if(!myUserId && me?.user_id) myUserId = me.user_id;

      // wrong list ∆∞u ti√™n details_json.wrong
      const dj = a.details_json || {};
      if(Array.isArray(dj.wrong)) wrongList = dj.wrong;
      else if(cached?.result?.wrong) wrongList = cached.result.wrong;
    }catch(_e){}
  }

  CURRENT_WRONG_LIST = Array.isArray(wrongList) ? wrongList : [];
  renderWrongModal(CURRENT_WRONG_LIST);

  renderSummary({
    title: qTitle || cached?.title || "K·∫øt qu·∫£",
    sub: qSub || cached?.sub || "",
    score10, correctCount, totalCount,
    wrongCount: CURRENT_WRONG_LIST.length
  });

  // leaderboard (RPC)
  try{
    const lb = await loadLeaderboard();
    renderLeaderboard(lb, myUserId);
  }catch(_e){
    renderLeaderboard([], "");
  }

  // discussion
  const discussionEl = document.getElementById("discussion");
  discussionEl.innerHTML = discussionHtml(username || fallbackName || "‚Äî");

  const rootInput = document.getElementById("rootInput");
  const rootCount = document.getElementById("rootCount");
  const btnPostRoot = document.getElementById("btnPostRoot");
  rootInput.addEventListener("input", ()=>{ rootCount.textContent = String((rootInput.value||"").length); }, {passive:true});

  const meForUI = me || { username: username || fallbackName || "", role:"user" };

  try{
    await loadComments();
    renderDiscussion(meForUI);
  }catch(e){
    discussionEl.innerHTML += `<div class="muted" style="margin-top:10px">Kh√¥ng load ƒë∆∞·ª£c comments (ki·ªÉm tra RLS b·∫£ng public.comments).</div>`;
  }

  btnPostRoot.addEventListener("click", async ()=>{
    const text = String(rootInput.value||"").trim();
    if(!text || text.length > DISCUSS_MAX){ toast("T·ªëi ƒëa 120 k√Ω t·ª±"); return; }
    const author = (username || fallbackName || "").trim();
    if(!author){ toast("Thi·∫øu t√™n"); return; }

    rootInput.value = ""; rootCount.textContent = "0";
    try{
      await addComment({ text, parent_id:null, author });
      await loadComments();
      renderDiscussion(meForUI);
      toast("ƒê√£ g·ª≠i");
    }catch(e){
      toast("G·ª≠i l·ªói (c√≥ th·ªÉ do RLS)");
    }
  });

  discussionEl.addEventListener("click", async (e)=>{
    const pinBtn = e.target.closest("[data-pin]");
    if(pinBtn){
      const id = pinBtn.getAttribute("data-pin");
      const pv = pinBtn.getAttribute("data-pv"); // 1=pin,0=unpin
      await togglePinComment({ me: meForUI, commentId: id, pin: pv==="1" });
      return;
    }

    const delBtn = e.target.closest("[data-del]");
    if(delBtn){
      const id = String(delBtn.getAttribute("data-del")||"");
      if(!id) return;
      if(!confirm("X√≥a b√¨nh lu·∫≠n n√†y?")) return;
      try{
        await deleteComment(id);
        await loadComments();
        renderDiscussion(meForUI);
        toast("ƒê√£ x√≥a");
      }catch(err){
        toast("X√≥a l·ªói (c√≥ th·ªÉ do RLS)");
      }
      return;
    }

    const replyBtn = e.target.closest("[data-reply]");
    if(replyBtn){
      const rootId = String(replyBtn.getAttribute("data-reply")||"");
      DISC.openReply = (DISC.openReply === rootId) ? "" : rootId;
      renderDiscussion(meForUI);
      const slot = discussionEl.querySelector(`[data-slot="${CSS.escape(rootId)}"]`);
      const ta = slot ? slot.querySelector("textarea") : null;
      if(ta) ta.focus();
      return;
    }

    const cancelBtn = e.target.closest("[data-cancelreply]");
    if(cancelBtn){
      DISC.openReply = "";
      renderDiscussion(meForUI);
      return;
    }

    const sendBtn = e.target.closest("[data-sendreply]");
    if(sendBtn){
      const rootId = String(sendBtn.getAttribute("data-sendreply")||"");
      const slot = discussionEl.querySelector(`[data-slot="${CSS.escape(rootId)}"]`);
      const ta = slot ? slot.querySelector("textarea") : null;
      const text = ta ? String(ta.value||"").trim() : "";
      if(!text || text.length > DISCUSS_MAX){ toast("T·ªëi ƒëa 120 k√Ω t·ª±"); return; }

      const author = (username || fallbackName || "").trim();
      if(!author){ toast("Thi·∫øu t√™n"); return; }

      DISC.openReply = "";
      renderDiscussion(meForUI);

      try{
        await addComment({ text, parent_id: rootId, author });
        await loadComments();
        renderDiscussion(meForUI);
        toast("ƒê√£ g·ª≠i");
      }catch(err){
        toast("G·ª≠i l·ªói (c√≥ th·ªÉ do RLS)");
      }
      return;
    }
  });

  discussionEl.addEventListener("input", (e)=>{
    const ta = e.target;
    if(!(ta && ta.tagName === "TEXTAREA")) return;
    const form = ta.closest(".replyForm");
    if(!form) return;
    const ct = form.querySelector("[data-ct]");
    if(ct) ct.textContent = String((ta.value||"").length);
  }, {passive:true});
})();
</script>
</body>
</html>
