<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>tuankhoi.site - Quiz Store</title>
  <style>
    body{font-family:system-ui,Arial;margin:24px;max-width:900px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .card{border:1px solid #ddd;border-radius:12px;padding:14px;margin:12px 0}
    .muted{color:#666}
    button{padding:8px 10px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    input{padding:8px 10px;border-radius:10px;border:1px solid #ccc}
    a{color:#06c;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div>
      <h1 style="margin:0">Quiz Store</h1>
      <div class="muted">Kệ hàng quiz - chọn quiz để làm</div>
    </div>
    <div id="authBox"></div>
  </header>

  <div id="list"></div>

  <p class="muted"><a href="/admin">Admin panel</a></p>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    import { listStore, me, login, register, logout } from "./lib/api.js";

    const authBox = document.getElementById("authBox");
    const listEl = document.getElementById("list");

    function renderAuth(meOut){
      if(meOut?.ok){
        authBox.innerHTML = `
          <div class="muted">Xin chào <b>${meOut.me.username}</b> (${meOut.me.role})</div>
          <button id="btnLogout">Logout</button>
        `;
        document.getElementById("btnLogout").onclick = async () => { await logout(); location.reload(); };
        return;
      }
      authBox.innerHTML = `
        <input id="u" placeholder="username (thường)" />
        <input id="p" placeholder="pin" type="password" style="width:120px" />
        <button id="btnLogin">Login</button>
        <button id="btnReg">Register</button>
      `;
      document.getElementById("btnLogin").onclick = async () => {
        const u = document.getElementById("u").value;
        const p = document.getElementById("p").value;
        const out = await login(u,p);
        if(!out.ok) return alert(out.error || "login fail");
        location.reload();
      };
      document.getElementById("btnReg").onclick = async () => {
        const u = document.getElementById("u").value;
        const p = document.getElementById("p").value;
        const out = await register(u,p);
        if(!out.ok) return alert(out.error || "register fail");
        location.reload();
      };
    }

    function renderList(items){
      if(!items?.length){
        listEl.innerHTML = `<div class="card">Chưa có quiz nào public.</div>`;
        return;
      }
      listEl.innerHTML = items.map(q => `
        <div class="card">
          <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
            <div>
              <div style="font-size:18px"><b>${q.title}</b></div>
              <div class="muted">${q.sub || ""}</div>
              <div class="muted">Link: <code>/q/${q.quiz_id}</code></div>
            </div>
            <div>
              <a href="/q/${q.quiz_id}"><button>Làm quiz</button></a>
            </div>
          </div>
        </div>
      `).join("");
    }

    // init
    const meOut = await me().catch(()=>({ok:false}));
    renderAuth(meOut);

    const out = await listStore();
    if(!out.ok) alert(out.error || "load store fail");
    renderList(out.items || []);
  </script>
</body>
</html>
