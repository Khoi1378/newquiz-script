<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
  <title>tuankhoi.site - Admin</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#dbeafe; --bg2:#fce7f3;
      --card:#fff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --soft:#f8fafc;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --radius:18px;
      --primary:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
        linear-gradient(120deg,var(--bg1) 0%, var(--bg2) 100%);
      overflow:hidden;
    }
    a{color:inherit;text-decoration:none}
    #shell{height:100vh;overflow:auto;-webkit-overflow-scrolling:touch;padding:12px 0 110px}
    .wrap{max-width:1100px;margin:0 auto;padding:0 14px}

    .topbar{
      margin-top:10px;
      background:rgba(255,255,255,.88);
      border:1px solid rgba(229,231,235,.9);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:14px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .titlebox{display:flex;gap:10px;align-items:center;flex:1 1 360px;min-width:240px}
    .logo{
      width:42px;height:42px;border-radius:16px;
      background:linear-gradient(135deg,#2563eb,#22c55e);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;
      box-shadow:0 10px 22px rgba(37,99,235,.18);
      user-select:none;
    }
    .titles h1{font-size:1.02rem;margin:0;font-weight:800}
    .titles .tiny{margin-top:3px;font-size:.86rem;color:var(--muted);font-weight:650}

    .actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex:1 1 320px}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:9px 12px;border-radius:999px;
      background:rgba(255,255,255,.78);
      border:1px solid rgba(229,231,235,.9);
      color:rgba(17,24,39,.85);
      font-weight:800;font-size:.9rem;
      box-shadow:0 10px 22px rgba(0,0,0,.05);
      user-select:none;
      max-width:78vw;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .badge-admin{
      padding:4px 8px;border-radius:999px;
      background:rgba(37,99,235,.12);
      border:1px solid rgba(37,99,235,.35);
      color:#2563eb;
      font-weight:950;
      font-size:.78rem;
    }

    .btn{
      border:0;cursor:pointer;border-radius:999px;padding:10px 14px;
      font-weight:900;font-size:.9rem;
      transition:transform .16s ease, filter .16s ease;
      display:inline-flex;align-items:center;gap:8px;
      user-select:none;white-space:nowrap;
      box-shadow:0 12px 24px rgba(0,0,0,.12);
      background:#fff;color:#111827;border:1px solid #e5e7eb;
      touch-action:manipulation;-webkit-tap-highlight-color:transparent;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(.98)}
    .btn:active{transform:translateY(0)}
    .btn-primary{
      background:linear-gradient(135deg,#2563eb,#22c55e);
      color:#fff;border:0;
      box-shadow:0 12px 24px rgba(37,99,235,.16);
    }
    .btn-danger{background:var(--danger);color:#fff;border:0}
    .btn-ghost{background:#fff;color:#111827;border:1px solid #e5e7eb;box-shadow:none}
    .btn[disabled]{opacity:.6;cursor:not-allowed;transform:none !important;filter:none !important}

    .card{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;margin:12px 0;
    }
    .row1{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .vi{margin:0;font-weight:900;font-size:1.04rem;line-height:1.25}
    .muted{color:var(--muted);font-weight:650}
    .input{
      width:100%;
      border-radius:14px;border:2px solid #e5e7eb;
      padding:11px 12px;font-size:.95rem;font-weight:700;
      outline:none;background:var(--soft);
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .input:focus{border-color:rgba(37,99,235,.55);box-shadow:0 0 0 5px rgba(37,99,235,.10);background:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.grid2{grid-template-columns:1fr}}

    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{padding:9px 12px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:900;cursor:pointer}
    .tab.active{background:linear-gradient(135deg,#2563eb,#22c55e);color:#fff;border:0}

    .list{display:grid;gap:10px}
    .item{
      border:1px solid #e5e7eb;border-radius:16px;padding:12px;background:#fff;
      box-shadow:0 10px 22px rgba(0,0,0,.05);
    }
    .item .meta{margin-top:6px;color:var(--muted);font-weight:650;font-size:.86rem}
    .idx{
      font-size:.78rem;font-weight:900;
      padding:6px 10px;border-radius:999px;
      background:#eff6ff;color:#1d4ed8;border:1px solid #dbeafe;
      white-space:nowrap;
    }
    .idx.ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .idx.bad{background:#fef2f2;color:#991b1b;border-color:#fecaca}

    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;align-items:center;justify-content:center;
      padding:16px;z-index:20000;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      width:100%;max-width:860px;
      background:#fff;border-radius:18px;border:1px solid #e5e7eb;
      box-shadow:0 20px 60px rgba(0,0,0,.18);
      padding:14px;max-height:82vh;overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .xclose{position:sticky;top:0;display:flex;justify-content:flex-end;z-index:2;margin-bottom:6px}
    .btn-x{
      width:56px;height:56px;border-radius:16px;
      border:1px solid #e5e7eb;background:#fff;cursor:pointer;
      font-weight:1000;font-size:1.8rem;line-height:1;
      box-shadow:0 12px 24px rgba(0,0,0,.10);
    }
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(17,24,39,.92);color:#fff;
      padding:10px 12px;border-radius:14px;
      font-weight:800;font-size:.9rem;
      opacity:0;pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width:calc(100% - 28px);
      z-index:20050;text-align:center;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
    textarea.input{min-height:260px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:.85rem}
  </style>
</head>

<body>
  <div id="shell">
    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">A</div>
          <div class="titles">
            <h1>Admin Panel</h1>
            <div class="tiny">Ch·ªâ d√†nh cho tuankhoi</div>
          </div>
        </div>

        <div class="actions">
          <div class="pill" id="mePill">‚Äî</div>
          <a href="/" class="btn btn-ghost">Trang ch·ªß</a>
          <button class="btn btn-danger" id="btnLogout" type="button">Logout</button>
        </div>
      </div>

      <div class="card" id="gateCard">
        <div class="row1">
          <p class="vi">Ki·ªÉm tra phi√™n ƒëƒÉng nh·∫≠p‚Ä¶</p>
          <span class="idx" id="gateIdx">‚Ä¶</span>
        </div>
        <p class="muted" style="margin:8px 0 0;line-height:1.4" id="gateMsg">ƒêang x√°c th·ª±c token admin.</p>
      </div>

      <div id="app" style="display:none">
        <div class="card">
          <div class="row1">
            <p class="vi">Qu·∫£n tr·ªã</p>
            <div class="tabs">
              <button class="tab active" id="tabQuizzes" type="button">Quizzes</button>
              <button class="tab" id="tabUsers" type="button">Users</button>
            </div>
          </div>

          <div style="margin-top:10px" id="panelQuizzes">
            <div class="grid2">
              <input class="input" id="quizSearch" placeholder="T√¨m quiz theo id/title‚Ä¶" />
              <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
                <button class="btn btn-primary" id="btnReloadQuizzes" type="button">‚Üª Reload</button>
                <button class="btn btn-primary" id="btnNewQuiz" type="button">Ôºã New quiz</button>
              </div>
            </div>
            <div class="list" id="quizList" style="margin-top:12px"></div>
          </div>

          <div style="margin-top:10px; display:none" id="panelUsers">
            <div class="grid2">
              <input class="input" id="userSearch" placeholder="T√¨m user theo username‚Ä¶" />
              <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
                <button class="btn btn-primary" id="btnReloadUsers" type="button">‚Üª Reload</button>
              </div>
            </div>
            <div class="list" id="userList" style="margin-top:12px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Quiz modal -->
  <div class="modal-backdrop" id="quizBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="xclose"><button class="btn-x" id="btnCloseQuiz" type="button" aria-label="ƒê√≥ng">‚úï</button></div>

      <div class="row1">
        <p class="vi" style="margin:0">Quiz</p>
        <span class="idx" id="quizModalIdx">‚Äî</span>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="muted">quiz_id (5 ch·ªØ)</div>
          <input class="input" id="q_quiz_id" placeholder="vd: abcde" maxlength="5" />
        </div>
        <div>
          <div class="muted">title</div>
          <input class="input" id="q_title" placeholder="Ti√™u ƒë·ªÅ" />
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="muted">sub</div>
        <input class="input" id="q_sub" placeholder="M√¥ t·∫£ ng·∫Øn" />
      </div>

      <div class="grid2" style="margin-top:10px">
        <label class="item" style="display:flex;gap:10px;align-items:center">
          <input type="checkbox" id="q_is_public" />
          <div>
            <div style="font-weight:900">is_public</div>
            <div class="muted">Hi·ªán public</div>
          </div>
        </label>

        <label class="item" style="display:flex;gap:10px;align-items:center">
          <input type="checkbox" id="q_is_hidden" />
          <div>
            <div style="font-weight:900">is_hidden</div>
            <div class="muted">·∫®n kh·ªèi store</div>
          </div>
        </label>

        <label class="item" style="display:flex;gap:10px;align-items:center">
          <input type="checkbox" id="q_show_in_store" />
          <div>
            <div style="font-weight:900">show_in_store</div>
            <div class="muted">Cho hi·ªán trong store</div>
          </div>
        </label>

        <label class="item" style="display:flex;gap:10px;align-items:center">
          <input type="checkbox" id="q_require_login" />
          <div>
            <div style="font-weight:900">require_login</div>
            <div class="muted">B·∫Øt ƒëƒÉng nh·∫≠p m·ªõi l√†m</div>
          </div>
        </label>

        <label class="item" style="display:flex;gap:10px;align-items:center">
          <input type="checkbox" id="q_pinned" />
          <div>
            <div style="font-weight:900">pinned</div>
            <div class="muted">ƒê∆∞a l√™n ƒë·∫ßu</div>
          </div>
        </label>

        <label class="item" style="display:flex;gap:10px;align-items:center">
          <input type="checkbox" id="q_require_access_code" />
          <div>
            <div style="font-weight:900">require_access_code</div>
            <div class="muted">B·∫Øt m√£ truy c·∫≠p</div>
          </div>
        </label>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="muted">scoring_mode</div>
          <input class="input" id="q_scoring_mode" placeholder="equal / custom" />
        </div>
        <div>
          <div class="muted">total_score</div>
          <input class="input" id="q_total_score" type="number" step="0.1" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="muted">shuffle_mode</div>
          <input class="input" id="q_shuffle_mode" placeholder="none / q / qa" />
        </div>
        <div>
          <div class="muted">access_code (n·∫øu require_access_code)</div>
          <input class="input" id="q_access_code" placeholder="vd: 1234" />
        </div>
      </div>

      <div style="height:1px;background:#e5e7eb;margin:14px 0;"></div>

      <div class="row1">
        <p class="vi" style="margin:0">Questions JSON</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btn-primary" id="btnLoadQuestions" type="button">Load</button>
          <button class="btn btn-primary" id="btnSaveQuestions" type="button">Save questions</button>
        </div>
      </div>
      <p class="muted" style="margin:6px 0 10px;line-height:1.35">
        D·∫°ng: m·∫£ng JSON. M·ªói item: { "q_type": "...", "prompt": "...", "answers": [...], "points": 0, "meta": {} }
      </p>
      <textarea class="input" id="q_questions_json" placeholder="[]"></textarea>

      <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px">
        <button class="btn btn-danger" id="btnDeleteQuiz" type="button">üóë Delete quiz</button>
        <button class="btn btn-primary" id="btnSaveQuiz" type="button">üíæ Save quiz</button>
      </div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
const SUPABASE_URL = "https://aidvlydhbdtwunyreqak.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZHZseWRoYmR0d3VueXJlcWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzM5NzYsImV4cCI6MjA4NDIwOTk3Nn0.LMKGjKlUbC5qoY7hqDpaDFQrFWfwKemBTpxjTNp_L8o";

/* ================== SECURITY: kill old dangerous hash ================== */
try{
  if(location.hash && /u=|pin=|username=|pass=|pwd=/i.test(location.hash)){
    history.replaceState(null,"", location.pathname + location.search);
  }
}catch{}

/* ================== TOKEN STORAGE (same keys as index) ================== */
const TOKEN_KEYS = ["tk_token_v2","tk_token_v1","tk_token"];
const TOKEN_COOKIES = ["tk_token_v2","tk_token_v1","tk_token"];

function cookieDomainHint(){
  const host = String(location.hostname||"").trim();
  if(!host || host==="localhost" || host.endsWith(".localhost")) return "";
  if(/^\d+\.\d+\.\d+\.\d+$/.test(host)) return "";
  const parts = host.split(".").filter(Boolean);
  if(parts.length < 2) return "";
  return "." + parts.slice(-2).join(".");
}
function cookieSecureFlag(){ return (location.protocol === "https:") ? "; Secure" : ""; }
function setCookie(name, value){
  const v = encodeURIComponent(String(value||""));
  const maxAge = 60*60*24*365*2;
  const base = cookieDomainHint();
  const common = `${name}=${v}; Max-Age=${maxAge}; Path=/; SameSite=Lax${cookieSecureFlag()}`;
  document.cookie = common;
  if(base && base !== location.hostname){
    document.cookie = `${common}; Domain=${base}`;
  }
}
function getCookie(name){
  const cs = document.cookie ? document.cookie.split(";") : [];
  for(const raw of cs){
    const s = raw.trim();
    if(!s) continue;
    const eq = s.indexOf("=");
    const k = (eq>=0 ? s.slice(0,eq) : s).trim();
    if(k === name){
      const v = (eq>=0 ? s.slice(eq+1) : "");
      try{ return v ? decodeURIComponent(v) : ""; }catch{ return v || ""; }
    }
  }
  return "";
}
function delCookie(name){
  const base = cookieDomainHint();
  const common = `${name}=; Max-Age=0; Path=/; SameSite=Lax${cookieSecureFlag()}`;
  document.cookie = common;
  if(base && base !== location.hostname){
    document.cookie = `${common}; Domain=${base}`;
  }
}
function setToken(t){
  t = String(t||"").trim();
  if(!t) return;
  for(const k of TOKEN_KEYS){
    try{ localStorage.setItem(k,t); }catch{}
    try{ sessionStorage.setItem(k,t); }catch{}
  }
  for(const c of TOKEN_COOKIES){
    try{ setCookie(c,t); }catch{}
  }
}
function getToken(){
  let t = "";
  for(const k of TOKEN_KEYS){
    try{ t = (localStorage.getItem(k)||"").trim(); if(t) break; }catch{}
  }
  if(!t){
    for(const k of TOKEN_KEYS){
      try{ t = (sessionStorage.getItem(k)||"").trim(); if(t) break; }catch{}
    }
  }
  if(!t){
    for(const c of TOKEN_COOKIES){
      t = (getCookie(c)||"").trim();
      if(t) break;
    }
  }
  if(t) setToken(t);
  return t;
}
function clearToken(){
  for(const k of TOKEN_KEYS){
    try{ localStorage.removeItem(k); }catch{}
    try{ sessionStorage.removeItem(k); }catch{}
  }
  for(const c of TOKEN_COOKIES){
    try{ delCookie(c); }catch{}
  }
}

/* ================== UI HELPERS ================== */
const toastEl = document.getElementById("toast");
function toast(msg){
  toastEl.textContent = String(msg||"");
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"),1200);
}
function esc(s){
  return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}

/* ================== RPC ================== */
async function rpc(fn, args){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{
    method:"POST",
    headers:{
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type":"application/json"
    },
    body: JSON.stringify(args||{})
  });
  const txt = await res.text();
  let data=null;
  try{ data = txt ? JSON.parse(txt) : null; }catch{}
  if(!res.ok){
    const msg = (data && (data.message||data.error||data.hint)) ? (data.message||data.error||data.hint) : txt;
    throw new Error(msg || `RPC failed: ${fn}`);
  }
  return data;
}

const API = {
  adminMe: (t)=>rpc("api_admin_me", { p_token: t }),
  logout:  (t)=>rpc("api_logout",   { p_token: t }),

  listQuizzes: (t)=>rpc("admin_list_quizzes_v0", { p_token: t }),
  upsertQuiz:  (t, payload)=>rpc("admin_upsert_quiz_v0", Object.assign({ p_token: t }, payload)),
  deleteQuiz:  (t, quiz_id)=>rpc("admin_delete_quiz_v0", { p_token: t, p_quiz_id: quiz_id }),

  getQuestions:(t, quiz_id)=>rpc("admin_get_questions_v0", { p_token: t, p_quiz_id: quiz_id }),
  replaceQuestions:(t, quiz_id, items)=>rpc("admin_replace_questions_v3_v0", { p_token: t, p_quiz_id: quiz_id, p_items: items }),

  listUsers: (t)=>rpc("admin_list_users_v0", { p_token: t }),
  deleteUser:(t, user_id)=>rpc("admin_delete_user_v0", { p_token: t, p_user_id: user_id }),
  forceRename:(t, user_id, newU)=>rpc("admin_force_rename_v0", { p_token: t, p_user_id: user_id, p_new_username: newU }),
  forceSetPin:(t, user_id, newPin)=>rpc("admin_force_set_pin_v0", { p_token: t, p_user_id: user_id, p_new_pin: newPin }),
};

/* ================== STATE ================== */
let TOKEN = "";
let ME = null;
let QUIZZES = [];
let USERS = [];
let CURRENT_QUIZ_ID = "";

/* ================== GATE ================== */
const gateCard = document.getElementById("gateCard");
const gateIdx = document.getElementById("gateIdx");
const gateMsg = document.getElementById("gateMsg");
const app = document.getElementById("app");
const mePill = document.getElementById("mePill");
const btnLogout = document.getElementById("btnLogout");

async function doLogout(){
  const t = getToken();
  try{ if(t) await API.logout(t); }catch{}
  clearToken();
  toast("ƒê√£ logout");
  setTimeout(()=>location.href="/", 250);
}

btnLogout.onclick = doLogout;

async function gate(){
  TOKEN = getToken();
  if(!TOKEN){
    gateIdx.className = "idx bad";
    gateIdx.textContent = "NO SESSION";
    gateMsg.innerHTML = `B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. H√£y v·ªÅ <b>Trang ch·ªß</b> ƒë·ªÉ login b·∫±ng <b>tuankhoi</b>.`;
    mePill.textContent = "Need login";
    app.style.display = "none";
    return false;
  }

  try{
    const out = await API.adminMe(TOKEN);
    if(!out?.ok || !out.me) throw new Error("not authorized");
    ME = out.me;

    gateIdx.className = "idx ok";
    gateIdx.textContent = "OK";
    gateMsg.innerHTML = `Xin ch√†o <b>${esc(ME.username)}</b>.`;

    mePill.innerHTML = `Xin ch√†o <b>${esc(ME.username)}</b> <span class="badge-admin">ADMIN</span>`;
    app.style.display = "";
    return true;
  }catch(e){
    // token invalid / not admin
    gateIdx.className = "idx bad";
    gateIdx.textContent = "DENY";
    gateMsg.innerHTML = `Kh√¥ng c√≥ quy·ªÅn / phi√™n h·∫øt h·∫°n. H√£y login ·ªü trang ch·ªß b·∫±ng <b>tuankhoi</b>.`;
    mePill.textContent = "Not authorized";
    app.style.display = "none";
    return false;
  }
}

/* ================== TABS ================== */
const tabQuizzes = document.getElementById("tabQuizzes");
const tabUsers = document.getElementById("tabUsers");
const panelQuizzes = document.getElementById("panelQuizzes");
const panelUsers = document.getElementById("panelUsers");

function setTab(name){
  const isQ = name === "quizzes";
  tabQuizzes.classList.toggle("active", isQ);
  tabUsers.classList.toggle("active", !isQ);
  panelQuizzes.style.display = isQ ? "" : "none";
  panelUsers.style.display = isQ ? "none" : "";
}

tabQuizzes.onclick = ()=>setTab("quizzes");
tabUsers.onclick = ()=>setTab("users");

/* ================== QUIZZES UI ================== */
const quizList = document.getElementById("quizList");
const quizSearch = document.getElementById("quizSearch");
document.getElementById("btnReloadQuizzes").onclick = ()=>loadQuizzes();
document.getElementById("btnNewQuiz").onclick = ()=>openQuizModal(null);

quizSearch.addEventListener("input", ()=>renderQuizzes(), {passive:true});

async function loadQuizzes(){
  try{
    const out = await API.listQuizzes(TOKEN);
    QUIZZES = out?.items || out?.rows || out?.data || [];
    renderQuizzes();
  }catch(e){
    toast(e.message || "Load quizzes l·ªói");
  }
}

function renderQuizzes(){
  const q = (quizSearch.value||"").trim().toLowerCase();
  const arr = (QUIZZES||[]).filter(x=>{
    if(!q) return true;
    return String(x.quiz_id||"").toLowerCase().includes(q) || String(x.title||"").toLowerCase().includes(q);
  });

  if(!arr.length){
    quizList.innerHTML = `<div class="muted">Kh√¥ng c√≥ quiz.</div>`;
    return;
  }

  quizList.innerHTML = arr.map(x=>{
    const badges = [
      x.pinned ? `<span class="idx">üìå PINNED</span>` : "",
      x.is_public ? `<span class="idx ok">PUBLIC</span>` : `<span class="idx bad">PRIVATE</span>`,
      x.require_login ? `<span class="idx">LOGIN</span>` : `<span class="idx ok">OPEN</span>`,
      x.require_access_code ? `<span class="idx">CODE</span>` : ""
    ].filter(Boolean).join(" ");

    return `
      <div class="item">
        <div class="row1">
          <div style="min-width:0">
            <div style="font-weight:950;font-size:1rem"><b>${esc(x.title||"(no title)")}</b></div>
            <div class="meta">
              <span class="idx">${esc(x.quiz_id||"")}</span>
              ${badges}
            </div>
            <div class="muted" style="margin-top:6px">${esc(x.sub||"")}</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn btn-primary" type="button" data-edit="${esc(x.quiz_id||"")}">Edit</button>
            <button class="btn btn-danger" type="button" data-del="${esc(x.quiz_id||"")}">Delete</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  for(const b of quizList.querySelectorAll("[data-edit]")){
    b.onclick = ()=>{
      const id = b.getAttribute("data-edit");
      const obj = (QUIZZES||[]).find(z=>String(z.quiz_id||"")===String(id||""));
      openQuizModal(obj || null);
    };
  }
  for(const b of quizList.querySelectorAll("[data-del]")){
    b.onclick = async ()=>{
      const id = b.getAttribute("data-del");
      if(!id) return;
      const ok = confirm(`X√≥a quiz ${id}? (x√≥a data li√™n quan)`);
      if(!ok) return;
      try{
        await API.deleteQuiz(TOKEN, id);
        toast("ƒê√£ x√≥a");
        await loadQuizzes();
      }catch(e){
        toast(e.message || "X√≥a l·ªói");
      }
    };
  }
}

/* ================== USERS UI ================== */
const userList = document.getElementById("userList");
const userSearch = document.getElementById("userSearch");
document.getElementById("btnReloadUsers").onclick = ()=>loadUsers();
userSearch.addEventListener("input", ()=>renderUsers(), {passive:true});

async function loadUsers(){
  try{
    const out = await API.listUsers(TOKEN);
    USERS = out?.items || out?.rows || out?.data || [];
    renderUsers();
  }catch(e){
    toast(e.message || "Load users l·ªói");
  }
}

function renderUsers(){
  const q = (userSearch.value||"").trim().toLowerCase();
  const arr = (USERS||[]).filter(x=>{
    if(!q) return true;
    return String(x.username||"").toLowerCase().includes(q);
  });

  if(!arr.length){
    userList.innerHTML = `<div class="muted">Kh√¥ng c√≥ user.</div>`;
    return;
  }

  userList.innerHTML = arr.map(x=>{
    const isAdmin = String(x.role||"").toLowerCase()==="admin" || String(x.username||"").toLowerCase()==="tuankhoi";
    return `
      <div class="item">
        <div class="row1">
          <div style="min-width:0">
            <div style="font-weight:950;font-size:1rem">
              <b>${esc(x.username||"")}</b> ${isAdmin ? `<span class="badge-admin">ADMIN</span>` : ""}
            </div>
            <div class="meta"><span class="idx">${esc(x.id||"")}</span> <span class="idx">${esc(x.role||"user")}</span></div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn" type="button" data-rename="${esc(x.id||"")}">Rename</button>
            <button class="btn" type="button" data-setpin="${esc(x.id||"")}">Set PIN</button>
            <button class="btn btn-danger" type="button" data-deluser="${esc(x.id||"")}">Delete</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  for(const b of userList.querySelectorAll("[data-rename]")){
    b.onclick = async ()=>{
      const id = b.getAttribute("data-rename");
      const nu = prompt("Username m·ªõi (a-z0-9_ 3-15):");
      if(!nu) return;
      try{
        await API.forceRename(TOKEN, id, String(nu||"").trim().toLowerCase());
        toast("ƒê√£ rename");
        await loadUsers();
      }catch(e){
        toast(e.message || "Rename l·ªói");
      }
    };
  }
  for(const b of userList.querySelectorAll("[data-setpin]")){
    b.onclick = async ()=>{
      const id = b.getAttribute("data-setpin");
      const np = prompt("PIN m·ªõi (tuankhoi=6 s·ªë, user=4 s·ªë):");
      if(!np) return;
      try{
        await API.forceSetPin(TOKEN, id, String(np||"").trim());
        toast("ƒê√£ set PIN");
      }catch(e){
        toast(e.message || "Set PIN l·ªói");
      }
    };
  }
  for(const b of userList.querySelectorAll("[data-deluser]")){
    b.onclick = async ()=>{
      const id = b.getAttribute("data-deluser");
      const ok = confirm("X√≥a user? (x√≥a attempts/progress/tokens)");
      if(!ok) return;
      try{
        await API.deleteUser(TOKEN, id);
        toast("ƒê√£ x√≥a user");
        await loadUsers();
      }catch(e){
        toast(e.message || "X√≥a user l·ªói");
      }
    };
  }
}

/* ================== QUIZ MODAL ================== */
const quizBackdrop = document.getElementById("quizBackdrop");
document.getElementById("btnCloseQuiz").onclick = ()=>closeQuizModal();
quizBackdrop.addEventListener("click",(e)=>{ if(e.target===quizBackdrop) closeQuizModal(); });

const quizModalIdx = document.getElementById("quizModalIdx");
const q_quiz_id = document.getElementById("q_quiz_id");
const q_title = document.getElementById("q_title");
const q_sub = document.getElementById("q_sub");
const q_is_public = document.getElementById("q_is_public");
const q_is_hidden = document.getElementById("q_is_hidden");
const q_show_in_store = document.getElementById("q_show_in_store");
const q_require_login = document.getElementById("q_require_login");
const q_pinned = document.getElementById("q_pinned");
const q_scoring_mode = document.getElementById("q_scoring_mode");
const q_total_score = document.getElementById("q_total_score");
const q_shuffle_mode = document.getElementById("q_shuffle_mode");
const q_require_access_code = document.getElementById("q_require_access_code");
const q_access_code = document.getElementById("q_access_code");
const q_questions_json = document.getElementById("q_questions_json");

document.getElementById("btnSaveQuiz").onclick = saveQuiz;
document.getElementById("btnDeleteQuiz").onclick = deleteQuizFromModal;
document.getElementById("btnLoadQuestions").onclick = loadQuestions;
document.getElementById("btnSaveQuestions").onclick = saveQuestions;

function openQuizModal(obj){
  CURRENT_QUIZ_ID = obj?.quiz_id ? String(obj.quiz_id) : "";
  quizModalIdx.textContent = CURRENT_QUIZ_ID ? CURRENT_QUIZ_ID : "NEW";

  q_quiz_id.value = CURRENT_QUIZ_ID || "";
  q_quiz_id.disabled = !!CURRENT_QUIZ_ID;

  q_title.value = obj?.title || "";
  q_sub.value = obj?.sub || "";
  q_is_public.checked = obj?.is_public ?? true;
  q_is_hidden.checked = obj?.is_hidden ?? false;
  q_show_in_store.checked = obj?.show_in_store ?? true;
  q_require_login.checked = obj?.require_login ?? true;
  q_pinned.checked = obj?.pinned ?? false;
  q_scoring_mode.value = obj?.scoring_mode || "equal";
  q_total_score.value = String(obj?.total_score ?? 10);
  q_shuffle_mode.value = obj?.shuffle_mode || "none";
  q_require_access_code.checked = obj?.require_access_code ?? false;
  q_access_code.value = "";

  q_questions_json.value = "[]";

  quizBackdrop.classList.add("show");
  quizBackdrop.setAttribute("aria-hidden","false");
}

function closeQuizModal(){
  quizBackdrop.classList.remove("show");
  quizBackdrop.setAttribute("aria-hidden","true");
}

async function saveQuiz(){
  const quiz_id = String(q_quiz_id.value||"").trim().toLowerCase();
  if(!/^[a-z]{5}$/.test(quiz_id)){
    toast("quiz_id ph·∫£i ƒë√∫ng 5 ch·ªØ a-z");
    return;
  }

  const payload = {
    p_quiz_id: quiz_id,
    p_title: String(q_title.value||""),
    p_sub: String(q_sub.value||""),
    p_is_public: !!q_is_public.checked,
    p_is_hidden: !!q_is_hidden.checked,
    p_show_in_store: !!q_show_in_store.checked,
    p_require_login: !!q_require_login.checked,
    p_pinned: !!q_pinned.checked,
    p_scoring_mode: String(q_scoring_mode.value||"equal"),
    p_total_score: Number(q_total_score.value||10),
    p_shuffle_mode: String(q_shuffle_mode.value||"none"),
    p_require_access_code: !!q_require_access_code.checked,
    p_access_code: String(q_access_code.value||"")
  };

  try{
    await API.upsertQuiz(TOKEN, payload);
    toast("ƒê√£ l∆∞u quiz");
    closeQuizModal();
    await loadQuizzes();
  }catch(e){
    toast(e.message || "L∆∞u quiz l·ªói");
  }
}

async function deleteQuizFromModal(){
  const quiz_id = String(q_quiz_id.value||"").trim().toLowerCase();
  if(!quiz_id) return;
  const ok = confirm(`X√≥a quiz ${quiz_id}?`);
  if(!ok) return;
  try{
    await API.deleteQuiz(TOKEN, quiz_id);
    toast("ƒê√£ x√≥a quiz");
    closeQuizModal();
    await loadQuizzes();
  }catch(e){
    toast(e.message || "X√≥a quiz l·ªói");
  }
}

async function loadQuestions(){
  const quiz_id = String(q_quiz_id.value||"").trim().toLowerCase();
  if(!quiz_id) return;
  try{
    const out = await API.getQuestions(TOKEN, quiz_id);
    const items = out?.items || out?.rows || out?.data || [];
    q_questions_json.value = JSON.stringify(items, null, 2);
    toast("ƒê√£ load questions");
  }catch(e){
    toast(e.message || "Load questions l·ªói");
  }
}

async function saveQuestions(){
  const quiz_id = String(q_quiz_id.value||"").trim().toLowerCase();
  if(!quiz_id) return;

  let items = null;
  try{
    items = JSON.parse(String(q_questions_json.value||"[]"));
  }catch{
    toast("JSON kh√¥ng h·ª£p l·ªá");
    return;
  }
  if(!Array.isArray(items)){
    toast("Questions ph·∫£i l√† m·∫£ng JSON []");
    return;
  }

  try{
    await API.replaceQuestions(TOKEN, quiz_id, items);
    toast("ƒê√£ save questions");
  }catch(e){
    toast(e.message || "Save questions l·ªói");
  }
}

/* ================== BOOT ================== */
async function boot(){
  const ok = await gate();
  if(!ok) return;

  setTab("quizzes");
  await loadQuizzes();
  await loadUsers();
}

boot();
</script>
</body>
</html>
