<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vocabulary Check</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg1: #ffecd2; --bg2: #fcb69f;
      --card: #fff; --text: #1f2937; --muted: #6b7280;
      --primary: #7c3aed; --ok: #16a34a; --bad: #dc2626;
      --border: #e5e7eb; --soft: #f8fafc;
      --shadow: 0 14px 40px rgba(0,0,0,.10);
      --radius: 18px;
      --gold: #f59e0b; --silver: #94a3b8; --bronze: #d97706;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Montserrat", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #fff 0%, rgba(255,255,255,0) 55%),
                  linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 100%);
      overflow: hidden;
    }
    #shell { height: 100vh; overflow: auto; -webkit-overflow-scrolling: touch; padding: 12px 0 80px; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 0 14px; }

    .actionbar {
      position: sticky; top: 10px; z-index: 9999;
      display: flex; justify-content: flex-end; gap: 10px; padding: 0 14px;
      flex-wrap: wrap;
    }
    .btn {
      border: 0; cursor: pointer;
      border-radius: 999px; padding: 10px 14px;
      font-weight: 900; font-size: .9rem;
      transition: transform .16s ease, filter .16s ease;
      display: inline-flex; align-items: center; gap: 8px;
      user-select: none; white-space: nowrap;
      box-shadow: 0 12px 24px rgba(0,0,0,.12);
      background: #fff; color: #111827; border: 1px solid #e5e7eb;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(.98); }
    .btn:active { transform: translateY(0px); }
    .btn-reset { background: #111827; color: #fff; border: 0; }
    .btn-primary {
      background: linear-gradient(135deg, #7c3aed, #fb7185);
      color: #fff; border: 0;
      box-shadow: 0 12px 24px rgba(124,58,237,.18);
    }
    .btn-check {
      border-radius: 14px;
      padding: 11px 12px;
      justify-content: center;
      width: 160px;
    }
    .btn-check[disabled] { opacity: .65; cursor: not-allowed; }

    .topbar {
      margin-top: 10px;
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      padding: 14px;
      display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap;
    }
    .titlebox { display: flex; gap: 10px; align-items: center; flex: 1 1 360px; min-width: 240px; }
    .logo {
      width: 42px; height: 42px; border-radius: 16px;
      background: linear-gradient(135deg, #a78bfa, #fb7185);
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: 900;
      box-shadow: 0 10px 22px rgba(124,58,237,.18);
      user-select: none;
    }
    .titles h1 { font-size: 1.02rem; margin: 0; font-weight: 800; }
    .titles .tiny { margin-top: 3px; font-size: .86rem; color: var(--muted); font-weight: 650; }

    .stats { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pill {
      background: #f3f4f6; border: 1px solid #e5e7eb;
      border-radius: 999px; padding: 8px 12px;
      font-weight: 800; font-size: .9rem; color: #374151; white-space: nowrap;
    }
    .pill strong { color: var(--primary); }
    .progressline {
      height: 10px; border-radius: 999px; background: #f3f4f6; overflow: hidden;
      border: 1px solid #e5e7eb; width: 100%; max-width: 360px;
    }
    .progressfill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, #22c55e, #a78bfa);
      transition: width .25s ease;
    }

    .content { padding: 12px 0 0; }
    .card {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px; margin: 12px 0;
    }
    .row1 { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .vi { margin: 0; font-weight: 900; font-size: 1.04rem; line-height: 1.25; }
    .meta { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .idx {
      font-size: .78rem; font-weight: 900;
      padding: 6px 10px; border-radius: 999px;
      background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe;
      white-space: nowrap;
    }
    .muted { color: var(--muted); font-weight: 650; }

    .input {
      width: 100%;
      border-radius: 14px; border: 2px solid #e5e7eb;
      padding: 11px 12px; font-size: .95rem; font-weight: 700;
      outline: none; background: var(--soft);
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .input:focus {
      border-color: rgba(124,58,237,.55);
      box-shadow: 0 0 0 5px rgba(124,58,237,.10);
      background: #fff;
    }
    .input[disabled] { background: #f3f4f6; color: #111827; }

    .resultRow{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:10px;
      align-items:center;
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px dashed #e5e7eb;
      background: #fff;
      font-weight: 800;
      line-height: 1.35;
    }
    .oktxt { color: var(--ok); font-weight: 1000; }
    .badtxt { color: var(--bad); font-weight: 1000; }

    /* leaderboard */
    .table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #fff;
    }
    .table th, .table td {
      padding: 10px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      font-weight: 750;
      font-size: .92rem;
    }
    .table th { background: #f8fafc; font-weight: 900; }
    .table tr:last-child td { border-bottom: 0; }

    .rankpill {
      display: inline-flex; align-items: center; gap: 8px;
      border-radius: 999px; padding: 6px 10px;
      font-weight: 950; font-size: .86rem;
      border: 1px solid #e5e7eb;
      background: #fff;
      white-space: nowrap;
    }
    .medal {
      width: 22px; height: 22px; border-radius: 999px;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: .9rem;
      color: #111827;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
    }
    .m1 { background: linear-gradient(135deg, #fde68a, #f59e0b); }
    .m2 { background: linear-gradient(135deg, #e2e8f0, #94a3b8); }
    .m3 { background: linear-gradient(135deg, #fdba74, #d97706); }

    .toprow1 td { background: rgba(245,158,11,.10); }
    .toprow2 td { background: rgba(148,163,184,.12); }
    .toprow3 td { background: rgba(217,119,6,.10); }

    .meRow td {
      background: rgba(124,58,237,.12) !important;
      border-top: 1px solid rgba(124,58,237,.25);
      border-bottom: 1px solid rgba(124,58,237,.25);
    }
    .meRow td:first-child { border-left: 6px solid rgba(124,58,237,.55); }
    .meName { font-weight: 1000; letter-spacing: .01em; }
    .meBadge {
      margin-left: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 900;
      font-size: .78rem;
      background: rgba(124,58,237,.14);
      border: 1px solid rgba(124,58,237,.35);
      color: #4c1d95;
      white-space: nowrap;
    }

    /* ADMIN badge */
    .adminBadge{
      margin-left: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 1000;
      font-size: .78rem;
      background: rgba(29,78,216,.12);
      border: 1px solid rgba(29,78,216,.28);
      color: #1d4ed8;
      white-space: nowrap;
    }

    /* Modal (Reset) */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.35);
      display: none; align-items: center; justify-content: center;
      padding: 16px;
      z-index: 10001;
    }
    .modal-backdrop.show { display: flex; }
    .modal {
      width: 100%; max-width: 520px;
      background: #fff;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      padding: 14px;
      max-height: 82vh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal h3 { margin: 4px 0 6px; font-size: 1.02rem; }
    .modal p { margin: 0 0 12px; color: var(--muted); font-weight: 650; font-size: .92rem; line-height: 1.35; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
    .btn-ghost { background: #fff; color: #111827; border: 1px solid #e5e7eb; box-shadow: none; }
    .btn-danger { background: var(--bad); color: #fff; border: 0; }

    /* Wrong popup */
    .xclose { position: sticky; top: 0; display: flex; justify-content: flex-end; z-index: 2; margin-bottom: 4px; }
    .btn-x {
      width: 56px; height: 56px;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #fff;
      cursor: pointer;
      font-weight: 1000;
      font-size: 1.8rem;
      line-height: 1;
      box-shadow: 0 12px 24px rgba(0,0,0,.10);
    }
    .btn-x:hover { filter: brightness(.98); transform: translateY(-1px); }
    .btn-x:active { transform: translateY(0px); }

    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(17,24,39,.92); color: #fff;
      padding: 10px 12px; border-radius: 14px;
      font-weight: 800; font-size: .9rem;
      opacity: 0; pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      max-width: calc(100% - 28px);
      z-index: 10003;
      text-align: center;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(-4px); }

    @media (max-width: 820px) {
      .progressline { max-width: 100%; }
      .btn { padding: 9px 12px; font-size: .85rem; }
      .btn-check{ width: 100%; }
      .resultRow{ grid-template-columns: 120px 1fr; }
    }
  </style>
</head>

<body>
  <div id="shell">
    <div class="actionbar">
      <button class="btn" id="btnScrollTop">‚¨ÜÔ∏è L√™n ƒë·∫ßu</button>
      <button class="btn btn-reset" id="btnReset">üîÅ L√†m l·∫°i</button>
      <button class="btn btn-primary" id="btnSubmit">üì§ N·ªôp b√†i</button>
    </div>

    <div class="wrap">
      <div class="topbar">
        <div class="titlebox">
          <div class="logo">Hi!</div>
          <div class="titles">
            <h1 id="quizTitle">Vocabulary</h1>
            <div class="tiny" id="quizSub"></div>
          </div>
        </div>

        <div class="stats">
          <div class="pill">Ng∆∞·ªùi l√†m: <strong id="whoName">‚Äî</strong></div>
          <div class="pill">ƒê√£ check: <strong id="answeredCount">0</strong>/<span id="totalCount">0</span></div>
          <div class="progressline"><div class="progressfill" id="progressFill"></div></div>
        </div>
      </div>

      <div class="content" id="content"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Reset Confirmation Modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">L√†m l·∫°i b√†i?</h3>
      <p>X√≥a l·∫ßn hi·ªán t·∫°i v√† shuffle l·∫°i.</p>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="btnCancel">H·ªßy</button>
        <button class="btn btn-danger" id="btnConfirmReset">X√≥a & L√†m l·∫°i</button>
      </div>
    </div>
  </div>

  <!-- Wrong Answers Popup -->
  <div class="modal-backdrop" id="wrongBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wrongTitle">
      <div class="xclose">
        <button class="btn-x" id="btnCloseWrong" aria-label="ƒê√≥ng">‚úï</button>
      </div>
      <h3 id="wrongTitle">Nh·ªØng c√¢u sai</h3>
      <div id="wrongBody" style="display:grid; gap:12px;"></div>
    </div>
  </div>

<script>
/********************
 * 0) SET API URL (Apps Script Web App)
 ********************/
const API_URL = "https://script.google.com/macros/s/AKfycbyplOXDMjC8XzxwKZd_-F1BsjmE6NzMiOWNeSAPlyLQzBPFaZ9nlOjIF9I7A3jvUroj/exec";

/********************
 * 0.05) Action fallback (ƒë·ªÉ kh·ªèi l·ªách t√™n action backend)
 ********************/
const ACTION_ALIASES = {
  getQuizData:      ["getQuizData","getQuiz","quizData","quiz","data"],
  registerUser:     ["registerUser","register","signup"],
  renameUser:       ["renameUser","rename","changeName"],
  me:               ["me","whoami","profile"],
  gradeOne:         ["gradeOne","grade","checkOne","check"],
  finalizeAttempt:  ["finalizeAttempt","finalize","submit","finish"],
  getLeaderboard:   ["getLeaderboard","leaderboard","lb","top"],
  saveProgress:     ["saveProgress","save","progressSave"],
  getProgress:      ["getProgress","progress","progressGet"]
};
const ACTION_RESOLVED = Object.create(null);

/********************
 * 0.1) Username rules
 ********************/
const USER_KEY = "tk_user_v1";
const RENAME_COOLDOWN_MS = 30 * 24 * 60 * 60 * 1000;
const BAD_SUBSTRINGS = ["du","dit","lon","cac","cho","fuck","shit","dick","pussy"];

/********************
 * Helpers
 ********************/
function escapeHtml(s) {
  return String(s ?? "")
    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;").replace(/'/g, "&#39;");
}
function toast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 1400);
}
function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function randId(prefix = "id") {
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function normalizeName(s){
  return String(s||"").trim().replace(/\s+/g," ").toLowerCase();
}
function isAdminName(name){
  return normalizeName(name) === "tuankhoi";
}

/********************
 * API core
 ********************/
function gasAvailable() {
  return !!(API_URL && API_URL.startsWith("http"));
}

async function postRaw(payload) {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=UTF-8" },
    body: JSON.stringify(payload),
  });

  const txt = await res.text();
  let data;
  try { data = JSON.parse(txt); }
  catch {
    throw new Error("API kh√¥ng tr·∫£ JSON. RAW: " + txt.slice(0, 160));
  }
  return data;
}

function isUnknownActionResp(data){
  const err = String((data && data.error) ? data.error : "");
  return data && data.ok === false && /unknown action/i.test(err);
}

async function callAction(logicalAction, payload) {
  const logical = String(logicalAction);
  const aliases = ACTION_ALIASES[logical] || [logical];
  const prefer = ACTION_RESOLVED[logical] ? [ACTION_RESOLVED[logical]] : [];
  const tries = [...prefer, ...aliases.filter(x => !prefer.includes(x))];

  let lastErr = null;
  for (const act of tries) {
    try {
      const data = await postRaw({ action: act, ...(payload||{}) });

      // unknown action -> th·ª≠ alias kh√°c
      if (isUnknownActionResp(data)) {
        lastErr = new Error(data.error || "Unknown action");
        continue;
      }

      // n·∫øu backend tr·∫£ ok:false th√¨ n√©m lu√¥n
      if (data && data.ok === false) {
        throw new Error(data.error || "API error");
      }

      ACTION_RESOLVED[logical] = act;
      return data;
    } catch (e) {
      lastErr = e;
      // n·∫øu l·ªói parse / network th√¨ d·ª´ng lu√¥n
      if (!(e && /Unknown action/i.test(String(e.message||"")))) break;
    }
  }
  throw (lastErr || new Error("API error"));
}

/********************
 * Polyfill google.script.run (ƒë·ªÉ code c≈© ch·∫°y)
 ********************/
function getQuizId() {
  try {
    const u = new URL(location.href);
    const q = (u.searchParams.get("quiz") || "").trim();
    return q || "vocab1";
  } catch { return "vocab1"; }
}

function installGoogleScriptRunPolyfill() {
  window.google = window.google || {};
  window.google.script = window.google.script || {};

  function runner(success, failure) {
    return new Proxy({}, {
      get(_t, prop) {
        if (prop === "withSuccessHandler") return (fn) => runner(fn, failure);
        if (prop === "withFailureHandler") return (fn) => runner(success, fn);

        return async (arg) => {
          const method = String(prop);

          // map primitive calls
          let payload = {};
          if (arg && typeof arg === "object") payload = { ...arg };
          else {
            if (method === "getLeaderboard") payload = { limit: arg };
            else if (method === "getProgress") payload = { cacheId: arg };
            else payload = {};
          }

          if (method === "getQuizData" && !payload.quizId) payload.quizId = getQuizId();

          try {
            const data = await callAction(method, payload);

            // getQuizData: backend c√≥ th·ªÉ tr·∫£ {ok:true,data:quiz} ho·∫∑c tr·∫£ th·∫≥ng quiz
            const out = (method === "getQuizData" && data && data.data) ? data.data : data;

            success && success(out);
            return out;
          } catch (err) {
            const e = (err instanceof Error) ? err : new Error(String(err));
            failure && failure(e);
            throw e;
          }
        };
      }
    });
  }

  window.google.script.run = runner(null, null);
}

/********************
 * User local
 ********************/
function loadUser() {
  try { return JSON.parse(localStorage.getItem(USER_KEY) || "null"); } catch { return null; }
}
function saveUser(u) {
  if (!u) localStorage.removeItem(USER_KEY);
  else localStorage.setItem(USER_KEY, JSON.stringify(u));
}

function normalizeForFilter(s) {
  let t = String(s || "").trim().toLowerCase();
  t = t.replace(/ƒë/g, "d");
  try { t = t.normalize("NFKD").replace(/[\u0300-\u036f]/g, ""); } catch {}
  t = t.replace(/0/g, "o").replace(/1/g, "l").replace(/3/g, "e").replace(/4/g, "a").replace(/5/g, "s").replace(/7/g, "t");
  t = t.replace(/[^a-z0-9_]/g, "");
  return t;
}
function isBadUsername(u) {
  const t = normalizeForFilter(u);
  for (const w of BAD_SUBSTRINGS) if (t.includes(w)) return true;
  return false;
}
function validateUsername(u) {
  u = String(u || "").trim();
  if (!u) return "Ch∆∞a nh·∫≠p username.";
  if (u.length > 15) return "Username t·ªëi ƒëa 15 k√Ω t·ª±.";
  if (!/^[A-Za-z0-9_]+$/.test(u)) return "Ch·ªâ ƒë∆∞·ª£c d√πng a-z A-Z 0-9 v√† d·∫•u _";
  if (isBadUsername(u)) return "Username c√≥ ch·ª©a t·ª´ kh√¥ng ph√π h·ª£p.";
  return null;
}

/********************
 * Persist (NH·∫∏: ch·ªâ localStorage + window.name)
 ********************/
const STORAGE_KEY = "gs_vocab_check_progress_v2";
const NAME_PREFIX = "GSV2::";

const Persist = {
  mirrorToWindowName(rawJson) {
    try { window.name = NAME_PREFIX + rawJson; } catch {}
  },
  mirrorGet() {
    try {
      const n = window.name || "";
      if (n.startsWith(NAME_PREFIX)) return n.slice(NAME_PREFIX.length);
    } catch {}
    return null;
  },
  get() {
    try { return localStorage.getItem(STORAGE_KEY) || null; } catch {}
    return this.mirrorGet();
  },
  set(raw, { mirror=false }={}) {
    if (mirror) this.mirrorToWindowName(raw);
    try { localStorage.setItem(STORAGE_KEY, raw); } catch {}
  },
  remove() {
    try { localStorage.removeItem(STORAGE_KEY); } catch {}
    try { if ((window.name||"").startsWith(NAME_PREFIX)) window.name=""; } catch {}
  }
};

/********************
 * Quiz Data
 ********************/
let QUIZ = { title: "Vocabulary", sub: "", vocabs: [], requireAccessCode: false };
let VMAP = new Map();

let QUIZ_READY = false;
let QUIZ_ERROR = null;
let QUIZ_PROMISE = null;

/********************
 * State
 ********************/
const QUIZ_VERSION = "vocab-check-v2";

let state = {
  quizVersion: QUIZ_VERSION,
  cacheId: "",
  name: "",
  accessCode: "",
  attemptId: "",
  order: [],
  answers: {},
  checked: {},
  finalized: false,
  result: null,
  history: []
};

let USER = null;

function ensureCacheId() {
  if (USER && USER.userId) {
    state.cacheId = USER.userId;
    try { location.hash = "cache=" + encodeURIComponent(state.cacheId); } catch {}
    return;
  }
  if (state.cacheId && String(state.cacheId).trim()) return;
  state.cacheId = randId("cache");
  try { location.hash = "cache=" + encodeURIComponent(state.cacheId); } catch {}
}

function newAttempt() {
  state.attemptId = randId("attempt");
  state.order = shuffle(QUIZ.vocabs.map(v => v.id));
  state.answers = {};
  state.checked = {};
  state.finalized = false;
  state.result = null;
}

let saveTimer = null;
function scheduleSave({ mirror = false } = {}) {
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    state.ts = Date.now();
    Persist.set(JSON.stringify(state), { mirror });
  }, 120);
}

// cloud save: CH·ªà khi check/finalize/pagehide (ƒë·ª° lag)
let lastCloud = 0;
function scheduleCloudSave(force=false) {
  if (!gasAvailable() || !window.google?.script?.run) return;
  const now = Date.now();
  if (!force && now - lastCloud < 4000) return;
  lastCloud = now;

  try {
    google.script.run.saveProgress({
      cacheId: state.cacheId,
      name: state.name || "",
      stateJson: JSON.stringify(state)
    });
  } catch {}
}

function checkedCount() { return Object.keys(state.checked || {}).length; }
function totalCount() { return QUIZ.vocabs.length; }

function updateStats() {
  const who = document.getElementById("whoName");
  const name = state.name ? state.name : "‚Äî";
  who.innerHTML = escapeHtml(name) + (state.name && isAdminName(state.name) ? ` <span class="adminBadge">ADMIN</span>` : "");
  who.style.cursor = state.name ? "pointer" : "default";
  who.title = state.name ? "B·∫•m ƒë·ªÉ ƒë·ªïi username (30 ng√†y/l·∫ßn)" : "";

  document.getElementById("answeredCount").textContent = checkedCount();
  document.getElementById("totalCount").textContent = totalCount();
  document.getElementById("progressFill").style.width =
    (totalCount() ? Math.round((checkedCount() / totalCount()) * 100) : 0) + "%";
}

/********************
 * Views
 ********************/
const content = document.getElementById("content");

function renderLoadingCard(msg, detail) {
  content.innerHTML = `
    <div class="card">
      <div class="row1">
        <p class="vi">${escapeHtml(msg || "ƒêang t·∫£i‚Ä¶")}</p>
        <div class="meta"><span class="idx">LOAD</span></div>
      </div>
      <div class="muted" style="margin-top:6px; line-height:1.35">
        ${escapeHtml(detail || "B·∫°n c√≥ th·ªÉ nh·∫≠p username ngay. D·ªØ li·ªáu s·∫Ω n·∫°p sau.")}
      </div>
      ${QUIZ_ERROR ? `
        <div class="muted" style="margin-top:10px;color:#b91c1c">
          ${escapeHtml(String(QUIZ_ERROR))}
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn btn-primary" id="btnRetry">üîÑ Th·ª≠ l·∫°i</button>
        </div>
      ` : ``}
    </div>
  `;
  const btn = document.getElementById("btnRetry");
  if (btn) btn.addEventListener("click", () => {
    QUIZ_ERROR = null;
    QUIZ_READY = false;
    QUIZ_PROMISE = loadQuizData();
    toast("ƒêang th·ª≠ l·∫°i‚Ä¶");
  });
}

async function registerWithAutoSuffix(baseUsername) {
  // th·ª≠: name, name1..name9
  const base = String(baseUsername || "").trim();
  for (let i = 0; i <= 9; i++) {
    const suffix = (i === 0) ? "" : String(i);
    const maxBaseLen = 15 - suffix.length;
    const candidate = (base.length > maxBaseLen ? base.slice(0, maxBaseLen) : base) + suffix;

    const err = validateUsername(candidate);
    if (err) throw new Error(err);

    try {
      const userId = randId("u");
      const res = await callAction("registerUser", { userId, username: candidate, ua: navigator.userAgent || "" });
      const u = res.user ? res.user : res;
      if (!u || !u.userId || !u.username) throw new Error("Backend registerUser tr·∫£ thi·∫øu user.");
      return { userId: u.userId, username: u.username, lastRenameAtMs: u.lastRenameAtMs || 0, _tried: candidate };
    } catch (e) {
      const msg = String(e && e.message ? e.message : e);
      // n·∫øu tr√πng t√™n -> th·ª≠ ti·∫øp
      if (/t·ªìn t·∫°i|exist|duplicate|used|taken/i.test(msg)) continue;
      throw e;
    }
  }
  throw new Error("Username ƒë√£ t·ªìn t·∫°i. Th·ª≠ t√™n kh√°c.");
}

function renderNameView() {
  content.innerHTML = "";
  const c = document.createElement("div");
  c.className = "card";
  c.innerHTML = `
    <div class="row1">
      <p class="vi">Nh·∫≠p USERNAME</p>
      <div class="meta"><span class="idx">B·∫ÆT BU·ªòC</span></div>
    </div>
    <div class="muted" style="margin-top:6px; line-height:1.35">
      Nh·∫≠p 1 l·∫ßn l√† d√πng m√£i. X√≥a cache/localStorage l√† m·∫•t lu√¥n (kh√¥ng kh√¥i ph·ª•c).<br/>
      Username t·ªëi ƒëa 15 k√Ω t·ª±, ch·ªâ a-z A-Z 0-9 v√† d·∫•u _.
    </div>
    ${QUIZ.requireAccessCode ? `<div style="margin-top:10px; display:grid; gap:10px;">
      <input id="codeInput" class="input" placeholder="M√£ truy c·∫≠p" maxlength="32" />
    </div>` : ``}
    <div style="margin-top:10px; display:grid; gap:10px;">
      <input id="nameInput" class="input" placeholder="vd: tuankhoi123" autocomplete="off" maxlength="15" />
      <button id="btnStart" class="btn btn-primary" style="justify-content:center;">‚û°Ô∏è V√†o l√†m</button>
    </div>
  `;
  content.appendChild(c);

  const input = c.querySelector("#nameInput");
  const btn = c.querySelector("#btnStart");
  const codeInput = c.querySelector("#codeInput");

  input.value = "";
  input.focus();

  const start = async () => {
    let username = String(input.value || "").trim();
    const vErr = validateUsername(username);
    if (vErr) { toast(vErr); return; }

    try {
      btn.disabled = true;
      btn.textContent = "‚è≥";

      const u = await registerWithAutoSuffix(username);
      USER = { userId: u.userId, username: u.username, lastRenameAtMs: u.lastRenameAtMs || 0 };
      saveUser(USER);

      state.name = USER.username;
      state.cacheId = USER.userId;
      if (codeInput) state.accessCode = String(codeInput.value || "").trim();

      ensureCacheId();

      if (!state.attemptId) newAttempt();
      scheduleSave({ mirror: true });

      if (u._tried && normalizeName(u._tried) !== normalizeName(username)) {
        toast(`T√™n tr√πng ‚Üí d√πng: ${u._tried}`);
      } else {
        toast("OK");
      }

      // n·∫øu quiz ch∆∞a load xong, show loading
      if (!QUIZ_READY) {
        renderLoadingCard("ƒêang t·∫£i c√¢u h·ªèi‚Ä¶", "ƒê·ª£i x√≠u nha, t·∫£i xong l√† v√†o l√†m li·ªÅn.");
        await QUIZ_PROMISE;
      }

      renderQuizView();
    } catch (e) {
      toast((e && e.message) ? e.message : String(e));
    } finally {
      btn.disabled = false;
      btn.textContent = "‚û°Ô∏è V√†o l√†m";
      updateStats();
    }
  };

  btn.addEventListener("click", start);
  input.addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); start(); } });
}

function buildQuizHTML() {
  const order = state.order && state.order.length ? state.order : QUIZ.vocabs.map(v => v.id);
  let html = "";

  order.forEach((id, idx) => {
    const v = VMAP.get(id);
    if (!v) return;

    const displayNo = idx + 1;
    const typed = String(state.answers[id] ?? "");
    const checked = state.checked && state.checked[id];
    const locked = !!(checked && checked.locked);

    const resultHtml = checked ? `
      <div class="resultRow">
        <div>${checked.ok ? `<span class="oktxt">ƒê√öNG ‚úÖ</span>` : `<span class="badtxt">SAI ‚ùå</span>`}</div>
        <div>${checked.ok ? `` : `<span class="muted">ƒê√°p √°n:</span> <b>${escapeHtml(checked.expected || v.meaning || "")}</b>`}</div>
      </div>
    ` : ``;

    html += `
      <div class="card" data-qcard="${id}">
        <div class="row1">
          <p class="vi">C√¢u ${displayNo}. <b>${escapeHtml(v.word)}</b> <span class="muted">(${escapeHtml(v.pos||"")})</span></p>
          <div class="meta"><span class="idx">#${displayNo}</span></div>
        </div>

        <div style="margin-top:10px; display:grid; gap:10px;">
          <input class="input ansInput" data-qid="${id}" placeholder="Nh·∫≠p nghƒ©a‚Ä¶" value="${escapeHtml(typed)}" ${locked ? "disabled" : ""}/>
          <button class="btn btn-primary btn-check" data-check="${id}" ${locked ? "disabled" : ""}>
            ${locked ? "ƒê√É CHECK" : "‚úÖ CHECK"}
          </button>
        </div>

        ${resultHtml}
      </div>
    `;
  });

  return html;
}

let handlersBound = false;
function renderQuizView() {
  updateStats();
  content.innerHTML = buildQuizHTML();

  if (!handlersBound) {
    content.addEventListener("input", onInput, { passive: true });
    content.addEventListener("click", onClick);
    handlersBound = true;
  }
}

function onInput(e) {
  const t = e.target;
  if (!t || !t.classList.contains("ansInput")) return;
  const id = Number(t.dataset.qid);
  if (!isFinite(id)) return;

  if (state.checked && state.checked[id] && state.checked[id].locked) {
    t.value = String(state.answers[id] ?? "");
    return;
  }

  state.answers[id] = String(t.value || "");
  scheduleSave();            // ch·ªâ save local
  // scheduleCloudSave();    // b·ªè ƒë·ªÉ kh·ªèi lag
}

let checking = new Set();

async function onClick(e) {
  const btn = e.target.closest("[data-check]");
  if (!btn) return;

  const id = Number(btn.dataset.check);
  if (!isFinite(id)) return;

  if (!state.name) { toast("B·∫°n c·∫ßn nh·∫≠p username tr∆∞·ªõc"); renderNameView(); return; }
  if (!gasAvailable()) { toast("Thi·∫øu API_URL Apps Script"); return; }
  if (!QUIZ_READY) { toast("ƒêang t·∫£i c√¢u h·ªèi‚Ä¶"); return; }

  if (state.checked && state.checked[id] && state.checked[id].locked) return;

  const input = content.querySelector(`.ansInput[data-qid="${id}"]`);
  const ans = input ? String(input.value || "").trim() : "";

  if (checking.has(id)) return;
  checking.add(id);

  btn.disabled = true;
  btn.textContent = "‚è≥";

  try {
    const res = await callAction("gradeOne", {
      name: state.name,
      accessCode: state.accessCode || "",
      cacheId: state.cacheId,
      attemptId: state.attemptId,
      vocabId: id,
      answer: ans,
      ua: navigator.userAgent || ""
    });

    // backend c√≥ th·ªÉ tr·∫£ {ok:true,item:{...}} ho·∫∑c {item:{...}} ho·∫∑c {ok,expected}
    const item = res.item ? res.item : res;

    if (!item || typeof item.ok === "undefined") {
      throw new Error("L·ªói check: backend tr·∫£ thi·∫øu item.ok");
    }

    state.answers[id] = ans;
    state.checked[id] = {
      locked: true,
      ok: !!item.ok,
      expected: String(item.expected || "")
    };

    scheduleSave({ mirror: true });
    scheduleCloudSave(false);

    renderQuizView();
    toast(item.ok ? "ƒê√öNG" : "SAI");

    if (checkedCount() >= totalCount()) {
      finalizeAndShow(); // auto
    }
  } catch (err) {
    toast("L·ªói: " + (err && err.message ? err.message : String(err)));
    btn.disabled = false;
    btn.textContent = "‚úÖ CHECK";
  } finally {
    checking.delete(id);
  }
}

/********************
 * Result + Leaderboard
 ********************/
const wrongBackdrop = document.getElementById("wrongBackdrop");
const wrongBody = document.getElementById("wrongBody");
document.getElementById("btnCloseWrong").addEventListener("click", () => closeWrongPopup());
wrongBackdrop.addEventListener("click", (e) => { if (e.target === wrongBackdrop) closeWrongPopup(); });

function openWrongPopup() {
  wrongBackdrop.classList.add("show");
  wrongBackdrop.setAttribute("aria-hidden", "false");
}
function closeWrongPopup() {
  wrongBackdrop.classList.remove("show");
  wrongBackdrop.setAttribute("aria-hidden", "true");
}

function buildWrongPopupContent() {
  wrongBody.innerHTML = "";
  const r = state.result;
  if (!r) return;

  const wrong = r.wrong || [];
  if (!wrong.length) {
    wrongBody.innerHTML = `<div class="card"><span class="oktxt">Kh√¥ng sai ‚úÖ</span></div>`;
    return;
  }

  wrong.forEach((w) => {
    const box = document.createElement("div");
    box.className = "card";
    box.innerHTML = `
      <div class="row1">
        <p class="vi"><b>${escapeHtml(w.word || "")}</b></p>
        <div class="meta"><span class="idx">SAI</span></div>
      </div>
      <div style="margin-top:10px" class="muted">B·∫°n vi·∫øt: <b>${escapeHtml(w.user || "‚Äî")}</b></div>
      <div style="margin-top:6px">ƒê√°p √°n: <b>${escapeHtml(w.expected || "")}</b></div>
    `;
    wrongBody.appendChild(box);
  });
}

async function fetchLeaderboard() {
  const box = document.getElementById("lbBox");
  if (!box) return;

  const meNorm = normalizeName(state.name);

  box.textContent = "ƒêang t·∫£i‚Ä¶";

  try {
    const res = await callAction("getLeaderboard", { limit: 30 });
    const rows = (res && res.rows) ? res.rows : (Array.isArray(res) ? res : []);

    if (!rows.length) {
      box.innerHTML = `<div class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>`;
      return;
    }

    const uniqueRows = rows.slice(0, 30);
    box.innerHTML = `
      <div style="overflow:auto;">
        <table class="table">
          <thead><tr><th>#</th><th>T√™n</th><th>ƒêi·ªÉm</th><th>%</th></tr></thead>
          <tbody>
            ${uniqueRows.map((r, index) => {
              const rk = index + 1;
              const medal = rk === 1 ? `<span class="medal m1">ü•á</span>` :
                            rk === 2 ? `<span class="medal m2">ü•à</span>` :
                            rk === 3 ? `<span class="medal m3">ü•â</span>` : "";
              const trClass = rk === 1 ? "toprow1" :
                              rk === 2 ? "toprow2" :
                              rk === 3 ? "toprow3" : "";

              const nameRaw = String(r.name || r.username || "‚Äî");
              const isMe = normalizeName(nameRaw) === meNorm;
              const rowClass = `${trClass} ${isMe ? "meRow" : ""}`.trim();

              const adminTag = isAdminName(nameRaw) ? `<span class="adminBadge">ADMIN</span>` : "";

              const nameCell = isMe
                ? `<span class="meName">${escapeHtml(nameRaw)}</span>${adminTag}<span class="meBadge">B·∫°n</span>`
                : `${escapeHtml(nameRaw)}${adminTag}`;

              const score10 = (typeof r.score10 !== "undefined") ? Number(r.score10).toFixed(1) : "‚Äî";
              const sp = (typeof r.scorePercent !== "undefined") ? Number(r.scorePercent).toFixed(0) : "‚Äî";

              return `
                <tr class="${rowClass}">
                  <td><span class="rankpill">${medal}<span>${rk}</span></span></td>
                  <td>${nameCell}</td>
                  <td><b>${score10}</b>/10</td>
                  <td>${sp}%</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
    `;
  } catch (err) {
    box.innerHTML = `L·ªói BXH: ${escapeHtml(err && err.message ? err.message : String(err))}`;
  }
}

function renderResultView() {
  content.innerHTML = "";
  const r = state.result;

  const sum = document.createElement("div");
  sum.className = "card";
  sum.innerHTML = `
    <div class="row1">
      <p class="vi">K·∫øt qu·∫£</p>
      <div class="meta"><span class="idx">DONE</span></div>
    </div>
    <div style="margin-top:10px; display:grid; gap:8px;">
      <div class="pill">ƒêi·ªÉm: <strong>${Number(r.scorePercent || 0).toFixed(0)}%</strong> (${Number(r.score10 || 0).toFixed(1)}/10)</div>
      <div class="pill">ƒê√∫ng: <strong>${Number(r.correctCount || 0)}</strong>/${Number(r.totalCount || 0)}</div>
      <button class="btn btn-primary" id="btnShowWrong" style="justify-content:center;">üìå Xem c√¢u sai</button>
    </div>
  `;
  content.appendChild(sum);

  const lb = document.createElement("div");
  lb.className = "card";
  lb.innerHTML = `
    <div class="row1">
      <p class="vi">B·∫£ng x·∫øp h·∫°ng</p>
      <div class="meta"><span class="idx">TOP</span></div>
    </div>
    <div id="lbBox" class="muted" style="margin-top:10px">ƒêang t·∫£i‚Ä¶</div>
  `;
  content.appendChild(lb);

  document.getElementById("btnShowWrong").addEventListener("click", () => {
    buildWrongPopupContent();
    openWrongPopup();
  });

  fetchLeaderboard();
  document.getElementById("shell").scrollTo({ top: 0, behavior: "smooth" });
}

async function finalizeAndShow() {
  if (!state.name) { toast("Ch∆∞a c√≥ username"); renderNameView(); return; }
  if (state.finalized && state.result) { renderResultView(); return; }

  state.finalized = true;
  scheduleSave({ mirror: true });

  try {
    const res = await callAction("finalizeAttempt", {
      name: state.name,
      accessCode: state.accessCode || "",
      cacheId: state.cacheId,
      attemptId: state.attemptId
    });

    const result = res.result ? res.result : res;
    if (!result || typeof result.scorePercent === "undefined") {
      throw new Error("Finalize l·ªói: backend tr·∫£ thi·∫øu result.scorePercent");
    }

    state.result = result;

    state.history = Array.isArray(state.history) ? state.history : [];
    state.history.push({
      ts: Date.now(),
      scorePercent: state.result.scorePercent,
      score10: state.result.score10,
      correctCount: state.result.correctCount,
      totalCount: state.result.totalCount
    });

    scheduleSave({ mirror: true });
    scheduleCloudSave(true);

    renderResultView();
    toast("Xong");
  } catch (err) {
    state.finalized = false;
    toast("Finalize l·ªói: " + (err && err.message ? err.message : String(err)));
  }
}

/********************
 * Reset
 ********************/
const modal = document.getElementById("modalBackdrop");
const openModal = () => { modal.classList.add("show"); modal.setAttribute("aria-hidden", "false"); };
const closeModal = () => { modal.classList.remove("show"); modal.setAttribute("aria-hidden", "true"); };

document.getElementById("btnReset").addEventListener("click", openModal);
document.getElementById("btnCancel").addEventListener("click", closeModal);
modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

document.getElementById("btnConfirmReset").addEventListener("click", () => {
  closeModal();
  const keepName = state.name;
  const keepCache = state.cacheId;
  const keepHist = Array.isArray(state.history) ? state.history : [];
  const keepCode = state.accessCode || "";

  state = {
    quizVersion: QUIZ_VERSION,
    cacheId: keepCache,
    name: keepName,
    accessCode: keepCode,
    attemptId: "",
    order: [],
    answers: {},
    checked: {},
    finalized: false,
    result: null,
    history: keepHist
  };
  if (QUIZ_READY) newAttempt();
  scheduleSave({ mirror: true });
  toast("ƒê√£ l√†m l·∫°i");
  if (QUIZ_READY) renderQuizView();
  else renderLoadingCard("ƒêang t·∫£i c√¢u h·ªèi‚Ä¶");
});

/********************
 * Scroll top
 ********************/
document.getElementById("btnScrollTop").addEventListener("click", () => {
  document.getElementById("shell").scrollTo({ top: 0, behavior: "smooth" });
});

/********************
 * Submit button (N·ªôp b√†i)
 ********************/
document.getElementById("btnSubmit").addEventListener("click", () => {
  finalizeAndShow();
});

/********************
 * Rename username (b·∫•m v√†o t√™n ·ªü topbar)
 ********************/
document.getElementById("whoName").addEventListener("click", async () => {
  if (!USER || !USER.userId) return;

  const last = Number(USER.lastRenameAtMs || 0);
  const can = (!last) || (Date.now() - last >= RENAME_COOLDOWN_MS);
  if (!can) {
    const leftMs = (last + RENAME_COOLDOWN_MS) - Date.now();
    const leftDays = Math.ceil(leftMs / (24*60*60*1000));
    toast(`Ch∆∞a ƒë·ªß 30 ng√†y ƒë·ªÉ ƒë·ªïi t√™n (${leftDays} ng√†y n·ªØa).`);
    return;
  }

  const newU = prompt("ƒê·ªïi username (t·ªëi ƒëa 15 k√Ω t·ª±, a-zA-Z0-9_):", USER.username || "");
  if (newU === null) return;

  const err = validateUsername(newU);
  if (err) { toast(err); return; }

  try {
    const res = await callAction("renameUser", { userId: USER.userId, newUsername: newU.trim(), ua: navigator.userAgent || "" });
    const u = res.user ? res.user : res;

    USER.username = u.username || newU.trim();
    USER.lastRenameAtMs = u.lastRenameAtMs || Date.now();
    saveUser(USER);

    state.name = USER.username;
    scheduleSave({ mirror: true });
    updateStats();
    toast("ƒê·ªïi t√™n OK");
  } catch (e) {
    toast((e && e.message) ? e.message : String(e));
  }
});

/********************
 * Boot
 ********************/
function parseHashCacheId() {
  try {
    const h = String(location.hash || "").replace(/^#/, "");
    const m = h.match(/(?:^|&)cache=([^&]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  } catch { return null; }
}

async function loadQuizData() {
  QUIZ_ERROR = null;
  QUIZ_READY = false;

  try {
    const data = await callAction("getQuizData", { quizId: getQuizId() });
    const quiz = data && data.data ? data.data : data;

    QUIZ = quiz || QUIZ;
    VMAP = new Map((QUIZ.vocabs || []).map(v => [v.id, v]));

    QUIZ_READY = true;
    return true;
  } catch (e) {
    QUIZ_ERROR = (e && e.message) ? e.message : String(e);
    QUIZ_READY = false;
    renderLoadingCard("L·ªói t·∫£i d·ªØ li·ªáu", "N·∫øu ƒë·ª©ng l√¢u: ki·ªÉm tra Apps Script Web App ƒë√£ deploy (Anyone) v√† doPost JSON.");
    throw e;
  }
}

function loadStateFast() {
  const raw = Persist.get() || Persist.mirrorGet();
  if (raw) {
    try { state = JSON.parse(raw) || state; } catch {}
  }
}

async function tryRestoreFromSheetIfMissing() {
  if (Persist.get()) return;
  const fromHash = parseHashCacheId();
  if (!fromHash) return;

  try {
    const res = await callAction("getProgress", { cacheId: fromHash });
    if (res && res.stateJson) {
      try {
        state = JSON.parse(res.stateJson) || state;
        Persist.set(JSON.stringify(state), { mirror: true });
      } catch {}
    }
  } catch {}
}

async function verifyUserIfAnyAsync() {
  if (!USER || !USER.userId) return;
  // kh√¥ng ch·∫∑n UI: verify sau
  try {
    await callAction("me", { userId: USER.userId });
  } catch {
    USER = null;
    saveUser(null);
    state.name = "";
    state.cacheId = "";
    updateStats();
    renderNameView();
    toast("User ƒë√£ m·∫•t (x√≥a cache r·ªìi ƒëƒÉng nh·∫≠p l·∫°i)");
  }
}

function bootRender() {
  document.getElementById("quizTitle").textContent = QUIZ.title || "Vocabulary";
  document.getElementById("quizSub").textContent = (QUIZ.sub || "").trim();

  ensureCacheId();

  if (!state.attemptId || !state.order || !state.order.length) {
    if (QUIZ_READY) newAttempt();
  }

  // √©p name/cache theo USER (nh·∫≠p 1 l·∫ßn d√πng m√£i)
  if (USER && USER.userId && USER.username) {
    state.name = USER.username;
    state.cacheId = USER.userId;
  }

  updateStats();

  if (!USER || !USER.username) renderNameView();
  else if (state.finalized && state.result) renderResultView();
  else if (QUIZ_READY) renderQuizView();
  else renderLoadingCard("ƒêang t·∫£i c√¢u h·ªèi‚Ä¶");

  scheduleSave({ mirror: true });

  window.addEventListener("pagehide", () => {
    try { Persist.mirrorToWindowName(JSON.stringify(state)); } catch {}
    scheduleCloudSave(true);
  }, { passive: true });
}

// START
(function(){
  if (!gasAvailable()) {
    content.innerHTML = `<div class="card"><b>Thi·∫øu API_URL Apps Script</b></div>`;
    return;
  }

  installGoogleScriptRunPolyfill();

  // render ngay l·∫≠p t·ª©c (kh√¥ng ch·ªù m·∫°ng)
  renderLoadingCard("ƒêang t·∫£i‚Ä¶", "B·∫°n c√≥ th·ªÉ nh·∫≠p username ngay, d·ªØ li·ªáu s·∫Ω n·∫°p sau.");

  USER = loadUser();
  loadStateFast();

  // n·∫øu c√≥ user -> set v√†o state ngay
  if (USER && USER.userId && USER.username) {
    state.name = USER.username;
    state.cacheId = USER.userId;
  }

  updateStats();
  if (!USER || !USER.username) renderNameView();

  // async: restore progress t·ª´ sheet (n·∫øu local m·∫•t)
  setTimeout(() => { tryRestoreFromSheetIfMissing().catch(()=>{}); }, 0);

  // async: verify user (kh√¥ng ch·∫∑n UI)
  setTimeout(() => { verifyUserIfAnyAsync().catch(()=>{}); }, 0);

  // async: load quiz (kh√¥ng ch·∫∑n UI)
  QUIZ_PROMISE = loadQuizData()
    .then(() => { bootRender(); })
    .catch(() => { /* l·ªói ƒë√£ render card */ });

})();
</script>
</body>
</html>
